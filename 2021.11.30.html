<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<!-- 2021-11-30 Tue 11:51 -->
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>OCaml Weekly News</title>
<meta name="generator" content="Org mode" />
<style type="text/css">
 <!--/*--><![CDATA[/*><!--*/
  .title  { text-align: center;
             margin-bottom: .2em; }
  .subtitle { text-align: center;
              font-size: medium;
              font-weight: bold;
              margin-top:0; }
  .todo   { font-family: monospace; color: red; }
  .done   { font-family: monospace; color: green; }
  .priority { font-family: monospace; color: orange; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .org-right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .org-left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .org-center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #ccc;
    box-shadow: 3px 3px 3px #eee;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: auto;
    padding-top: 1.2em;
  }
  pre.src:before {
    display: none;
    position: absolute;
    background-color: white;
    top: -10px;
    right: 10px;
    padding: 3px;
    border: 1px solid black;
  }
  pre.src:hover:before { display: inline; margin-top: 14px;}
  /* Languages per Org manual */
  pre.src-asymptote:before { content: 'Asymptote'; }
  pre.src-awk:before { content: 'Awk'; }
  pre.src-C:before { content: 'C'; }
  /* pre.src-C++ doesn't work in CSS */
  pre.src-clojure:before { content: 'Clojure'; }
  pre.src-css:before { content: 'CSS'; }
  pre.src-D:before { content: 'D'; }
  pre.src-ditaa:before { content: 'ditaa'; }
  pre.src-dot:before { content: 'Graphviz'; }
  pre.src-calc:before { content: 'Emacs Calc'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-fortran:before { content: 'Fortran'; }
  pre.src-gnuplot:before { content: 'gnuplot'; }
  pre.src-haskell:before { content: 'Haskell'; }
  pre.src-hledger:before { content: 'hledger'; }
  pre.src-java:before { content: 'Java'; }
  pre.src-js:before { content: 'Javascript'; }
  pre.src-latex:before { content: 'LaTeX'; }
  pre.src-ledger:before { content: 'Ledger'; }
  pre.src-lisp:before { content: 'Lisp'; }
  pre.src-lilypond:before { content: 'Lilypond'; }
  pre.src-lua:before { content: 'Lua'; }
  pre.src-matlab:before { content: 'MATLAB'; }
  pre.src-mscgen:before { content: 'Mscgen'; }
  pre.src-ocaml:before { content: 'Objective Caml'; }
  pre.src-octave:before { content: 'Octave'; }
  pre.src-org:before { content: 'Org mode'; }
  pre.src-oz:before { content: 'OZ'; }
  pre.src-plantuml:before { content: 'Plantuml'; }
  pre.src-processing:before { content: 'Processing.js'; }
  pre.src-python:before { content: 'Python'; }
  pre.src-R:before { content: 'R'; }
  pre.src-ruby:before { content: 'Ruby'; }
  pre.src-sass:before { content: 'Sass'; }
  pre.src-scheme:before { content: 'Scheme'; }
  pre.src-screen:before { content: 'Gnu Screen'; }
  pre.src-sed:before { content: 'Sed'; }
  pre.src-sh:before { content: 'shell'; }
  pre.src-sql:before { content: 'SQL'; }
  pre.src-sqlite:before { content: 'SQLite'; }
  /* additional languages in org.el's org-babel-load-languages alist */
  pre.src-forth:before { content: 'Forth'; }
  pre.src-io:before { content: 'IO'; }
  pre.src-J:before { content: 'J'; }
  pre.src-makefile:before { content: 'Makefile'; }
  pre.src-maxima:before { content: 'Maxima'; }
  pre.src-perl:before { content: 'Perl'; }
  pre.src-picolisp:before { content: 'Pico Lisp'; }
  pre.src-scala:before { content: 'Scala'; }
  pre.src-shell:before { content: 'Shell Script'; }
  pre.src-ebnf2ps:before { content: 'ebfn2ps'; }
  /* additional language identifiers per "defun org-babel-execute"
       in ob-*.el */
  pre.src-cpp:before  { content: 'C++'; }
  pre.src-abc:before  { content: 'ABC'; }
  pre.src-coq:before  { content: 'Coq'; }
  pre.src-groovy:before  { content: 'Groovy'; }
  /* additional language identifiers from org-babel-shell-names in
     ob-shell.el: ob-shell is the only babel language using a lambda to put
     the execution function name together. */
  pre.src-bash:before  { content: 'bash'; }
  pre.src-csh:before  { content: 'csh'; }
  pre.src-ash:before  { content: 'ash'; }
  pre.src-dash:before  { content: 'dash'; }
  pre.src-ksh:before  { content: 'ksh'; }
  pre.src-mksh:before  { content: 'mksh'; }
  pre.src-posh:before  { content: 'posh'; }
  /* Additional Emacs modes also supported by the LaTeX listings package */
  pre.src-ada:before { content: 'Ada'; }
  pre.src-asm:before { content: 'Assembler'; }
  pre.src-caml:before { content: 'Caml'; }
  pre.src-delphi:before { content: 'Delphi'; }
  pre.src-html:before { content: 'HTML'; }
  pre.src-idl:before { content: 'IDL'; }
  pre.src-mercury:before { content: 'Mercury'; }
  pre.src-metapost:before { content: 'MetaPost'; }
  pre.src-modula-2:before { content: 'Modula-2'; }
  pre.src-pascal:before { content: 'Pascal'; }
  pre.src-ps:before { content: 'PostScript'; }
  pre.src-prolog:before { content: 'Prolog'; }
  pre.src-simula:before { content: 'Simula'; }
  pre.src-tcl:before { content: 'tcl'; }
  pre.src-tex:before { content: 'TeX'; }
  pre.src-plain-tex:before { content: 'Plain TeX'; }
  pre.src-verilog:before { content: 'Verilog'; }
  pre.src-vhdl:before { content: 'VHDL'; }
  pre.src-xml:before { content: 'XML'; }
  pre.src-nxml:before { content: 'XML'; }
  /* add a generic configuration mode; LaTeX export needs an additional
     (add-to-list 'org-latex-listings-langs '(conf " ")) in .emacs */
  pre.src-conf:before { content: 'Configuration File'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.org-right  { text-align: center;  }
  th.org-left   { text-align: center;   }
  th.org-center { text-align: center; }
  td.org-right  { text-align: right;  }
  td.org-left   { text-align: left;   }
  td.org-center { text-align: center; }
  dt { font-weight: bold; }
  .footpara { display: inline; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .equation-container {
    display: table;
    text-align: center;
    width: 100%;
  }
  .equation {
    vertical-align: middle;
  }
  .equation-label {
    display: table-cell;
    text-align: right;
    vertical-align: middle;
  }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  .org-svg { width: 90%; }
  /*]]>*/-->
</style>
<style type="text/css">#table-of-contents h2 { display: none } .title { display: none } .authorname { text-align: right }</style>
<style type="text/css">.outline-2 {border-top: 1px solid black;}</style>
<script type="text/javascript">
// @license magnet:?xt=urn:btih:e95b018ef3580986a04669f1b5879592219e2a7a&dn=public-domain.txt Public Domain
<!--/*--><![CDATA[/*><!--*/
     function CodeHighlightOn(elem, id)
     {
       var target = document.getElementById(id);
       if(null != target) {
         elem.classList.add("code-highlighted");
         target.classList.add("code-highlighted");
       }
     }
     function CodeHighlightOff(elem, id)
     {
       var target = document.getElementById(id);
       if(null != target) {
         elem.classList.remove("code-highlighted");
         target.classList.remove("code-highlighted");
       }
     }
    /*]]>*///-->
// @license-end
</script>
</head>
<body>
<div id="content">
<h1 class="title">OCaml Weekly News</h1>
<p>
<a href="https://alan.petitepomme.net/cwn/2021.11.23.html">Previous Week</a> <a href="https://alan.petitepomme.net/cwn/index.html">Up</a> <a href="https://alan.petitepomme.net/cwn/2021.12.07.html">Next Week</a>
</p>

<p>
Hello
</p>

<p>
Here is the latest OCaml Weekly News, for the week of November 23 to 30, 2021.
</p>

<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#1">opam 2.1.1, opam 2.0.10, and opam-depext 1.2</a></li>
<li><a href="#2">OTOML 0.9.0 — a compliant and flexible TOML parsing, manipulation, and pretty-printing library</a></li>
<li><a href="#3">New release of Fix</a></li>
<li><a href="#4">New release of Menhir (20211125)</a></li>
<li><a href="#5">Lwt 5.5.0, Lwt_domain 0.1.0, Lwt_react.1.1.5</a></li>
<li><a href="#6">OCaml's CI is gradually moving to GitHub Actions</a></li>
<li><a href="#7">How to combine 3 monads: Async/Lwt, Error and State?</a></li>
<li><a href="#org572034b">Old CWN</a></li>
</ul>
</div>
</div>


<div id="outline-container-1" class="outline-2">
<h2 id="1">opam 2.1.1, opam 2.0.10, and opam-depext 1.2</h2>
<div class="outline-text-2" id="text-1">
<p>
Archive: <a href="https://discuss.ocaml.org/t/ann-opam-2-1-1-opam-2-0-10-opam-depext-1-2/8872/1">https://discuss.ocaml.org/t/ann-opam-2-1-1-opam-2-0-10-opam-depext-1-2/8872/1</a>
</p>
</div>

<div id="outline-container-org599f8fb" class="outline-3">
<h3 id="org599f8fb">R. Boujbel announced</h3>
<div class="outline-text-3" id="text-org599f8fb">
<p>
We are pleased to announce several minor releases: <a href="https://github.com/ocaml/opam/releases/tag/2.0.10">opam 2.0.10</a>,
<a href="https://github.com/ocaml/opam/releases/tag/2.1.1">opam 2.1.1</a>, and <a href="https://github.com/ocaml-opam/opam-depext/releases/tag/1.2">opam-depext
1.2</a>.
</p>

<p>
The opam releases consist of backported fixes, while <code>opam-depext</code> has been adapted to be compatible with opam 2.1,
to allow for workflows which need to maintain compatibility with opam 2.0. With opam 2.1.1, if you export
<code>OPAMCLI=2.0</code> into your environment then workflows expecting opam 2.0 should now behave even more equivalently.
</p>

<p>
You'll find more information in the <a href="https://opam.ocaml.org/blog/opam-2-0-10-2-1-1-depext/">blog post </a>.
</p>
</div>
</div>
</div>




<div id="outline-container-2" class="outline-2">
<h2 id="2">OTOML 0.9.0 — a compliant and flexible TOML parsing, manipulation, and pretty-printing library</h2>
<div class="outline-text-2" id="text-2">
<p>
Archive: <a href="https://discuss.ocaml.org/t/ann-otoml-0-9-0-a-compliant-and-flexible-toml-parsing-manipulation-and-pretty-printing-library/8152/10">https://discuss.ocaml.org/t/ann-otoml-0-9-0-a-compliant-and-flexible-toml-parsing-manipulation-and-pretty-printing-library/8152/10</a>
</p>
</div>

<div id="outline-container-org0bc80a6" class="outline-3">
<h3 id="org0bc80a6">Daniil Baturin announced</h3>
<div class="outline-text-3" id="text-org0bc80a6">
<p>
A new 0.9.3 relase is available. Still not 1.0.0 just in case. The change I'm most glad I managed to make is that the
lexer is now re-entrant and doesn't use any mutable state. Where can I apply for the "Designed for multicore OCaml"
certification sticker? ;)
</p>
</div>

<div id="outline-container-orgf0e641f" class="outline-4">
<h4 id="orgf0e641f">Breaking change in the functor interface</h4>
<div class="outline-text-4" id="text-orgf0e641f">
<p>
I found an oversight that took a breaking change to fix. It didn't break any package that was already in the OPAM
repository, so I'm glad I noticed it before it caused anyone trouble.
</p>

<p>
My idea to make the functor take separate integer and float modules turned out to be misguided: it wouldn't compose
with <code>Otoml.get_float ~strict:false</code> and similar functions that apply type conversions.
</p>

<p>
Logically, <code>Otoml.get_float ~strict:false (Otoml.integer 5)</code> should produce <code>Otoml.TomlFloat 5.0</code>. However, it means
that <code>get_float</code> needs to know how to convert integers to float. If integer and float types are in separate modules,
that isn't possible.
</p>

<p>
So I combined both integers and floats in a single <code>TomlNumber</code>. That way people who want to bring their own bignum
libraries will have to write more code, but numbers will behave as they are expected to in a dynamically typed
format.
</p>

<div class="org-src-container">
<pre class="src src-ocaml"><span style="color: #000000; font-weight: bold;">module</span> <span style="color: #228b22;">BigNumber</span> = <span style="color: #000000; font-weight: bold;">struct</span>
  <span style="color: #000000; font-weight: bold;">type</span> <span style="color: #228b22;">int</span> = <span style="color: #228b22;">Z.</span>t
  <span style="color: #000000; font-weight: bold;">type</span> <span style="color: #228b22;">float</span> = <span style="color: #228b22;">Decimal.</span>t

  <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #a0522d;">int_of_string</span> = <span style="color: #228b22;">Z.</span>of_string
  <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #a0522d;">int_to_string</span> = <span style="color: #228b22;">Z.</span>to_string
  <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #0000ff;">int_of_boolean</span> <span style="color: #a0522d;">b</span> = <span style="color: #a020f0;">if</span> b <span style="color: #a020f0;">then</span> <span style="color: #228b22;">Z.</span>one <span style="color: #a020f0;">else</span> <span style="color: #228b22;">Z.</span>zero
  <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #0000ff;">int_to_boolean</span> <span style="color: #a0522d;">n</span> = (n &lt;&gt; <span style="color: #228b22;">Z.</span>zero)

  <span style="color: #b22222;">(* </span><span style="color: #b22222;">Can't just reuse Decimal.to/of_string because their optional arguments</span>
<span style="color: #b22222;">     would cause a signature mismatch. </span><span style="color: #b22222;">*)</span>
  <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #0000ff;">float_of_string</span> <span style="color: #a0522d;">s</span> = <span style="color: #228b22;">Decimal.</span>of_string s

  <span style="color: #b22222;">(* </span><span style="color: #b22222;">Decimal.to_string uses "NaN" spelling</span>
<span style="color: #b22222;">     while TOML requires all special float values to be lowercase. </span><span style="color: #b22222;">*)</span>
  <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #0000ff;">float_to_string</span> <span style="color: #a0522d;">x</span> = <span style="color: #228b22;">Decimal.</span>to_string x <span style="color: #a52a2a;">|&gt;</span> <span style="color: #228b22;">String.</span>lowercase_ascii
  <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #0000ff;">float_of_boolean</span> <span style="color: #a0522d;">b</span> = <span style="color: #a020f0;">if</span> b <span style="color: #a020f0;">then</span> <span style="color: #228b22;">Decimal.</span>one <span style="color: #a020f0;">else</span> <span style="color: #228b22;">Decimal.</span>zero
  <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #0000ff;">float_to_boolean</span> <span style="color: #a0522d;">x</span> = (x &lt;&gt; <span style="color: #228b22;">Decimal.</span>zero)

  <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #a0522d;">float_of_int</span> = <span style="color: #228b22;">Decimal.</span>of_bigint
  <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #a0522d;">int_of_float</span> = <span style="color: #228b22;">Decimal.</span>to_bigint
<span style="color: #000000; font-weight: bold;">end</span>

<span style="color: #000000; font-weight: bold;">module</span> <span style="color: #228b22;">Otoml</span> = <span style="color: #228b22;">Otoml.Base.Make (BigNumber) (Otoml.Base.StringDate)</span>
</pre>
</div>

<p>
The next release will likely be 1.0.0 for real.
</p>
</div>
</div>
</div>
</div>




<div id="outline-container-3" class="outline-2">
<h2 id="3">New release of Fix</h2>
<div class="outline-text-2" id="text-3">
<p>
Archive: <a href="https://discuss.ocaml.org/t/ann-new-release-of-fix/8895/1">https://discuss.ocaml.org/t/ann-new-release-of-fix/8895/1</a>
</p>
</div>

<div id="outline-container-org0775e84" class="outline-3">
<h3 id="org0775e84">François Pottier announced</h3>
<div class="outline-text-3" id="text-org0775e84">
<p>
I am pleased to announce a new release of Fix, with several new modules
contribued by Frédéric Bour (thanks!).
</p>

<p>
In short, Fix is a toolkit that helps perform memoization and fixed point
computations (including data flow analyses). More generally, it offers a
number of basic algorithmic building blocks that can be useful in many
circumstances.
</p>

<pre class="example" id="org77c2bf4">
opam update
opam install fix.20211125
</pre>

<p>
Documentation can be found here:
</p>

<ul class="org-ul">
<li><a href="https://gitlab.inria.fr/fpottier/fix/-/blob/master/README.md">https://gitlab.inria.fr/fpottier/fix/-/blob/master/README.md</a></li>
<li><a href="http://cambium.inria.fr/~fpottier/fix/doc/fix/Fix/index.html">http://cambium.inria.fr/~fpottier/fix/doc/fix/Fix/index.html</a></li>
</ul>

<p>
Enjoy,
</p>

<p>
François Pottier <br />
francois.pottier@inria.fr <br />
<a href="http://cambium.inria.fr/~fpottier/">http://cambium.inria.fr/~fpottier/</a>
</p>
</div>

<div id="outline-container-orge777212" class="outline-4">
<h4 id="orge777212">2021/11/25</h4>
<div class="outline-text-4" id="text-orge777212">
<ul class="org-ul">
<li>The new module <code>CompactQueue</code> offers a minimalist mutable FIFO queue. It is
comparable with OCaml's <code>Queue</code> module. In comparison with <code>Queue</code>, it uses
a more compact internal representation: elements are stored contiguously in
a circular array. This has a positive impact on performance: both time and
memory consumption are reduced. This data structure is optimized for maximum
throughput. (Contributed by Frédéric Bour, reviewed by François Pottier.)</li>

<li>The new functor <code>DataFlow.ForCustomMaps</code> offers a forward data flow analysis
that is tuned for greater performance. (Contributed by Frédéric Bour,
reviewed by François Pottier.)</li>

<li>The new module <code>Indexing</code> offers a safe API for manipulating indices into
fixed-size arrays. This API involves some dynamic checks as well as static
type checks, thereby (hopefully) greatly reducing the risk of confusion in
code that uses many arrays and many indices into these arrays. (Contributed
by Frédéric Bour, reviewed by François Pottier.)</li>

<li>In <code>DataFlow</code>, allow the function <code>foreach_root</code>
(which is part of the signature <code>DATA_FLOW_GRAPH</code>)
to call <code>contribute x _</code> several times at a single root <code>x</code>.</li>
</ul>
</div>
</div>
</div>
</div>




<div id="outline-container-4" class="outline-2">
<h2 id="4">New release of Menhir (20211125)</h2>
<div class="outline-text-2" id="text-4">
<p>
Archive: <a href="https://discuss.ocaml.org/t/ann-new-release-of-menhir-20211125/8896/1">https://discuss.ocaml.org/t/ann-new-release-of-menhir-20211125/8896/1</a>
</p>
</div>

<div id="outline-container-orgc472115" class="outline-3">
<h3 id="orgc472115">François Pottier announced</h3>
<div class="outline-text-3" id="text-orgc472115">
<p>
I am pleased to announce a new release of Menhir, with an exciting
contribution by Frédéric Bour: a groundbreaking performance improvement in
<code>menhir --list-errors</code>. This is made possible by an entirely new reachability
algorithm, which has been designed and implemented by Frédéric, and which is
described in our paper "Faster Reachability Analysis for LR(1) Parsers". This
is the link to the paper:
</p>

<p>
<a href="http://cambium.inria.fr/~fpottier/publis/bour-pottier-reachability.pdf">http://cambium.inria.fr/~fpottier/publis/bour-pottier-reachability.pdf</a>
</p>

<p>
To install the new release, just type
</p>

<pre class="example" id="org1b00224">
opam update
opam install menhir.20211125
</pre>

<p>
Enjoy!
</p>

<p>
François Pottier <br />
Francois.Pottier@inria.fr <br />
<a href="http://cambium.inria.fr/~fpottier/">http://cambium.inria.fr/~fpottier/</a>
</p>

<ul class="org-ul">
<li>The command <code>menhir --list-errors</code> has been sped up by a factor of up
to x100, and requires up to x1000 less memory, thanks to a new LR(1)
reachability algorithm, which has been designed and implemented by
Frédéric Bour.</li>

<li>Better document the restricted way in which the <code>error</code> token must be
used when using <code>--strategy simplified</code>. Menhir now checks that this
token is used only at the end of a production, and warns if this is
not the case. (Better yet, our suggestion is to not use the <code>error</code>
token at all!)</li>

<li>The <code>$syntaxerror</code> keyword is now forbidden when using
<code>--strategy simplified</code>. This keyword will be entirely removed
in the next release. Incidentally, we have just found out that
it behaves differently under the code back-end and under the
table back-end.</li>

<li>Disable OCaml warning 39 (unused rec flag) in the OCaml code produced
by Menhir's code back-end. This does not affect the table back-end.
(Reported by Armaël Guéneau.)</li>

<li>Fix a bug in <code>--random-*</code> which could cause Menhir to diverge if the
grammar uses the <code>error</code> token.</li>

<li>Warn if a terminal symbol is named <code>Error</code>. This creates a name clash
in the public interface of the generated parser.</li>

<li>Menhir now requires OCaml 4.03.0 (instead of 4.02.3)
and Dune 2.8.0 (instead of 2.0.0).</li>
</ul>
</div>
</div>
</div>




<div id="outline-container-5" class="outline-2">
<h2 id="5">Lwt 5.5.0, Lwt_domain 0.1.0, Lwt_react.1.1.5</h2>
<div class="outline-text-2" id="text-5">
<p>
Archive: <a href="https://discuss.ocaml.org/t/ann-lwt-5-5-0-lwt-domain-0-1-0-lwt-react-1-1-5/8897/1">https://discuss.ocaml.org/t/ann-lwt-5-5-0-lwt-domain-0-1-0-lwt-react-1-1-5/8897/1</a>
</p>
</div>

<div id="outline-container-org01d7fdc" class="outline-3">
<h3 id="org01d7fdc">Raphaël Proust announced</h3>
<div class="outline-text-3" id="text-org01d7fdc">
<p>
It is my pleasure to announce the release of Lwt version 5.5.0, Lwt_domain version 0.1.0, Lwt_react version 1.1.5,
Lwt_ppx version 2.0.3 and Lwt_ppx_let version 5.5.0.
</p>

<p>
<a href="https://github.com/ocsigen/lwt/releases/tag/5.5.0">https://github.com/ocsigen/lwt/releases/tag/5.5.0</a>
</p>

<p>
All those packages can be installed via opam as usual.
</p>
</div>

<div id="outline-container-org3388df3" class="outline-4">
<h4 id="org3388df3">:rotating_light:  Deprecation</h4>
<div class="outline-text-4" id="text-org3388df3">
<p>
One notable change is the deprecation of <code>Lwt_main.yield</code> and <code>Lwt_unix.yield</code>. It is recommended to use <code>Lwt.pause</code>
instead.
</p>
</div>
</div>

<div id="outline-container-org0b90a91" class="outline-4">
<h4 id="org0b90a91">:rocket:  Lwt_domain: an interface to multicore parallelism</h4>
<div class="outline-text-4" id="text-org0b90a91">
<p>
Another notable change is the addition of the Lwt_domain package. This package includes a single module <code>Lwt_domain</code>
with functions to execute some computations in parallel, using the features of Multicore OCaml. The package requires
an OCaml compiler with domains support to install.
</p>

<p>
Code for this package is the work of @sudha with reviews and packaging from Lwt contributors.
</p>
</div>
</div>

<div id="outline-container-org231338d" class="outline-4">
<h4 id="org231338d">Other changes</h4>
<div class="outline-text-4" id="text-org231338d">
<p>
The full list of changes is available in the <a href="https://github.com/ocsigen/lwt/blob/5.5.0/CHANGES">CHANGES file</a>.
</p>
</div>
</div>
</div>
</div>




<div id="outline-container-6" class="outline-2">
<h2 id="6">OCaml's CI is gradually moving to GitHub Actions</h2>
<div class="outline-text-2" id="text-6">
<p>
Archive: <a href="https://discuss.ocaml.org/t/ann-ocamls-ci-is-gradually-moving-to-github-actions/8902/1">https://discuss.ocaml.org/t/ann-ocamls-ci-is-gradually-moving-to-github-actions/8902/1</a>
</p>
</div>

<div id="outline-container-orgef52111" class="outline-3">
<h3 id="orgef52111">Sora Morimoto announced</h3>
<div class="outline-text-3" id="text-orgef52111">
<p>
The OCaml team started switching to GitHub Actions last year for some of the official OCaml repositories. Also, we
have released some CI related stuff, such as setup-ocaml, to the community. Some OCaml hackers also know that CI in
the OCaml community is gradually switching to GitHub Actions nowadays.
</p>

<p>
However, what gradually became a problem when we started switching was that the number of concurrent jobs that could
run in a free account on GitHub was not enough for our activeness.
</p>

<p>
One of the major pain points for compiler contributors is that the wait time for CI to complete, which is unrelated
to the actual build, is too long. However, this has been a pain point in all services, even before GitHub Actions.
</p>

<p>
The GitHub team did their best to help us make it better. As a result, they offered to upgrade the OCaml
organization's plan to the team plan for free, which means that we can now benefit from a range of features,
including access to 3x more concurrent runners than before.
</p>

<ul class="org-ul">
<li>About team plan: <a href="https://docs.github.com/en/actions/learn-github-actions/usage-limits-billing-and-administration">https://docs.github.com/en/actions/learn-github-actions/usage-limits-billing-and-administration</a></li>
<li>Concurrency/plan: <a href="https://docs.github.com/en/get-started/learning-about-github/githubs-products#github-team">https://docs.github.com/en/get-started/learning-about-github/githubs-products#github-team</a></li>
</ul>

<p>
We would like to thank GitHub for supporting our team and Ahmed Bilal, who supported this effort.
</p>
</div>
</div>
</div>




<div id="outline-container-7" class="outline-2">
<h2 id="7">How to combine 3 monads: Async/Lwt, Error and State?</h2>
<div class="outline-text-2" id="text-7">
<p>
Archive: <a href="https://discuss.ocaml.org/t/how-to-combine-3-monads-async-lwt-error-and-state/8906/9">https://discuss.ocaml.org/t/how-to-combine-3-monads-async-lwt-error-and-state/8906/9</a>
</p>
</div>

<div id="outline-container-orgc983fe0" class="outline-3">
<h3 id="orgc983fe0">Deep in this thread, Ivan Gotovchits said</h3>
<div class="outline-text-3" id="text-orgc983fe0">
<p>
The monads library provides the transformers for some well-known monads. All these monads have a more or less
standard implementation, offering the same performance as any other monadic library can offer. Like there is no
better way of implementing the state monad other than a function. We have experimented a lot with different
performance optimizations, such as boxing and unboxing it and inlining various operators, and keep experimenting to
get the maximum from the current compiler. In BAP, we heavily use the monads library, first of all for our <a href="https://binaryanalysisplatform.github.io/bap/api/master/bap-knowledge/Bap_knowledge/Knowledge/index.html">knowledge
representation and reasoning engine</a>, which is the foundation for all BAP analyses. We also use it for <a href="https://binaryanalysisplatform.github.io/bap/api/master/bap-primus/Bap_primus/Std/index.html">emulating
binary programs</a>.  The rich interface is here to make our life easier and more comfortable when we use monads. It
definitely comes for free¹ as the number of functions doesn't affect the performance of the underlying
monad.
</p>

<p>
But&#x2026; there is always a but :) Stacking monads using a transformer does have a price. Even with the flambda
compiler. The latter is doing an excellent job of unstacking them and eliminating the overhead of having a chain of
monads. But our latest experiments show that a custom-made monad (still with the monads library) performs better
under either branch of the compiler. We <a href="https://github.com/BinaryAnalysisPlatform/bap/pull/1361">have rewritten our main monads</a> that were relying on transformers and got
from 20% to 50% performance improvement. But that is not to say that the monads library itself is slow or that we're
not using it, it is to say that there are other options to transformers that might work in some cases.  See the
linked PR if you want to learn the trick.
</p>

<p>
¹⁾ Provided that we ignore the size of the executable, e.g., linking the core_kernel library results in a
quite large binary, which may increase the startup time. Insignificantly, but in some use cases, it might be a
significant factor.
</p>
</div>
</div>


<div id="outline-container-org16dd28f" class="outline-3">
<h3 id="org16dd28f">Ivan Gotovchits then said</h3>
<div class="outline-text-3" id="text-org16dd28f">
<p>
As it was already suggested, you can use <a href="https://en.wikipedia.org/wiki/Monad_transformer">monad transformers</a>, to compose several monads into a single monad. As a
show-case, we will use the <a href="https://binaryanalysisplatform.github.io/bap/api/master/monads/Monads/Std/index.html">monads</a> library (disclaimer, I am an author of this library), which you can install
with
</p>

<pre class="example" id="orgc036967">
opam install monads
</pre>

<p>
It offers most of the well-known monads in a form of a monad transformer, which in terms of OCaml, is a functor that
takes a monad and returns a new monad that enriches it with some new behavior. For example, to make a
non-deterministic error monad, we can do <code>Monad.List.Make(Monad.Result.Error)</code> and get a monadic structure (i.e., a
module that implements the <a href="https://binaryanalysisplatform.github.io/bap/api/master/monads/Monads/Std/Monad/index.html">Monad.S</a> interface) that is both a list monad and an error monad.  The small caveat is
that the operations of the wrapped monad,  the error monad in our case, are not available directly, so we have to
<span class="underline">lift</span> them, e.g.,
</p>
<div class="org-src-container">
<pre class="src src-ocaml"><span style="color: #000000; font-weight: bold;">let</span> <span style="color: #0000ff;">fail</span> <span style="color: #a0522d;">p</span> = lift <span style="color: #a52a2a;">@@</span> <span style="color: #228b22;">Monad.Result.Error.</span>fail p
</pre>
</div>
<p>
So that in the end, the full implementation of the transformed monad still requires some boilerplate code,
</p>

<div class="org-src-container">
<pre class="src src-ocaml"><span style="color: #000000; font-weight: bold;">module</span> <span style="color: #228b22;">ListE</span> = <span style="color: #000000; font-weight: bold;">struct</span>
  <span style="color: #000000; font-weight: bold;">type</span> <span style="color: #228b22;">'a t</span> = 'a list <span style="color: #228b22;">Monad.Result.Error.</span>t
  <span style="color: #000000; font-weight: bold;">include</span> <span style="color: #228b22;">Monad.List.Make(Monad.Result.Error)</span>
  <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #0000ff;">fail</span> <span style="color: #a0522d;">p</span> = lift<span style="color: #a52a2a;">@@</span><span style="color: #228b22;">Monad.Result.Error.</span>fail p
  <span style="color: #b22222;">(* </span><span style="color: #b22222;">and so on for each operation that is specific to the wrapped monad </span><span style="color: #b22222;">*)</span>
<span style="color: #000000; font-weight: bold;">end</span>
</pre>
</div>

<p>
Now, let's try wrapping the Lwt monad into the state. We don't want to add the Error monad because Lwt is already the
error monad and adding an extra layer of errors monad is not what we want. First of all, we need to adapt the <code>Lwt</code>
monad to the <code>Monad.S</code> interface, e.g.,
</p>
<div class="org-src-container">
<pre class="src src-ocaml"><span style="color: #000000; font-weight: bold;">module</span> <span style="color: #228b22;">LwtM</span> = <span style="color: #000000; font-weight: bold;">struct</span>
  <span style="color: #000000; font-weight: bold;">type</span> <span style="color: #228b22;">'a t</span> = 'a <span style="color: #228b22;">Lwt.</span>t
  <span style="color: #000000; font-weight: bold;">include</span> <span style="color: #228b22;">Monad.Make</span>(<span style="color: #000000; font-weight: bold;">struct</span>
      <span style="color: #000000; font-weight: bold;">type</span> <span style="color: #228b22;">'a t</span> = 'a <span style="color: #228b22;">Lwt.</span>t
      <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #a0522d;">return</span> = <span style="color: #228b22;">Lwt.</span>return
      <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #a0522d;">bind</span> = <span style="color: #228b22;">Lwt.</span>bind
      <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #0000ff;">map</span> <span style="color: #a0522d;">x</span> ~<span style="color: #a0522d;">f</span> = <span style="color: #228b22;">Lwt.</span>map f x
      <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #a0522d;">map</span> = <span style="color: #000000; background-color: #ffffff;">`Custom</span> map
    <span style="color: #000000; font-weight: bold;">end</span>)
<span style="color: #000000; font-weight: bold;">end</span>
</pre>
</div>

<p>
If we want to keep the state type monomorphic, then we will need a module for it. Suppose your state is represented
as,
</p>
<div class="org-src-container">
<pre class="src src-ocaml"><span style="color: #000000; font-weight: bold;">module</span> <span style="color: #228b22;">State</span> = <span style="color: #000000; font-weight: bold;">struct</span>
  <span style="color: #000000; font-weight: bold;">type</span> <span style="color: #228b22;">t</span> = string <span style="color: #228b22;">Map.</span><span style="color: #000000; background-color: #ffffff;">M</span>(<span style="color: #000000; background-color: #ffffff;">String</span>).t
<span style="color: #000000; font-weight: bold;">end</span>
</pre>
</div>

<p>
Now, we can use it to build our <code>State(Lwt)</code> Russian doll,
</p>
<div class="org-src-container">
<pre class="src src-ocaml"><span style="color: #000000; font-weight: bold;">module</span> <span style="color: #228b22;">IO</span> = <span style="color: #000000; font-weight: bold;">struct</span>
  <span style="color: #000000; font-weight: bold;">include</span> <span style="color: #228b22;">Monad.State.T1(State)(LwtM)</span>
  <span style="color: #000000; font-weight: bold;">include</span> <span style="color: #228b22;">Monad.State.Make(State)(LwtM)</span>

  <span style="color: #b22222;">(* </span><span style="color: #b22222;">let's lift [read] as an example </span><span style="color: #b22222;">*)</span>
  <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #0000ff;">read</span> <span style="color: #a0522d;">fd</span> <span style="color: #a0522d;">buf</span> <span style="color: #a0522d;">ofs</span> <span style="color: #a0522d;">len</span> =
    lift (<span style="color: #228b22;">Lwt_unix.</span>read fd buf ofs len)
<span style="color: #000000; font-weight: bold;">end</span>
</pre>
</div>

<p>
The <code>Monad.State.T1</code> functor is used to create the types for the generated monad. You can write them manually, of
course, like as we did in the List(Error) example, but the type generating modules are here for the
convenience¹
</p>

<p>
Now, let's get back to the problem of the lifting. It looks tedious to impossible to lift every operation from Lwt.
Commonly, we try to put the smaller monad inside, to minimize the work, but it doesn't work with Lwt as the latter is
not a transformer. So what is the solution? For me, the solution is to not lift the operations at all, but instead,
define your IO abstraction and hide that it is using Lwt underneath the hood. This will make the code that uses this
new abstraction more generic and less error-prone so that it can focus on the business logic and the implementation
details could be hidden inside the monad implementation. This is what the monads are for, anyway.
</p>

<p>
¹⁾ We omit the types from the output of the <code>Make</code> functor since for a long time OCaml didn't allow the
repetition of types in a structure so having the types in it will prevent us from composing various flavors of monads
using <code>include</code>. It is also a long-time convention widely used in many OCaml libraries, including Core and Async. A
convention that we probably don't need anymore.
</p>
</div>
</div>
</div>




<div id="outline-container-org572034b" class="outline-2">
<h2 id="org572034b">Old CWN</h2>
<div class="outline-text-2" id="text-org572034b">
<p>
If you happen to miss a CWN, you can <a href="mailto:alan.schmitt@polytechnique.org">send me a message</a> and I'll mail it to you, or go take a look at <a href="https://alan.petitepomme.net/cwn/">the archive</a> or the <a href="https://alan.petitepomme.net/cwn/cwn.rss">RSS feed of the archives</a>.
</p>

<p>
If you also wish to receive it every week by mail, you may subscribe <a href="http://lists.idyll.org/listinfo/caml-news-weekly/">online</a>.
</p>

<div class="authorname" id="org46351f9">
<p>
<a href="https://alan.petitepomme.net/">Alan Schmitt</a>
</p>

</div>
</div>
</div>
</div>
</body>
</html>
