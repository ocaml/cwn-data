<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<!-- 2021-05-18 Tue 18:08 -->
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>OCaml Weekly News</title>
<meta name="generator" content="Org mode" />
<style type="text/css">
 <!--/*--><![CDATA[/*><!--*/
  .title  { text-align: center;
             margin-bottom: .2em; }
  .subtitle { text-align: center;
              font-size: medium;
              font-weight: bold;
              margin-top:0; }
  .todo   { font-family: monospace; color: red; }
  .done   { font-family: monospace; color: green; }
  .priority { font-family: monospace; color: orange; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .org-right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .org-left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .org-center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #ccc;
    box-shadow: 3px 3px 3px #eee;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: auto;
    padding-top: 1.2em;
  }
  pre.src:before {
    display: none;
    position: absolute;
    background-color: white;
    top: -10px;
    right: 10px;
    padding: 3px;
    border: 1px solid black;
  }
  pre.src:hover:before { display: inline; margin-top: 14px;}
  /* Languages per Org manual */
  pre.src-asymptote:before { content: 'Asymptote'; }
  pre.src-awk:before { content: 'Awk'; }
  pre.src-C:before { content: 'C'; }
  /* pre.src-C++ doesn't work in CSS */
  pre.src-clojure:before { content: 'Clojure'; }
  pre.src-css:before { content: 'CSS'; }
  pre.src-D:before { content: 'D'; }
  pre.src-ditaa:before { content: 'ditaa'; }
  pre.src-dot:before { content: 'Graphviz'; }
  pre.src-calc:before { content: 'Emacs Calc'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-fortran:before { content: 'Fortran'; }
  pre.src-gnuplot:before { content: 'gnuplot'; }
  pre.src-haskell:before { content: 'Haskell'; }
  pre.src-hledger:before { content: 'hledger'; }
  pre.src-java:before { content: 'Java'; }
  pre.src-js:before { content: 'Javascript'; }
  pre.src-latex:before { content: 'LaTeX'; }
  pre.src-ledger:before { content: 'Ledger'; }
  pre.src-lisp:before { content: 'Lisp'; }
  pre.src-lilypond:before { content: 'Lilypond'; }
  pre.src-lua:before { content: 'Lua'; }
  pre.src-matlab:before { content: 'MATLAB'; }
  pre.src-mscgen:before { content: 'Mscgen'; }
  pre.src-ocaml:before { content: 'Objective Caml'; }
  pre.src-octave:before { content: 'Octave'; }
  pre.src-org:before { content: 'Org mode'; }
  pre.src-oz:before { content: 'OZ'; }
  pre.src-plantuml:before { content: 'Plantuml'; }
  pre.src-processing:before { content: 'Processing.js'; }
  pre.src-python:before { content: 'Python'; }
  pre.src-R:before { content: 'R'; }
  pre.src-ruby:before { content: 'Ruby'; }
  pre.src-sass:before { content: 'Sass'; }
  pre.src-scheme:before { content: 'Scheme'; }
  pre.src-screen:before { content: 'Gnu Screen'; }
  pre.src-sed:before { content: 'Sed'; }
  pre.src-sh:before { content: 'shell'; }
  pre.src-sql:before { content: 'SQL'; }
  pre.src-sqlite:before { content: 'SQLite'; }
  /* additional languages in org.el's org-babel-load-languages alist */
  pre.src-forth:before { content: 'Forth'; }
  pre.src-io:before { content: 'IO'; }
  pre.src-J:before { content: 'J'; }
  pre.src-makefile:before { content: 'Makefile'; }
  pre.src-maxima:before { content: 'Maxima'; }
  pre.src-perl:before { content: 'Perl'; }
  pre.src-picolisp:before { content: 'Pico Lisp'; }
  pre.src-scala:before { content: 'Scala'; }
  pre.src-shell:before { content: 'Shell Script'; }
  pre.src-ebnf2ps:before { content: 'ebfn2ps'; }
  /* additional language identifiers per "defun org-babel-execute"
       in ob-*.el */
  pre.src-cpp:before  { content: 'C++'; }
  pre.src-abc:before  { content: 'ABC'; }
  pre.src-coq:before  { content: 'Coq'; }
  pre.src-groovy:before  { content: 'Groovy'; }
  /* additional language identifiers from org-babel-shell-names in
     ob-shell.el: ob-shell is the only babel language using a lambda to put
     the execution function name together. */
  pre.src-bash:before  { content: 'bash'; }
  pre.src-csh:before  { content: 'csh'; }
  pre.src-ash:before  { content: 'ash'; }
  pre.src-dash:before  { content: 'dash'; }
  pre.src-ksh:before  { content: 'ksh'; }
  pre.src-mksh:before  { content: 'mksh'; }
  pre.src-posh:before  { content: 'posh'; }
  /* Additional Emacs modes also supported by the LaTeX listings package */
  pre.src-ada:before { content: 'Ada'; }
  pre.src-asm:before { content: 'Assembler'; }
  pre.src-caml:before { content: 'Caml'; }
  pre.src-delphi:before { content: 'Delphi'; }
  pre.src-html:before { content: 'HTML'; }
  pre.src-idl:before { content: 'IDL'; }
  pre.src-mercury:before { content: 'Mercury'; }
  pre.src-metapost:before { content: 'MetaPost'; }
  pre.src-modula-2:before { content: 'Modula-2'; }
  pre.src-pascal:before { content: 'Pascal'; }
  pre.src-ps:before { content: 'PostScript'; }
  pre.src-prolog:before { content: 'Prolog'; }
  pre.src-simula:before { content: 'Simula'; }
  pre.src-tcl:before { content: 'tcl'; }
  pre.src-tex:before { content: 'TeX'; }
  pre.src-plain-tex:before { content: 'Plain TeX'; }
  pre.src-verilog:before { content: 'Verilog'; }
  pre.src-vhdl:before { content: 'VHDL'; }
  pre.src-xml:before { content: 'XML'; }
  pre.src-nxml:before { content: 'XML'; }
  /* add a generic configuration mode; LaTeX export needs an additional
     (add-to-list 'org-latex-listings-langs '(conf " ")) in .emacs */
  pre.src-conf:before { content: 'Configuration File'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.org-right  { text-align: center;  }
  th.org-left   { text-align: center;   }
  th.org-center { text-align: center; }
  td.org-right  { text-align: right;  }
  td.org-left   { text-align: left;   }
  td.org-center { text-align: center; }
  dt { font-weight: bold; }
  .footpara { display: inline; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .equation-container {
    display: table;
    text-align: center;
    width: 100%;
  }
  .equation {
    vertical-align: middle;
  }
  .equation-label {
    display: table-cell;
    text-align: right;
    vertical-align: middle;
  }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  .org-svg { width: 90%; }
  /*]]>*/-->
</style>
<style type="text/css">#table-of-contents h2 { display: none } .title { display: none } .authorname { text-align: right }</style>
<style type="text/css">.outline-2 {border-top: 1px solid black;}</style>
<script type="text/javascript">
// @license magnet:?xt=urn:btih:e95b018ef3580986a04669f1b5879592219e2a7a&dn=public-domain.txt Public Domain
<!--/*--><![CDATA[/*><!--*/
     function CodeHighlightOn(elem, id)
     {
       var target = document.getElementById(id);
       if(null != target) {
         elem.classList.add("code-highlighted");
         target.classList.add("code-highlighted");
       }
     }
     function CodeHighlightOff(elem, id)
     {
       var target = document.getElementById(id);
       if(null != target) {
         elem.classList.remove("code-highlighted");
         target.classList.remove("code-highlighted");
       }
     }
    /*]]>*///-->
// @license-end
</script>
</head>
<body>
<div id="content">
<h1 class="title">OCaml Weekly News</h1>
<p>
<a href="https://alan.petitepomme.net/cwn/2021.05.11.html">Previous Week</a> <a href="https://alan.petitepomme.net/cwn/index.html">Up</a> <a href="https://alan.petitepomme.net/cwn/2021.05.25.html">Next Week</a>
</p>

<p>
Hello
</p>

<p>
Here is the latest OCaml Weekly News, for the week of May 11 to 18, 2021.
</p>

<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#1">The shape design problem</a></li>
<li><a href="#2">Set up OCaml 1.1.11</a></li>
<li><a href="#3">Wtr (Well Typed Router) v1.0.0 release</a></li>
<li><a href="#4">OCaml compiler development newsletter, issue 1: before May 2021</a></li>
<li><a href="#5">Multicore OCaml: April 2021</a></li>
<li><a href="#6">Analyzing contributions to the OCaml compiler and all opam packages</a></li>
<li><a href="#7">Timedesc 0.1.0</a></li>
<li><a href="#8">vec 0.2.0</a></li>
<li><a href="#orgf51badf">Old CWN</a></li>
</ul>
</div>
</div>


<div id="outline-container-1" class="outline-2">
<h2 id="1">The shape design problem</h2>
<div class="outline-text-2" id="text-1">
<p>
Archive: <a href="https://discuss.ocaml.org/t/the-shape-design-problem/7810/39">https://discuss.ocaml.org/t/the-shape-design-problem/7810/39</a>
</p>
</div>

<div id="outline-container-orgc6d79de" class="outline-3">
<h3 id="orgc6d79de">Ivan Gotovchits explained</h3>
<div class="outline-text-3" id="text-orgc6d79de">
<p>
<i>Editor note: This thread contains too many messages to be summarized here. I chose one to give an example, I recommand you read <a href="https://discuss.ocaml.org/t/the-shape-design-problem/7810">the whole thread</a> if the topic is of interest to you.</i>
</p>

<p>
For programming in small, I will use plain old algebraic data types. For public libraries and large programs designed
for change, I will use the <a href="https://en.wikipedia.org/wiki/Dependency_inversion_principle">dependency inversion principle</a> and make sure that my high-level policy code (e.g.,
drawing facilities) doesn't depend on the low-level implementation details.
</p>
</div>

<div id="outline-container-orge1c2adb" class="outline-4">
<h4 id="orge1c2adb">Large vs. Small</h4>
<div class="outline-text-4" id="text-orge1c2adb">
<p>
First of all, let's define what is programming in large and what is in small. The truth is that there is no definite
answer, you have to develop some taste to understand where you should just stick with plain ADT (PADT) or where to
unpack the heavy artillery of GADT and final tagless styles. There is, however, a rule of thumb that I have developed
and which might be useful to you as well.
</p>
</div>

<div id="outline-container-orgc2ad3c9" class="outline-5">
<h5 id="orgc2ad3c9"><span class="underline">ADT is the detail of implementation</span></h5>
<div class="outline-text-5" id="text-orgc2ad3c9">
<p>
ADT shall never go into the public interface. Both PADT and GADT are details of implementation and should be hidden
inside the module and never reach the mli file, at least the mli of a publically available code (i.e., a library that
you plan to distribute and for which you install cmi/mli files). Exposing your data definitions is much like showing
your public member values in C++ or Java.
</p>

<p>
The less the extent of an ADT in your codebase the easier it will be to maintain it. Indeed, notice even how hard and
ugly it is to work in OCaml with ADT defined in other modules. So even the language resists this. And if the language
resists then don't force it.
</p>

<p>
With that said, 90% of your code should be small code with data types defined for the extent of a compilation unit,
which, in general, should be less than 300-500 lines of code (ideally start with 100) and have a couple of internal
modules. Basically, a compilation unit should have a size that easily fits into short-term memory.
</p>

<p>
Since programming in small is more or less clearly let's move forward.
</p>
</div>
</div>
</div>

<div id="outline-container-org7bafa92" class="outline-4">
<h4 id="org7bafa92">Programming In Large</h4>
<div class="outline-text-4" id="text-org7bafa92">
<p>
So you're designing a large project, possibly with API, that will help lots of developers with different backgrounds
and skills. And as always it should be delivered next week, well at least the minimal viable product. The upper
management is stressing you but you still don't want to mess things up and be cursed by the generations of software
developers that will use your product.
</p>

<p>
One of the killer features of OCaml, and the main reason why I have switched to it a long time ago and use it since
then, is that it ideally fits the above-described use case. It fully supports the programming in large style (like
Java and Ada) but enables at the same easy prototyping and delivering MVPs the next day your manager asks (like
Python). And if you have young students in your team, their enthusiasm will not leave the boundaries of the module
abstraction. And if you are the manager you have excellent language (the language of mli files) that you can use to
convey your design ideas to other team members and even to non-technical personal.
</p>

<p>
So let's do some prototyping and design, using the language of signatures. First of all, we shall decide which type
should be designed for change and which should be regular data types. E.g., we probably don't want to have a string
data type with pluggable implementation. But we definitely know that our figures will change and more will be added,
possibly by 3rd-party developers.
</p>

<p>
We finally decide that Point and Canvas will be the regular types (for Canvas we might regret our design decision).
For prototyping, we will write the module type of our project. At the same time, we should also write documentation
for each module and its items (functions, types, classes, etc). Writing documentation is an important design
procedure. If you can't describe in plain English what a module is doing then probably it is a wrong abstraction. But
now, for the sake of brevity and lack of time we will skip this important step and unroll the whole design right
away.
</p>

<div class="org-src-container">
<pre class="src src-ocaml"><span style="color: #000000; font-weight: bold;">module type</span> <span style="color: #228b22;">Project</span> = <span style="color: #000000; font-weight: bold;">sig</span>

  <span style="color: #000000; font-weight: bold;">module</span> <span style="color: #228b22;">Point</span> : <span style="color: #000000; font-weight: bold;">sig</span>
    <span style="color: #000000; font-weight: bold;">type</span> <span style="color: #228b22;">t</span>
    <span style="color: #000000; font-weight: bold;">val</span> <span style="color: #0000ff;">create</span> : int -&gt; int -&gt; t
    <span style="color: #000000; font-weight: bold;">val</span> <span style="color: #0000ff;">x</span> : t -&gt; int
    <span style="color: #000000; font-weight: bold;">val</span> <span style="color: #0000ff;">y</span> : t -&gt; int
    <span style="color: #000000; font-weight: bold;">val</span> <span style="color: #0000ff;">show</span> : t -&gt; string
  <span style="color: #000000; font-weight: bold;">end</span>

  <span style="color: #000000; font-weight: bold;">module</span> <span style="color: #228b22;">Canvas</span> : <span style="color: #000000; font-weight: bold;">sig</span>
    <span style="color: #000000; font-weight: bold;">type</span> <span style="color: #228b22;">t</span>
    <span style="color: #000000; font-weight: bold;">val</span> <span style="color: #0000ff;">empty</span> : t
    <span style="color: #000000; font-weight: bold;">val</span> <span style="color: #0000ff;">text</span> : t -&gt; <span style="color: #228b22;">Point.</span>t -&gt; string -&gt; unit
  <span style="color: #000000; font-weight: bold;">end</span>

  <span style="color: #000000; font-weight: bold;">module</span> <span style="color: #228b22;">Widget</span> : <span style="color: #000000; font-weight: bold;">sig</span>
    <span style="color: #000000; font-weight: bold;">type</span> <span style="color: #228b22;">t</span>
    <span style="color: #000000; font-weight: bold;">val</span> <span style="color: #0000ff;">create</span> : ('a -&gt; <span style="color: #228b22;">Canvas.</span>t -&gt; unit) -&gt; 'a -&gt; t
    <span style="color: #000000; font-weight: bold;">val</span> <span style="color: #0000ff;">draw</span> : t -&gt; <span style="color: #228b22;">Canvas.</span>t -&gt; unit
  <span style="color: #000000; font-weight: bold;">end</span>

  <span style="color: #000000; font-weight: bold;">module type</span> <span style="color: #228b22;">Figure</span> = <span style="color: #000000; font-weight: bold;">sig</span>
    <span style="color: #000000; font-weight: bold;">type</span> <span style="color: #228b22;">t</span>
    <span style="color: #000000; font-weight: bold;">val</span> <span style="color: #0000ff;">widget</span> : t -&gt; <span style="color: #228b22;">Widget.</span>t
  <span style="color: #000000; font-weight: bold;">end</span>

  <span style="color: #000000; font-weight: bold;">module</span> <span style="color: #228b22;">Rectangle</span> : <span style="color: #000000; font-weight: bold;">sig</span>
    <span style="color: #000000; font-weight: bold;">include</span> <span style="color: #228b22;">Figure</span>
    <span style="color: #000000; font-weight: bold;">val</span> <span style="color: #0000ff;">create</span> : <span style="color: #228b22;">Point.</span>t -&gt; <span style="color: #228b22;">Point.</span>t -&gt; t
  <span style="color: #000000; font-weight: bold;">end</span>

  <span style="color: #000000; font-weight: bold;">module</span> <span style="color: #228b22;">Circle</span> : <span style="color: #000000; font-weight: bold;">sig</span>
    <span style="color: #000000; font-weight: bold;">include</span> <span style="color: #228b22;">Figure</span>
    <span style="color: #000000; font-weight: bold;">val</span> <span style="color: #0000ff;">create</span> : <span style="color: #228b22;">Point.</span>t -&gt; int -&gt; t
  <span style="color: #000000; font-weight: bold;">end</span>
<span style="color: #000000; font-weight: bold;">end</span>
</pre>
</div>

<p>
Let's discuss it a bit. The <code>Canvas</code> and <code>Point</code> types are pretty obvious, in fact this design just assumes that they
are already provided by the third-party libraries, so that we can focus on our figures.
</p>

<p>
Now the <code>Widget</code> types. Following the dependency inversion principle, we decided to make our rendering layer
independent of the particular implementation of the things that will populate it. Therefore we created an abstraction
of a drawable entity with a rather weak definition of the abstraction, i.e., a drawable is anything that implements
<code>('a -&gt; Canvas.t -&gt; unit)</code> method. We will later muse on how we will extend this abstraction without breaking good
relationships with colleagues.
</p>

<p>
Another point of view on Widget is that it defines a Drawable type class and that <code>Widget.create</code> is defining an
instance of that class, so we could even choose a different naming for that, e.g.,
</p>

<div class="org-src-container">
<pre class="src src-ocaml"><span style="color: #000000; font-weight: bold;">module</span> <span style="color: #228b22;">Draw</span> : <span style="color: #000000; font-weight: bold;">sig</span>
  <span style="color: #000000; font-weight: bold;">type</span> <span style="color: #228b22;">t</span>
  <span style="color: #000000; font-weight: bold;">val</span> <span style="color: #0000ff;">instance</span> : ('a -&gt; <span style="color: #228b22;">Canvas.</span>t -&gt; unit) -&gt; 'a -&gt; t
  <span style="color: #000000; font-weight: bold;">val</span> <span style="color: #0000ff;">render</span> : t -&gt; <span style="color: #228b22;">Canvas.</span>t -&gt; unit
<span style="color: #000000; font-weight: bold;">end</span>
</pre>
</div>

<p>
The particular choice depends on the mindset of your team, but I bet that the <code>Widget</code> abstraction would fit better
more people.
</p>

<p>
But let's go back to our figures. So far we only decided that a figure is any type <code>t</code> that defines <code>val widget : t -&gt; Widget.t</code>. We can view this from the type classes standpoint as that the figure class is an instance of the widget
class. Or we can invoke Curry-Howard isomorphism and notice that <code>val widget : t -&gt; Widget.t</code> is a theorem that
states that every figure is a widget.
</p>

<p>
The next should be trivial with this signatures, so let's move forward and develop MVP,
</p>
<div class="org-src-container">
<pre class="src src-ocaml"><span style="color: #000000; font-weight: bold;">module</span> <span style="color: #228b22;">Prototype</span> : <span style="color: #228b22;">Project</span> = <span style="color: #000000; font-weight: bold;">struct</span>

  <span style="color: #000000; font-weight: bold;">module</span> <span style="color: #228b22;">Point</span> = <span style="color: #000000; font-weight: bold;">struct</span>
    <span style="color: #000000; font-weight: bold;">type</span> <span style="color: #228b22;">t</span> = {x : int; y : int}
    <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #0000ff;">create</span> <span style="color: #a0522d;">x</span> <span style="color: #a0522d;">y</span> = {x; y}
    <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #0000ff;">x</span> {<span style="color: #a0522d;">x</span>} = x
    <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #0000ff;">y</span> {<span style="color: #a0522d;">y</span>} = y
    <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #0000ff;">show</span> {<span style="color: #a0522d;">x</span>; <span style="color: #a0522d;">y</span>} = <span style="color: #8b2252;">"("</span> <span style="color: #a52a2a;">^</span> string_of_int x <span style="color: #a52a2a;">^</span> <span style="color: #8b2252;">", "</span> <span style="color: #a52a2a;">^</span> string_of_int y <span style="color: #a52a2a;">^</span> <span style="color: #8b2252;">")"</span>
  <span style="color: #000000; font-weight: bold;">end</span>

  <span style="color: #000000; font-weight: bold;">module</span> <span style="color: #228b22;">Canvas</span> = <span style="color: #000000; font-weight: bold;">struct</span>
    <span style="color: #000000; font-weight: bold;">type</span> <span style="color: #228b22;">t</span> = unit
    <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #a0522d;">empty</span> = ()
    <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #0000ff;">text</span> <span style="color: #a0522d;">_canvas</span> <span style="color: #a0522d;">_position</span> = print_endline
  <span style="color: #000000; font-weight: bold;">end</span>

  <span style="color: #000000; font-weight: bold;">module</span> <span style="color: #228b22;">Widget</span> = <span style="color: #000000; font-weight: bold;">struct</span>
    <span style="color: #000000; font-weight: bold;">type</span> <span style="color: #228b22;">t</span> = <span style="color: #000000; background-color: #ffffff;">Widget</span> : {
        draw : 'obj -&gt; <span style="color: #228b22;">Canvas.</span>t -&gt; unit;
        self : 'obj;
      } -&gt; t

    <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #0000ff;">create</span> <span style="color: #a0522d;">draw</span> <span style="color: #a0522d;">self</span> = <span style="color: #000000; background-color: #ffffff;">Widget</span> {self; draw}
    <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #0000ff;">draw</span> (<span style="color: #000000; background-color: #ffffff;">Widget</span> {<span style="color: #a0522d;">draw</span>; <span style="color: #a0522d;">self</span>}) <span style="color: #a0522d;">canvas</span> = draw self canvas
  <span style="color: #000000; font-weight: bold;">end</span>

  <span style="color: #000000; font-weight: bold;">module type</span> <span style="color: #228b22;">Figure</span> = <span style="color: #000000; font-weight: bold;">sig</span>
    <span style="color: #000000; font-weight: bold;">type</span> <span style="color: #228b22;">t</span>
    <span style="color: #000000; font-weight: bold;">val</span> <span style="color: #0000ff;">widget</span> : t -&gt; <span style="color: #228b22;">Widget.</span>t
  <span style="color: #000000; font-weight: bold;">end</span>

  <span style="color: #000000; font-weight: bold;">module</span> <span style="color: #228b22;">Rectangle</span> = <span style="color: #000000; font-weight: bold;">struct</span>
    <span style="color: #000000; font-weight: bold;">type</span> <span style="color: #228b22;">t</span> = {ll : <span style="color: #228b22;">Point.</span>t; ur : <span style="color: #228b22;">Point.</span>t}
    <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #0000ff;">create</span> <span style="color: #a0522d;">ll</span> <span style="color: #a0522d;">ur</span> = {ll; ur}
    <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #a0522d;">widget</span> = <span style="color: #228b22;">Widget.</span>create <span style="color: #a52a2a;">@@</span> <span style="color: #a020f0;">fun</span> {<span style="color: #a0522d;">ll</span>} <span style="color: #a0522d;">canvas</span> -&gt;
      <span style="color: #228b22;">Canvas.</span>text canvas ll <span style="color: #8b2252;">"rectangle"</span>
  <span style="color: #000000; font-weight: bold;">end</span>

  <span style="color: #000000; font-weight: bold;">module</span> <span style="color: #228b22;">Circle</span> = <span style="color: #000000; font-weight: bold;">struct</span>
    <span style="color: #000000; font-weight: bold;">type</span> <span style="color: #228b22;">t</span> = {p : <span style="color: #228b22;">Point.</span>t; r : int}
    <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #0000ff;">create</span> <span style="color: #a0522d;">p</span> <span style="color: #a0522d;">r</span> = {p; r}
    <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #a0522d;">widget</span> = <span style="color: #228b22;">Widget.</span>create <span style="color: #a52a2a;">@@</span> <span style="color: #a020f0;">fun</span> {<span style="color: #a0522d;">p</span>; <span style="color: #a0522d;">r</span>} <span style="color: #a0522d;">canvas</span> -&gt;
        <span style="color: #228b22;">Canvas.</span>text canvas p <span style="color: #8b2252;">"circle"</span>
  <span style="color: #000000; font-weight: bold;">end</span>
<span style="color: #000000; font-weight: bold;">end</span>
</pre>
</div>

<p>
Et voila, we can show it to our boss and have some coffee. But let's look into the implementation details to learn
some new tricks. We decided to encode widget as an existential data type, no surprises here as <a href="https://homepages.inf.ed.ac.uk/gdp/publications/Abstract_existential.pdf">abstract types have
existential type</a> and our widget is an abstract type. What is existential you might ask (even after reading the
paper), well in OCaml it is a GADT that captures one or more type variables, e.g., here we have <code>'obj</code> type variable
that is not bound (quantified) on the type level, but is left hidden inside the type. You can think of existential as
closures on the type level.
</p>

<p>
This approach enables us to have widgets of any types and, moreover, develop widgets totally independently and even
load them as plugins without having to recompile our main project.
</p>

<p>
Of course, using GADT as encoding for abstract type is not the only choice. It even has its drawbacks, like we can't
serialize/deserialize them directly (though probably we shouldn't) it has some small overhead.
</p>

<p>
There are other options that are feasible. For example, for a widget type, it is quite logical to stick with the
featherweight design pattern and represent it as an integer, and store the table of methods in the external hash
table.
</p>

<p>
We might also need more than one method to implement the widget class, which we can pack as modules and store in the
existential or in an external hash table. Using module types enables us gradual upgrade of our interfaces and build
hierarchies of widgets if we need.
</p>

<p>
When we will develop more abstract types (type classes), like the <code>Geometry</code> class that will calculate area and
bounding rectangles for our figures, we might notice some commonalities in the implementation. We might even choose
to implement dynamic typing so that we can have the common representation for all abstract types and even type
casting operators, e.g., this is where we might end up several years later.
</p>

<div class="org-src-container">
<pre class="src src-ocaml"><span style="color: #000000; font-weight: bold;">module</span> <span style="color: #228b22;">Widget</span> : <span style="color: #000000; font-weight: bold;">sig</span>
  <span style="color: #000000; font-weight: bold;">type</span> <span style="color: #228b22;">'cls t</span>

  <span style="color: #000000; font-weight: bold;">module type</span> <span style="color: #228b22;">S</span> = <span style="color: #000000; font-weight: bold;">sig</span>
    <span style="color: #000000; font-weight: bold;">type</span> <span style="color: #228b22;">t</span>
    ...
  <span style="color: #000000; font-weight: bold;">end</span>

  <span style="color: #000000; font-weight: bold;">type</span> <span style="color: #228b22;">'a widget</span> = (<span style="color: #000000; font-weight: bold;">module</span> <span style="color: #228b22;">S</span> <span style="color: #000000; font-weight: bold;">with type</span> <span style="color: #228b22;">t</span> = 'a)

  <span style="color: #000000; font-weight: bold;">val</span> <span style="color: #0000ff;">create</span> : 'a widget -&gt; 'a -&gt; 'a cls t

  <span style="color: #000000; font-weight: bold;">val</span> <span style="color: #0000ff;">forget</span> : 'a t -&gt; unit t
  <span style="color: #000000; font-weight: bold;">val</span> <span style="color: #0000ff;">refine</span> : 'a <span style="color: #228b22;">Class.</span>t -&gt; unit t -&gt; 'a cls t option
  <span style="color: #000000; font-weight: bold;">val</span> <span style="color: #0000ff;">figure</span> : 'a t -&gt; 'a
<span style="color: #000000; font-weight: bold;">end</span>
</pre>
</div>

<p>
We're now using a module type to define the abstraction of widget, we probably even have a full hierarchy of module
types to give the widget implementors more freedom and to preserve backward compatibility and good relationships. We
also keep the original type in the widget so that we can recover it back using the <code>figure</code> function. yes, we
resisted this design decision, because it is in fact downcasting, but our clients insisted on it. And yes, we
implemented dynamic types, so that we can upcast all widgets to the base class <code>unit Widget.t</code> using <code>forget</code>, but we
can still recover the original type (downcast) with <code>refine</code>, which is, obviously, a non-total function.
</p>

<p>
In <a href="https://github.com/BinaryAnalysisPlatform/bap">BAP</a>, we ended up having all this features as we represent complex data types (machine instructions and
expressions). We represent instructions as lightweight integers with all related information stored in the knowledge
base. We use dynamic typing together with final tagless style to build our programs and ensure their well-formedness,
and we use our typeclass approach a lot, to enable serialization, inspection, and ordering (we use domains for all
our data type). You can read more about our <a href="https://binaryanalysisplatform.github.io/bap/api/master/bap-knowledge/Bap_knowledge/Knowledge/index.html">knowledge base</a> and even peek into the <a href="https://github.com/BinaryAnalysisPlatform/bap/blob/master/lib/knowledge/bap_knowledge.ml">implementation</a> of it. And
we have a large <a href="https://binaryanalysisplatform.github.io/bap/api/master/bap-core-theory/Bap_core_theory/index.html">library of signatures</a> that define our abstract types, such as semantics, values, and programs.
In the end, our design allows us to extend our abstractions without breaking backward compatibility and to add new
operations or new representations without even having to rebuild the library or the main executable. But this is a
completely different story that doesn't really fit into this post.
</p>
</div>
</div>

<div id="outline-container-orgb9c234d" class="outline-4">
<h4 id="orgb9c234d">Conclusions</h4>
<div class="outline-text-4" id="text-orgb9c234d">
<p>
We can easily see that we our design makes it easy to add new behaviors and even extend the existing one. It also
provisions for DRY as we can write generic algorithms for widgets that are totally independent of the underlying
implementation. We have a place to grow and an option to completely overhaul our inner representation without
breaking any existing code. For example, we can switch from a fat GADT representation of a widget to a featherweight
pattern and nobody will notice anything (except, hopefully) improved performance. With that said, I have to conclude
as it already took too much time. I am ready for the questions if you have any.
</p>
</div>
</div>
</div>
</div>




<div id="outline-container-2" class="outline-2">
<h2 id="2">Set up OCaml 1.1.11</h2>
<div class="outline-text-2" id="text-2">
<p>
Archive: <a href="https://discuss.ocaml.org/t/ann-set-up-ocaml-1-1-11/7843/1">https://discuss.ocaml.org/t/ann-set-up-ocaml-1-1-11/7843/1</a>
</p>
</div>

<div id="outline-container-org80f1959" class="outline-3">
<h3 id="org80f1959">Sora Morimoto announced</h3>
<div class="outline-text-3" id="text-org80f1959">
</div>
<div id="outline-container-orgeb4d1f0" class="outline-4">
<h4 id="orgeb4d1f0">Changed</h4>
<div class="outline-text-4" id="text-orgeb4d1f0">
<ul class="org-ul">
<li>Stop setting switch jobs variable on Windows (<code>OPAMJOBS</code> is sufficient).</li>
</ul>
</div>
</div>
</div>
</div>




<div id="outline-container-3" class="outline-2">
<h2 id="3">Wtr (Well Typed Router) v1.0.0 release</h2>
<div class="outline-text-2" id="text-3">
<p>
Archive: <a href="https://discuss.ocaml.org/t/ann-wtr-well-typed-router-v1-0-0-release/7844/1">https://discuss.ocaml.org/t/ann-wtr-well-typed-router-v1-0-0-release/7844/1</a>
</p>
</div>

<div id="outline-container-orgbcea2d8" class="outline-3">
<h3 id="orgbcea2d8">Bikal Lem announced</h3>
<div class="outline-text-3" id="text-orgbcea2d8">
<p>
On the recent occassion of the 25th birthday of OCaml, I am pleased to announce v1.0.0 release of <code>wtr</code> to opam. Wtr - Well Typed Router - is a library for routing uri path and query parameters in OCaml web applications.
</p>

<p>
A ppx - <code>wtr.ppx</code> is provided so that specifying uri routes is ergonomic and familiar. For e.g. to specify a uri path
<code>/home/about</code>, you would specify as such,
</p>
<div class="org-src-container">
<pre class="src src-ocaml">{<span style="color: #a52a2a;">%</span>wtr| /home/about |}
</pre>
</div>
<p>
You can see more full demos here:
</p>
<ul class="org-ul">
<li><a href="https://github.com/lemaetech/wtr/blob/main/examples/demo.ml">cli demo</a></li>
<li><a href="https://github.com/lemaetech/wtr/blob/main/examples/cohttp.ml">cohttp Demo</a></li>
</ul>

<p>
The router matching algorithm is based on the <b><b>trie</b></b> algorithm.
</p>

<ul class="org-ul">
<li><a href="https://github.com/lemaetech/wtr">Wtr</a></li>
<li><a href="https://github.com/lemaetech/wtr/blob/main/tests/user_guide.md">Wtr User guide</a></li>
<li><a href="https://lemaetech.co.uk/wtr/wtr/Wtr/index.html">Wtr API</a></li>
</ul>
</div>
</div>
</div>




<div id="outline-container-4" class="outline-2">
<h2 id="4">OCaml compiler development newsletter, issue 1: before May 2021</h2>
<div class="outline-text-2" id="text-4">
<p>
Archive: <a href="https://discuss.ocaml.org/t/ocaml-compiler-development-newsletter-issue-1-before-may-2021/7831/11">https://discuss.ocaml.org/t/ocaml-compiler-development-newsletter-issue-1-before-may-2021/7831/11</a>
</p>
</div>

<div id="outline-container-orgd43144f" class="outline-3">
<h3 id="orgd43144f">Continuing the thread from last week, gasche said</h3>
<div class="outline-text-3" id="text-orgd43144f">
<p>
For some reason @octachron's contribution to the newsletter got lost in my pipeline. So below it is.
</p>
</div>

<div id="outline-container-org37107b5" class="outline-4">
<h4 id="org37107b5">@octachron (Florian Angeletti)</h4>
<div class="outline-text-4" id="text-org37107b5">
<ul class="org-ul">
<li>With Sébastien, David, and Gabriel's help, I have finally merged the change needed to integrate odoc in our documentation pipeline. Currently, this is hidden behind a configuration switch (or specific Makefile's target). The user experience is still a bit rough, in particular it requires an trunk-updated version of odoc. Fortunately, the number of users right now is most probably of only one. My current plan is to see how well the maintenance goes during this release cycle before maybe switching to odoc for the 4.13.0 version of the manual.</li>
<li>I have been discussing with David about how much time and effort we should spend on testing the manual. (My opinion is that testing only the PR that alters the manual's source file is essentially fine.) David has been testing more thorough configuration however but that requires some more tuning to avoid sending scary emails to innocent passersby.</li>
</ul>
</div>
</div>
</div>
</div>




<div id="outline-container-5" class="outline-2">
<h2 id="5">Multicore OCaml: April 2021</h2>
<div class="outline-text-2" id="text-5">
<p>
Archive: <a href="https://discuss.ocaml.org/t/multicore-ocaml-april-2021/7849/1">https://discuss.ocaml.org/t/multicore-ocaml-april-2021/7849/1</a>
</p>
</div>

<div id="outline-container-orgd1c4274" class="outline-3">
<h3 id="orgd1c4274">Anil Madhavapeddy announced</h3>
<div class="outline-text-3" id="text-orgd1c4274">
<p>
<b>Multicore OCaml: April 2021</b>
</p>

<p>
Welcome to the April 2021 <a href="https://github.com/ocaml-multicore/ocaml-multicore">Multicore OCaml</a> monthly report! My
friends and colleagues on the project in India are going through a terrible second wave of the Covid pandemic, but
continue to work to deliver all the updates from the Multicore OCaml project. This month's update along with the
<a href="https://discuss.ocaml.org/tag/multicore-monthly">previous updates</a> have been compiled by myself, @kayceesrk and
@shakthimaan.
</p>
</div>

<div id="outline-container-org45299fc" class="outline-4">
<h4 id="org45299fc">Upstream OCaml 4.13 development</h4>
<div class="outline-text-4" id="text-org45299fc">
<p>
GC safepoints continues to be the focus of the OCaml 4.13 release development for multicore. While it might seem
quiet with only <a href="https://github.com/ocaml/ocaml/pull/10039">one PR</a> being worked on, you can also look at <a href="https://github.com/sadiqj/ocaml/pull/3">the
compiler fork</a> where an intrepid team of adventurous compiler backend hackers
have been refining the design.  You can also find more details of ongoing upstream work in the first <a href="https://discuss.ocaml.org/t/ocaml-compiler-development-newsletter-issue-1-before-may-2021/7831">core compiler
development
newsletter</a>.   To
quote @xavierleroy from there, "<i>it’s a nontrivial change involving a new static analysis and a number of tweaks in
every code emitter, but things are starting to look good here.</i>".
</p>
</div>
</div>

<div id="outline-container-org388ab03" class="outline-4">
<h4 id="org388ab03">Multicore OCaml trees</h4>
<div class="outline-text-4" id="text-org388ab03">
<p>
The switch to using OCaml 4.12 has now completed, and all of the development PRs are now working against that
version.  We've put a lot of focus into establishing whether or not Domain Local Allocation Buffers
(<a href="https://github.com/ocaml-multicore/ocaml-multicore/pull/508">ocaml-multicore#508</a>) should go into the initial 5.0
patches or not.
</p>

<p>
What are DLABs?  When testing multicore on larger core counts (up to 128), we observed that there was a lot of early
promotion of values from the minor GCs (which are per-domain). DLABs were introduced in order to encourage domains to
have more values that remained heap-local, and this <b>should</b> have increased our scalability.  But computers being
computers, we noticed the opposite effect &#x2013; although the number of early promotions dropped with DLABs active, the
overall performance was either flat or even lower!  We're still working on profiling to figure out the root cause &#x2013;
modern architectures have complex non-uniform and hierarchical memory and cache topologies that interact in
unexpected ways.  Stay tuned to next month's monthly about the decision, or follow
<a href="https://github.com/ocaml-multicore/ocaml-multicore/pull/508">ocaml-multicore#508</a> directly!
</p>
</div>
</div>

<div id="outline-container-org607d7bf" class="outline-4">
<h4 id="org607d7bf">The multicore ecosystem</h4>
<div class="outline-text-4" id="text-org607d7bf">
<p>
Aside from this, the test suite coverage for the Multicore OCaml project has had significant improvement, and we
continue to add more and more tests to the project.  Please do continue with your contribution of parallel
benchmarks. With respect to benchmarking, we have been able to build the Sandmark-2.0 benchmarks with the
<a href="https://github.com/ocurrent/current-bench">current-bench</a> continuous benchmarking framework, which provides a GitHub
frontend and PostgreSQL database to store the results.  Some other projects such as Dune have also started also using
current-bench, which is nice to see &#x2013; it would be great to establish it on the core OCaml project once it is a bit
more mature.
</p>

<p>
We are also rolling out a <a href="https://github.com/ocurrent/ocaml-multicore-ci">multicore-specific CI</a> that can do
differential testing against opam packages (for example, to help isolate if something is a multicore-specific failure
or a general compilation error on upstream OCaml).  We're <a href="https://multicore.ci.ocamllabs.io:8100/?org=ocaml-multicore">pushing this
live</a> at the moment, and it means that we are in a
position to begin accepting projects that might benefit from multicore.  <b>If you do have a project on opam that
would benefit from being tested with multicore OCaml, and if it compiles on 4.12, then please do get in touch</b>.
We're initially folding in codebases we're familiar with, but we need a diversity of sources to get good coverage.
The only thing we'll need is a responsive contact within the project that can work with us on the integration.  We'll
start reporting on project statuses if we get a good response to this call.
</p>

<p>
As always, we begin with the Multicore OCaml ongoing and completed tasks. This is followed by the Sandmark
benchmarking project updates and the relevant Multicore OCaml feature requests in the current-bench project. Finally,
upstream OCaml work is mentioned for your reference.
</p>
</div>
</div>

<div id="outline-container-org67f55ee" class="outline-4">
<h4 id="org67f55ee">Multicore OCaml</h4>
<div class="outline-text-4" id="text-org67f55ee">
</div>
<div id="outline-container-org847157e" class="outline-5">
<h5 id="org847157e">Ongoing</h5>
<div class="outline-text-5" id="text-org847157e">
</div>
<div id="outline-container-org8b096f7" class="outline-6">
<h6 id="org8b096f7">Testing</h6>
<div class="outline-text-6" id="text-org8b096f7">
<ul class="org-ul">
<li><p>
<a href="https://github.com/ocaml-multicore/domainslib/issues/23">ocaml-multicore/domainslib#23</a>
Running tests: moving to <code>dune runtest</code> from manual commands in <code>run_test</code> target
</p>

<p>
At present, the tests are executed with explicit exec commands in
the Makefile, and the objective is to move to using the <code>dune
  runtest</code> command.
</p></li>

<li><p>
<a href="https://github.com/ocaml-multicore/ocaml-multicore/issues/522">ocaml-multicore/ocaml-multicore#522</a>
Building the runtime with -O0 rather than -O2 causes testsuite to fail
</p>

<p>
The use of <code>-O0</code> optimization fails the runtime tests, while <code>-O2</code>
optimization succeeds. This needs to be investigated further.
</p></li>

<li><p>
<a href="https://github.com/ocaml-multicore/ocaml-multicore/issues/526">ocaml-multicore/ocaml-multicore#526</a>
weak-ephe-final issue468 can fail with really small minor heaps
</p>

<p>
The failure of issue468 test is currently being looked into for the
<code>weak-ephe-final</code> tests with a small minor heap (4096 words).
</p></li>

<li><p>
<a href="https://github.com/ocaml-multicore/ocaml-multicore/pull/528">ocaml-multicore/ocaml-multicore#528</a>
Expand CI runs
</p>

<p>
The PR implements parallel "callback" "gc-roots" "effects"
"lib-threads" "lib-systhreads" tests, with <code>taskset -c 0</code> option,
and using a small minor heap. The CI coverage needs to be enhanced
to add more variants and optimization flags.
</p></li>

<li><p>
<a href="https://github.com/ocaml-multicore/ocaml-multicore/pull/542">ocaml-multicore/ocaml-multicore#542</a>
Add ephemeron lazy test
</p>

<p>
Addition of tests to cover ephemerons, lazy values and domain
lifecycle with GC.
</p></li>

<li><p>
<a href="https://github.com/ocaml-multicore/ocaml-multicore/issues/545">ocaml-multicore/ocaml-multicore#545</a>
ephetest6 fails with more number of domains
</p>

<p>
The test <code>ephetest6.ml</code> fails when more number of domains are
spawned, and also deadlocks at times.
</p></li>

<li><p>
<a href="https://github.com/ocaml-multicore/ocaml-multicore/issues/547">ocaml-multicore/ocaml-multicore#547</a>
Investigate weaktest.ml failure
</p>

<p>
The <code>weaktest.ml</code> is disabled in the test suite and it is
failing. This needs to be investigated further.
</p></li>

<li><p>
<a href="https://github.com/ocaml-multicore/ocaml-multicore/issues/549">ocaml-multicore/ocaml-multicore#549</a>
zmq-lwt test failure
</p>

<p>
An opam-ci bug that has reported a failure in the <code>zmq-lwt</code> test. It
is throwing a Zmq.ZMQ_exception with a <code>Context was terminated</code>
error message.
</p></li>
</ul>
</div>
</div>

<div id="outline-container-org49b033e" class="outline-6">
<h6 id="org49b033e">Sundries</h6>
<div class="outline-text-6" id="text-org49b033e">
<ul class="org-ul">
<li><p>
<a href="https://github.com/ocaml-multicore/ocaml-multicore/pull/508">ocaml-multicore/ocaml-multicore#508</a>
Domain Local Allocation Buffers
</p>

<p>
The code review and the respective changes for the Domain Local
Allocation Buffer implementation is actively being worked upon.
</p></li>

<li><p>
<a href="https://github.com/ocaml-multicore/ocaml-multicore/pull/514">ocaml-multicore/ocaml-multicore#514</a>
Update instructions in ocaml-variants.opam
</p>

<p>
The <code>ocaml-variants.opam</code> and <code>configure.ac</code> have been updated to
now use the Multicore OCaml repository. We want different version
strings for <code>+domains</code> and <code>+domains+effects</code> for the branches.
</p></li>

<li><p>
<a href="https://github.com/ocaml-multicore/ocaml-multicore/pull/527">ocaml-multicore/ocaml-multicore#527</a>
Port eventlog to CTF
</p>

<p>
The code review on the porting of the <code>eventlog</code> implementation to
the Common Trace Format is in progress. The relevant code changes
have been made and the tests pass.
</p></li>

<li><p>
<a href="https://github.com/ocaml-multicore/ocaml-multicore/issues/529">ocaml-multicore/ocaml-multicore#529</a>
Fiber size control and statistics
</p>

<p>
A feature request to set the maximum stack size for fibers, and to
obtain memory statistics for the same.
</p></li>
</ul>
</div>
</div>
</div>

<div id="outline-container-orgd17c4a9" class="outline-5">
<h5 id="orgd17c4a9">Completed</h5>
<div class="outline-text-5" id="text-orgd17c4a9">
</div>
<div id="outline-container-orgd087309" class="outline-6">
<h6 id="orgd087309">Upstream</h6>
<div class="outline-text-6" id="text-orgd087309">
<ul class="org-ul">
<li><p>
<a href="https://github.com/ocaml-multicore/ocaml-multicore/pull/533">ocaml-multicore/ocaml-multicore#533</a>
Systhreads synchronization use pthread functions
</p>

<p>
The <code>pthread_*</code> functions are now used directly instead of
<code>caml_plat_*</code> functions to be in-line with OCaml trunk. The
<code>Sys_error</code> is raised now instead of <code>Fatal error</code>.
</p></li>

<li><p>
<a href="https://github.com/ocaml-multicore/ocaml-multicore/pull/535">ocaml-multicore/ocaml-multicore#535</a>
Remove Multicore stats collection
</p>

<p>
The configurable stats collection functionality is now removed from
Multicore OCaml. This greatly reduces the diff with trunk and makes
it easy for upstreaming.
</p></li>

<li><p>
<a href="https://github.com/ocaml-multicore/ocaml-multicore/pull/536">ocaml-multicore/ocaml-multicore#536</a>
Remove emit_block_header_for_closure
</p>

<p>
The <code>emit_block_header_for_closure</code> is no longer used and hence
removed from asmcomp sources.
</p></li>

<li><p>
<a href="https://github.com/ocaml-multicore/ocaml-multicore/pull/537">ocaml-multicore/ocaml-multicore#537</a>
Port @stedolan "Micro-optimise allocations on amd64 to save a register"
</p>

<p>
The upstream micro-optimise allocations on amd64 to save a register
have now been ported to Multicore OCaml. This greatly brings down
the diff on amd64's emit.mlp.
</p></li>
</ul>
</div>
</div>

<div id="outline-container-orgc3a476f" class="outline-6">
<h6 id="orgc3a476f">Enhancements</h6>
<div class="outline-text-6" id="text-orgc3a476f">
<ul class="org-ul">
<li><p>
<a href="https://github.com/ocaml-multicore/ocaml-multicore/pull/531">ocaml-multicore/ocaml-multicore#531</a>
Make native stack size limit configurable (and fix Gc.set)
</p>

<p>
The stack size limit for fibers in native made is now made
configurable through the <code>Gc.set</code> interface.
</p></li>

<li><p>
<a href="https://github.com/ocaml-multicore/ocaml-multicore/pull/534">ocaml-multicore/ocaml-multicore#534</a>
Move allocation size information to frame descriptors
</p>

<p>
The allocation size information is now propagated using the frame
descriptors so that they can be tracked by statmemprof.
</p></li>

<li><p>
<a href="https://github.com/ocaml-multicore/ocaml-multicore/pull/548">ocaml-multicore/ocaml-multicore#548</a>
Multicore implementation of Mutex, Condition and Semaphore
</p>

<p>
The <code>Mutex</code>, <code>Condition</code> and <code>Semaphore</code> modules are now fully
compatible with stdlib features and can be used with <code>Domain</code>.
</p></li>
</ul>
</div>
</div>
</div>

<div id="outline-container-orgb1b6ea1" class="outline-5">
<h5 id="orgb1b6ea1">Testing</h5>
<div class="outline-text-5" id="text-orgb1b6ea1">
<ul class="org-ul">
<li><p>
<a href="https://github.com/ocaml-multicore/ocaml-multicore/pull/532">ocaml-multicore/ocaml-multicore#532</a>
Addition of test for finaliser callback with major cycle
</p>

<p>
Update to <code>test_finaliser_gc.ml</code> code that adds a test wherein a
finaliser is run with a root in a register.
</p></li>

<li><p>
<a href="https://github.com/ocaml-multicore/ocaml-multicore/pull/541">ocaml-multicore/ocaml-multicore#541</a>
Addition of a parallel tak testcase
</p>

<p>
Parallel test cases to stress the minor heap and also enter the
minor GC organically without calling a <code>Gc</code> function or a domain
termination have now been added to the repository.
</p></li>

<li><p>
<a href="https://github.com/ocaml-multicore/ocaml-multicore/pull/543">ocaml-multicore/ocaml-multicore#543</a>
Parallel version of weaklifetime test
</p>

<p>
The parallel implementation of the <code>weaklifetime.ml</code> test has now
been added to the test suite, where the Weak structures are accessed
by multiple domains.
</p></li>

<li><p>
<a href="https://github.com/ocaml-multicore/ocaml-multicore/pull/546">ocaml-multicore/ocaml-multicore#546</a>
Coverage of domain life-cycle in domain_dls and ephetest_par tests
</p>

<p>
Improvement to <code>domain_dls.ml</code> and <code>ephetest_par.ml</code> for better
coverage for domain lifecycle testing.
</p></li>
</ul>
</div>

<div id="outline-container-org23106af" class="outline-6">
<h6 id="org23106af">Fixes</h6>
<div class="outline-text-6" id="text-org23106af">
<ul class="org-ul">
<li><p>
<a href="https://github.com/ocaml-multicore/ocaml-multicore/pull/530">ocaml-multicore/ocaml-multicore#530</a>
Fix off-by-1 with gc_regs buckets
</p>

<p>
An off-by-1 bug is now fixed when scanning the stack for the
location of the previous <code>gc_regs</code> bucket.
</p></li>

<li><p>
<a href="https://github.com/ocaml-multicore/ocaml-multicore/pull/540">ocaml-multicore/ocaml-multicore#540</a>
Fix small alloc retry
</p>

<p>
The <code>Alloc_small</code> macro was not handling the case when the GC
function does not return a minor heap with enough size, and this PR
fixes the same along with code clean-ups.
</p></li>
</ul>
</div>
</div>

<div id="outline-container-org6b2fd6e" class="outline-6">
<h6 id="org6b2fd6e">Ecosystem</h6>
<div class="outline-text-6" id="text-org6b2fd6e">
<ul class="org-ul">
<li><p>
<a href="https://github.com/ocaml-multicore/retro-httpaf-bench/pull/3">ocaml-multicore/retro-httpaf-bench#3</a>
Add cohttp-lwt-unix to the benchmark
</p>

<p>
A <code>cohttp-lwt-unix</code> benchmark is now added to the
<code>retro-httpaf-bench</code> package along with the update to the
Dockerfile.
</p></li>

<li><p>
<a href="https://github.com/ocaml-multicore/domainslib/pull/22">ocaml-multicore/domainslib#22</a>
Move the CI to 4.12 Multicore and Github Actions
</p>

<p>
The CI has been switched to using GitHub Actions instead of
Travis. The version of Multicore OCaml used in the CI is now
4.12+domains+effects.
</p></li>

<li><p>
<a href="https://github.com/ocaml-multicore/multicore-opam/pull/51">ocaml-multicore/mulicore-opam#51</a>
Update merlin and ocaml-lsp installation instructions for 4.12 variants
</p>

<p>
The README.md has been updated with instructions to use merlin and
ocaml-lisp for <code>4.12+domains</code> and <code>4.12+domains+effects</code> branches.
</p></li>

<li><p>
<a href="https://github.com/ocaml-multicore/dwarf_validator">dwarf_validator</a>
DWARF validation tool
</p>

<p>
The DWARF validation tool in <code>eh_frame_check.py</code> is now made
available in a public repository. It single steps through the binary
as it executes, and unwinds the stack using the DWARF directives.
</p></li>
</ul>
</div>
</div>

<div id="outline-container-orgd9dc38f" class="outline-6">
<h6 id="orgd9dc38f">Sundries</h6>
<div class="outline-text-6" id="text-orgd9dc38f">
<ul class="org-ul">
<li><p>
<a href="https://github.com/ocaml-multicore/ocaml-multicore/pull/523">ocaml-multicore/ocaml-multicore#523</a>
Systhreads Mutex raises Sys_error
</p>

<p>
The Systhreads Mutex error checks are now inline with OCaml, as
mentioned in <a href="https://github.com/ocaml/ocaml/pull/9846">Use "error checking" mutexes in the threads
library</a>.
</p></li>

<li><p>
<a href="https://github.com/ocaml-multicore/ocaml-multicore/pull/525">ocaml-multicore/ocaml-multicore#525</a>
Add issue URL for disabled signal handling test
</p>

<p>
Updated <code>testsuite/disabled</code> with the issue URL
<a href="https://github.com/ocaml-multicore/ocaml-multicore/issues/517">ocaml-multicore#517</a>
for future tracking.
</p></li>

<li><p>
<a href="https://github.com/ocaml-multicore/ocaml-multicore/pull/539">ocaml-multicore/ocaml-multicore#539</a>
Forcing_tag invalid argument to Gc.finalise
</p>

<p>
Addition of <code>Forcing_tag</code> for tag lazy values when the computation
is being forced. This is included so that <code>Gc.finalise</code> can raise an
invalid argument exception when a block with <code>Forcing_tag</code> is given
as an argument.
</p></li>
</ul>
</div>
</div>
</div>
</div>

<div id="outline-container-org2b6b3e3" class="outline-4">
<h4 id="org2b6b3e3">Benchmarking</h4>
<div class="outline-text-4" id="text-org2b6b3e3">
</div>
<div id="outline-container-org0342fbb" class="outline-5">
<h5 id="org0342fbb">Ongoing</h5>
<div class="outline-text-5" id="text-org0342fbb">
</div>
<div id="outline-container-org9de49ff" class="outline-6">
<h6 id="org9de49ff">Sandmark</h6>
<div class="outline-text-6" id="text-org9de49ff">
<ul class="org-ul">
<li><p>
We now have the frontend showing the graph results for Sandmark 2.0 builds
with <a href="https://github.com/ocurrent/current-bench">current-bench</a> for
CI. A raw output of the graph is shown below:
</p>


<div id="orgea24d84" class="figure">
<p><img src="https://aws1.discourse-cdn.com/standard11/uploads/ocaml/optimized/2X/2/2f57e7d54420b574af55657f78a1d38993ddc64f_2_624x998.png" alt="2f57e7d54420b574af55657f78a1d38993ddc64f_2_624x998.png" />
</p>
</div>

<p>
The Sandmark 2.0 benchmarking is moving to use the <code>current-bench</code>
tooling. You can now create necessary issues and PRs for the
Multicore OCaml project in the <code>current-bench</code> project using the
<code>multicore</code> label.
</p></li>

<li><p>
<a href="https://github.com/ocaml-bench/sandmark/pull/209">ocaml-bench/sandmark#209</a>
Use rule target kronecker.txt and remove from macro_bench
</p>

<p>
A rewrite of the graph500seq <code>kernel1.ml</code> implementation based on
the code review suggestions is currently being worked upon.
</p></li>

<li><p>
<a href="https://github.com/ocaml-bench/sandmark/pull/215">ocaml-bench/sandmark#215</a>
Remove Gc.promote_to from treiber_stack.ml
</p>

<p>
We are updating Sandmark to run with 4.12+domains and
4.12+domains+effects, and this patch removes Gc.promote_to from the
runtime.
</p></li>
</ul>
</div>
</div>

<div id="outline-container-org7d09748" class="outline-6">
<h6 id="org7d09748">current-bench</h6>
<div class="outline-text-6" id="text-org7d09748">
<ul class="org-ul">
<li><p>
<a href="https://github.com/ocurrent/current-bench/issues/87">ocurrent/current-bench#87</a>
Run benchmarks for old commits
</p>

<p>
We would like to be able to re-run the benchmarks for older commits
in a project for analysis and comparison.
</p></li>

<li><p>
<a href="https://github.com/ocurrent/current-bench/issues/103">ocurrent/current-bench#103</a>
Ability to set scale on UI to start at 0
</p>

<p>
The raw results plotted in the graph need to start from <code>[0, y_max+delta]</code> for the y-axis for better comparison. A <a href="https://github.com/ocurrent/current-bench/pull/74">PR</a> is available  for the same, and the fixed output is shown in the following graph:
</p>


<div id="orgd4e411d" class="figure">
<p><img src="https://aws1.discourse-cdn.com/standard11/uploads/ocaml/optimized/2X/3/36ba7ffa0c753bf3950594bfaf36557c09e9292a_2_1380x644.jpeg" alt="36ba7ffa0c753bf3950594bfaf36557c09e9292a_2_1380x644.jpeg" />
</p>
</div></li>

<li><p>
<a href="https://github.com/ocurrent/current-bench/issues/105">ocurrent/current-bench#105</a>
Abstract out Docker image name from <code>pipeline/lib/pipeline.ml</code>
</p>

<p>
The Multicore OCaml uses <code>ocaml/opam:ubuntu-20.10-ocaml-4.10</code> image
while the <code>pipeline/lib/pipeline.ml</code> uses <code>ocaml/opam</code>, and it will
be useful to use an environment variable for the same.
</p></li>

<li><p>
<a href="https://github.com/ocurrent/current-bench/issues/106">ocurrent/current-bench#106</a>
Use <code>--privileged</code> with Docker run_args for Multicore OCaml
</p>

<p>
The Sandmark environment uses <code>bwrap</code> for Multicore OCaml benchmark
builds, and hence we need to run the Docker container with
<code>--privileged</code> option. Otherwise, the build exits with an <code>Operation
  not permitted</code> error.
</p></li>

<li><p>
<a href="https://github.com/ocurrent/current-bench/issues/107">ocurrent/current-bench#107</a>
Ability to start and run only PostgreSQL and frontend
</p>

<p>
For Multicore OCaml, we provision the hardware with different
configuration settings for various experiments, and using an ETL
tool to just load the results to the PostgreSQL database and
visualize the same in the frontend will be useful.
</p></li>

<li><p>
<a href="https://github.com/ocurrent/current-bench/issues/108">ocurrent/current-bench#108</a>
Support for native builds for bare metals
</p>

<p>
In order to avoid any overhead with Docker, we need a way to run the
Multicore OCaml benchmarks on bare metal machines.
</p></li>
</ul>
</div>
</div>
</div>

<div id="outline-container-org706cdd5" class="outline-5">
<h5 id="org706cdd5">Completed</h5>
<div class="outline-text-5" id="text-org706cdd5">
</div>
<div id="outline-container-orge3928fe" class="outline-6">
<h6 id="orge3928fe">Documentation</h6>
<div class="outline-text-6" id="text-orge3928fe">
<ul class="org-ul">
<li><p>
<a href="https://github.com/ocurrent/current-bench/pull/75">ocurrent/current-bench#75</a>
Fix production deployment; add instructions
</p>

<p>
The HACKING.md is now updated with documentation for doing a
production deployment of current-bench.
</p></li>

<li><p>
<a href="https://github.com/ocurrent/current-bench/pull/90">ocurrent/current-bench#90</a>
Add some solutions to errors that users might run into
</p>

<p>
Based on our testing of current-bench with Sandmark-2.0, we now have
updated the FAQ in the HACKING.md file.
</p></li>
</ul>
</div>
</div>

<div id="outline-container-org73fa37a" class="outline-6">
<h6 id="org73fa37a">Sundries</h6>
<div class="outline-text-6" id="text-org73fa37a">
<ul class="org-ul">
<li><p>
<a href="https://github.com/ocurrent/current-bench/pull/96">ocurrent/current-bench#96</a>
Remove hardcoded URL for the frontend
</p>

<p>
The frontend URL is now abstracted out from the code, so that we can
deploy a current-bench instance on any new pristine server.
</p></li>

<li><p>
<a href="https://github.com/ocaml-bench/sandmark/pull/204">ocaml-bench/sandmark#204</a>
Adding layers.ml as a benchmark to Sandmark
</p>

<p>
The Irmin layers.ml benchmark is now added to Sandmark along with
its dependencies. This is tagged with <code>gt_100s</code>.
</p></li>
</ul>
</div>
</div>
</div>
</div>

<div id="outline-container-org8f7e1f6" class="outline-4">
<h4 id="org8f7e1f6">OCaml</h4>
<div class="outline-text-4" id="text-org8f7e1f6">
</div>
<div id="outline-container-orga95b0f8" class="outline-5">
<h5 id="orga95b0f8">Ongoing</h5>
<div class="outline-text-5" id="text-orga95b0f8">
<ul class="org-ul">
<li><p>
<a href="https://github.com/ocaml/ocaml/pull/10039">ocaml/ocaml#10039</a>
Safepoints
</p>

<p>
This PR is a work-in-progress. Thanks to Mark Shinwell and Damien
Doligez and Xavier Leroy for their valuable feedback and code suggestions.
</p></li>
</ul>

<p>
Special thanks to all the OCaml users and developers from the community for their continued support and contribution
to the project. Stay safe!
</p>
</div>
</div>
</div>

<div id="outline-container-org6302a03" class="outline-4">
<h4 id="org6302a03">Acronyms</h4>
<div class="outline-text-4" id="text-org6302a03">
<ul class="org-ul">
<li>AMD: Advanced Micro Devices</li>
<li>CI: Continuous Integration</li>
<li>CTF: Common Trace Format</li>
<li>DLAB: Domain Local Allocation Buffer</li>
<li>DWARF: Debugging With Attributed Record Formats</li>
<li>ETL: Extract Transform Load</li>
<li>GC: Garbage Collector</li>
<li>OPAM: OCaml Package Manager</li>
<li>PR: Pull Request</li>
<li>UI: User Interface</li>
<li>URL: Uniform Resource Locator</li>
<li>ZMQ: ZEROMQ</li>
</ul>
</div>
</div>
</div>
</div>




<div id="outline-container-6" class="outline-2">
<h2 id="6">Analyzing contributions to the OCaml compiler and all opam packages</h2>
<div class="outline-text-2" id="text-6">
<p>
Archive: <a href="https://discuss.ocaml.org/t/analyzing-contributions-to-the-ocaml-compiler-and-all-opam-packages/7854/1">https://discuss.ocaml.org/t/analyzing-contributions-to-the-ocaml-compiler-and-all-opam-packages/7854/1</a>
</p>
</div>

<div id="outline-container-org19c2503" class="outline-3">
<h3 id="org19c2503">gasche announced</h3>
<div class="outline-text-3" id="text-org19c2503">
<p>
I recently learned of <a href="https://github.com/hpjansson/fornalder">fornalder</a>, a tool that creates nice visualizations of
contributions to open-source projects by analyzing commits to their git repositories (the author used it to <a href="https://hpjansson.org/blag/2020/12/16/on-the-graying-of-gnome/">analyze
GNOME contributions</a>). I decided to use it to study
contributions to the OCaml implementation and OCaml open-source packages, results below.
</p>
</div>

<div id="outline-container-org286067c" class="outline-4">
<h4 id="org286067c">The OCaml compiler distribution</h4>
<div class="outline-text-4" id="text-org286067c">
<p>
This <a href="https://gitlab.com/gasche-snippets/fornalder-studies/-/tree/main/data/ocaml/ocaml-contributors.png">graph</a>
shows the "contributor cohorts" for the <a href="https://github.com/ocaml/ocaml">OCaml compiler</a> over time. For example, the
big dark-red bar that shows up in 2015 represents the "2015 cohort", the number of long-term contributors to the
OCaml compiler that did their first contribution in 2015. The dark-red bar in similar position in each following year
represents the contributors from the 2015 cohort that are still active on that year. The bar shrinks over time, as
some members of this cohort stop contributors.  Short-term contributors (all their contributions fall within a
90-days period) are shown as the "Brief" bars at the top.
</p>

<p>
The main thing we see on this graph is that moving the compiler development on Github in 2015 increased sharply the
number of contributors, which has remained relatively stable since (there is an "expert pool" that is stable in
size), with a large fraction of occasional contributors each year.
</p>

<p>
(Note: stability of contributor numbers is fine for the compiler, which is not meant to keep growing in size and
complexity. We hope most contributors go to other parts of the OCaml ecosystem.)
</p>

<p>
This <a href="https://gitlab.com/gasche-snippets/fornalder-studies/-/tree/main/data/ocaml/ocaml-commits.png">graph</a> shows the
number of <b>commits</b> from the contributors of each cohort. We see for example that the 1995 contributor, namely
Xavier, has remained relatively active throughout the compiler development, with a marked uptick in 2020 (possibly
related to the Multicore upstreaming effort). Today most of the commit volume seems to come from community members
that started contributing right after the Github transition, after 2015-2016.
</p>

<p>
It's interesting to compare these two charts: we see that the 2015 cohort has shrunk in size in 2020 (by half), but
that they contributed much more in 2020 than in 2015: over time, the remaining contributors from this cohort grew in
confidence/expertise/interest and are now contributing more (several of them became core maintainers, for example).
</p>
</div>
</div>

<div id="outline-container-org4b6919a" class="outline-4">
<h4 id="org4b6919a">All OCaml software on opam</h4>
<div class="outline-text-4" id="text-org4b6919a">
<p>
I then ran the same visualization tool on <b>all OCaml git repositories</b> listed in the public
<a href="https://github.com/ocaml/opam-repository/">opam-repository</a>. This is a very-large subset of all open source software
implemented in OCaml. But it does not represent well the "industrial" codebases that some industiral OCaml users are
working on &#x2013; even when the code is open-source, it may be packaged and distributed separately.
</p>

<p>
This <a href="https://gitlab.com/gasche-snippets/fornalder-studies/-/tree/main/data/ocaml/opam-repo-contributors.png">graph</a>
shows the number of contributors, in yearly cohorts. We can see that the number of contributors has been growing each
year, plateauing in 2018.
</p>

<p>
Note: there is a measurement artefact that makes the last column smaller than the previous ones: some of the
"short-term" contributors in 2020 will later become longer-term contributor by contributing again in 2021, so they be
added to the long-term cohort of 2020. This artefact may suffice to explain the small decrease in long-term
contributors in 2020.
</p>

<p>
This <a href="https://gitlab.com/gasche-snippets/fornalder-studies/-/tree/main/data/ocaml/opam-repo-commits.png">graph</a> shows
the volume of commits. Here we don't see a plateau; there is in fact a small decrease in 2018, and further growth in
2019 and 2020. Another aspect I find striking is the stability of commit volume in each cohort. For example, the 2014
cohort seems to have contributed roughly as many commits during all years 2016-2020. Given the reduction in the
number of contributors in this commit, this is again explained by fewer contributors gradually increasing their
contribution volume.
</p>
</div>
</div>

<div id="outline-container-org64e6af9" class="outline-4">
<h4 id="org64e6af9">Disclaimer</h4>
<div class="outline-text-4" id="text-org64e6af9">
<p>
Some industrial OCaml codebases are included in the public opam repository, but a large part is not.
</p>

<p>
This visualization aggregates project data assuming that they follow "standard" git development practices. The data
is imperfact, it may be skewed by tool-generated commits. For example, some of the Jane Street software packaged on
opam uses git repository mirrors that are updated automatically by usually a single committer, in a way that does not
reflect their true development activity. (Thanks to @yminsky for catching that.)
</p>

<p>
Another threat to validity is that some authors commit in different projects using different names, so they may be
counted as separate contributors instead. (Inside a project, one may use a .mailmap file to merge contributor
identities, but afaik there is no support in git or fornalder for overlaying an extra .mailmap file that would work
across repositories.)
</p>

<p>
If you wish to study the dataset to see if the overall conclusions are endangered by such anomalies, please feel free
to replay the <a href="https://gitlab.com/gasche-snippets/fornalder-studies/-/tree/main/data/ocaml/logs.md">data-collection
steps</a>. You can either manually
inspect git repositories, or play with the SQLite database generated by fornalder.
</p>
</div>
</div>

<div id="outline-container-org955a084" class="outline-4">
<h4 id="org955a084">My take away</h4>
<div class="outline-text-4" id="text-org955a084">
<p>
I found this analysis interesting. Here would be my conclusion so far:
</p>

<ul class="org-ul">
<li>The OCaml community gets a regular influx of new contributors.</li>

<li>Some of our contributors stay for a long period, and they contribute more and more over time.</li>

<li>We observe a plateau-ing numbers of new contributors on the years 2018-2020 (and the pandemic is probably not going to improve the figure for 2021), but the volume of commits keeps growing.</li>
</ul>

<p>
It is difficult to draw definitive conclusions from these visualizations, especially as we don't have them for many
other communities to compare to. Compared to the Gnome trends shown in the original blog post (
<a href="https://hpjansson.org/blag/2020/12/16/on-the-graying-of-gnome/">https://hpjansson.org/blag/2020/12/16/on-the-graying-of-gnome/</a> ), I would say that we are doing "better" than the
Gnome ecosystem (in terms of attracting new contributors).
</p>

<p>
My personal view for now is that OCaml remains a more niche language than "mainstream" contenders (we don't see an
exponential growth here that would change the status), but that its contributor flow is healthy.
</p>
</div>
</div>

<div id="outline-container-orgd8ba50e" class="outline-4">
<h4 id="orgd8ba50e">Reproduction information</h4>
<div class="outline-text-4" id="text-orgd8ba50e">
<p>
You can find a curated log of my analysis process in
<a href="https://gitlab.com/gasche-snippets/fornalder-studies/-/tree/main/data/ocaml/logs.md">logs.md</a>; this should contain
enough information for you to reproduce the result, and it could easily be adapted to other software communities.
</p>

<p>
I uploaded all the small-enough data of my run in this repository, in particular the <a href="https://gitlab.com/gasche-snippets/fornalder-studies/-/tree/main/data/ocaml/git-urls.txt">list of
URLs</a> I tried to clone &#x2013;
some of them failed. Not included: the cloned git repositories, and the databases build by fornalder to store its
analysis data.
</p>
</div>
</div>
</div>


<div id="outline-container-orgdf7d34d" class="outline-3">
<h3 id="orgdf7d34d">Anil Madhavapeddy then said</h3>
<div class="outline-text-3" id="text-orgdf7d34d">
<p>
This is an extremely cool analysis, thanks for posting it @gasche!  I'm trying to think of any systemic reasons for
the plateauing of new contributors in 2018/2019, but the only thing I can come up with is that there are more private
industrial codebases employing OCaml developers.  Anecdotally, the number of jobs across OCaml/Reason seems to be on
the up in the past few years.
</p>

<p>
I'll have a go at reproducing your methodology after the academic term here finishes. One thing we'd be very happy to
take PRs for in the opam-repository are improvements to metadata to assist with this sort of research. For instance,
filtering out dev-repo entries <a href="https://gitlab.com/gasche-snippets/fornalder-studies/-/blob/main/data/ocaml/logs.md#turning-git-repo-urls-into-git-clone-command">for non-OCaml
projects</a>
seems like an immediate win and would simplify the data collection.
</p>
</div>
</div>


<div id="outline-container-orgde2b007" class="outline-3">
<h3 id="orgde2b007">gasche then said</h3>
<div class="outline-text-3" id="text-orgde2b007">
<p>
One hypothesis I considered is that some contributions have moved away from the opam-repository and are happening
directly in npm, thanks to esy. I ran a similar analysis
(<a href="https://gitlab.com/gasche-snippets/fornalder-studies/-/blob/main/data/npm-ocaml/logs.md">logs</a>) on all npm packages
tagged <code>ocaml</code>, but the results are unconclusive (I may be missing more OCaml package on npm that is not tagged).
</p>
</div>

<div id="outline-container-org1bc12d3" class="outline-4">
<h4 id="org1bc12d3">npm "ocaml" contributors</h4>
<div class="outline-text-4" id="text-org1bc12d3">
<p>
<a href="https://gitlab.com/gasche-snippets/fornalder-studies/-/tree/main/data/npm-ocaml/npm-ocaml-contributors.png">npm-ocaml
contributors</a>
</p>
</div>
</div>

<div id="outline-container-orgac37718" class="outline-4">
<h4 id="orgac37718">npm "ocaml" commits</h4>
<div class="outline-text-4" id="text-orgac37718">
<p>
<a href="https://gitlab.com/gasche-snippets/fornalder-studies/-/tree/main/data/npm-ocaml/npm-ocaml-commits.png">npm-ocaml
commits</a>
</p>

<p>
(If you wonder what's the long trail between 2003 and 2009: this is the development of `bs-sedlex`, which goes back
to an old OCaml-only prototype by Alain Frisch in 2003. There is also a version of OCaml packaged on npm, but I
removed it from the analysis as it was adding noise and was mostly not-esy-specific contributions.)
</p>

<p>
Note that we are talking about ~4K commits here, which remains fairly small compared to the ~120K commits for
opam-repository packages on the last year. When I tried to merge both sets together this didn't make much of a
difference compared to just-opam numbers.
</p>

<p>
Maybe someone should redo the analysis with "reason/rescript" tags in addition, to measure the contribution volume
there. I sticked with packages that self-identify as "ocaml" for now.
</p>
</div>
</div>
</div>


<div id="outline-container-org8717745" class="outline-3">
<h3 id="org8717745">gasche then added</h3>
<div class="outline-text-3" id="text-org8717745">
</div>
<div id="outline-container-orgdf3247d" class="outline-4">
<h4 id="orgdf3247d">Batteries</h4>
<div class="outline-text-4" id="text-orgdf3247d">
<p>
Here are graphs for <a href="https://github.com/ocaml-batteries-team/batteries-included/">batteries-included</a>.
</p>

<p>
Cohorts, per number of contributors:
</p>


<div id="org815d587" class="figure">
<p><img src="https://aws1.discourse-cdn.com/standard11/uploads/ocaml/optimized/2X/d/d78265f805413446e26f11b0ecfa6a4e06a82a31_2_1380x646.png" alt="d78265f805413446e26f11b0ecfa6a4e06a82a31_2_1380x646.png" />
</p>
</div>

<p>
Cohorts, per volume of commits:
</p>


<div id="org4af6493" class="figure">
<p><img src="https://aws1.discourse-cdn.com/standard11/uploads/ocaml/optimized/2X/6/62d8e4fe481521565340485d21582b8df21da294_2_1380x646.png" alt="62d8e4fe481521565340485d21582b8df21da294_2_1380x646.png" />
</p>
</div>

<p>
What we see, I think, is that Batteries has been fairly quiet since 2015, which probably corresponds to entering some
kind of "maintenance mode". There is still a reasonable diversity of contributors, with many one-shot contributors
(which I assume corresponds to user that are mostly happy silently using the library, and come to add a function or
fix a bug once in a while).
</p>

<p>
Looking at the volume of commits: the strong decrease of the gray bar in 2018 corresponds, I think, to when I stopped
contributing actively, and you took over as a contributor. It looks like I was effectively the last of the early-day
contributors still active. The purple "2013" cohort is interesting, and I went to look at the data: it's you
(François Berenger) and Simon @c-cube Cruanes. Simon contributed a lot on a short period, and then went off to create
the very nice <a href="https://github.com/c-cube/ocaml-containers">Containers</a> library that would move faster. You stuck and
are now the most active contributor (and maintainers).
</p>
</div>
</div>

<div id="outline-container-orge41a6c5" class="outline-4">
<h4 id="orge41a6c5">Containers</h4>
<div class="outline-text-4" id="text-orge41a6c5">
<p>
Contributors:
</p>


<div id="org03f76bd" class="figure">
<p><img src="https://aws1.discourse-cdn.com/standard11/uploads/ocaml/optimized/2X/9/9db7ef7707024dc6f5c567865f01976c3a67414c_2_1380x646.png" alt="9db7ef7707024dc6f5c567865f01976c3a67414c_2_1380x646.png" />
</p>
</div>

<p>
Commits:
</p>


<div id="org794ae42" class="figure">
<p><img src="https://aws1.discourse-cdn.com/standard11/uploads/ocaml/optimized/2X/f/f321a7134b68d7922f0aae8c88431a589f531116_2_1380x646.png" alt="f321a7134b68d7922f0aae8c88431a589f531116_2_1380x646.png" />
</p>
</div>

<p>
Containers is mostly a one-person library with Simon doing most of the work. There were many new contributors in 2017
and 2018 (most of them brief), and the strong show of purple year 2018 in today's commit volume is mostly due to the
enigmatic Fardale.
</p>
</div>
</div>

<div id="outline-container-org98d2fd5" class="outline-4">
<h4 id="org98d2fd5">Disclaimer</h4>
<div class="outline-text-4" id="text-org98d2fd5">
<p>
I think that fornalder is more useful to study large repositories (or set of repositories) that have been going for
many years. For a single project, especially if they are relatively small or young, <code>git shortlog -n -s</code> (over the
whole log or <code>--since 2018</code>, etc.) tells you mostly the same thing.
</p>
</div>
</div>
</div>
</div>




<div id="outline-container-7" class="outline-2">
<h2 id="7">Timedesc 0.1.0</h2>
<div class="outline-text-2" id="text-7">
<p>
Archive: <a href="https://discuss.ocaml.org/t/ann-timedesc-0-1-0/7860/1">https://discuss.ocaml.org/t/ann-timedesc-0-1-0/7860/1</a>
</p>
</div>

<div id="outline-container-org1264539" class="outline-3">
<h3 id="org1264539">Darren announced</h3>
<div class="outline-text-3" id="text-org1264539">
<p>
I'm pleased to announce the first release of <a href="https://github.com/daypack-dev/timere">Timedesc</a>, a date time handling
library. Timedesc provides utilities to describe points of time, and properly handle calendar and time zone
information.
</p>

<p>
You can find the tutorial and API doc <a href="https://daypack-dev.github.io/timere/timedesc/Timedesc/index.html">here</a>.
</p>
</div>

<div id="outline-container-org0360025" class="outline-4">
<h4 id="org0360025">Features</h4>
<div class="outline-text-4" id="text-org0360025">
<ul class="org-ul">
<li>Timestamp and date time handling with platform independent time zone support
<ul class="org-ul">
<li>Subset of the IANA time zone database is built into this library</li>
</ul></li>
<li>Supports Gregorian calendar date, ISO week date, and ISO ordinal date</li>
<li>Supports nanosecond precision</li>
<li>ISO8601 parsing and RFC3339 printing</li>
</ul>
</div>
</div>

<div id="outline-container-org533f0b2" class="outline-4">
<h4 id="org533f0b2">Some context</h4>
<div class="outline-text-4" id="text-org533f0b2">
<p>
This is a much more polished repackaging of the date time components from Timere. The separation and restructuring
came from the growing size of the date time components, and very nice and extensive feedback on UX from @gasche at
<a href="https://github.com/daypack-dev/timere/issues/25">issue #25</a> and other issues branching from it (many thanks!).
</p>

<p>
And as usual, many thanks to @Drup for his advice.
</p>
</div>
</div>
</div>
</div>




<div id="outline-container-8" class="outline-2">
<h2 id="8">vec 0.2.0</h2>
<div class="outline-text-2" id="text-8">
<p>
Archive: <a href="https://discuss.ocaml.org/t/ann-vec-0-2-0/7864/1">https://discuss.ocaml.org/t/ann-vec-0-2-0/7864/1</a>
</p>
</div>

<div id="outline-container-org6c9452f" class="outline-3">
<h3 id="org6c9452f">Alex Ionescu announced</h3>
<div class="outline-text-3" id="text-org6c9452f">
<p>
I've just released version <code>0.2.0</code> of <code>vec</code>, a library for safe dynamic arrays with Rust-like mutability permissions.
</p>

<p>
You can find the package on opam <a href="https://opam.ocaml.org/packages/vec/">here</a>, and the source repository
<a href="https://github.com/aionescu/vec">here</a>.
</p>

<p>
This release adds new APIs for filtering and comparing vectors, as well as some bug fixes.
</p>

<p>
Breaking changes from <code>0.1.0</code>:
</p>
<ul class="org-ul">
<li>Some functions were renamed to conform to <code>Stdlib</code>'s conventions: <code>any</code> -&gt; <code>exists</code>, <code>all</code> -&gt; <code>for_all</code></li>
<li>Potentially-unsafe APIs for directly creating vectors with a buffer and accessing vectors' buffers were removed</li>
</ul>

<p>
Looking for feedback and suggestions!
</p>
</div>
</div>


<div id="outline-container-org7546d7a" class="outline-3">
<h3 id="org7546d7a">gasche then said</h3>
<div class="outline-text-3" id="text-org7546d7a">
<p>
A minor remark: I find it remarkable how closely the proposed API mirrors the one of the
<a href="https://ocaml-batteries-team.github.io/batteries-included/hdoc2/BatArray.Cap.html">BatArray.Cap</a> interface, an Array
submodule doing essentially the same thing contributed by David Teller in 2008. (Many details are different as <code>vec</code>
offers dynamically-resizable arrays, while <code>Array.Cap</code> is fixed-size arrays, but this is orthogonal to the static
control over mutability.)
</p>

<p>
To me this suggests that the <code>vec</code> API is not actually specific to Rust, or at least that the inspiration arrived at
the same point as the long tradition of "phantom types" in ML-family languages. (In this space I think the key idea
popularized by Rust would be ownership (possibly with borrowing), and in particular the idea that by default mutable
values should be uniquely-owned, while immutable values can easily be shared.)
</p>

<p>
This is not a criticism of the library itslef! I very much like the idea of having small modules that cover simple
needs, rather than large monolithic libraries.
</p>

<p>
Question: in Batteries, my impression is that <code>Array.Cap</code> was never used much. I would guess that the reason was
that, for most users, the static guarantees of the interface did not offset the (mild) cost of the more complex types
to manage. What is/are your use-case(s) where reasoning about mutation is important?
</p>
</div>
</div>


<div id="outline-container-org3e67a52" class="outline-3">
<h3 id="org3e67a52">Alex Ionescu replied</h3>
<div class="outline-text-3" id="text-org3e67a52">
<p>
I didn't know about that module. They are indeed <b>very</b> similar.
</p>

<p>
Regarding your second point, yes, this isn't really specific to Rust, it just popularized the idea.
My initial inspiration was <a href="https://youtu.be/-J8YyfrSwTk?t=3405">this presentation by Yaron Minsky</a>, where he does a
similar thing, but for a <code>ref</code>-like type. My initial reaction was "Hey, that looks a lot like Rust's references".
</p>

<p>
Honestly, I started this project more as a fun exercise rather than to meet a real-world use-case, but I assume there
are situations when the mutability control comes in handy e.g. If you want to pass a buffer to some function to fill
but don't want it to read its current contents, you could pass an <code>('a, [`W]) Vec.t</code> instead of allocating a new
buffer.
</p>
</div>
</div>


<div id="outline-container-org405bb7f" class="outline-3">
<h3 id="org405bb7f">Simon Cruanes then said</h3>
<div class="outline-text-3" id="text-org405bb7f">
<p>
Interestingly it also looks very similar to containers' <code>CCVector</code>, which is a resizable array with read and write
permissions using phantom types. (see <a href="https://c-cube.github.io/ocaml-containers/last/containers/CCVector/index.html">https://c-cube.github.io/ocaml-containers/last/containers/CCVector/index.html</a>)
</p>

<p>
And to answer gasche's question, personally I like having a vector that is immutable, after building it using mutable
means. It's like a list but it can be right appended to easily.
</p>
</div>
</div>


<div id="outline-container-org2e833a7" class="outline-3">
<h3 id="org2e833a7">Yaron Minsky said</h3>
<div class="outline-text-3" id="text-org2e833a7">
<p>
You might find the documentation of the Perms library in Core_kernel to be interesting:
</p>

<p>
<a href="https://ocaml.janestreet.com/ocaml-core/v0.12/doc/core_kernel/Core_kernel/Perms/index.html">https://ocaml.janestreet.com/ocaml-core/v0.12/doc/core_kernel/Core_kernel/Perms/index.html</a>
</p>

<p>
This establishes idioms that are used across a variety of permissioned types in our codebase. Notably, it
distinguishes between a read-only value (which doesn't directly support mutation) and immutable values (which no has
a write-handle to), which we've found to be a useful distinction. It also highlights some usage patterns that help
avoid some common mistakes in using phantom types correctly.
</p>
</div>
</div>


<div id="outline-container-org4661c91" class="outline-3">
<h3 id="org4661c91">Calascibetta Romain</h3>
<div class="outline-text-3" id="text-org4661c91">
<p>
And, in the same spirit of others posts, I would to share a pull-request on
<a href="https://github.com/mirage/ocaml-cstruct/pull/237"><code>ocaml-cstruct</code></a> which is a nice discussion about <span class="underline">capabilities</span>
and how to implement them into an already existing codebase.
</p>

<p>
However, as far as I can tell, we don't really use it widely - and we should. The main problem is the cost to upgrade
an old code with <code>cstruct</code> with this interface where we put some new constraints (which can reveal some "bugs" in any
way).
</p>
</div>
</div>
</div>




<div id="outline-container-orgf51badf" class="outline-2">
<h2 id="orgf51badf">Old CWN</h2>
<div class="outline-text-2" id="text-orgf51badf">
<p>
If you happen to miss a CWN, you can <a href="mailto:alan.schmitt@polytechnique.org">send me a message</a> and I'll mail it to you, or go take a look at <a href="https://alan.petitepomme.net/cwn/">the archive</a> or the <a href="https://alan.petitepomme.net/cwn/cwn.rss">RSS feed of the archives</a>.
</p>

<p>
If you also wish to receive it every week by mail, you may subscribe <a href="http://lists.idyll.org/listinfo/caml-news-weekly/">online</a>.
</p>

<div class="authorname" id="org66fba33">
<p>
<a href="https://alan.petitepomme.net/">Alan Schmitt</a>
</p>

</div>
</div>
</div>
</div>
</body>
</html>
