<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<!-- 2021-10-26 Tue 13:40 -->
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>OCaml Weekly News</title>
<meta name="generator" content="Org mode" />
<style type="text/css">
 <!--/*--><![CDATA[/*><!--*/
  .title  { text-align: center;
             margin-bottom: .2em; }
  .subtitle { text-align: center;
              font-size: medium;
              font-weight: bold;
              margin-top:0; }
  .todo   { font-family: monospace; color: red; }
  .done   { font-family: monospace; color: green; }
  .priority { font-family: monospace; color: orange; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .org-right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .org-left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .org-center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #ccc;
    box-shadow: 3px 3px 3px #eee;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: auto;
    padding-top: 1.2em;
  }
  pre.src:before {
    display: none;
    position: absolute;
    background-color: white;
    top: -10px;
    right: 10px;
    padding: 3px;
    border: 1px solid black;
  }
  pre.src:hover:before { display: inline; margin-top: 14px;}
  /* Languages per Org manual */
  pre.src-asymptote:before { content: 'Asymptote'; }
  pre.src-awk:before { content: 'Awk'; }
  pre.src-C:before { content: 'C'; }
  /* pre.src-C++ doesn't work in CSS */
  pre.src-clojure:before { content: 'Clojure'; }
  pre.src-css:before { content: 'CSS'; }
  pre.src-D:before { content: 'D'; }
  pre.src-ditaa:before { content: 'ditaa'; }
  pre.src-dot:before { content: 'Graphviz'; }
  pre.src-calc:before { content: 'Emacs Calc'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-fortran:before { content: 'Fortran'; }
  pre.src-gnuplot:before { content: 'gnuplot'; }
  pre.src-haskell:before { content: 'Haskell'; }
  pre.src-hledger:before { content: 'hledger'; }
  pre.src-java:before { content: 'Java'; }
  pre.src-js:before { content: 'Javascript'; }
  pre.src-latex:before { content: 'LaTeX'; }
  pre.src-ledger:before { content: 'Ledger'; }
  pre.src-lisp:before { content: 'Lisp'; }
  pre.src-lilypond:before { content: 'Lilypond'; }
  pre.src-lua:before { content: 'Lua'; }
  pre.src-matlab:before { content: 'MATLAB'; }
  pre.src-mscgen:before { content: 'Mscgen'; }
  pre.src-ocaml:before { content: 'Objective Caml'; }
  pre.src-octave:before { content: 'Octave'; }
  pre.src-org:before { content: 'Org mode'; }
  pre.src-oz:before { content: 'OZ'; }
  pre.src-plantuml:before { content: 'Plantuml'; }
  pre.src-processing:before { content: 'Processing.js'; }
  pre.src-python:before { content: 'Python'; }
  pre.src-R:before { content: 'R'; }
  pre.src-ruby:before { content: 'Ruby'; }
  pre.src-sass:before { content: 'Sass'; }
  pre.src-scheme:before { content: 'Scheme'; }
  pre.src-screen:before { content: 'Gnu Screen'; }
  pre.src-sed:before { content: 'Sed'; }
  pre.src-sh:before { content: 'shell'; }
  pre.src-sql:before { content: 'SQL'; }
  pre.src-sqlite:before { content: 'SQLite'; }
  /* additional languages in org.el's org-babel-load-languages alist */
  pre.src-forth:before { content: 'Forth'; }
  pre.src-io:before { content: 'IO'; }
  pre.src-J:before { content: 'J'; }
  pre.src-makefile:before { content: 'Makefile'; }
  pre.src-maxima:before { content: 'Maxima'; }
  pre.src-perl:before { content: 'Perl'; }
  pre.src-picolisp:before { content: 'Pico Lisp'; }
  pre.src-scala:before { content: 'Scala'; }
  pre.src-shell:before { content: 'Shell Script'; }
  pre.src-ebnf2ps:before { content: 'ebfn2ps'; }
  /* additional language identifiers per "defun org-babel-execute"
       in ob-*.el */
  pre.src-cpp:before  { content: 'C++'; }
  pre.src-abc:before  { content: 'ABC'; }
  pre.src-coq:before  { content: 'Coq'; }
  pre.src-groovy:before  { content: 'Groovy'; }
  /* additional language identifiers from org-babel-shell-names in
     ob-shell.el: ob-shell is the only babel language using a lambda to put
     the execution function name together. */
  pre.src-bash:before  { content: 'bash'; }
  pre.src-csh:before  { content: 'csh'; }
  pre.src-ash:before  { content: 'ash'; }
  pre.src-dash:before  { content: 'dash'; }
  pre.src-ksh:before  { content: 'ksh'; }
  pre.src-mksh:before  { content: 'mksh'; }
  pre.src-posh:before  { content: 'posh'; }
  /* Additional Emacs modes also supported by the LaTeX listings package */
  pre.src-ada:before { content: 'Ada'; }
  pre.src-asm:before { content: 'Assembler'; }
  pre.src-caml:before { content: 'Caml'; }
  pre.src-delphi:before { content: 'Delphi'; }
  pre.src-html:before { content: 'HTML'; }
  pre.src-idl:before { content: 'IDL'; }
  pre.src-mercury:before { content: 'Mercury'; }
  pre.src-metapost:before { content: 'MetaPost'; }
  pre.src-modula-2:before { content: 'Modula-2'; }
  pre.src-pascal:before { content: 'Pascal'; }
  pre.src-ps:before { content: 'PostScript'; }
  pre.src-prolog:before { content: 'Prolog'; }
  pre.src-simula:before { content: 'Simula'; }
  pre.src-tcl:before { content: 'tcl'; }
  pre.src-tex:before { content: 'TeX'; }
  pre.src-plain-tex:before { content: 'Plain TeX'; }
  pre.src-verilog:before { content: 'Verilog'; }
  pre.src-vhdl:before { content: 'VHDL'; }
  pre.src-xml:before { content: 'XML'; }
  pre.src-nxml:before { content: 'XML'; }
  /* add a generic configuration mode; LaTeX export needs an additional
     (add-to-list 'org-latex-listings-langs '(conf " ")) in .emacs */
  pre.src-conf:before { content: 'Configuration File'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.org-right  { text-align: center;  }
  th.org-left   { text-align: center;   }
  th.org-center { text-align: center; }
  td.org-right  { text-align: right;  }
  td.org-left   { text-align: left;   }
  td.org-center { text-align: center; }
  dt { font-weight: bold; }
  .footpara { display: inline; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .equation-container {
    display: table;
    text-align: center;
    width: 100%;
  }
  .equation {
    vertical-align: middle;
  }
  .equation-label {
    display: table-cell;
    text-align: right;
    vertical-align: middle;
  }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  .org-svg { width: 90%; }
  /*]]>*/-->
</style>
<style type="text/css">#table-of-contents h2 { display: none } .title { display: none } .authorname { text-align: right }</style>
<style type="text/css">.outline-2 {border-top: 1px solid black;}</style>
<script type="text/javascript">
// @license magnet:?xt=urn:btih:e95b018ef3580986a04669f1b5879592219e2a7a&dn=public-domain.txt Public Domain
<!--/*--><![CDATA[/*><!--*/
     function CodeHighlightOn(elem, id)
     {
       var target = document.getElementById(id);
       if(null != target) {
         elem.classList.add("code-highlighted");
         target.classList.add("code-highlighted");
       }
     }
     function CodeHighlightOff(elem, id)
     {
       var target = document.getElementById(id);
       if(null != target) {
         elem.classList.remove("code-highlighted");
         target.classList.remove("code-highlighted");
       }
     }
    /*]]>*///-->
// @license-end
</script>
</head>
<body>
<div id="content">
<h1 class="title">OCaml Weekly News</h1>
<p>
<a href="https://alan.petitepomme.net/cwn/2021.10.19.html">Previous Week</a> <a href="https://alan.petitepomme.net/cwn/index.html">Up</a> <a href="https://alan.petitepomme.net/cwn/2021.11.02.html">Next Week</a>
</p>

<p>
Hello
</p>

<p>
Here is the latest OCaml Weekly News, for the week of October 19 to 26, 2021.
</p>

<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#1">OCaml MOOC, third edition</a></li>
<li><a href="#2">Release of ocaml-sf/learn-ocaml:0.13.0</a></li>
<li><a href="#3">First release of <code>conan</code>, the detective to recognize your file</a></li>
<li><a href="#4">Software Engineer Position at OCamlPro (France)</a></li>
<li><a href="#5">New version of Try OCaml</a></li>
<li><a href="#6">Well Typed Router (wtr, wtr-ppx) v3.0.0 released</a></li>
<li><a href="#7">containers 3.6</a></li>
<li><a href="#8">ocaml-annot for binary annotations</a></li>
<li><a href="#9">shuttle v0.3.1 released</a></li>
<li><a href="#10">Generating static and portable executables with OCaml</a></li>
<li><a href="#11">"Parsing" terms into a well-typed representation: a GADT puzzle</a></li>
<li><a href="#org21bb23a">Old CWN</a></li>
</ul>
</div>
</div>


<div id="outline-container-1" class="outline-2">
<h2 id="1">OCaml MOOC, third edition</h2>
<div class="outline-text-2" id="text-1">
<p>
Archive: <a href="https://discuss.ocaml.org/t/ocaml-mooc-third-edition/2458/5">https://discuss.ocaml.org/t/ocaml-mooc-third-edition/2458/5</a>
</p>
</div>

<div id="outline-container-org06ab565" class="outline-3">
<h3 id="org06ab565">Alain announced</h3>
<div class="outline-text-3" id="text-org06ab565">
<p>
<a href="https://archive.org/details/fun_ocaml_mooc">https://archive.org/details/fun_ocaml_mooc</a>
</p>
</div>
</div>
</div>




<div id="outline-container-2" class="outline-2">
<h2 id="2">Release of ocaml-sf/learn-ocaml:0.13.0</h2>
<div class="outline-text-2" id="text-2">
<p>
Archive: <a href="https://discuss.ocaml.org/t/ann-release-of-ocaml-sf-learn-ocaml-0-13-0/8577/7">https://discuss.ocaml.org/t/ann-release-of-ocaml-sf-learn-ocaml-0-13-0/8577/7</a>
</p>
</div>

<div id="outline-container-org02a11cc" class="outline-3">
<h3 id="org02a11cc">Continuing this thread, Vincent Laviron announced</h3>
<div class="outline-text-3" id="text-org02a11cc">
<p>
The video is up:
<a href="https://www.irill.org/videos/seminaires2021/IRILL-seminaire-Louis-Gesbert-2021-10-07.html">https://www.irill.org/videos/seminaires2021/IRILL-seminaire-Louis-Gesbert-2021-10-07.html</a>
The talk is in French with English slides.
</p>
</div>
</div>
</div>




<div id="outline-container-3" class="outline-2">
<h2 id="3">First release of <code>conan</code>, the detective to recognize your file</h2>
<div class="outline-text-2" id="text-3">
<p>
Archive: <a href="https://discuss.ocaml.org/t/ann-first-release-of-conan-the-detective-to-recognize-your-file/8655/1">https://discuss.ocaml.org/t/ann-first-release-of-conan-the-detective-to-recognize-your-file/8655/1</a>
</p>
</div>

<div id="outline-container-org818154b" class="outline-3">
<h3 id="org818154b">Calascibetta Romain announced</h3>
<div class="outline-text-3" id="text-org818154b">
</div>
<div id="outline-container-org3d969bb" class="outline-4">
<h4 id="org3d969bb">Conan, an OCaml detective to recognize your file</h4>
<div class="outline-text-4" id="text-org3d969bb">
<p>
I'm glad to announce the first experimental release of <a href="https://github.com/mirage/conan"><code>conan</code></a>. This tool/library
helps us to recognize the <a href="https://en.wikipedia.org/wiki/Media_type">MIME type</a> of a given file. More concretely, <code>conan</code> is a reimplementation of the
command <code>file</code>:
</p>
<div class="org-src-container">
<pre class="src src-shell">$ file --mime image.png
image/png
</pre>
</div>

<p>
This tool was made to replace our old <a href="https://github.com/mirage/ocaml-magic-mime">ocaml-magic-mime</a> project which recognizes the type of the MIME type of the
given file <span class="underline">via</span> its extension and a static database. However, a security problem remains: <code>ocaml-magic-mime</code> trusts
on the user's input.
</p>

<p>
The MIME type of a file is <b>not</b> a user's input (like the file name). It's a property of the file itself. A more
secure way to recognize the type of the file is to introspect contents and compare it with a given database to
possibly recognize the MIME type.
</p>

<p>
So, <code>file</code> and specially <code>libmagic</code> work like that. They have a <code>magic</code> database which describes some magic numbers
about some formats. Then, they traverse contents of the given file and compare inner values with what its expected
from a certain MIME type.
</p>
</div>
</div>

<div id="outline-container-org9e211c2" class="outline-4">
<h4 id="org9e211c2">The goal of Conan / <code>ocaml-magic-mime</code></h4>
<div class="outline-text-4" id="text-org9e211c2">
<p>
The main problem with this approach is the inherent assumption that we manipulate a file from a file-system. However,
as we said many times, MirageOS does not have, at first, a file-system (but you can add one if you want).
</p>

<p>
This is why we made <code>ocaml-magic-mime</code> to be able to recognize MIME type of <span class="underline">something</span> (a file, a simple <code>string</code>, a
stream, etc.).
</p>

<p>
You are probably wondering why we need to recognize the MIME type?
</p>

<p>
In many protocols such as HTTP or emails, we are able to transfer files. The usual way is to let the sender tell the
MIME type of the transfered files. A concrete example is the <code>Content-Type</code> field used by HTTP. Indeed, it tells the
client the MIME type of the given document - and by this way, the client is able to open this document with the right
application.
</p>

<p>
This is where <code>libmagic</code> comes in and tries to recognize the MIME type as the part of the request's processes of the
server to transfer an image for example.
</p>

<p>
We aim to have less and less C codes, so we started to re-implement <code>file</code> as our tool to recognize files and let our
HTTP server inform the MIME type to the client. Then, instead of trusting the extension of the given file and our
database, we started to propose something <span class="underline">more secure</span>.
</p>

<p>
Finally, we took the opportunity to re-use the existing database (under the 2-clause BSD license) for our project
(and provide a simple tool <code>conan.file</code> which does the same thing than <code>file</code>). So the challenge was to enable to
parse and process this database - and create a little DSL in OCaml to describe format of files.
</p>
</div>
</div>

<div id="outline-container-orgea285bc" class="outline-4">
<h4 id="orgea285bc">Into MirageOS</h4>
<div class="outline-text-4" id="text-orgea285bc">
<p>
With this DSL, we are able to serialize a given database (as the <code>libmagic</code> database) as a simple OCaml value which
can be linked to a larger program such as an unikernel. In this way, we are able to create a full unikernel which is
able to recognize MIME type of some contents.
</p>

<p>
The goal is bigger than that because such little piece of software, as we said, is used by many protocols. Of course,
our goal is to integrate our <code>conan</code> library into our HTTP server and be enable it to transfer files regardless of
extensions/user's inputs.
</p>

<p>
You can see an example here: <a href="https://github.com/mirage/conan/blob/381b7e8622397f0093e40884ecc4a713b282c6d1/unikernel/unikernel.ml">unikernel.ml</a>
</p>

<p>
We made an optimization into the given database to keep only MIME informations. Indeed, <code>file</code> tells more than MIME
type. It gives a full description of the file such as the size of the image or the bitrate of the music. Of course,
for a programmatic use, these informations is useless. So we deleted all of these informations and we finally are
able to make a simple statically-linked unikernel of ~6.5 Mb.
</p>
</div>
</div>

<div id="outline-container-org6e45535" class="outline-4">
<h4 id="org6e45535">Re-update an old project</h4>
<div class="outline-text-4" id="text-org6e45535">
<p>
The <code>file</code> command is <b><b>pretty</b></b> old (1987) and it's implemented with C. A standard of the DSL does not really exists
and, of course, it does not take the advantage of a type system such as OCaml. Indeed, the DSL consists into:
</p>
<ol class="org-ol">
<li>an offset into the given file</li>
<li>a "type" of the value at this offset</li>
<li>a test to compare this value</li>
<li>a part of the resultat description which can print the value</li>
</ol>

<p>
For an OCaml developper, it's sure that we can not mix potatoes and carrot for our salad (even if it's
<a href="http://m.middleeastkitchen.com/salads/tunisiancarrotpotato.html">good</a>). Indeed, for us, the value has a type <code>'a</code>, the test must be <code>'a -&gt; 'a -&gt; bool</code> and the description
must take an <code>'a</code> value to print it.
</p>

<p>
So <code>conan</code> (despite <a href="https://ocaml.org/meetings/ocaml/2013/slides/vaugon.pdf"><code>Format</code></a>) is a nice example of the GADT power to keep along the process the same type as long
as we are able to prove that the description of a format is <span class="underline">well typed</span>. When we started to implement the DSL, we
focused on its implementation via GADTs to keep the type information and to be not wrong when we want to compare
value from the given file and the database - of course, we tweak some details about the description which rely on the
C-like <code>printf</code>.
</p>

<p>
This is the major advantage between <code>file</code> and <code>conan</code> where we are more reliable about what we consume and what we
do to recognize a file.
</p>

<p>
Then, as we said and specially for the MirageOS project, we decided to abstract <span class="underline">syscalls</span> (or functions to get
values from a file) to be able to use <code>conan</code> into an unikernel. It's more about design and <code>conan</code> is obviously
compatible with <code>lwt</code>, <code>async</code> (or <code>multicore</code>). But it let an usage of the file recognition in many contexts
(MirageOS, Linux or Windows?).
</p>

<p>
Finally, such design splits well the project into multiples part where the core is only about the DSL and derivation
of <code>conan</code> (such as <code>conan-unix</code> or <code>conan-lwt</code>) are more about accesses &amp; file representation into specific
contexts.
</p>

<p>
As other MirageOS projects, we implemented a fuzzer which checks that the recognition never breaks the control flow
via an exception from an unimplemented feature and we tried to implement tests as much as we can.
</p>
</div>
</div>

<div id="outline-container-orgdcd6857" class="outline-4">
<h4 id="orgdcd6857">Status of the project</h4>
<div class="outline-text-4" id="text-orgdcd6857">
<p>
The project is usable as its first release. However, we did not implemented the whole <code>libmagic</code> because:
</p>
<ol class="org-ol">
<li>it's not really essential for our purpose</li>
<li>it's buggy from the type-system point-of-view</li>
</ol>

<p>
That mostly means that, given the <code>libmagic</code>'s database, we are not sure to handle all cases. And it's probable that
an error still occurs for some patterns. But this is where you come. We definitely need a large usage of <code>conan</code> to
improve it <span class="underline">via</span> an interaction loop between you and us.
</p>

<p>
So we advise you that <code>conan</code> can fails and you should be aware about its usage. However, we ensure that we want to
improve it by times and we need you to help us about that.
</p>
</div>
</div>
</div>
</div>




<div id="outline-container-4" class="outline-2">
<h2 id="4">Software Engineer Position at OCamlPro (France)</h2>
<div class="outline-text-2" id="text-4">
<p>
Archive: <a href="https://discuss.ocaml.org/t/job-internship-software-engineer-position-at-ocamlpro-france/8665/1">https://discuss.ocaml.org/t/job-internship-software-engineer-position-at-ocamlpro-france/8665/1</a>
</p>
</div>

<div id="outline-container-org41fc8e9" class="outline-3">
<h3 id="org41fc8e9">Fabrice Le Fessant announced</h3>
<div class="outline-text-3" id="text-org41fc8e9">
<p>
OCamlPro is a Paris-based company devoted to the promotion of the
OCaml language in the industry, as a way to make industrial software
more reliable. In the last 10 years, OCamlPro contributed many
developments to the OCaml community, from open-source tooling (like
the OPAM package manager, ocp-indent, Flambda compiler optimizations,
Learn-OCaml website, etc.) to new industrial projects like the Tezos
blockchain.
</p>

<p>
We are looking for motivated OCaml (and Rust) programmers in our two
main axis of development:
</p>

<ul class="org-ul">
<li><p>
OCaml Software Development: we develop software in OCaml and Rust
for our customers, with a focus on reliability and language
design. We are working on a large range of applications, so
developers with a broad knowledge and experience in various domains
are highly welcome. We hire both junior developers, starting at the
M2 level, to senior developers with longer experience in the
industry.
</p>

<p>
For M2 students, we propose internships (check
<a href="https://www.ocamlpro.com/fr/recrutement-ocamlpro/">https://www.ocamlpro.com/fr/recrutement-ocamlpro/</a> for updates !)
</p></li>

<li>Formal Methods Development: we develop formal methods software and
use them in industrial contexts for software verification. Our work
is currently mostly focused around the use of the Why3 toolchain,
the development of SMT solvers, and their application to the
verification of real programs, such as Solidity smart contracts in
the FreeTON blockchain. We usually hire developers with PhDs in
formal methods, and M2 students interested in research internships
followed by industrial Phds.</li>
</ul>

<p>
Our team is mostly based in Paris, but we are remote-friendly as soon as
regular stays in Paris are possible for team building.
</p>

<p>
Please email your resume or C.V. and a description of some of your
best accomplishments to: contact@ocamlpro.com
</p>

<p>
<a href="http://www.ocamlpro.com/">http://www.ocamlpro.com/</a>
</p>
</div>
</div>
</div>




<div id="outline-container-5" class="outline-2">
<h2 id="5">New version of Try OCaml</h2>
<div class="outline-text-2" id="text-5">
<p>
Archive: <a href="https://discuss.ocaml.org/t/ann-new-version-of-try-ocaml/8666/1">https://discuss.ocaml.org/t/ann-new-version-of-try-ocaml/8666/1</a>
</p>
</div>

<div id="outline-container-org7148ee7" class="outline-3">
<h3 id="org7148ee7">OCamlPro announced</h3>
<div class="outline-text-3" id="text-org7148ee7">
<p>
OCamlPro is happy to announce a new version of <a href="https://try.ocaml.pro/">TryOCaml</a>!
</p>

<p>
It features the latest version of OCaml, allows easy sharing of snippets of code and brings many other usability
improvements besides a renewed stylesheet.
</p>

<p>
<a href="https://gitlab.ocamlpro.com/OCamlPro/learn-ocaml">https://gitlab.ocamlpro.com/OCamlPro/learn-ocaml</a>
</p>
</div>
</div>
</div>




<div id="outline-container-6" class="outline-2">
<h2 id="6">Well Typed Router (wtr, wtr-ppx) v3.0.0 released</h2>
<div class="outline-text-2" id="text-6">
<p>
Archive: <a href="https://discuss.ocaml.org/t/ann-well-typed-router-wtr-wtr-ppx-v3-0-0-released/8675/1">https://discuss.ocaml.org/t/ann-well-typed-router-wtr-wtr-ppx-v3-0-0-released/8675/1</a>
</p>
</div>

<div id="outline-container-orgf17e172" class="outline-3">
<h3 id="orgf17e172">Bikal Lem announced</h3>
<div class="outline-text-3" id="text-orgf17e172">
<p>
I am pleased to announce v3.0.0 release of <code>wtr (Well Typed Router)</code> . <code>wtr</code> is a trie-based router for OCaml HTTP
web applications.
</p>

<p>
v3.0.0 introduces a set of combinators(functions) for specifying routes/router. This is in addition to the <code>ppx</code>
mechanism which is now available in a separate package <code>wtr-ppx</code>.  Let me give you a small example of the new
functionalities.
</p>

<p>
Let's assume we want to match the following HTTP target/url:
</p>
<pre class="example" id="orgd8d3ce2">
/hello/true?i=233&amp;s=str1
/hello/false?i=-1234&amp;s=str2
</pre>
<p>
This is how it can be implemented via the new combinators:
</p>

<div class="org-src-container">
<pre class="src src-ocaml"><span style="color: #000000; font-weight: bold;">let</span> <span style="color: #a0522d;">target2</span> = <span style="color: #228b22;">Wtr.</span>(exact <span style="color: #8b2252;">"hello"</span> / bool /? qint <span style="color: #8b2252;">"i"</span> / qstring <span style="color: #8b2252;">"s"</span> /<span style="color: #a52a2a;">?.</span> ())
</pre>
</div>
<p>
and correspondingly via the ppx:
</p>
<div class="org-src-container">
<pre class="src src-ocaml"><span style="color: #000000; font-weight: bold;">let</span> <span style="color: #a0522d;">target2</span> = {<span style="color: #a52a2a;">%</span>routes|  /hello/:bool?i=:int<span style="color: #a52a2a;">&amp;</span>s=:string  |} about_page
</pre>
</div>
<p>
Other notable changes are:
</p>
<ul class="org-ul">
<li>Addition of <code>pretty printers</code> of routes and router to aid in the debugging and usage in <code>utop</code></li>
<li>Massive overhaul of the documentation which include both the prose and the addition of examples/samples.</li>
</ul>

<p>
 
</p>

<ul class="org-ul">
<li><a href="https://lemaetech.co.uk/wtr/">Manual/API</a></li>
<li><a href="https://github.com/lemaetech/wtr/blob/main/CHANGES.md#v300-2021-10-20">v3.0.0 Changes</a></li>
</ul>
</div>
</div>
</div>




<div id="outline-container-7" class="outline-2">
<h2 id="7">containers 3.6</h2>
<div class="outline-text-2" id="text-7">
<p>
Archive: <a href="https://discuss.ocaml.org/t/ann-containers-3-6/8677/1">https://discuss.ocaml.org/t/ann-containers-3-6/8677/1</a>
</p>
</div>

<div id="outline-container-orgd1be409" class="outline-3">
<h3 id="orgd1be409">Simon Cruanes announced</h3>
<div class="outline-text-3" id="text-orgd1be409">
<p>
Containers 3.6 has just been merged on opam. Containers is a stdlib extension (not replacement) that aims at being
lightweight, fast, and modular. This release comes with a renaming of <code>CCOpt</code> to <code>CCOption</code> (and associated
deprecation, although it will not happen before 4.0), along with bugfixes and a revamp of the <code>CCParse</code> module.
</p>

<p>
The new <code>CCParse</code> is a small library of parser combinators that ships directly with <code>containers</code>, and is intended for
small parsers (where <code>scanf</code> would be used otherwise, typically). In particular, I've tried to make it possible to
mix "regular" forward parsers, and ad-hoc parsers based on splitting input on tokens (e.g. splitting into lines,
splitting on a separator like <code>,</code>, etc.). The API is
<a href="https://c-cube.github.io/ocaml-containers/3.6/containers/CCParse/index.html">here</a> and there are some examples:
</p>
<ul class="org-ul">
<li>a <a href="https://github.com/c-cube/ocaml-containers/blob/master/examples/ccparse_sexp.ml">tiny S-expression parser</a></li>
<li>an <a href="https://github.com/c-cube/ocaml-containers/blob/master/examples/ccparse_irclogs_real.cond.ml">IRC log parser</a> (for weechat logs) that also illustrates the use of let-operators.</li>
</ul>

<p>
This module is still pretty experimental, so feedback is very welcome. Special thanks to @Fardale for his review.
</p>

<p>
Changelog and release are <a href="https://github.com/c-cube/ocaml-containers/releases/tag/v3.6">here</a>.
</p>
</div>
</div>
</div>




<div id="outline-container-8" class="outline-2">
<h2 id="8">ocaml-annot for binary annotations</h2>
<div class="outline-text-2" id="text-8">
<p>
Archive: <a href="https://discuss.ocaml.org/t/ann-ocaml-annot-for-binary-annotations/8683/1">https://discuss.ocaml.org/t/ann-ocaml-annot-for-binary-annotations/8683/1</a>
</p>
</div>

<div id="outline-container-orgb9228d2" class="outline-3">
<h3 id="orgb9228d2">rixed announced</h3>
<div class="outline-text-3" id="text-orgb9228d2">
<p>
If, like me, you loved the convenience of <a href="https://github.com/avsm/ocaml-annot">ocaml-annot</a> from a time where
annotations were stored as mere text files, you might want to try
<a href="https://github.com/rixed/ocaml-bin-annot">ocaml-bin-annot</a>, that does about the same thing with binary annotations.
</p>

<p>
In other words, <code>bin-annot -type lineno colno file.cmt</code> will print the type at the given location, which comes handy
in an editor and much simpler to configure than merlin.
</p>

<p>
I haven't tested on many cases or many compilers yet though, it's still only a one day project so do not expect too
much.
</p>

<p>
The main differences that I can see between <code>annot</code> and <code>bin-annot</code>:
</p>

<ul class="org-ul">
<li><code>bin-annot</code> is tied to a specific version of the OCaml compiler because of Marshalled cmt files, whereas <code>annot</code> can be installed once and forgotten;</li>
<li><code>bin-annot</code> is ten times larger than <code>annot</code>, again because it has to embed the compiler libs.</li>
</ul>
</div>
</div>
</div>




<div id="outline-container-9" class="outline-2">
<h2 id="9">shuttle v0.3.1 released</h2>
<div class="outline-text-2" id="text-9">
<p>
Archive: <a href="https://discuss.ocaml.org/t/ann-shuttle-v0-3-1-released/8684/1">https://discuss.ocaml.org/t/ann-shuttle-v0-3-1-released/8684/1</a>
</p>
</div>

<div id="outline-container-org4573a13" class="outline-3">
<h3 id="org4573a13">Anurag Soni announced</h3>
<div class="outline-text-3" id="text-org4573a13">
<p>
I'd like to announce the release of version 0.3.1 of <a href="https://github.com/anuragsoni/shuttle">shuttle</a>.
</p>

<p>
Installation: <code>opam install shuttle</code>
</p>

<p>
<b>Shuttle</b> provides an API for buffered I/O for applications using
<a href="https://opensource.janestreet.com/async/">async</a>. It fills the same role as the Reader/Writer modules from async,
but only supports file descriptors that support non blocking IO. Feature parity with the reader/writer modules is a
non-goal.
</p>

<p>
The library grew out of experiments in replacing manually orchestrated buffer management in some of my older async
based applications. The goal is to have a high level api that gives a similar api as reader/writer modules, while
providing a little more control over how/when the writes are scheduled. Credits for the idea go to the Janestreet
engineers and their implementation of a low latency transport that's used in <code>async_rpc</code>.
</p>

<p>
The initial release consists of:
</p>

<ol class="org-ol">
<li>Shuttle -&gt; This is the core library that contains the channel implementation</li>
<li>Shuttle_ssl -&gt; Encrypted channels using <code>async_ssl</code></li>
<li>Shuttle_http -&gt; Httpaf driver that uses <code>shuttle</code> instead of <code>httpaf-async</code>. Experimental module mostly used for testing, and some performance benchmarks.</li>
</ol>

<p>
<b>Additional Notes:</b>
</p>

<ul class="org-ul">
<li>The httpaf driver has been contributed as a candidate for the http benchmarks maintained by the ocaml-multicore project -&gt; <a href="https://discuss.ocaml.org/t/multicore-ocaml-september-2021-effect-handlers-will-be-in-ocaml-5-0/8554#benchmarks-22">https://discuss.ocaml.org/t/multicore-ocaml-september-2021-effect-handlers-will-be-in-ocaml-5-0/8554#benchmarks-22</a></li>
<li>For most use-cases people should still default to the Reader/Writer modules from async_unix. They are battle tested and cover a lot more use-cases.</li>
<li>Future work will involve adding a driver for <code>ocaml-tls</code>, and adding minimal windows support mostly to allow at-least being able to build/develop shuttle based libraries on windows.</li>
</ul>
</div>
</div>
</div>




<div id="outline-container-10" class="outline-2">
<h2 id="10">Generating static and portable executables with OCaml</h2>
<div class="outline-text-2" id="text-10">
<p>
Archive: <a href="https://discuss.ocaml.org/t/generating-static-and-portable-executables-with-ocaml/8405/9">https://discuss.ocaml.org/t/generating-static-and-portable-executables-with-ocaml/8405/9</a>
</p>
</div>

<div id="outline-container-org7af61d5" class="outline-3">
<h3 id="org7af61d5">Continuing this old thread, Robin Björklin announced</h3>
<div class="outline-text-3" id="text-org7af61d5">
<p>
Thanks for a great article!
</p>

<p>
If anyone is curious what a complete example looks like I published a project with Github actions to release a static
binary here: <a href="https://github.com/rbjorklin/throttle-fstrim">https://github.com/rbjorklin/throttle-fstrim</a>
</p>
</div>
</div>
</div>




<div id="outline-container-11" class="outline-2">
<h2 id="11">"Parsing" terms into a well-typed representation: a GADT puzzle</h2>
<div class="outline-text-2" id="text-11">
<p>
Archive: <a href="https://discuss.ocaml.org/t/parsing-terms-into-a-well-typed-representation-a-gadt-puzzle/8688/1">https://discuss.ocaml.org/t/parsing-terms-into-a-well-typed-representation-a-gadt-puzzle/8688/1</a>
</p>
</div>

<div id="outline-container-org8451ce3" class="outline-3">
<h3 id="org8451ce3">gasche explained</h3>
<div class="outline-text-3" id="text-org8451ce3">
<p>
The haskell reddit had <a href="https://www.reddit.com/r/haskell/comments/qent02/parse_debruijn_indices/">a GADT programming
puzzle</a> yesterday, and I wrote a solution
in OCaml which I thought could be worth sharing. (For a primer on GADTs, see <a href="https://ocaml.org/manual/gadts-tutorial.html">the tutorial in the
manual</a>.)
</p>
</div>

<div id="outline-container-org7969d29" class="outline-4">
<h4 id="org7969d29">The problem</h4>
<div class="outline-text-4" id="text-org7969d29">
<p>
The author has a GADT that represents well-scoped, well-typed lambda-terms, which is nice as it captures the
structure of the data very well.
</p>

<div class="org-src-container">
<pre class="src src-ocaml"><span style="color: #000000; font-weight: bold;">type</span> <span style="color: #228b22;">('e, 'a) idx</span> =
  | <span style="color: #000000; background-color: #ffffff;">Zero</span> : (('e * 'a), 'a) idx
  | <span style="color: #000000; background-color: #ffffff;">Succ</span> : ('e, 'a) idx -&gt; ('e * 'b, 'a) idx

<span style="color: #000000; font-weight: bold;">type</span> <span style="color: #228b22;">('e, 'a) texp</span> =
  | <span style="color: #000000; background-color: #ffffff;">Var</span> : ('e, 'a) idx -&gt; ('e, 'a) texp
  | <span style="color: #000000; background-color: #ffffff;">Lam</span> : (('e * 'a), 'b) texp -&gt; ('e, 'a -&gt; 'b) texp
  | <span style="color: #000000; background-color: #ffffff;">App</span> : ('e, 'a -&gt; 'b) texp * ('e, 'a) texp -&gt; ('e, 'b) texp
</pre>
</div>

<p>
With this representation, <code>'e</code> represents a type environment, and <code>'a</code> represents the type of a term. For example,
<code>fun (x : 'a) -&gt; fun (y : 'b) -&gt; x</code> would be written as <code>Lam (Lam (Var (Succ Zero)))</code>, whose type is <code>('e, 'a -&gt; 'b
-&gt; 'a) texp</code>: in any environment <code>'e</code>, this term has type <code>'a -&gt; 'b -&gt; 'a</code>. The result of the function <code>y</code> is
represented by <code>Var (Succ Zero)</code>, of type <code>(('e * 'a) * 'b, 'a) texp</code>: in an environment that extends <code>'e</code> with a
first variable of type <code>'a</code> and a second variable of type <code>'b</code>, this term has type <code>'a</code>. <code>Zero</code> means "the last
variable introduced in the context", and <code>Succ Zero</code> means "the variable before that", so here the variable of type
<code>'a</code>. (This representation of variables by numbers, with 0 being the last variable, is standard in
programming-language theory, it is called "De Bruijn indices".)
</p>

<p>
<b>Problem</b>: we have seen how to express a fixed, well-typed term, but how could we turn an arbitrary term provided
at runtime (say, as a s-expression or a parse-tree) into this highly-structured implementation?
</p>

<p>
Implementing a parser for lambda-terms is rather standard, but here we are trying to do the next step, to implement a
"parser" from a standard AST to this well-typed GADT representation.
</p>

<p>
Suppose we start from the following representation, which may have been "parsed" from some input string from a
standard parser:
</p>

<div class="org-src-container">
<pre class="src src-ocaml"><span style="color: #000000; font-weight: bold;">type</span> <span style="color: #228b22;">uty</span> =
  | <span style="color: #000000; background-color: #ffffff;">Unit</span>
  | <span style="color: #000000; background-color: #ffffff;">Arr</span> <span style="color: #a020f0;">of</span> uty * uty

<span style="color: #000000; font-weight: bold;">type</span> <span style="color: #228b22;">uexp</span> =
  | <span style="color: #000000; background-color: #ffffff;">Var</span> <span style="color: #a020f0;">of</span> int
  | <span style="color: #000000; background-color: #ffffff;">Lam</span> <span style="color: #a020f0;">of</span> uty * uexp
  | <span style="color: #000000; background-color: #ffffff;">App</span> <span style="color: #a020f0;">of</span> uexp * uexp
</pre>
</div>

<p>
Can we write a function that converts an <code>uexp</code> (untyped expression) into a <code>('e, 'a) texp</code> (typed expression) for
some <code>'a</code>?
</p>

<p>
If you want to take this post as a puzzle for yourself, feel free to stop here and try to solve the problem. In the
next section I'm going to explain just the high-level details of my solution (types and type signatures), so you can
still have fun implementing the actual functions. The post ends with my full code.
</p>
</div>
</div>

<div id="outline-container-org14367dd" class="outline-4">
<h4 id="org14367dd">Sketch of a solution</h4>
<div class="outline-text-4" id="text-org14367dd">
</div>
<div id="outline-container-org05c024f" class="outline-5">
<h5 id="org05c024f">Singleton datatypes</h5>
<div class="outline-text-5" id="text-org05c024f">
<p>
To "parse" an untyped expression into a well-typed GADT, we are in fact implementing a type-checker. We can think of
implementing a type-checker without any GADT stuff: we need to traverse the type, maintain information about the
typing environment, and sometimes check equalities between types (for the application form <code>App(f, arg)</code>, the input
type of <code>f</code> must be equal to the type of <code>arg</code>). Then the general idea is to do exactly the same thing, in a
"type-enriched" way: our code needs to propagate type-level information to build our GADT at the same time.
</p>

<p>
For example, instead of an "untyped" representation of the environment, that would be basically <code>uty list</code>, we will
use a GADT-representation of the environment, with the same runtime information but richer static types:
</p>

<div class="org-src-container">
<pre class="src src-ocaml"><span style="color: #000000; font-weight: bold;">type</span> <span style="color: #228b22;">'a ty</span> =
  | <span style="color: #000000; background-color: #ffffff;">Unit</span> : unit ty
  | <span style="color: #000000; background-color: #ffffff;">Arr</span> : 'a ty * 'b ty -&gt; ('a -&gt; 'b) ty

<span style="color: #000000; font-weight: bold;">type</span> <span style="color: #228b22;">'e env</span> =
  | <span style="color: #000000; background-color: #ffffff;">Empty</span> : unit env
  | <span style="color: #000000; background-color: #ffffff;">Cons</span> : 'e env * 'a ty -&gt; ('e * 'a) env
</pre>
</div>

<p>
Notice in particular how <code>'a ty</code> gives a dynamic/runtime value that encodes the content of the type <code>'a</code>. (I made the
choice to restrict the language type system to a single base type, <code>Unit</code>; we could add more constants/primitive
types, but embedding any OCaml type would be more difficult for reasons that will show up soon.)
</p>
</div>
</div>

<div id="outline-container-orgf9ef956" class="outline-5">
<h5 id="orgf9ef956">Typeful equality checking</h5>
<div class="outline-text-5" id="text-orgf9ef956">
<p>
We cannot write OCaml code that checks, at runtime, whether <code>'a</code> and <code>'b</code> are the same type, but we can check whether
two values of type <code>'a ty</code> and <code>'b ty</code> are equal. In fact, when they are, we can even get a <b>proof</b> (as a GADT) that
<code>'a = 'b</code>:
</p>

<div class="org-src-container">
<pre class="src src-ocaml"><span style="color: #b22222;">(* </span><span style="color: #b22222;">a value of type ('a, 'b) eq is a proof that ('a = 'b) </span><span style="color: #b22222;">*)</span>
<span style="color: #000000; font-weight: bold;">type</span> <span style="color: #228b22;">(_, _) eq</span> = <span style="color: #000000; background-color: #ffffff;">Refl</span> : ('a, 'a) eq

<span style="color: #a020f0;">exception</span> <span style="color: #000000; background-color: #ffffff;">Clash</span>
<span style="color: #b22222;">(* </span><span style="color: #b22222;">ensures that (a = b) or raises Clash </span><span style="color: #b22222;">*)</span>
<span style="color: #000000; font-weight: bold;">let</span> <span style="color: #000000; font-weight: bold;">rec</span> <span style="color: #a0522d;">eq_ty</span> :<span style="color: #228b22;"> </span><span style="color: #a020f0;">type</span><span style="color: #228b22;"> a b . a ty -&gt; b ty -&gt; (a, b) eq </span>= ...
</pre>
</div>
</div>
</div>

<div id="outline-container-org0f710d2" class="outline-5">
<h5 id="org0f710d2">Existential packing</h5>
<div class="outline-text-5" id="text-org0f710d2">
<p>
Our type-checking function will get a type environent <code>'e env</code> and an untyped expression <code>uexp</code>, and it should
produce some <code>('e, 'a) texp</code> &#x2013; or fail with an exception. But if the <code>uexp</code> is produced at runtime, we don't know
what its type <code>'a</code> will be. To represent this, we use an "existential packing" of our type <code>('e, 'a) texp</code>:
</p>

<div class="org-src-container">
<pre class="src src-ocaml"><span style="color: #000000; font-weight: bold;">type</span> <span style="color: #228b22;">'e some_texp</span> = <span style="color: #000000; background-color: #ffffff;">Exp</span> : 'a ty * ('e, 'a) texp -&gt; 'e some_texp
</pre>
</div>

<p>
The type <code>'e some_texp</code> morally expresses <code>exists 'a. ('e, 'a) texp</code>; this is a standard GADT programming pattern.
</p>

<p>
 Notice the <code>'a ty</code> argument, which gives us a runtime witness/singleton for the type <code>'a</code>: <code>'a</code> is unknown, but we
have a dynamic representation of it that we can use for printing, equality checking etc. (And our unknown <code>'a</code> is
restricted to the subset of types that can be valid parameters of <code>'a ty</code>.) This is a standard extension of the
standard pattern, which one may call "existential packing with dynamic witness".
</p>

<p>
In fact, we will need "existential packings" of some other GADTs that
will be dynamically produced by our type-checker.
</p>

<div class="org-src-container">
<pre class="src src-ocaml"><span style="color: #000000; font-weight: bold;">type</span> <span style="color: #228b22;">some_ty</span> = <span style="color: #000000; background-color: #ffffff;">Ty</span> : 'a ty -&gt; some_ty
<span style="color: #000000; font-weight: bold;">type</span> <span style="color: #228b22;">'e some_idx</span> = <span style="color: #000000; background-color: #ffffff;">Idx</span> : 'a ty * ('e, 'a) idx -&gt; 'e some_idx
</pre>
</div>

<p>
We can "parse" an untyped <code>uty</code> value into a well-typed <code>'a ty</code> value, in fact its existential counterpart <code>some_ty</code>:
</p>

<div class="org-src-container">
<pre class="src src-ocaml"><span style="color: #000000; font-weight: bold;">let</span> <span style="color: #000000; font-weight: bold;">rec</span> <span style="color: #0000ff;">check_ty</span> :<span style="color: #228b22;"> uty -&gt; some_ty </span>= <span style="color: #a020f0;">function</span>
  ...
</pre>
</div>
</div>
</div>

<div id="outline-container-org374c8da" class="outline-5">
<h5 id="org374c8da">Type-checking functions</h5>
<div class="outline-text-5" id="text-org374c8da">
<p>
Given a type environment <code>'e env</code>, we can "typecheck" an untyped variable (De Bruijn index) of type <code>int</code> into a
well-typed representation <code>('e, 'a) idx</code> for some unknown <code>'a</code> determined at runtime.
</p>

<div class="org-src-container">
<pre class="src src-ocaml"><span style="color: #a020f0;">exception</span> <span style="color: #000000; background-color: #ffffff;">Ill_scoped</span>
<span style="color: #000000; font-weight: bold;">let</span> <span style="color: #000000; font-weight: bold;">rec</span> <span style="color: #a0522d;">check_var</span> :<span style="color: #228b22;"> </span><span style="color: #a020f0;">type</span><span style="color: #228b22;"> e . e env -&gt; int -&gt; e some_idx </span>=
  <span style="color: #a020f0;">fun</span> <span style="color: #a0522d;">env</span> <span style="color: #a0522d;">n</span> -&gt;
    ...
</pre>
</div>

<p>
If the integer <code>n</code> is out of bounds (negative or above the environment size), the function raises an <code>Ill_scoped</code>
exception. It is not standard to use untyped exception for error-handling in this kind of programs, but extremely
convenient &#x2013; it lets us write <code>let (Idx (ty, var)) = check_var env n in ...</code>, instead of having to both with
options, <code>result</code> or some other error monad. There is not enough information in our exceptions to provide decent
error messages, but who needs decent error messages, right?
</p>

<p>
Finally we can write the main typechecking function for expressions:
</p>

<div class="org-src-container">
<pre class="src src-ocaml"><span style="color: #a020f0;">exception</span> <span style="color: #000000; background-color: #ffffff;">Ill_typed</span>
<span style="color: #000000; font-weight: bold;">let</span> <span style="color: #000000; font-weight: bold;">rec</span> <span style="color: #a0522d;">check</span> :<span style="color: #228b22;"> </span><span style="color: #a020f0;">type</span><span style="color: #228b22;"> a e. e env -&gt; uexp -&gt; e some_texp </span>=
  <span style="color: #a020f0;">fun</span> <span style="color: #a0522d;">env</span> <span style="color: #a0522d;">exp</span> -&gt;
    ...
</pre>
</div>

<p>
Example:
</p>

<div class="org-src-container">
<pre class="src src-ocaml"># check <span style="color: #000000; background-color: #ffffff;">Empty</span> (<span style="color: #000000; background-color: #ffffff;">Lam</span> (<span style="color: #000000; background-color: #ffffff;">Unit</span>, <span style="color: #000000; background-color: #ffffff;">Lam</span> (<span style="color: #000000; background-color: #ffffff;">Unit</span>, <span style="color: #000000; background-color: #ffffff;">Var</span> 1)))<span style="color: #ff4500;">;;</span>
- : unit some_texp =
<span style="color: #000000; background-color: #ffffff;">Exp</span> (<span style="color: #000000; background-color: #ffffff;">Arr</span> (<span style="color: #000000; background-color: #ffffff;">Unit</span>, <span style="color: #000000; background-color: #ffffff;">Arr</span> (<span style="color: #000000; background-color: #ffffff;">Unit</span>, <span style="color: #000000; background-color: #ffffff;">Unit</span>)), <span style="color: #000000; background-color: #ffffff;">Lam</span> (<span style="color: #000000; background-color: #ffffff;">Lam</span> (<span style="color: #000000; background-color: #ffffff;">Var</span> (<span style="color: #000000; background-color: #ffffff;">Succ</span> <span style="color: #000000; background-color: #ffffff;">Zero</span>))))
</pre>
</div>
</div>
</div>

<div id="outline-container-org81c819f" class="outline-5">
<h5 id="org81c819f">Full code</h5>
<div class="outline-text-5" id="text-org81c819f">
<div class="org-src-container">
<pre class="src src-ocaml"><span style="color: #b22222;">(* </span><span style="color: #b22222;">well-typed representations </span><span style="color: #b22222;">*)</span>
<span style="color: #000000; font-weight: bold;">type</span> <span style="color: #228b22;">('e, 'a) idx</span> =
  | <span style="color: #000000; background-color: #ffffff;">Zero</span> : (('e * 'a), 'a) idx
  | <span style="color: #000000; background-color: #ffffff;">Succ</span> : ('e, 'a) idx -&gt; ('e * 'b, 'a) idx

<span style="color: #000000; font-weight: bold;">type</span> <span style="color: #228b22;">('e, 'a) texp</span> =
  | <span style="color: #000000; background-color: #ffffff;">Var</span> : ('e, 'a) idx -&gt; ('e, 'a) texp
  | <span style="color: #000000; background-color: #ffffff;">Lam</span> : (('e * 'a), 'b) texp -&gt; ('e, 'a -&gt; 'b) texp
  | <span style="color: #000000; background-color: #ffffff;">App</span> : ('e, 'a -&gt; 'b) texp * ('e, 'a) texp -&gt; ('e, 'b) texp

<span style="color: #000000; font-weight: bold;">let</span> <span style="color: #a0522d;">example</span> = <span style="color: #000000; background-color: #ffffff;">Lam</span> (<span style="color: #000000; background-color: #ffffff;">Lam</span> (<span style="color: #000000; background-color: #ffffff;">Var</span> (<span style="color: #000000; background-color: #ffffff;">Succ</span> <span style="color: #000000; background-color: #ffffff;">Zero</span>)))

<span style="color: #b22222;">(* </span><span style="color: #b22222;">untyped representations </span><span style="color: #b22222;">*)</span>
<span style="color: #000000; font-weight: bold;">type</span> <span style="color: #228b22;">uty</span> =
  | <span style="color: #000000; background-color: #ffffff;">Unit</span>
  | <span style="color: #000000; background-color: #ffffff;">Arr</span> <span style="color: #a020f0;">of</span> uty * uty

<span style="color: #000000; font-weight: bold;">type</span> <span style="color: #228b22;">uexp</span> =
  | <span style="color: #000000; background-color: #ffffff;">Var</span> <span style="color: #a020f0;">of</span> int
  | <span style="color: #000000; background-color: #ffffff;">Lam</span> <span style="color: #a020f0;">of</span> uty * uexp
  | <span style="color: #000000; background-color: #ffffff;">App</span> <span style="color: #a020f0;">of</span> uexp * uexp

<span style="color: #b22222;">(* </span><span style="color: #b22222;">singleton types to express type-checking </span><span style="color: #b22222;">*)</span>
<span style="color: #000000; font-weight: bold;">type</span> <span style="color: #228b22;">'a ty</span> =
  | <span style="color: #000000; background-color: #ffffff;">Unit</span> : unit ty
  | <span style="color: #000000; background-color: #ffffff;">Arr</span> : 'a ty * 'b ty -&gt; ('a -&gt; 'b) ty

<span style="color: #000000; font-weight: bold;">type</span> <span style="color: #228b22;">'e env</span> =
  | <span style="color: #000000; background-color: #ffffff;">Empty</span> : unit env
  | <span style="color: #000000; background-color: #ffffff;">Cons</span> : 'e env * 'a ty -&gt; ('e * 'a) env

<span style="color: #b22222;">(* </span><span style="color: #b22222;">existential types </span><span style="color: #b22222;">*)</span>
<span style="color: #000000; font-weight: bold;">type</span> <span style="color: #228b22;">some_ty</span> = <span style="color: #000000; background-color: #ffffff;">Ty</span> : 'a ty -&gt; some_ty
<span style="color: #000000; font-weight: bold;">type</span> <span style="color: #228b22;">'e some_idx</span> = <span style="color: #000000; background-color: #ffffff;">Idx</span> : 'a ty * ('e, 'a) idx -&gt; 'e some_idx
<span style="color: #000000; font-weight: bold;">type</span> <span style="color: #228b22;">'e some_texp</span> = <span style="color: #000000; background-color: #ffffff;">Exp</span> : 'a ty * ('e, 'a) texp -&gt; 'e some_texp

<span style="color: #b22222;">(* </span><span style="color: #b22222;">dynamic type equality check </span><span style="color: #b22222;">*)</span>
<span style="color: #000000; font-weight: bold;">type</span> <span style="color: #228b22;">(_, _) eq</span> = <span style="color: #000000; background-color: #ffffff;">Refl</span> : ('a, 'a) eq
<span style="color: #a020f0;">exception</span> <span style="color: #000000; background-color: #ffffff;">Clash</span>
<span style="color: #000000; font-weight: bold;">let</span> <span style="color: #000000; font-weight: bold;">rec</span> <span style="color: #0000ff;">eq_ty</span> :<span style="color: #228b22;"> </span><span style="color: #a020f0;">type</span><span style="color: #228b22;"> a b . a ty -&gt; b ty -&gt; (a, b) eq</span>
<span style="color: #228b22;">    </span>= <span style="color: #a020f0;">fun</span> <span style="color: #a0522d;">ta</span> <span style="color: #a0522d;">tb</span> -&gt; <span style="color: #a020f0;">match</span> (ta, tb) <span style="color: #a020f0;">with</span>
    | (<span style="color: #000000; background-color: #ffffff;">Unit</span>, <span style="color: #000000; background-color: #ffffff;">Unit</span>) -&gt; <span style="color: #000000; background-color: #ffffff;">Refl</span>
    | (<span style="color: #000000; background-color: #ffffff;">Unit</span>, <span style="color: #000000; background-color: #ffffff;">Arr</span> _) | (<span style="color: #000000; background-color: #ffffff;">Arr</span> _, <span style="color: #000000; background-color: #ffffff;">Unit</span>) -&gt; <span style="color: #483d8b;">raise</span> <span style="color: #000000; background-color: #ffffff;">Clash</span>
    | (<span style="color: #000000; background-color: #ffffff;">Arr</span> (ta1, ta2), <span style="color: #000000; background-color: #ffffff;">Arr</span> (tb1, tb2)) -&gt;
      <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #000000; background-color: #ffffff;">Refl</span> = eq_ty ta1 tb1 <span style="color: #000000; font-weight: bold;">in</span>
      <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #000000; background-color: #ffffff;">Refl</span> = eq_ty ta2 tb2 <span style="color: #000000; font-weight: bold;">in</span>
      <span style="color: #000000; background-color: #ffffff;">Refl</span>

<span style="color: #b22222;">(* </span><span style="color: #b22222;">"checking" a type (no failure) </span><span style="color: #b22222;">*)</span>
<span style="color: #000000; font-weight: bold;">let</span> <span style="color: #000000; font-weight: bold;">rec</span> <span style="color: #0000ff;">check_ty</span> :<span style="color: #228b22;"> uty -&gt; some_ty </span>= <span style="color: #a020f0;">function</span>
  | <span style="color: #000000; background-color: #ffffff;">Unit</span> -&gt; <span style="color: #000000; background-color: #ffffff;">Ty</span> <span style="color: #000000; background-color: #ffffff;">Unit</span>
  | <span style="color: #000000; background-color: #ffffff;">Arr</span> (ta, tb) -&gt;
    <span style="color: #000000; font-weight: bold;">let</span> (<span style="color: #000000; background-color: #ffffff;">Ty</span> <span style="color: #a0522d;">ta</span>) = check_ty ta <span style="color: #000000; font-weight: bold;">in</span>
    <span style="color: #000000; font-weight: bold;">let</span> (<span style="color: #000000; background-color: #ffffff;">Ty</span> <span style="color: #a0522d;">tb</span>) = check_ty tb <span style="color: #000000; font-weight: bold;">in</span>
    <span style="color: #000000; background-color: #ffffff;">Ty</span> (<span style="color: #000000; background-color: #ffffff;">Arr</span> (ta, tb))

<span style="color: #b22222;">(* </span><span style="color: #b22222;">"checking" a variable </span><span style="color: #b22222;">*)</span>
<span style="color: #a020f0;">exception</span> <span style="color: #000000; background-color: #ffffff;">Ill_scoped</span>
<span style="color: #000000; font-weight: bold;">let</span> <span style="color: #000000; font-weight: bold;">rec</span> <span style="color: #a0522d;">check_var</span> :<span style="color: #228b22;"> </span><span style="color: #a020f0;">type</span><span style="color: #228b22;"> e . e env -&gt; int -&gt; e some_idx </span>=
  <span style="color: #a020f0;">fun</span> <span style="color: #a0522d;">env</span> <span style="color: #a0522d;">n</span> -&gt;
    <span style="color: #a020f0;">match</span> env <span style="color: #a020f0;">with</span>
    | <span style="color: #000000; background-color: #ffffff;">Empty</span> -&gt; <span style="color: #483d8b;">raise</span> <span style="color: #000000; background-color: #ffffff;">Ill_scoped</span>
    | <span style="color: #000000; background-color: #ffffff;">Cons</span> (env, ty) -&gt;
      <span style="color: #a020f0;">if</span> n = 0 <span style="color: #a020f0;">then</span> <span style="color: #000000; background-color: #ffffff;">Idx</span> (ty, <span style="color: #000000; background-color: #ffffff;">Zero</span>)
      <span style="color: #a020f0;">else</span>
        <span style="color: #000000; font-weight: bold;">let</span> (<span style="color: #000000; background-color: #ffffff;">Idx</span> (<span style="color: #a0522d;">tyn</span>, <span style="color: #a0522d;">idx</span>)) = check_var env (n - 1) <span style="color: #000000; font-weight: bold;">in</span>
        <span style="color: #000000; background-color: #ffffff;">Idx</span> (tyn, <span style="color: #000000; background-color: #ffffff;">Succ</span> idx)

<span style="color: #b22222;">(* </span><span style="color: #b22222;">"checking" an input expression </span><span style="color: #b22222;">*)</span>
<span style="color: #a020f0;">exception</span> <span style="color: #000000; background-color: #ffffff;">Ill_typed</span>
<span style="color: #000000; font-weight: bold;">let</span> <span style="color: #000000; font-weight: bold;">rec</span> <span style="color: #a0522d;">check</span> :<span style="color: #228b22;"> </span><span style="color: #a020f0;">type</span><span style="color: #228b22;"> a e. e env -&gt; uexp -&gt; e some_texp </span>=
  <span style="color: #a020f0;">fun</span> <span style="color: #a0522d;">env</span> <span style="color: #a0522d;">exp</span> -&gt;
    <span style="color: #a020f0;">match</span> exp <span style="color: #a020f0;">with</span>
    | <span style="color: #000000; background-color: #ffffff;">Var</span> n -&gt;
      <span style="color: #000000; font-weight: bold;">let</span> (<span style="color: #000000; background-color: #ffffff;">Idx</span> (<span style="color: #a0522d;">ty</span>, <span style="color: #a0522d;">n</span>)) = check_var env n <span style="color: #000000; font-weight: bold;">in</span>
      <span style="color: #000000; background-color: #ffffff;">Exp</span> (ty, <span style="color: #000000; background-color: #ffffff;">Var</span> n)
    | <span style="color: #000000; background-color: #ffffff;">Lam</span> (tya, exp') -&gt;
      <span style="color: #000000; font-weight: bold;">let</span> (<span style="color: #000000; background-color: #ffffff;">Ty</span> <span style="color: #a0522d;">tya</span>) = check_ty tya <span style="color: #000000; font-weight: bold;">in</span>
      <span style="color: #000000; font-weight: bold;">let</span> (<span style="color: #000000; background-color: #ffffff;">Exp</span> (<span style="color: #a0522d;">tyb</span>, <span style="color: #a0522d;">exp'</span>)) = check (<span style="color: #000000; background-color: #ffffff;">Cons</span> (env, tya)) exp' <span style="color: #000000; font-weight: bold;">in</span>
      <span style="color: #000000; background-color: #ffffff;">Exp</span> (<span style="color: #000000; background-color: #ffffff;">Arr</span> (tya, tyb), <span style="color: #000000; background-color: #ffffff;">Lam</span> exp')
    | <span style="color: #000000; background-color: #ffffff;">App</span> (exp_f, exp_arg) -&gt;
      <span style="color: #000000; font-weight: bold;">let</span> (<span style="color: #000000; background-color: #ffffff;">Exp</span> (<span style="color: #a0522d;">ty_f</span>, <span style="color: #a0522d;">exp_f</span>)) = check env exp_f <span style="color: #000000; font-weight: bold;">in</span>
      <span style="color: #000000; font-weight: bold;">let</span> (<span style="color: #000000; background-color: #ffffff;">Exp</span> (<span style="color: #a0522d;">ty_arg</span>, <span style="color: #a0522d;">exp_arg</span>)) = check env exp_arg <span style="color: #000000; font-weight: bold;">in</span>
      <span style="color: #000000; font-weight: bold;">begin</span> <span style="color: #a020f0;">match</span> ty_f <span style="color: #a020f0;">with</span>
        | <span style="color: #000000; background-color: #ffffff;">Unit</span> -&gt; <span style="color: #483d8b;">raise</span> <span style="color: #000000; background-color: #ffffff;">Ill_typed</span>
        | <span style="color: #000000; background-color: #ffffff;">Arr</span> (ty_arg', ty_res) -&gt;
          <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #000000; background-color: #ffffff;">Refl</span> = eq_ty ty_arg ty_arg' <span style="color: #000000; font-weight: bold;">in</span>
          <span style="color: #000000; background-color: #ffffff;">Exp</span> (ty_res, <span style="color: #000000; background-color: #ffffff;">App</span> (exp_f, exp_arg))
      <span style="color: #000000; font-weight: bold;">end</span>
</pre>
</div>
</div>
</div>
</div>
</div>


<div id="outline-container-orgc0466ee" class="outline-3">
<h3 id="orgc0466ee">Calascibetta Romain then said</h3>
<div class="outline-text-3" id="text-orgc0466ee">
<p>
I just would like to extend a bit your fantastic tutorial with a "toy" which does what you explain:
<a href="https://github.com/mirage/mirage-lambda">https://github.com/mirage/mirage-lambda</a> It's an unikernel which takes a lambda-calculus (via <code>protobuf</code>) and try to
<span class="underline">map</span> it into a GADT - however, this lambda-calculus is much more complex than yours. Then, it executes the given
GADT "safely" and returns the result. The most interesting part is this file:
</p>

<p>
<a href="https://github.com/mirage/mirage-lambda/blob/master/src/typedtree.mli">https://github.com/mirage/mirage-lambda/blob/master/src/typedtree.mli</a>
</p>

<p>
Note that it's an old toy (and I don't have enough times to upgrade it - but if someone want, I will happy to merge
their PRs). The initial idea was to take a lambda-calcul such as <a href="https://people.mpi-sws.org/~rossberg/1ml/">1ml</a> and map it to a GADT to finally use
<a href="https://github.com/stedolan/malfunction">malfunction</a> to emit OCaml bytecode and make my new best toy language.
</p>

<p>
However, I did not yet make a time machine to save my time and continue such interesting side-project :) !
</p>
</div>
</div>
</div>




<div id="outline-container-org21bb23a" class="outline-2">
<h2 id="org21bb23a">Old CWN</h2>
<div class="outline-text-2" id="text-org21bb23a">
<p>
If you happen to miss a CWN, you can <a href="mailto:alan.schmitt@polytechnique.org">send me a message</a> and I'll mail it to you, or go take a look at <a href="https://alan.petitepomme.net/cwn/">the archive</a> or the <a href="https://alan.petitepomme.net/cwn/cwn.rss">RSS feed of the archives</a>.
</p>

<p>
If you also wish to receive it every week by mail, you may subscribe <a href="http://lists.idyll.org/listinfo/caml-news-weekly/">online</a>.
</p>

<div class="authorname" id="org00368ae">
<p>
<a href="https://alan.petitepomme.net/">Alan Schmitt</a>
</p>

</div>
</div>
</div>
</div>
</body>
</html>
