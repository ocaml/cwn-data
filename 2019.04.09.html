<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<!-- 2019-04-09 Tue 10:32 -->
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>OCaml Weekly News</title>
<meta name="generator" content="Org mode" />
<style type="text/css">
 <!--/*--><![CDATA[/*><!--*/
  .title  { text-align: center;
             margin-bottom: .2em; }
  .subtitle { text-align: center;
              font-size: medium;
              font-weight: bold;
              margin-top:0; }
  .todo   { font-family: monospace; color: red; }
  .done   { font-family: monospace; color: green; }
  .priority { font-family: monospace; color: orange; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .org-right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .org-left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .org-center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #ccc;
    box-shadow: 3px 3px 3px #eee;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: visible;
    padding-top: 1.2em;
  }
  pre.src:before {
    display: none;
    position: absolute;
    background-color: white;
    top: -10px;
    right: 10px;
    padding: 3px;
    border: 1px solid black;
  }
  pre.src:hover:before { display: inline;}
  /* Languages per Org manual */
  pre.src-asymptote:before { content: 'Asymptote'; }
  pre.src-awk:before { content: 'Awk'; }
  pre.src-C:before { content: 'C'; }
  /* pre.src-C++ doesn't work in CSS */
  pre.src-clojure:before { content: 'Clojure'; }
  pre.src-css:before { content: 'CSS'; }
  pre.src-D:before { content: 'D'; }
  pre.src-ditaa:before { content: 'ditaa'; }
  pre.src-dot:before { content: 'Graphviz'; }
  pre.src-calc:before { content: 'Emacs Calc'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-fortran:before { content: 'Fortran'; }
  pre.src-gnuplot:before { content: 'gnuplot'; }
  pre.src-haskell:before { content: 'Haskell'; }
  pre.src-hledger:before { content: 'hledger'; }
  pre.src-java:before { content: 'Java'; }
  pre.src-js:before { content: 'Javascript'; }
  pre.src-latex:before { content: 'LaTeX'; }
  pre.src-ledger:before { content: 'Ledger'; }
  pre.src-lisp:before { content: 'Lisp'; }
  pre.src-lilypond:before { content: 'Lilypond'; }
  pre.src-lua:before { content: 'Lua'; }
  pre.src-matlab:before { content: 'MATLAB'; }
  pre.src-mscgen:before { content: 'Mscgen'; }
  pre.src-ocaml:before { content: 'Objective Caml'; }
  pre.src-octave:before { content: 'Octave'; }
  pre.src-org:before { content: 'Org mode'; }
  pre.src-oz:before { content: 'OZ'; }
  pre.src-plantuml:before { content: 'Plantuml'; }
  pre.src-processing:before { content: 'Processing.js'; }
  pre.src-python:before { content: 'Python'; }
  pre.src-R:before { content: 'R'; }
  pre.src-ruby:before { content: 'Ruby'; }
  pre.src-sass:before { content: 'Sass'; }
  pre.src-scheme:before { content: 'Scheme'; }
  pre.src-screen:before { content: 'Gnu Screen'; }
  pre.src-sed:before { content: 'Sed'; }
  pre.src-sh:before { content: 'shell'; }
  pre.src-sql:before { content: 'SQL'; }
  pre.src-sqlite:before { content: 'SQLite'; }
  /* additional languages in org.el's org-babel-load-languages alist */
  pre.src-forth:before { content: 'Forth'; }
  pre.src-io:before { content: 'IO'; }
  pre.src-J:before { content: 'J'; }
  pre.src-makefile:before { content: 'Makefile'; }
  pre.src-maxima:before { content: 'Maxima'; }
  pre.src-perl:before { content: 'Perl'; }
  pre.src-picolisp:before { content: 'Pico Lisp'; }
  pre.src-scala:before { content: 'Scala'; }
  pre.src-shell:before { content: 'Shell Script'; }
  pre.src-ebnf2ps:before { content: 'ebfn2ps'; }
  /* additional language identifiers per "defun org-babel-execute"
       in ob-*.el */
  pre.src-cpp:before  { content: 'C++'; }
  pre.src-abc:before  { content: 'ABC'; }
  pre.src-coq:before  { content: 'Coq'; }
  pre.src-groovy:before  { content: 'Groovy'; }
  /* additional language identifiers from org-babel-shell-names in
     ob-shell.el: ob-shell is the only babel language using a lambda to put
     the execution function name together. */
  pre.src-bash:before  { content: 'bash'; }
  pre.src-csh:before  { content: 'csh'; }
  pre.src-ash:before  { content: 'ash'; }
  pre.src-dash:before  { content: 'dash'; }
  pre.src-ksh:before  { content: 'ksh'; }
  pre.src-mksh:before  { content: 'mksh'; }
  pre.src-posh:before  { content: 'posh'; }
  /* Additional Emacs modes also supported by the LaTeX listings package */
  pre.src-ada:before { content: 'Ada'; }
  pre.src-asm:before { content: 'Assembler'; }
  pre.src-caml:before { content: 'Caml'; }
  pre.src-delphi:before { content: 'Delphi'; }
  pre.src-html:before { content: 'HTML'; }
  pre.src-idl:before { content: 'IDL'; }
  pre.src-mercury:before { content: 'Mercury'; }
  pre.src-metapost:before { content: 'MetaPost'; }
  pre.src-modula-2:before { content: 'Modula-2'; }
  pre.src-pascal:before { content: 'Pascal'; }
  pre.src-ps:before { content: 'PostScript'; }
  pre.src-prolog:before { content: 'Prolog'; }
  pre.src-simula:before { content: 'Simula'; }
  pre.src-tcl:before { content: 'tcl'; }
  pre.src-tex:before { content: 'TeX'; }
  pre.src-plain-tex:before { content: 'Plain TeX'; }
  pre.src-verilog:before { content: 'Verilog'; }
  pre.src-vhdl:before { content: 'VHDL'; }
  pre.src-xml:before { content: 'XML'; }
  pre.src-nxml:before { content: 'XML'; }
  /* add a generic configuration mode; LaTeX export needs an additional
     (add-to-list 'org-latex-listings-langs '(conf " ")) in .emacs */
  pre.src-conf:before { content: 'Configuration File'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.org-right  { text-align: center;  }
  th.org-left   { text-align: center;   }
  th.org-center { text-align: center; }
  td.org-right  { text-align: right;  }
  td.org-left   { text-align: left;   }
  td.org-center { text-align: center; }
  dt { font-weight: bold; }
  .footpara { display: inline; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .equation-container {
    display: table;
    text-align: center;
    width: 100%;
  }
  .equation {
    vertical-align: middle;
  }
  .equation-label {
    display: table-cell;
    text-align: right;
    vertical-align: middle;
  }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  .org-svg { width: 90%; }
  /*]]>*/-->
</style>
<style type="text/css">#table-of-contents h2 { display: none } .title { display: none } .authorname { text-align: right }</style>
<style type="text/css">.outline-2 {border-top: 1px solid black;}</style>
<script type="text/javascript">
/*
@licstart  The following is the entire license notice for the
JavaScript code in this tag.

Copyright (C) 2012-2019 Free Software Foundation, Inc.

The JavaScript code in this tag is free software: you can
redistribute it and/or modify it under the terms of the GNU
General Public License (GNU GPL) as published by the Free Software
Foundation, either version 3 of the License, or (at your option)
any later version.  The code is distributed WITHOUT ANY WARRANTY;
without even the implied warranty of MERCHANTABILITY or FITNESS
FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.

As additional permission under GNU GPL version 3 section 7, you
may distribute non-source (e.g., minimized or compacted) forms of
that code without the copy of the GNU GPL normally required by
section 4, provided you include this license notice and a URL
through which recipients can access the Corresponding Source.


@licend  The above is the entire license notice
for the JavaScript code in this tag.
*/
<!--/*--><![CDATA[/*><!--*/
 function CodeHighlightOn(elem, id)
 {
   var target = document.getElementById(id);
   if(null != target) {
     elem.cacheClassElem = elem.className;
     elem.cacheClassTarget = target.className;
     target.className = "code-highlighted";
     elem.className   = "code-highlighted";
   }
 }
 function CodeHighlightOff(elem, id)
 {
   var target = document.getElementById(id);
   if(elem.cacheClassElem)
     elem.className = elem.cacheClassElem;
   if(elem.cacheClassTarget)
     target.className = elem.cacheClassTarget;
 }
/*]]>*///-->
</script>
</head>
<body>
<div id="content">
<h1 class="title">OCaml Weekly News</h1>
<p>
<a href="http://alan.petitepomme.net/cwn/2019.04.02.html">Previous Week</a> <a href="http://alan.petitepomme.net/cwn/index.html">Up</a> <a href="http://alan.petitepomme.net/cwn/2019.04.16.html">Next Week</a>
</p>

<p>
Hello
</p>

<p>
Here is the latest OCaml Weekly News, for the week of April 02 to 09, 2019.
</p>

<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#1">Easy_logging 0.2</a></li>
<li><a href="#2">OCaml Users and Developers Meeting 2019</a></li>
<li><a href="#3">Firewall-tree - demo using MirageOS is available, with overview of current progress</a></li>
<li><a href="#4">routes: path based routing for web applications</a></li>
<li><a href="#5">Other OCaml News</a></li>
<li><a href="#org656acd0">Old CWN</a></li>
</ul>
</div>
</div>


<div id="outline-container-orgc1cdadb" class="outline-2">
<h2 id="1">Easy_logging 0.2</h2>
<div class="outline-text-2" id="text-1">
<p>
Archive: <a href="https://discuss.ocaml.org/t/easy-logging-0-2/3551/6">https://discuss.ocaml.org/t/easy-logging-0-2/3551/6</a>
</p>
</div>

<div id="outline-container-org7e2fd07" class="outline-3">
<h3 id="org7e2fd07">Sapristi announced</h3>
<div class="outline-text-3" id="text-org7e2fd07">
<p>
Version 0.4 is out  (or should be soon) :
</p>

<ul class="org-ul">
<li>printf style logging is now the default</li>
<li>simplifed configuration in case of multiple loggers (and closer to the python module) :
<ul class="org-ul">
<li>the loggers form a tree (based on their name, dots indicating descendence)</li>
<li>log items are passed to the handlers of a logger's ancestors (so that few handlers need initialisation) (possible to override)</li>
<li>loggers inherit the level of their ancestor if not set explicitely</li>
</ul></li>
<li>an additional package <code>easy_logging_yojson</code> provides initialisation of loggers from the json format (with <code>ppx_deriving_yojson</code>), so that configuration can be fully done outside the code.</li>
</ul>
</div>
</div>
</div>




<div id="outline-container-orgf8b533e" class="outline-2">
<h2 id="2">OCaml Users and Developers Meeting 2019</h2>
<div class="outline-text-2" id="text-2">
<p>
Archive: <a href="https://discuss.ocaml.org/t/ocaml-users-and-developers-meeting-2019/3620/1">https://discuss.ocaml.org/t/ocaml-users-and-developers-meeting-2019/3620/1</a>
</p>
</div>

<div id="outline-container-org59d6914" class="outline-3">
<h3 id="org59d6914">David Allsopp announced</h3>
<div class="outline-text-3" id="text-org59d6914">
<p>
I'm pleased to annouce that the 8th ICFP co-located OCaml Users and Developers Workshop will be held in Berlin on August 23rd.
</p>

<p>
The workshop is an informal occasion consisting of ~20 minute talks and a poster session on topics ranging from compiler developments, new libraries and applications through to experience reports on industrial/experimental uses of OCaml.
</p>

<p>
The <a href="https://ocaml2019.hotcrp.com">submission site</a> for talk proposals is now open and full details of the call may be found on the <a href="https://icfp19.sigplan.org/home/ocaml-2019#Call-for-Presentations">ICFP 2019 website</a>. The deadline for proposals is May 17 <a href="https://en.wikipedia.org/wiki/Anywhere_on_Earth">Anywhere on Earth</a>.
</p>
</div>
</div>
</div>




<div id="outline-container-orge74dafd" class="outline-2">
<h2 id="3">Firewall-tree - demo using MirageOS is available, with overview of current progress</h2>
<div class="outline-text-2" id="text-3">
<p>
Archive: <a href="https://discuss.ocaml.org/t/firewall-tree-demo-using-mirageos-is-available-with-overview-of-current-progress/3621/1">https://discuss.ocaml.org/t/firewall-tree-demo-using-mirageos-is-available-with-overview-of-current-progress/3621/1</a>
</p>
</div>

<div id="outline-container-org92e50e9" class="outline-3">
<h3 id="org92e50e9">Darren announced</h3>
<div class="outline-text-3" id="text-org92e50e9">
<p>
I'm very pleased to announce that <a href="https://gitlab.com/darrenldl/ocaml-firewall-tree">firewall-tree</a> library has reached a presentable stage and a demo which uses firewall-tree in MirageOS is available.
</p>
</div>

<div id="outline-container-org3772527" class="outline-4">
<h4 id="org3772527">Demo</h4>
<div class="outline-text-4" id="text-org3772527">
<p>
The demo code is available <a href="https://github.com/darrenldl/firewall-tree-demos/tree/master/demos/load-balancing-proxy">here</a>.
</p>

<p>
The code itself is quite thoroughly commented, the README in the folder contains build and run instructions and also illustrations of the tree in graphical form, so I won't dive into the details of the demo here.
</p>

<p>
In short, the demo shows how to separate of ICMP trafffic and TCP traffic. For TCP, filter some TCP traffic, then load balance the remaining TCP connections across multiple destination IPv4 addresses. For ICMP ping requests, only reply to every other one.
</p>

<p>
The tree itself is only a couple of lines, but there is quite a bit setup code for wrapping MirageOS stuff into a module and types usable by firewall-tree. However, it should be possible to package the setup code into a library supporting MirageOS as a firewall-tree backend, so in future the usage of the library should be much smoother and less cluttered than the demo.
</p>

<p>
I'd like to note that the library right now is still very rough at more complex constructs, and the connection tracker, which is used inside the translators, works fine for a very typical TCP connection, but fails to handle TCP retransmissions, or TCP PDUs with RST and PSH flags.
</p>
</div>
</div>

<div id="outline-container-org10ad414" class="outline-4">
<h4 id="org10ad414">Library overview</h4>
<div class="outline-text-4" id="text-org10ad414">
<p>
The library requires a "base", which you can think of as an environment implementation (see <a href="https://darrenldl.gitlab.io/ocaml-firewall-tree/doc/firewall-tree/Firewall_tree/module-type-B/index.html">here</a> for module type signature), which it then extends into a full firewall module. The resulting module provides the following functions/constructs
</p>
<ul class="org-ul">
<li><a href="https://darrenldl.gitlab.io/ocaml-firewall-tree/doc/firewall-tree/Firewall_tree/module-type-S/PDU/index.html">Hierarchical PDU definition</a></li>
<li><a href="https://darrenldl.gitlab.io/ocaml-firewall-tree/doc/firewall-tree/Firewall_tree/module-type-S/PDU_to/index.html">PDU decapsulation</a></li>
<li><a href="https://darrenldl.gitlab.io/ocaml-firewall-tree/doc/firewall-tree/Firewall_tree/module-type-S/PDU_map/index.html">PDU mapping</a> (can also map inner components)</li>
<li><a href="https://darrenldl.gitlab.io/ocaml-firewall-tree/doc/firewall-tree/Firewall_tree/module-type-S/PDU_replace/index.html">PDU replacement</a> (can also replace inner components)</li>
<li><a href="https://darrenldl.gitlab.io/ocaml-firewall-tree/doc/firewall-tree/Firewall_tree/module-type-S/To_debug_string/index.html">PDU pretty printing</a> (see the demo for sample output)</li>
<li><a href="https://darrenldl.gitlab.io/ocaml-firewall-tree/doc/firewall-tree/Firewall_tree/module-type-S/Lookup_table/index.html">Memory bounded lookup table</a>  with evict timed out entries function</li>
<li><a href="https://darrenldl.gitlab.io/ocaml-firewall-tree/doc/firewall-tree/Firewall_tree/module-type-S/RLU_IPv4/index.html">Routing logic unit</a> only partial implementaiton is in place currently</li>
<li><a href="https://darrenldl.gitlab.io/ocaml-firewall-tree/doc/firewall-tree/Firewall_tree/module-type-S/Conn_track/index.html">Connection tracker</a> (bidirectional, so you can use it without much thinking)
<ul class="org-ul">
<li>Largely functional, still a long way to go before becoming robust enough</li>
</ul></li>
<li><a href="https://darrenldl.gitlab.io/ocaml-firewall-tree/doc/firewall-tree/Firewall_tree/module-type-S/Pred/index.html">Predicates for building filters/selectors</a></li>
<li><a href="https://darrenldl.gitlab.io/ocaml-firewall-tree/doc/firewall-tree/Firewall_tree/module-type-S/Translator/index.html">Translators</a> for building load balancers or proxy
<ul class="org-ul">
<li>These were essentially a more general form of NAT translators when I wrote them, so hopefully they (or variant of them) can be used to build a full blown NAT at some point</li>
</ul></li>
</ul>

<p>
The package provides another set of functors which take the resulted tree module as parameter and derive commonly used constructs. See demo for example use.
</p>
<ul class="org-ul">
<li><a href="https://darrenldl.gitlab.io/ocaml-firewall-tree/doc/firewall-tree/Firewall_tree/Selectors/module-type-S/index.html">Selectors</a></li>
<li><a href="https://darrenldl.gitlab.io/ocaml-firewall-tree/doc/firewall-tree/Firewall_tree/Modifiers/module-type-S/index.html">Modifiers</a></li>
<li><a href="https://darrenldl.gitlab.io/ocaml-firewall-tree/doc/firewall-tree/Firewall_tree/Scanners/module-type-S/index.html">Scanners</a></li>
</ul>
</div>
</div>

<div id="outline-container-orgb1ce05b" class="outline-4">
<h4 id="orgb1ce05b">Moving onward</h4>
<div class="outline-text-4" id="text-orgb1ce05b">
<p>
Still a lot of things to be done, following lists a few of the items
</p>
<ul class="org-ul">
<li>TCP connection tracking needs to be fixed</li>
<li>Implement more translators, make them more modular (e.g. swappable algorithms)</li>
<li>Couple translators to form NAT modules</li>
<li>Benchmark
<ul class="org-ul">
<li>I am hoping this library doesn't slow down MirageOS too much for equivalent functionalities, but I don't have concrete benchmarks</li>
</ul></li>
</ul>
</div>
</div>

<div id="outline-container-org572b3b5" class="outline-4">
<h4 id="org572b3b5">Final thoughts</h4>
<div class="outline-text-4" id="text-org572b3b5">
<p>
The progress so far has been quite time consuming to implement, with a lot of redesigns and rewrites in-between. I am hoping the current design is sane, but I feel I've invested too much time in last couple of weeks to get a clear view of things. So I would absolutely appreciate any feedback, whether it's on API design, the architecture of the code or any other aspects.
</p>

<p>
I had some experiences with networking and firewall, but as far as implementing a network stack goes, I have zero experience, so I'd also appreciate help on components which demand such expertise as well.
</p>
</div>
</div>
</div>


<div id="outline-container-org509b26d" class="outline-3">
<h3 id="org509b26d">Hannes Mehnert asked and Darren replied</h3>
<div class="outline-text-3" id="text-org509b26d">
<p>
Thanks for reading through!
</p>

<p>
&gt; I’ve not been reading through all of your code, but you seem to <a href="https://gitlab.com/darrenldl/ocaml-firewall-tree/blob/master/src/conn_track_ip_generic_tcp.ml">have implemented 80% of a TCP stack</a> and also mention that reset handling (what about simultaneous open, (IP) fragmentation, and retransmissions?) is missing.
</p>

<ul class="org-ul">
<li>Simultaneous open
<ul class="org-ul">
<li>Uh&#x2026;uh oh, I didn't realise simultaneous open is a thing</li>
<li>This might require redesign of the TCP connection tracker as it right now assumes only one side is the initiator, and the other side must be the responder</li>
</ul></li>
<li>IP fragmentation
<ul class="org-ul">
<li>Don't think this matters too much unless the library moves toward supporting deep packet inspection?</li>
<li>But yeah this may be a problem if the library needs to support moving packets from a layer 2 segment of higher MTU to one with lower MTU? But that should be handled by the IP layer (of MirageOS) in this case</li>
<li>In any case I don't know if it should be in the scope of the library</li>
</ul></li>
<li>Retransmissions
<ul class="org-ul">
<li>From firewall perspective I think it only needs to remember seeing the PDU at some point and just allow duplicates to be sent through up to some threshold, which means collecting the hashes should suffice I hope</li>
</ul></li>
</ul>

<p>
Ideally the library is network implementation agnostic, but I can't tell if that's a reachable goal exactly considering all these intricate things.
</p>

<p>
&gt; Did you try to use mirage-tcpip instead, which already implements some of the missing pieces (at least reset handling AFAIR)?
</p>

<p>
Right now the demo itself uses <code>Tcp.Tcp_packet</code> from tcpip to handle serialisation and deserialisation, but not flow or any connection establishing components.
</p>

<p>
I can't tell if flow is suitable for firewall, since that means the unikernel needs to add 65535 listeners to cover all ports? I might be being silly here or misunderstood something, please correct me if I am.
</p>

<p>
&gt; But given the <a href="https://www.cl.cam.ac.uk/~pes20/Netsem/paper3.pdf">complexity of TCP</a>, I’m not sure how many partial TCP implementations in OCaml are sensible
</p>

<p>
W.r.t. stack implementation, I think I might have picked the wrong wording. For the library atm, RST handling entails some adjustments in the state machine (which is not too much work, but need a lot of debugging probably), and retransmission entails recording PDUs (through hashes most likely) and allow pass through if duplicates are seen (up to N times etc). Both of which are much less work than a full stack implementation.
</p>

<p>
A firewall does need to work on a slightly different perspective compared to a client, however, as when a firewall sees a PDU, it's not always the case that either client will see it, as opposed to being a client and receiving something means you know for sure you've received it. So the other adjustment required is the state machine of connection tracker needs to tolerate "partial" state transition in some way (so just look ahead one state but don't commit or whatever).
</p>

<p>
So overall it's more of a partial stack implementation powerful enough to observe and forward things and that's the end of the story.
</p>

<p>
Thanks for the link to the paper btw! I'm interested in formal verification stuff in general and currently researching on protocol verification topics at uni, so I'll definitely give it a thorough read later.
</p>
</div>
</div>
</div>




<div id="outline-container-org631c962" class="outline-2">
<h2 id="4">routes: path based routing for web applications</h2>
<div class="outline-text-2" id="text-4">
<p>
Archive: <a href="https://discuss.ocaml.org/t/ann-routes-path-based-routing-for-web-applications/3624/1">https://discuss.ocaml.org/t/ann-routes-path-based-routing-for-web-applications/3624/1</a>
</p>
</div>

<div id="outline-container-org558de00" class="outline-3">
<h3 id="org558de00">Anurag Soni announced</h3>
<div class="outline-text-3" id="text-org558de00">
<p>
I have just published an initial release for a path based routing library. The library has minimal dependencies and isn't tied to any particular HTTP or UI framework.
</p>

<p>
Example usage can be like below:
</p>

<div class="org-src-container">
<pre class="src src-ocaml"><span style="color: #000000; font-weight: bold;">module</span> <span style="color: #228b22;">Request</span> <span style="color: #a52a2a;">=</span> <span style="color: #000000; font-weight: bold;">struct</span>
  <span style="color: #000000; font-weight: bold;">type</span> <span style="color: #228b22;">t</span>
  <span style="color: #a52a2a;">...</span>
<span style="color: #000000; font-weight: bold;">end</span>

<span style="color: #000000; font-weight: bold;">module</span> <span style="color: #228b22;">Response</span> <span style="color: #a52a2a;">=</span> <span style="color: #000000; font-weight: bold;">struct</span>
  <span style="color: #000000; font-weight: bold;">type</span> <span style="color: #228b22;">t</span>
  <span style="color: #a52a2a;">...</span>
<span style="color: #000000; font-weight: bold;">end</span>

<span style="color: #000000; font-weight: bold;">let</span> <span style="color: #0000ff;">get_user</span><span style="color: #a0522d;"> state </span><span style="color: #a52a2a;">(</span><span style="color: #a0522d;">id</span><span style="color: #a52a2a;">:</span><span style="color: #228b22;"> int</span><span style="color: #a52a2a;">)</span> <span style="color: #a52a2a;">=</span>
  <span style="color: #b22222;">(* </span><span style="color: #b22222;">Request handlers can define their own routes too </span><span style="color: #b22222;">*)</span>
  <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #000000; font-weight: bold;">open </span><span style="color: #228b22;">Routes</span> <span style="color: #000000; font-weight: bold;">in</span>
  <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #a0522d;">routes</span> <span style="color: #a52a2a;">=</span> <span style="color: #a52a2a;">[</span> int64 <span style="color: #a52a2a;">&lt;/&gt;</span> boolean <span style="color: #a52a2a;">&lt;/&gt;</span> <span style="color: #a52a2a;">==&gt;</span> <span style="color: #a52a2a;">(</span><span style="color: #a020f0;">fun</span> <span style="color: #a0522d;">_ i b</span> <span style="color: #a52a2a;">-&gt;</span> <span style="color: #a52a2a;">...</span> <span style="color: #a52a2a;">)</span> <span style="color: #a52a2a;">]</span> <span style="color: #000000; font-weight: bold;">in</span>
  match_with_state <span style="color: #a52a2a;">~</span>state routes <span style="color: #a020f0;">with</span>
  <span style="color: #a52a2a;">|</span> <span style="color: #000000; background-color: #ffffff;">None</span> <span style="color: #a52a2a;">-&gt;</span> <span style="color: #a52a2a;">...</span>
  <span style="color: #a52a2a;">|</span> <span style="color: #000000; background-color: #ffffff;">Some</span> response <span style="color: #a52a2a;">-&gt;</span> <span style="color: #a52a2a;">...</span>

<span style="color: #000000; font-weight: bold;">let</span> <span style="color: #0000ff;">search_user</span><span style="color: #a0522d;"> _ </span><span style="color: #a52a2a;">(</span><span style="color: #a0522d;">name</span><span style="color: #a52a2a;">:</span><span style="color: #228b22;"> string</span><span style="color: #a52a2a;">)</span><span style="color: #a0522d;"> </span><span style="color: #a52a2a;">(</span><span style="color: #a0522d;">city </span><span style="color: #a52a2a;">:</span><span style="color: #228b22;"> string</span><span style="color: #a52a2a;">)</span> <span style="color: #a52a2a;">=</span>
  <span style="color: #a52a2a;">...</span>

<span style="color: #000000; font-weight: bold;">let</span> <span style="color: #a0522d;">routes</span> <span style="color: #a52a2a;">=</span>
  <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #000000; font-weight: bold;">open </span><span style="color: #228b22;">Routes</span> <span style="color: #000000; font-weight: bold;">in</span>
  <span style="color: #a52a2a;">[</span> empty <span style="color: #a52a2a;">==&gt;</span> idx <span style="color: #b22222;">(* </span><span style="color: #b22222;">matches the index route "/" </span><span style="color: #b22222;">*)</span>
  <span style="color: #a52a2a;">;</span> method' <span style="color: #000000; background-color: #ffffff;">`GET</span> <span style="color: #a52a2a;">&lt;/&gt;</span> s <span style="color: #8b2252;">"user"</span> <span style="color: #a52a2a;">&lt;/&gt;</span> int <span style="color: #a52a2a;">&lt;/&gt;</span> empty <span style="color: #a52a2a;">==&gt;</span> get_user <span style="color: #b22222;">(* </span><span style="color: #b22222;">matches "/user/&lt;int&gt;" </span><span style="color: #b22222;">*)</span>
  <span style="color: #a52a2a;">;</span> method' <span style="color: #000000; background-color: #ffffff;">`GET</span> <span style="color: #a52a2a;">&lt;/&gt;</span> s <span style="color: #8b2252;">"user"</span> <span style="color: #a52a2a;">&lt;/&gt;</span> str <span style="color: #a52a2a;">&lt;/&gt;</span> str <span style="color: #a52a2a;">==&gt;</span> search_user <span style="color: #b22222;">(* </span><span style="color: #b22222;">missing empty so it matches "/user/&lt;str&gt;/&lt;str&gt;/*" </span><span style="color: #b22222;">*)</span>
  <span style="color: #a52a2a;">]</span>

<span style="color: #a020f0;">match</span> <span style="color: #228b22;">Routes.</span>match' routes <span style="color: #a52a2a;">~</span>req <span style="color: #008b8b;">~target</span><span style="color: #a52a2a;">:</span><span style="color: #8b2252;">"/some/url"</span> <span style="color: #008b8b;">~meth</span><span style="color: #a52a2a;">:</span><span style="color: #000000; background-color: #ffffff;">`GET</span> <span style="color: #a52a2a;">=</span>
<span style="color: #a52a2a;">|</span> <span style="color: #000000; background-color: #ffffff;">None</span> <span style="color: #a52a2a;">-&gt;</span> <span style="color: #b22222;">(* </span><span style="color: #b22222;">No route matched. Alternative could be to provide default routes </span><span style="color: #b22222;">*)</span>
<span style="color: #a52a2a;">|</span> <span style="color: #000000; background-color: #ffffff;">Some</span> r <span style="color: #a52a2a;">-&gt;</span> <span style="color: #b22222;">(* </span><span style="color: #b22222;">Match found. Do something further with handler response </span><span style="color: #b22222;">*)</span>
</pre>
</div>

<p>
Git repository: <a href="https://github.com/anuragsoni/routes">https://github.com/anuragsoni/routes</a>
</p>

<p>
Example using Httpaf: <a href="https://github.com/anuragsoni/routes/blob/7fc2ecb0b3a2e46b26254efe54f1147d99d91995/example/main.ml">https://github.com/anuragsoni/routes/blob/7fc2ecb0b3a2e46b26254efe54f1147d99d91995/example/main.ml</a>
</p>

<p>
This is not published on <code>opam</code> yet so it can be pinned locally via:
<code>opam pin add routes git+https://github.com/anuragsoni/routes.git</code>
</p>
</div>
</div>


<div id="outline-container-orgaa6f5a9" class="outline-3">
<h3 id="orgaa6f5a9">Jean Michel asked and Anurag Soni replied</h3>
<div class="outline-text-3" id="text-orgaa6f5a9">
<p>
&gt; Have you looked at <a href="https://github.com/inhabitedtype/ocaml-dispatch">dispatch</a>?
</p>

<p>
&gt; What are the advantages/differences of path?
</p>

<p>
Yes i did look at dispatch. One difference from dispatch is that the URL's path parameters are extract in a way that assigns them the types defined by the user. If such a type coercion isn't possible the route won't match.
</p>
</div>
</div>


<div id="outline-container-orgf3d6c79" class="outline-3">
<h3 id="orgf3d6c79">Later on, Anurag Soni added</h3>
<div class="outline-text-3" id="text-orgf3d6c79">
<p>
A small update to the library.
</p>

<ul class="org-ul">
<li>Updated the internal representation of a route so the same source is used for both scanning and printing routes.</li>
<li>Added a <code>sprintf</code> like function to format routes.</li>
<li>Route matching is now strict by default. ex: <code>s "user" &lt;/&gt; str</code> will just match <code>/user/&lt;string&gt;</code> and not <code>/user/&lt;string&gt;/*</code></li>
<li>Following from the previous point, nested routing has been removed for now.</li>
</ul>

<div class="org-src-container">
<pre class="src src-ocaml">utop <span style="color: #a52a2a;">#</span> <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #a0522d;">route</span> <span style="color: #a52a2a;">=</span> method' <span style="color: #000000; background-color: #ffffff;">None</span> <span style="color: #a52a2a;">(</span>s <span style="color: #8b2252;">"foo"</span> <span style="color: #a52a2a;">&lt;/&gt;</span> int <span style="color: #a52a2a;">&lt;/&gt;</span> str <span style="color: #a52a2a;">&lt;/&gt;</span> bool<span style="color: #a52a2a;">)</span><span style="color: #ff4500;">;;</span>
<span style="color: #a52a2a;">-</span> <span style="color: #a52a2a;">:</span> <span style="color: #000000; font-weight: bold;">val</span> <span style="color: #0000ff;">route</span> <span style="color: #a52a2a;">:</span> <span style="color: #a52a2a;">(</span>int <span style="color: #a52a2a;">-&gt;</span> string <span style="color: #a52a2a;">-&gt;</span> bool <span style="color: #a52a2a;">-&gt;</span> unit <span style="color: #a52a2a;">-&gt;</span> '_weak1<span style="color: #a52a2a;">,</span> '_weak1<span style="color: #a52a2a;">)</span> route <span style="color: #a52a2a;">=</span>
  <span style="color: #000000; background-color: #ffffff;">Route</span> <span style="color: #a52a2a;">(</span><span style="color: #000000; background-color: #ffffff;">None</span><span style="color: #a52a2a;">,</span> <span style="color: #000000; background-color: #ffffff;">S</span> <span style="color: #a52a2a;">(</span><span style="color: #8b2252;">"foo"</span><span style="color: #a52a2a;">,</span> <span style="color: #000000; background-color: #ffffff;">S</span> <span style="color: #a52a2a;">(</span><span style="color: #8b2252;">"/"</span><span style="color: #a52a2a;">,</span> <span style="color: #000000; background-color: #ffffff;">Int</span> <span style="color: #a52a2a;">(</span><span style="color: #000000; background-color: #ffffff;">S</span> <span style="color: #a52a2a;">(</span><span style="color: #8b2252;">"/"</span><span style="color: #a52a2a;">,</span> <span style="color: #000000; background-color: #ffffff;">Str</span> <span style="color: #a52a2a;">(</span><span style="color: #000000; background-color: #ffffff;">S</span> <span style="color: #a52a2a;">(</span><span style="color: #8b2252;">"/"</span><span style="color: #a52a2a;">,</span> <span style="color: #000000; background-color: #ffffff;">Bool</span> <span style="color: #000000; background-color: #ffffff;">End</span><span style="color: #a52a2a;">)))))))</span>

utop <span style="color: #a52a2a;">#</span> sprintf route<span style="color: #ff4500;">;;</span>
<span style="color: #a52a2a;">-</span> <span style="color: #a52a2a;">:</span> int <span style="color: #a52a2a;">-&gt;</span> string <span style="color: #a52a2a;">-&gt;</span> bool <span style="color: #a52a2a;">-&gt;</span> unit <span style="color: #a52a2a;">-&gt;</span> string <span style="color: #a52a2a;">=</span> <span style="color: #a52a2a;">&lt;</span><span style="color: #a020f0;">fun</span><span style="color: #a52a2a;">&gt;</span>

utop <span style="color: #a52a2a;">#</span> <span style="color: #a52a2a;">(</span>sprintf route<span style="color: #a52a2a;">)</span> 12 <span style="color: #8b2252;">"bar"</span> <span style="color: #008b8b;">false</span> <span style="color: #a52a2a;">()</span><span style="color: #ff4500;">;;</span>
<span style="color: #a52a2a;">-</span> <span style="color: #a52a2a;">:</span> string <span style="color: #a52a2a;">=</span> <span style="color: #8b2252;">"foo/12/bar/false"</span>
</pre>
</div>
</div>
</div>
</div>




<div id="outline-container-orgc75f680" class="outline-2">
<h2 id="5">Other OCaml News</h2>
<div class="outline-text-2" id="text-5">
</div>
<div id="outline-container-org01ae33c" class="outline-3">
<h3 id="org01ae33c">From the ocamlcore planet blog</h3>
<div class="outline-text-3" id="text-org01ae33c">
<p>
Here are links from many OCaml blogs aggregated at <a href="http://ocaml.org/community/planet/">OCaml Planet</a>.
</p>

<ul class="org-ul">
<li><a href="https://mirage.io/blog/2019-spring-retreat-roundup">MirageOS Spring 2019 hack retreat roundup</a></li>
</ul>
</div>
</div>
</div>




<div id="outline-container-org656acd0" class="outline-2">
<h2 id="org656acd0">Old CWN</h2>
<div class="outline-text-2" id="text-org656acd0">
<p>
If you happen to miss a CWN, you can <a href="mailto:alan.schmitt@polytechnique.org">send me a message</a> and I'll mail it to you, or go take a look at <a href="http://alan.petitepomme.net/cwn/">the archive</a> or the <a href="http://alan.petitepomme.net/cwn/cwn.rss">RSS feed of the archives</a>.
</p>

<p>
If you also wish to receive it every week by mail, you may subscribe <a href="http://lists.idyll.org/listinfo/caml-news-weekly/">online</a>.
</p>

<div class="authorname">
<p>
<a href="http://alan.petitepomme.net/">Alan Schmitt</a>
</p>

</div>
</div>
</div>
</div>
</body>
</html>
