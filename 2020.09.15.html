<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<!-- 2020-09-15 Tue 14:53 -->
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>OCaml Weekly News</title>
<meta name="generator" content="Org mode" />
<style type="text/css">
 <!--/*--><![CDATA[/*><!--*/
  .title  { text-align: center;
             margin-bottom: .2em; }
  .subtitle { text-align: center;
              font-size: medium;
              font-weight: bold;
              margin-top:0; }
  .todo   { font-family: monospace; color: red; }
  .done   { font-family: monospace; color: green; }
  .priority { font-family: monospace; color: orange; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .org-right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .org-left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .org-center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #ccc;
    box-shadow: 3px 3px 3px #eee;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: visible;
    padding-top: 1.2em;
  }
  pre.src:before {
    display: none;
    position: absolute;
    background-color: white;
    top: -10px;
    right: 10px;
    padding: 3px;
    border: 1px solid black;
  }
  pre.src:hover:before { display: inline;}
  /* Languages per Org manual */
  pre.src-asymptote:before { content: 'Asymptote'; }
  pre.src-awk:before { content: 'Awk'; }
  pre.src-C:before { content: 'C'; }
  /* pre.src-C++ doesn't work in CSS */
  pre.src-clojure:before { content: 'Clojure'; }
  pre.src-css:before { content: 'CSS'; }
  pre.src-D:before { content: 'D'; }
  pre.src-ditaa:before { content: 'ditaa'; }
  pre.src-dot:before { content: 'Graphviz'; }
  pre.src-calc:before { content: 'Emacs Calc'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-fortran:before { content: 'Fortran'; }
  pre.src-gnuplot:before { content: 'gnuplot'; }
  pre.src-haskell:before { content: 'Haskell'; }
  pre.src-hledger:before { content: 'hledger'; }
  pre.src-java:before { content: 'Java'; }
  pre.src-js:before { content: 'Javascript'; }
  pre.src-latex:before { content: 'LaTeX'; }
  pre.src-ledger:before { content: 'Ledger'; }
  pre.src-lisp:before { content: 'Lisp'; }
  pre.src-lilypond:before { content: 'Lilypond'; }
  pre.src-lua:before { content: 'Lua'; }
  pre.src-matlab:before { content: 'MATLAB'; }
  pre.src-mscgen:before { content: 'Mscgen'; }
  pre.src-ocaml:before { content: 'Objective Caml'; }
  pre.src-octave:before { content: 'Octave'; }
  pre.src-org:before { content: 'Org mode'; }
  pre.src-oz:before { content: 'OZ'; }
  pre.src-plantuml:before { content: 'Plantuml'; }
  pre.src-processing:before { content: 'Processing.js'; }
  pre.src-python:before { content: 'Python'; }
  pre.src-R:before { content: 'R'; }
  pre.src-ruby:before { content: 'Ruby'; }
  pre.src-sass:before { content: 'Sass'; }
  pre.src-scheme:before { content: 'Scheme'; }
  pre.src-screen:before { content: 'Gnu Screen'; }
  pre.src-sed:before { content: 'Sed'; }
  pre.src-sh:before { content: 'shell'; }
  pre.src-sql:before { content: 'SQL'; }
  pre.src-sqlite:before { content: 'SQLite'; }
  /* additional languages in org.el's org-babel-load-languages alist */
  pre.src-forth:before { content: 'Forth'; }
  pre.src-io:before { content: 'IO'; }
  pre.src-J:before { content: 'J'; }
  pre.src-makefile:before { content: 'Makefile'; }
  pre.src-maxima:before { content: 'Maxima'; }
  pre.src-perl:before { content: 'Perl'; }
  pre.src-picolisp:before { content: 'Pico Lisp'; }
  pre.src-scala:before { content: 'Scala'; }
  pre.src-shell:before { content: 'Shell Script'; }
  pre.src-ebnf2ps:before { content: 'ebfn2ps'; }
  /* additional language identifiers per "defun org-babel-execute"
       in ob-*.el */
  pre.src-cpp:before  { content: 'C++'; }
  pre.src-abc:before  { content: 'ABC'; }
  pre.src-coq:before  { content: 'Coq'; }
  pre.src-groovy:before  { content: 'Groovy'; }
  /* additional language identifiers from org-babel-shell-names in
     ob-shell.el: ob-shell is the only babel language using a lambda to put
     the execution function name together. */
  pre.src-bash:before  { content: 'bash'; }
  pre.src-csh:before  { content: 'csh'; }
  pre.src-ash:before  { content: 'ash'; }
  pre.src-dash:before  { content: 'dash'; }
  pre.src-ksh:before  { content: 'ksh'; }
  pre.src-mksh:before  { content: 'mksh'; }
  pre.src-posh:before  { content: 'posh'; }
  /* Additional Emacs modes also supported by the LaTeX listings package */
  pre.src-ada:before { content: 'Ada'; }
  pre.src-asm:before { content: 'Assembler'; }
  pre.src-caml:before { content: 'Caml'; }
  pre.src-delphi:before { content: 'Delphi'; }
  pre.src-html:before { content: 'HTML'; }
  pre.src-idl:before { content: 'IDL'; }
  pre.src-mercury:before { content: 'Mercury'; }
  pre.src-metapost:before { content: 'MetaPost'; }
  pre.src-modula-2:before { content: 'Modula-2'; }
  pre.src-pascal:before { content: 'Pascal'; }
  pre.src-ps:before { content: 'PostScript'; }
  pre.src-prolog:before { content: 'Prolog'; }
  pre.src-simula:before { content: 'Simula'; }
  pre.src-tcl:before { content: 'tcl'; }
  pre.src-tex:before { content: 'TeX'; }
  pre.src-plain-tex:before { content: 'Plain TeX'; }
  pre.src-verilog:before { content: 'Verilog'; }
  pre.src-vhdl:before { content: 'VHDL'; }
  pre.src-xml:before { content: 'XML'; }
  pre.src-nxml:before { content: 'XML'; }
  /* add a generic configuration mode; LaTeX export needs an additional
     (add-to-list 'org-latex-listings-langs '(conf " ")) in .emacs */
  pre.src-conf:before { content: 'Configuration File'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.org-right  { text-align: center;  }
  th.org-left   { text-align: center;   }
  th.org-center { text-align: center; }
  td.org-right  { text-align: right;  }
  td.org-left   { text-align: left;   }
  td.org-center { text-align: center; }
  dt { font-weight: bold; }
  .footpara { display: inline; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .equation-container {
    display: table;
    text-align: center;
    width: 100%;
  }
  .equation {
    vertical-align: middle;
  }
  .equation-label {
    display: table-cell;
    text-align: right;
    vertical-align: middle;
  }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  .org-svg { width: 90%; }
  /*]]>*/-->
</style>
<style type="text/css">#table-of-contents h2 { display: none } .title { display: none } .authorname { text-align: right }</style>
<style type="text/css">.outline-2 {border-top: 1px solid black;}</style>
<script type="text/javascript">
/*
@licstart  The following is the entire license notice for the
JavaScript code in this tag.

Copyright (C) 2012-2020 Free Software Foundation, Inc.

The JavaScript code in this tag is free software: you can
redistribute it and/or modify it under the terms of the GNU
General Public License (GNU GPL) as published by the Free Software
Foundation, either version 3 of the License, or (at your option)
any later version.  The code is distributed WITHOUT ANY WARRANTY;
without even the implied warranty of MERCHANTABILITY or FITNESS
FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.

As additional permission under GNU GPL version 3 section 7, you
may distribute non-source (e.g., minimized or compacted) forms of
that code without the copy of the GNU GPL normally required by
section 4, provided you include this license notice and a URL
through which recipients can access the Corresponding Source.


@licend  The above is the entire license notice
for the JavaScript code in this tag.
*/
<!--/*--><![CDATA[/*><!--*/
 function CodeHighlightOn(elem, id)
 {
   var target = document.getElementById(id);
   if(null != target) {
     elem.cacheClassElem = elem.className;
     elem.cacheClassTarget = target.className;
     target.className = "code-highlighted";
     elem.className   = "code-highlighted";
   }
 }
 function CodeHighlightOff(elem, id)
 {
   var target = document.getElementById(id);
   if(elem.cacheClassElem)
     elem.className = elem.cacheClassElem;
   if(elem.cacheClassTarget)
     target.className = elem.cacheClassTarget;
 }
/*]]>*///-->
</script>
</head>
<body>
<div id="content">
<h1 class="title">OCaml Weekly News</h1>
<p>
<a href="http://alan.petitepomme.net/cwn/2020.09.08.html">Previous Week</a> <a href="http://alan.petitepomme.net/cwn/index.html">Up</a> <a href="http://alan.petitepomme.net/cwn/2020.09.22.html">Next Week</a>
</p>

<p>
Hello
</p>

<p>
Here is the latest OCaml Weekly News, for the week of September 08 to 15, 2020.
</p>

<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#1">A PPX Rewriter approach to ocaml-migrate-parsetree</a></li>
<li><a href="#2">OCaml web server run multiple processes</a></li>
<li><a href="#3">Query-json: Re-implemented jq in Reason Native/OCaml</a></li>
<li><a href="#4">Suggestions for a simple, portable, graphics library?</a></li>
<li><a href="#5">1sr release of omlr: Multiple Linear Regression modeling (using R under the carpet)</a></li>
<li><a href="#6">Multicore OCaml: August 2020</a></li>
<li><a href="#org53093c9">Old CWN</a></li>
</ul>
</div>
</div>


<div id="outline-container-orgd1e2bcd" class="outline-2">
<h2 id="1">A PPX Rewriter approach to ocaml-migrate-parsetree</h2>
<div class="outline-text-2" id="text-1">
<p>
Archive: <a href="https://discuss.ocaml.org/t/a-ppx-rewriter-approach-to-ocaml-migrate-parsetree/6369/7">https://discuss.ocaml.org/t/a-ppx-rewriter-approach-to-ocaml-migrate-parsetree/6369/7</a>
</p>
</div>

<div id="outline-container-org26fbd58" class="outline-3">
<h3 id="org26fbd58">Continuing this thread, Chet Murthy said</h3>
<div class="outline-text-3" id="text-org26fbd58">
<p>
OK, I finished writing the migrations for the OCaml ASTs, so decided that it might be fun to write a
little example to demonstrate how this works.
</p>
</div>

<div id="outline-container-org40eec25" class="outline-4">
<h4 id="org40eec25">The ASTs</h4>
<div class="outline-text-4" id="text-org40eec25">
<p>
Suppose that I have two AST types (in <code>ex_ast.ml</code>):
</p>
<div class="org-src-container">
<pre class="src src-ocaml"><span style="color: #000000; font-weight: bold;">module</span> <span style="color: #228b22;">AST1</span> = <span style="color: #000000; font-weight: bold;">struct</span>
<span style="color: #000000; font-weight: bold;">type</span> <span style="color: #228b22;">t0</span> = string
<span style="color: #000000; font-weight: bold;">type</span> <span style="color: #228b22;">t1</span> = <span style="color: #000000; background-color: #ffffff;">A</span> <span style="color: #a020f0;">of</span> t1 * int list
<span style="color: #000000; font-weight: bold;">type</span> <span style="color: #228b22;">t2</span> = <span style="color: #000000; background-color: #ffffff;">B</span> <span style="color: #a020f0;">of</span> string * t0 | <span style="color: #000000; background-color: #ffffff;">C</span> <span style="color: #a020f0;">of</span> bool | <span style="color: #000000; background-color: #ffffff;">D</span>
<span style="color: #000000; font-weight: bold;">type</span> <span style="color: #228b22;">'a pt3</span> = { it : 'a ; extra : int ; dropped_field: string }
<span style="color: #000000; font-weight: bold;">type</span> <span style="color: #228b22;">t4</span> = t2 pt3
<span style="color: #000000; font-weight: bold;">end</span>

<span style="color: #000000; font-weight: bold;">module</span> <span style="color: #228b22;">AST2</span> = <span style="color: #000000; font-weight: bold;">struct</span>
<span style="color: #000000; font-weight: bold;">type</span> <span style="color: #228b22;">t0</span> = int
<span style="color: #000000; font-weight: bold;">type</span> <span style="color: #228b22;">t1</span> = <span style="color: #000000; background-color: #ffffff;">A</span> <span style="color: #a020f0;">of</span> t1 * int list
<span style="color: #000000; font-weight: bold;">type</span> <span style="color: #228b22;">t2</span> = <span style="color: #000000; background-color: #ffffff;">B</span> <span style="color: #a020f0;">of</span> string * t0 | <span style="color: #000000; background-color: #ffffff;">C</span> <span style="color: #a020f0;">of</span> int | <span style="color: #000000; background-color: #ffffff;">E</span>
<span style="color: #000000; font-weight: bold;">type</span> <span style="color: #228b22;">'a pt3</span> = { it : 'a ; extra : int ; new_field : int }
<span style="color: #000000; font-weight: bold;">type</span> <span style="color: #228b22;">t4</span> = t2 pt3
<span style="color: #000000; font-weight: bold;">end</span>
</pre>
</div>

<p>
These AST types differ in the following ways:
</p>
<ol class="org-ol">
<li><code>t0</code> is just completely different in these versions</li>
<li><code>t1</code> is identical, but references a type that is different in each version; also an externally-defined polymorphic type-constructor (~ 'a list~)</li>
<li><code>t2</code> differs in each version: it loses a branch (<code>D</code>), and gains a branch (<code>E</code>).  It also has a branch whose arguments change type (<code>C</code>)</li>
<li><code>'a pt3</code> similarly loses a field and gains a field; it's also a polymorphic type</li>
<li><code>t4</code> is identical, but again references types that are different in each version.</li>
</ol>
</div>
</div>

<div id="outline-container-orgf994f10" class="outline-4">
<h4 id="orgf994f10">The Migrations</h4>
<div class="outline-text-4" id="text-orgf994f10">
<p>
We'd like to write migrations that incur the -least- amount of boilerplate.  What would that mean?  For
starters, we need to match up the types: there's no way to avoid that.  Next, for branches that change
type, we need to provide code.  We need a way to flag branches that appear or disappear, and similarly
for fields, to compute the value of fields that appear.  So we'll:
</p>

<ol class="org-ol">
<li>list the types we're going to work with, importing their definitions, so that the migration code will work against those already-defined types</li>
<li>specify pairs of source-type, destination-type patterns, and for each, perhaps supply the function, or code for new/disappearing fields/branches</li>
<li>for polymorphic types, we need to specify how their type-parameters get rewritten.</li>
</ol>

<p>
Below, we'll describe the process for taking this information and automatically computing the code of
these migrations.
</p>

<div class="org-src-container">
<pre class="src src-ocaml"><span style="color: #000000; font-weight: bold;">module</span> <span style="color: #228b22;">Migrate_AST1_AST2</span> = <span style="color: #000000; font-weight: bold;">struct</span>

<span style="color: #000000; font-weight: bold;">module</span> <span style="color: #228b22;">SRC</span> = <span style="color: #228b22;">Ex_ast.AST1</span>
<span style="color: #000000; font-weight: bold;">module</span> <span style="color: #228b22;">DST</span> = <span style="color: #228b22;">Ex_ast.AST2</span>

<span style="color: #a020f0;">exception</span> <span style="color: #000000; background-color: #ffffff;">Migration_error</span> <span style="color: #a020f0;">of</span> string

<span style="color: #000000; font-weight: bold;">let</span> <span style="color: #0000ff;">migration_error</span> <span style="color: #a0522d;">feature</span> =
  <span style="color: #483d8b;">raise</span> (<span style="color: #000000; background-color: #ffffff;">Migration_error</span> feature)

<span style="color: #000000; font-weight: bold;">let</span> <span style="color: #0000ff;">_migrate_list</span> <span style="color: #a0522d;">subrw0</span> <span style="color: #a0522d;">__dt__</span> <span style="color: #a0522d;">l</span> =
  <span style="color: #228b22;">List.</span>map (subrw0 __dt__) l

<span style="color: #000000; font-weight: bold;">type</span> <span style="color: #228b22;">t0</span> = <span style="color: #483d8b; background-color: #ebebeb;">[%import</span>: <span style="color: #228b22;">Ex_ast.AST1.</span>t0<span style="color: #483d8b; background-color: #ebebeb;">]</span>
<span style="color: #000000; font-weight: bold;">and</span> <span style="color: #a0522d;">t1</span> = <span style="color: #483d8b; background-color: #ebebeb;">[%import</span>: <span style="color: #228b22;">Ex_ast.AST1.</span>t1<span style="color: #483d8b; background-color: #ebebeb;">]</span>
<span style="color: #000000; font-weight: bold;">and</span> <span style="color: #a0522d;">t2</span> = <span style="color: #483d8b; background-color: #ebebeb;">[%import</span>: <span style="color: #228b22;">Ex_ast.AST1.</span>t2<span style="color: #483d8b; background-color: #ebebeb;">]</span>
<span style="color: #000000; font-weight: bold;">and</span> 'a <span style="color: #a0522d;">pt3</span> = <span style="color: #483d8b; background-color: #ebebeb;">[%import</span>: 'a <span style="color: #228b22;">Ex_ast.AST1.</span>pt3<span style="color: #483d8b; background-color: #ebebeb;">]</span>
<span style="color: #000000; font-weight: bold;">and</span> <span style="color: #a0522d;">t4</span> = <span style="color: #483d8b; background-color: #ebebeb;">[%import</span>: <span style="color: #228b22;">Ex_ast.AST1.</span>t4<span style="color: #483d8b; background-color: #ebebeb;">]</span>
<span style="color: #483d8b;">[@@deriving migrate</span>
<span style="color: #483d8b;">    { dispatch_type = dispatch_table_t</span>
<span style="color: #483d8b;">    ; dispatch_table_value = dt</span>
<span style="color: #483d8b;">    ; dispatchers = {</span>
<span style="color: #483d8b;">        migrate_list = {</span>
<span style="color: #483d8b;">          srctype = [%typ: 'a list]</span>
<span style="color: #483d8b;">        ; dsttype = [%typ: 'b list]</span>
<span style="color: #483d8b;">        ; code = _migrate_list</span>
<span style="color: #483d8b;">        ; subs = [ ([%typ: 'a], [%typ: 'b]) ]</span>
<span style="color: #483d8b;">        }</span>
<span style="color: #483d8b;">      ; migrate_t0 = {</span>
<span style="color: #483d8b;">          srctype = [%typ: t0]</span>
<span style="color: #483d8b;">        ; dsttype = [%typ: DST.t0]</span>
<span style="color: #483d8b;">        ; code = fun __dt__ s -&gt;</span>
<span style="color: #483d8b;">            match int_of_string s with</span>
<span style="color: #483d8b;">              n -&gt; n</span>
<span style="color: #483d8b;">            | exception Failure _ -&gt; migration_error </span><span style="color: #8b2252;">"t0"</span>
<span style="color: #483d8b;">        }</span>
<span style="color: #483d8b;">      ; migrate_t1 = {</span>
<span style="color: #483d8b;">          srctype = [%typ: t1]</span>
<span style="color: #483d8b;">        ; dsttype = [%typ: DST.t1]</span>
<span style="color: #483d8b;">        }</span>
<span style="color: #483d8b;">      ; migrate_t2 = {</span>
<span style="color: #483d8b;">          srctype = [%typ: t2]</span>
<span style="color: #483d8b;">        ; dsttype = [%typ: DST.t2]</span>
<span style="color: #483d8b;">        ; custom_branches_code = function</span>
<span style="color: #483d8b;">              C true -&gt; C 1</span>
<span style="color: #483d8b;">            | C false -&gt; C 0</span>
<span style="color: #483d8b;">            | D -&gt; migration_error </span><span style="color: #8b2252;">"t2:D"</span>
<span style="color: #483d8b;">        }</span>
<span style="color: #483d8b;">      ; migrate_pt3 = {</span>
<span style="color: #483d8b;">          srctype = [%typ: 'a pt3]</span>
<span style="color: #483d8b;">        ; dsttype = [%typ: 'b DST.pt3]</span>
<span style="color: #483d8b;">        ; subs = [ ([%typ: 'a], [%typ: 'b]) ]</span>
<span style="color: #483d8b;">        ; skip_fields = [ dropped_field ]</span>
<span style="color: #483d8b;">        ; custom_fields_code = {</span>
<span style="color: #483d8b;">            new_field = extra</span>
<span style="color: #483d8b;">          }</span>
<span style="color: #483d8b;">        }</span>
<span style="color: #483d8b;">      ; migrate_t4 = {</span>
<span style="color: #483d8b;">          srctype = [%typ: t4]</span>
<span style="color: #483d8b;">        ; dsttype = [%typ: DST.t4]</span>
<span style="color: #483d8b;">        }</span>
<span style="color: #483d8b;">      }</span>
<span style="color: #483d8b;">    }</span>
<span style="color: #483d8b;">]</span>
<span style="color: #000000; font-weight: bold;">end</span>

<span style="color: #000000; font-weight: bold;">module</span> <span style="color: #228b22;">Migrate_AST2_AST1</span> = <span style="color: #000000; font-weight: bold;">struct</span>

<span style="color: #000000; font-weight: bold;">module</span> <span style="color: #228b22;">SRC</span> = <span style="color: #228b22;">Ex_ast.AST2</span>
<span style="color: #000000; font-weight: bold;">module</span> <span style="color: #228b22;">DST</span> = <span style="color: #228b22;">Ex_ast.AST1</span>

<span style="color: #a020f0;">exception</span> <span style="color: #000000; background-color: #ffffff;">Migration_error</span> <span style="color: #a020f0;">of</span> string

<span style="color: #000000; font-weight: bold;">let</span> <span style="color: #0000ff;">migration_error</span> <span style="color: #a0522d;">feature</span> =
  <span style="color: #483d8b;">raise</span> (<span style="color: #000000; background-color: #ffffff;">Migration_error</span> feature)

<span style="color: #000000; font-weight: bold;">let</span> <span style="color: #0000ff;">_migrate_list</span> <span style="color: #a0522d;">subrw0</span> <span style="color: #a0522d;">__dt__</span> <span style="color: #a0522d;">l</span> =
  <span style="color: #228b22;">List.</span>map (subrw0 __dt__) l

<span style="color: #000000; font-weight: bold;">type</span> <span style="color: #228b22;">t0</span> = <span style="color: #483d8b; background-color: #ebebeb;">[%import</span>: <span style="color: #228b22;">Ex_ast.AST2.</span>t0<span style="color: #483d8b; background-color: #ebebeb;">]</span>
<span style="color: #000000; font-weight: bold;">and</span> <span style="color: #a0522d;">t1</span> = <span style="color: #483d8b; background-color: #ebebeb;">[%import</span>: <span style="color: #228b22;">Ex_ast.AST2.</span>t1<span style="color: #483d8b; background-color: #ebebeb;">]</span>
<span style="color: #000000; font-weight: bold;">and</span> <span style="color: #a0522d;">t2</span> = <span style="color: #483d8b; background-color: #ebebeb;">[%import</span>: <span style="color: #228b22;">Ex_ast.AST2.</span>t2<span style="color: #483d8b; background-color: #ebebeb;">]</span>
<span style="color: #000000; font-weight: bold;">and</span> 'a <span style="color: #a0522d;">pt3</span> = <span style="color: #483d8b; background-color: #ebebeb;">[%import</span>: 'a <span style="color: #228b22;">Ex_ast.AST2.</span>pt3<span style="color: #483d8b; background-color: #ebebeb;">]</span>
<span style="color: #000000; font-weight: bold;">and</span> <span style="color: #a0522d;">t4</span> = <span style="color: #483d8b; background-color: #ebebeb;">[%import</span>: <span style="color: #228b22;">Ex_ast.AST2.</span>t4<span style="color: #483d8b; background-color: #ebebeb;">]</span>
<span style="color: #483d8b;">[@@deriving migrate</span>
<span style="color: #483d8b;">    { dispatch_type = dispatch_table_t</span>
<span style="color: #483d8b;">    ; dispatch_table_value = dt</span>
<span style="color: #483d8b;">    ; dispatchers = {</span>
<span style="color: #483d8b;">        migrate_list = {</span>
<span style="color: #483d8b;">          srctype = [%typ: 'a list]</span>
<span style="color: #483d8b;">        ; dsttype = [%typ: 'b list]</span>
<span style="color: #483d8b;">        ; code = _migrate_list</span>
<span style="color: #483d8b;">        ; subs = [ ([%typ: 'a], [%typ: 'b]) ]</span>
<span style="color: #483d8b;">        }</span>
<span style="color: #483d8b;">      ; migrate_t0 = {</span>
<span style="color: #483d8b;">          srctype = [%typ: t0]</span>
<span style="color: #483d8b;">        ; dsttype = [%typ: DST.t0]</span>
<span style="color: #483d8b;">        ; code = fun __dt__ n -&gt; string_of_int n</span>
<span style="color: #483d8b;">        }</span>
<span style="color: #483d8b;">      ; migrate_t1 = {</span>
<span style="color: #483d8b;">          srctype = [%typ: t1]</span>
<span style="color: #483d8b;">        ; dsttype = [%typ: DST.t1]</span>
<span style="color: #483d8b;">        }</span>
<span style="color: #483d8b;">      ; migrate_t2 = {</span>
<span style="color: #483d8b;">          srctype = [%typ: t2]</span>
<span style="color: #483d8b;">        ; dsttype = [%typ: DST.t2]</span>
<span style="color: #483d8b;">        ; custom_branches_code = function</span>
<span style="color: #483d8b;">              C 1 -&gt; C true</span>
<span style="color: #483d8b;">            | C 0 -&gt; C false</span>
<span style="color: #483d8b;">            | C _ -&gt; migration_error </span><span style="color: #8b2252;">"t2:C"</span>
<span style="color: #483d8b;">            | E -&gt; migration_error </span><span style="color: #8b2252;">"t2:E"</span>
<span style="color: #483d8b;">        }</span>
<span style="color: #483d8b;">      ; migrate_pt3 = {</span>
<span style="color: #483d8b;">          srctype = [%typ: 'a pt3]</span>
<span style="color: #483d8b;">        ; dsttype = [%typ: 'b DST.pt3]</span>
<span style="color: #483d8b;">        ; subs = [ ([%typ: 'a], [%typ: 'b]) ]</span>
<span style="color: #483d8b;">        ; skip_fields = [ new_field ]</span>
<span style="color: #483d8b;">        ; custom_fields_code = {</span>
<span style="color: #483d8b;">            dropped_field = string_of_int extra</span>
<span style="color: #483d8b;">          }</span>
<span style="color: #483d8b;">        }</span>
<span style="color: #483d8b;">      ; migrate_t4 = {</span>
<span style="color: #483d8b;">          srctype = [%typ: t4]</span>
<span style="color: #483d8b;">        ; dsttype = [%typ: DST.t4]</span>
<span style="color: #483d8b;">        }</span>
<span style="color: #483d8b;">      }</span>
<span style="color: #483d8b;">    }</span>
<span style="color: #483d8b;">]</span>
<span style="color: #000000; font-weight: bold;">end</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org1b9f71f" class="outline-4">
<h4 id="org1b9f71f">Using the Migrations</h4>
<div class="outline-text-4" id="text-org1b9f71f">
<p>
And we can use them in the toplevel to migrate in each direction:
</p>

<div class="org-src-container">
<pre class="src src-ocaml"><span style="color: #708090;">#load</span> <span style="color: #8b2252;">"ex_ast.cmo"</span><span style="color: #ff4500;">;;</span>
<span style="color: #708090;">#load</span> <span style="color: #8b2252;">"ex_migrate.cmo"</span><span style="color: #ff4500;">;;</span>
<span style="color: #000000; font-weight: bold;">open </span><span style="color: #228b22;">Ex_migrate</span> <span style="color: #ff4500;">;;</span>
<span style="color: #000000; font-weight: bold;">open </span><span style="color: #228b22;">Ex_ast</span> <span style="color: #ff4500;">;;</span>
# <span style="color: #228b22;">Migrate_AST1_AST2.</span>(dt.migrate_t4 dt <span style="color: #228b22;">AST1.</span>{ it = <span style="color: #000000; background-color: #ffffff;">C</span> <span style="color: #008b8b;">true</span> ; extra = 3 ; dropped_field = <span style="color: #8b2252;">"1"</span> })<span style="color: #ff4500;">;;</span>
- : <span style="color: #228b22;">Ex_migrate.Migrate_AST1_AST2.DST.</span>t4 =
{<span style="color: #228b22;">Ex_migrate.Migrate_AST1_AST2.DST.</span>it = <span style="color: #228b22;">Ex_migrate.Migrate_AST1_AST2.DST.</span><span style="color: #000000; background-color: #ffffff;">C</span> 1;
 extra = 3; new_field = 3}
# <span style="color: #228b22;">Migrate_AST2_AST1.</span>(dt.migrate_t1 dt <span style="color: #228b22;">AST2.</span>(<span style="color: #000000; background-color: #ffffff;">A</span>(1, [2;3])))<span style="color: #ff4500;">;;</span>
- : <span style="color: #228b22;">Ex_migrate.Migrate_AST2_AST1.DST.</span>t1 =
<span style="color: #228b22;">Ex_migrate.Migrate_AST2_AST1.DST.</span><span style="color: #000000; background-color: #ffffff;">A</span> (<span style="color: #8b2252;">"1"</span>, [2; 3])
</pre>
</div>
</div>
</div>

<div id="outline-container-org7ff0ec3" class="outline-4">
<h4 id="org7ff0ec3">How Does It Work?</h4>
<div class="outline-text-4" id="text-org7ff0ec3">
<p>
The migration code is computed in a pretty straightforward manner.  In the following, assume we're
migrating from <code>AST1</code> to <code>AST2</code> (<code>DST</code> is also the same as <code>AST2</code>).  Let's call a "migration function"
something of type
</p>
<div class="org-src-container">
<pre class="src src-ocaml"><span style="color: #000000; font-weight: bold;">type</span> <span style="color: #228b22;">('a, 'b) migrater_t</span> = dispatch_table_t -&gt; 'a -&gt; 'b
</pre>
</div>
<p>
where <code>dispatch_table_t</code> will be defined later.  First, assume (recursively) that each each migration
rule yields a
migration function.  So a rule like
</p>
<div class="org-src-container">
<pre class="src src-ocaml">; migrate_t1 = {
    srctype = <span style="color: #483d8b; background-color: #ebebeb;">[%typ</span>: t1<span style="color: #483d8b; background-color: #ebebeb;">]</span>
  ; dsttype = <span style="color: #483d8b; background-color: #ebebeb;">[%typ</span>: <span style="color: #228b22;">DST.</span>t1<span style="color: #483d8b; background-color: #ebebeb;">]</span>
  }
</pre>
</div>
<p>
will yield a function of type
</p>
<div class="org-src-container">
<pre class="src src-ocaml">(<span style="color: #228b22;">AST1.</span>t1, <span style="color: #228b22;">AST2.</span>t1) migrater_t
</pre>
</div>
<p>
and a rule like
</p>
<div class="org-src-container">
<pre class="src src-ocaml">; migrate_pt3 = {
    srctype = <span style="color: #483d8b; background-color: #ebebeb;">[%typ</span>: 'a pt3<span style="color: #483d8b; background-color: #ebebeb;">]</span>
  ; dsttype = <span style="color: #483d8b; background-color: #ebebeb;">[%typ</span>: 'b <span style="color: #228b22;">DST.</span>pt3<span style="color: #483d8b; background-color: #ebebeb;">]</span>
  ; subs = [ (<span style="color: #483d8b; background-color: #ebebeb;">[%typ</span>: 'a<span style="color: #483d8b; background-color: #ebebeb;">]</span>, <span style="color: #483d8b; background-color: #ebebeb;">[%typ</span>: 'b<span style="color: #483d8b; background-color: #ebebeb;">]</span>) ]
  ; skip_fields = [ dropped_field ]
  ; custom_fields_code = {
      new_field = extra
    }
  }
</pre>
</div>
<p>
will yield
</p>
<div class="org-src-container">
<pre class="src src-ocaml">'a 'b. ('a, 'b) migrater_t -&gt; ('a <span style="color: #228b22;">AST1.</span>pt3, 'b <span style="color: #228b22;">AST2.</span>pt3) migrater_t
</pre>
</div>
<p>
Notice that this is a function that takes a migration from ~ 'a~ to ~ 'b~, and produces one from ~ 'a
AST1.pt3~ to ~ 'a AST2.pt3~.  So from a source-type, we need to mechanically compute the code, and also
compute the result-type.  This will be key idea: the migration process, applied to a source-type, will
produce both the code that migrates that source-type, and <b>also</b> the destination-type.
</p>

<p>
Now, consider any rewrite rule, and let's argue by cases on how its code &amp; destination-type can be
computed.
</p>

<ol class="org-ol">
<li>suppose that the <b>source type</b> (the field <code>srctype</code>) of the rule can be <b>head-reduced</b> (by applying some type-definition as an abbreviation) to an algebraic sum-type (<code>A of ... | B of ...</code>) or record-type (<code>{a: t1 ; b : ... }</code>).  Then we can generate code to pattern-match on values of the source-type, and for variables in the generated patterns, we know their types.  We can then apply (via pattern-matching over types) <b>all</b> the rewrite-rules to compute code that will migrate the variables' values.  Since the recursive application of migration-rules produce destination-types, we can substitute those into branches/fields, to get the destination-type.  [More on pattern-matching below.]
<ul class="org-ul">
<li>some of the branches of a sum-type might have their code specified in a <code>custom_branches_code</code>, and those branches supersede what would have been automatically-generated.</li>
<li>some of the fields of a record-type are listed in <code>skip_fields</code>, and they're not generated; some of the fields are listed with code to compute them (based on the fields in the pattern above) in <code>custom_fields_code</code>, and those get added.</li>
</ul></li>
<li>suppose that the <b>source type</b> after a <b>single</b> head-reduction yields a type-expression that can be successfully pattern-matched by one of the rewrite-rules <b>other than this rule we're currently processing</b>; then we can use that rewriter function to migrate the value of the source-type, and again, we get the destination-type.
<ul class="org-ul">
<li>Why other than the current rule?  It's simple: we could end up in an infinite recursion if care isn't taken to write the migration rules correctly.</li>
</ul></li>
<li>The process of pattern-matching takes as input a type-expression, and a migration-rule.  If the source-type of the migration-rule matches the type-expression (in the usual sense), then it produces bindings for the type-variables.</li>
</ol>

<p>
Let's look at an example.  Suppose we want to compute the migration function for the type-expression
<code>t4</code>.
</p>

<ol class="org-ol">
<li>head-reducing once yields <code>t2 pt3</code>.</li>
<li>the rule <code>migrate_pt3</code> matches (source-type <code>'a pt3</code>), with type-variable ~ 'a~ bound to <code>t2</code>.
<ul class="org-ul">
<li>also, (via the <code>subs</code> field) if the type bound to ~ 'a~ is rewritten to ~ 'b~ then the destination-type is ~ 'b AST2.pt3~ [remember this below]</li>
</ul></li>
<li>the type-expression <code>t2</code> matches the rule <code>migrate_t2</code>, with no type-variables bound and destination-type <code>AST2.t2</code>.</li>
<li>So <code>migrate_t2 : (AST1.t2, AST2.t2) migrater_t</code> (that is, the destination type is <code>AST2.t2</code>)</li>
<li>Thus in #2 above, ~ 'b~ is bound to <code>AST2.t2</code>, and hence the destination-type in #2 above is <code>AST2.t2 AST2.pt3</code></li>
</ol>

<p>
So the whole migration code for type <code>t4</code> is <code>migrate_pt3 migrate_t2</code> (which is what we would expect).
</p>
</div>
</div>
</div>
</div>




<div id="outline-container-org59ff422" class="outline-2">
<h2 id="2">OCaml web server run multiple processes</h2>
<div class="outline-text-2" id="text-2">
<p>
Archive: <a href="https://discuss.ocaml.org/t/ocaml-web-server-run-multiple-processes/6408/1">https://discuss.ocaml.org/t/ocaml-web-server-run-multiple-processes/6408/1</a>
</p>
</div>

<div id="outline-container-org8021028" class="outline-3">
<h3 id="org8021028">mudrz announced</h3>
<div class="outline-text-3" id="text-org8021028">
<p>
I've been running some simple benchmarks to compare web servers written in JS, F# and OCaml:
</p>
<ul class="org-ul">
<li>JS: fastify <a href="https://www.fastify.io">https://www.fastify.io</a> + pg + knex (not entirely fare with the other ones since they are more bare bone than knex)</li>
<li>OCaml: opium on master (httpaf) <a href="https://github.com/rgrinberg/opium">https://github.com/rgrinberg/opium</a> + caqti</li>
<li>F#: giraffe <a href="https://giraffe.wiki">https://giraffe.wiki</a> + dapper <a href="https://dapper-tutorial.net">https://dapper-tutorial.net</a></li>
</ul>

<p>
I started with @shonfeder's excellent tutorial: <a href="https://shonfeder.gitlab.io/ocaml_webapp/">https://shonfeder.gitlab.io/ocaml_webapp/</a>
Seriously if there were more tutorials like this the OCaml community would have been times bigger, they
are so helpful when starting out and you don't want to solve the same problem everyone else has already
solved.
And then implemented parts of it in JS and F#
</p>

<p>
the test:
</p>
<ul class="org-ul">
<li>queries a DB</li>
<li>adds an additional item to the result</li>
<li>orders the list</li>
<li>returns an html containing the rendered result</li>
</ul>

<p>
I ran each test 3 times and posted the best result
</p>

<p>
This is not a scientific test using a controlled environment, this is a quick and dirty test, so take
it with a bit of salt (but in many ways the results are not so unexpected). The tests are also not
comparing the languages themselves but a combination of some of the more popular libraries of them,
which is how you would normally use them.
</p>

<p>
I'm not posting a link to a repo with the benchmarks since the code is not organised and the tests are
not automated, don't want to spend too much time on this, but happy to post the code used if someone is
interested.
</p>

<p>
The tests were made with <code>wrk -t8 -c400 -d30s</code> - 8 threads, 400 connections, 30 seconds;
</p>
</div>

<div id="outline-container-org538533a" class="outline-4">
<h4 id="org538533a">HTML endpoint, no DB access</h4>
<div class="outline-text-4" id="text-org538533a">
<p>
JS - single process
</p>
<pre class="example">
  Thread Stats   Avg      Stdev     Max   +/- Stdev
    Latency    44.16ms    4.73ms  59.22ms   88.44%
    Req/Sec     1.10k    89.00     1.50k    82.83%
  262651 requests in 30.05s, 179.60MB read
  Socket errors: connect 0, read 264, write 0, timeout 0
Requests/sec:   8739.98
Transfer/sec:      5.98MB
</pre>

<p>
JS - multiple processes
</p>
<pre class="example">
  Thread Stats   Avg      Stdev     Max   +/- Stdev
    Latency    43.37ms   56.91ms 316.27ms   83.49%
    Req/Sec     2.43k   459.80     3.81k    73.25%
  580742 requests in 30.05s, 397.10MB read
  Socket errors: connect 0, read 239, write 0, timeout 0
Requests/sec:  19325.95
Transfer/sec:     13.21MB
</pre>

<p>
OCaml - single process
</p>
<pre class="example">
  Thread Stats   Avg      Stdev     Max   +/- Stdev
    Latency    15.01ms    2.28ms  39.86ms   89.00%
    Req/Sec     3.27k   240.86     4.53k    89.83%
  781313 requests in 30.01s, 489.54MB read
  Socket errors: connect 0, read 308, write 0, timeout 0
Requests/sec:  26031.65
Transfer/sec:     16.31MB
</pre>

<p>
F#
</p>
<pre class="example">
  Thread Stats   Avg      Stdev     Max   +/- Stdev
    Latency     5.46ms  840.10us  20.34ms   83.20%
    Req/Sec     8.91k   659.89    13.27k    73.25%
  2130565 requests in 30.04s, 1.45GB read
  Socket errors: connect 0, read 272, write 0, timeout 0
Requests/sec:  70923.15
Transfer/sec:     49.31MB
</pre>

<p>
Results:
</p>
<ul class="org-ul">
<li>OCaml: 1.34x more requests/s than JS, with 2.8x less latency</li>
<li>F#: 3.66x more than JS, 2.7x more requests/s than OCaml, with 2.7x less latency</li>
</ul>
</div>
</div>

<div id="outline-container-org15c2bf6" class="outline-4">
<h4 id="org15c2bf6">JSON endpoint, DB access</h4>
<div class="outline-text-4" id="text-org15c2bf6">
<p>
The JSON response for JS and OCaml was:
</p>
<div class="org-src-container">
<pre class="src src-json">{"excerpts":[{"author":"kan","excerpt":"Another excerpt","source":"My source2","page":"another
page"},{"author":"kan","excerpt":"My excerpt","source":"my source","page":"23"}]}
</pre>
</div>
<p>
for F# it was slightly longer since option types are serialized by default with a Some/None variant (it
can be changed):
</p>
<div class="org-src-container">
<pre class="src src-json">{"excerpts":[{"author":"kan","excerpt":"Another excerpt","source":"My
source2","page":{"case":"Some","fields":["another page"]}},{"author":"kan","excerpt":"My
excerpt","source":"my
source","page":{"case":"Some","fields":["23"]}},{"author":"a","excerpt":"b","source":"c","page":{"case":"Some","fields":["d"]}}]}
</pre>
</div>
<p>
The DB was Postgres with 10 max connections
</p>

<p>
JS - single process
</p>
<pre class="example">
  Thread Stats   Avg      Stdev     Max   +/- Stdev
    Latency    57.79ms    5.68ms  88.02ms   85.24%
    Req/Sec   848.20    109.95     1.37k    72.24%
  202885 requests in 30.09s, 62.69MB read
  Socket errors: connect 0, read 237, write 0, timeout 0
Requests/sec:   6742.09
Transfer/sec:      2.08MB
</pre>

<p>
JS - multiple processes
</p>
<pre class="example">
  Thread Stats   Avg      Stdev     Max   +/- Stdev
    Latency    57.48ms   61.84ms 774.03ms   83.36%
    Req/Sec     1.20k   260.84     2.29k    71.38%
  287101 requests in 30.04s, 88.71MB read
  Socket errors: connect 0, read 286, write 38, timeout 0
Requests/sec:   9558.04
Transfer/sec:      2.95MB
</pre>

<p>
OCaml
</p>
<pre class="example">
  Thread Stats   Avg      Stdev     Max   +/- Stdev
    Latency     6.69ms   38.78ms   1.07s    98.17%
    Req/Sec     1.78k   842.50     3.62k    56.33%
  424454 requests in 30.02s, 100.39MB read
  Socket errors: connect 0, read 253, write 0, timeout 13
Requests/sec:  14139.42
Transfer/sec:      3.34MB
</pre>

<p>
F#
</p>
<pre class="example">
  Thread Stats   Avg      Stdev     Max   +/- Stdev
    Latency    19.27ms    3.92ms 107.53ms   82.60%
    Req/Sec     2.54k   165.82     3.26k    79.21%
  606868 requests in 30.02s, 261.02MB read
  Socket errors: connect 0, read 259, write 0, timeout 0
Requests/sec:  20214.71
Transfer/sec:      8.69MB
</pre>

<p>
Results:
</p>
<ul class="org-ul">
<li>OCaml: 1.48x more requests/s than JS (up from 1.34x before), with 8.6x less latency (before: 2.7x)</li>
<li>F#: 2.1x more than JS (down from 3.66x before), 1.43x more requests/s than OCaml (down from 2.7x before), with 2.88x MORE latency than OCaml (before: 2.7x LESS than OCaml)</li>
</ul>

<p>
Observations:
</p>
<ul class="org-ul">
<li>JS is performing unexpectedly good compared to compiled languages</li>
<li>F# (or ASP.NET Core) is really fast out of the box, with no tweaking necessary</li>
<li>OCaml is running on a single process and has had Max request time of <code>1.07s</code> and Stdev 10x that of F#; in some tests it spiked to 2seconds for some requests, is this the GC? how can I troubleshoot that?</li>
</ul>

<p>
Is there a good tutorial on running OCaml with multiple processes and generally commonly faced use
cases for web servers?
There are countless articles for the other ecosystems, but it is a bit difficult to find ones for
OCaml, making it a bit time consuming to try to figure each thing out
</p>
</div>
</div>
</div>


<div id="outline-container-org8d400ed" class="outline-3">
<h3 id="org8d400ed">Later, mudrz added</h3>
<div class="outline-text-3" id="text-org8d400ed">
<p>
added the code to:
<a href="https://gitlab.com/mudrz/ocaml-web-benchmarks/-/tree/master/">https://gitlab.com/mudrz/ocaml-web-benchmarks/-/tree/master/</a>
</p>

<p>
there are 3 dirs for each server
</p>
</div>
</div>


<div id="outline-container-orgcd28c76" class="outline-3">
<h3 id="orgcd28c76">mudrz also said</h3>
<div class="outline-text-3" id="text-orgcd28c76">
<p>
I found it generally interesting to compare OCaml and F# syntaxes and how things work, so adding this
if others find it interesting:
</p>
</div>

<div id="outline-container-org48e4fe9" class="outline-4">
<h4 id="org48e4fe9">HTML templates</h4>
<div class="outline-text-4" id="text-org48e4fe9">
<p>
OCaml (tyxml):
<a href="https://gitlab.com/mudrz/ocaml-web-benchmarks/-/blob/master/opi-bench/lib/content.ml#L5-42">https://gitlab.com/mudrz/ocaml-web-benchmarks/-/blob/master/opi-bench/lib/content.ml#L5-42</a>
each element is a function that has labeled arguments for attributes and a final argument for the
children
</p>
<div class="org-src-container">
<pre class="src src-ocaml">head
  (title (txt <span style="color: #8b2252;">"OCaml Webapp Tutorial"</span>))
  [ meta <span style="color: #008b8b;">~a</span>:[a_charset <span style="color: #8b2252;">"UTF-8"</span>] ()
  ; link <span style="color: #008b8b;">~rel</span>:[<span style="color: #000000; background-color: #ffffff;">`Stylesheet</span>] <span style="color: #008b8b;">~href</span>:<span style="color: #8b2252;">"/static/style.css"</span> () ]
</pre>
</div>

<p>
F# (giraffe viewing engine, there were others, but I haven't tested them):
<a href="https://gitlab.com/mudrz/ocaml-web-benchmarks/-/blob/master/fsharp-bench/src/fsharp-bench/Content.fs#L6-35">https://gitlab.com/mudrz/ocaml-web-benchmarks/-/blob/master/fsharp-bench/src/fsharp-bench/Content.fs#L6-35</a>
each element is a function that accepts 2 lists - the first one for attributes, the second for children
</p>
<div class="org-src-container">
<pre class="src src-fsharp">head [] [
    title []  [ encodedText "fsharp_bench" ]
    link [ _rel  "stylesheet"
	   _type "text/css"
	   _href "/style.css" ]
]
</pre>
</div>
</div>
</div>

<div id="outline-container-org257dfd6" class="outline-4">
<h4 id="org257dfd6">DB Query</h4>
<div class="outline-text-4" id="text-org257dfd6">
<p>
OCaml (caqti rapper):
<a href="https://gitlab.com/mudrz/ocaml-web-benchmarks/-/blob/master/opi-bench/lib/db.ml#L78-88">https://gitlab.com/mudrz/ocaml-web-benchmarks/-/blob/master/opi-bench/lib/db.ml#L78-88</a>
using a ppx
</p>
<div class="org-src-container">
<pre class="src src-ocaml"><span style="color: #483d8b; background-color: #ebebeb;">[%rapper</span> get_many
    <span style="color: #8b2252;">{sql|</span>
<span style="color: #8b2252;">    SELECT @string{author}, @string{excerpt}, @string{source}, @string?{page}</span>
<span style="color: #8b2252;">    FROM excerpts</span>
<span style="color: #8b2252;">    WHERE author = %string{author}</span>
<span style="color: #8b2252;">    |sql}</span>
    record_out
<span style="color: #483d8b; background-color: #ebebeb;">]</span>
</pre>
</div>

<p>
F# (dapper):
<a href="https://gitlab.com/mudrz/ocaml-web-benchmarks/-/blob/master/fsharp-bench/src/fsharp-bench/Db.fs#L30-35">https://gitlab.com/mudrz/ocaml-web-benchmarks/-/blob/master/fsharp-bench/src/fsharp-bench/Db.fs#L30-35</a>
</p>
<div class="org-src-container">
<pre class="src src-fsharp">let sql = """
   SELECT author, excerpt, source, page
   FROM excerpts
   WHERE author = @author;
"""
let! data = conn.QueryAsync&lt;Excerpt.t&gt;(sql,  dict ["author" =&gt; "kan"])
</pre>
</div>
</div>
</div>

<div id="outline-container-orgcfe9551" class="outline-4">
<h4 id="orgcfe9551">Serialization</h4>
<div class="outline-text-4" id="text-orgcfe9551">
<p>
OCaml:
define as serialisable:
<a href="https://gitlab.com/mudrz/ocaml-web-benchmarks/-/blob/master/opi-bench/lib/excerpt.ml#L1-6">https://gitlab.com/mudrz/ocaml-web-benchmarks/-/blob/master/opi-bench/lib/excerpt.ml#L1-6</a>
</p>
<div class="org-src-container">
<pre class="src src-ocaml"><span style="color: #000000; font-weight: bold;">type</span> <span style="color: #228b22;">t</span> =
  { author: string
  ; excerpt: string
  ; source: string
  ; page: string option
  }<span style="color: #483d8b;">[@@deriving yojson]</span>
</pre>
</div>
<p>
and then call the generated function:
<a href="https://gitlab.com/mudrz/ocaml-web-benchmarks/-/blob/master/opi-bench/lib/route.ml#L97">https://gitlab.com/mudrz/ocaml-web-benchmarks/-/blob/master/opi-bench/lib/route.ml#L97</a>
</p>
<div class="org-src-container">
<pre class="src src-ocaml"><span style="color: #000000; font-weight: bold;">let</span> <span style="color: #000000; font-weight: bold;">open </span><span style="color: #228b22;">Excerpt.Response.Err</span> <span style="color: #000000; font-weight: bold;">in</span>
<span style="color: #000000; font-weight: bold;">let</span> <span style="color: #a0522d;">json</span> = to_yojson { message= e } <span style="color: #000000; font-weight: bold;">in</span>
</pre>
</div>

<p>
F#:
mark type as "cli mutable":
<a href="https://gitlab.com/mudrz/ocaml-web-benchmarks/-/blob/master/fsharp-bench/src/fsharp-bench/Excerpt.fs#L3-9">https://gitlab.com/mudrz/ocaml-web-benchmarks/-/blob/master/fsharp-bench/src/fsharp-bench/Excerpt.fs#L3-9</a>
</p>
<div class="org-src-container">
<pre class="src src-fsharp">[&lt;CLIMutable&gt;]
type t =
  { author: string
  ; excerpt: string
  ; source: string
  ; page: string option
  }
</pre>
</div>
<p>
serialisation happens automatically
</p>
</div>
</div>

<div id="outline-container-org51bd4ba" class="outline-4">
<h4 id="org51bd4ba">async:</h4>
<div class="outline-text-4" id="text-org51bd4ba">
<p>
OCaml (lwt):
<a href="https://gitlab.com/mudrz/ocaml-web-benchmarks/-/blob/master/opi-bench/lib/route.ml#L106-110">https://gitlab.com/mudrz/ocaml-web-benchmarks/-/blob/master/opi-bench/lib/route.ml#L106-110</a>
"await" with <code>let*</code> and <code>let+</code> and then return with <code>Lwt.return</code>
</p>
<div class="org-src-container">
<pre class="src src-ocaml"><span style="color: #000000; font-weight: bold;">let</span> <span style="color: #a0522d;">excerpts</span> = get <span style="color: #8b2252;">"/excerpts"</span> <span style="color: #000000; font-weight: bold;">begin</span> <span style="color: #a020f0;">fun</span> <span style="color: #a0522d;">req</span> -&gt;
    <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #000000; font-weight: bold;">open </span><span style="color: #228b22;">Lwt.Syntax</span> <span style="color: #000000; font-weight: bold;">in</span>
    <span style="color: #000000; font-weight: bold;">let+</span> <span style="color: #a0522d;">authors</span> = <span style="color: #228b22;">Db.Get.</span>authors req <span style="color: #000000; font-weight: bold;">in</span>
    respond_or_err <span style="color: #228b22;">Content.</span>author_excerpts_page authors
  <span style="color: #000000; font-weight: bold;">end</span>
</pre>
</div>

<p>
F#:
<a href="https://gitlab.com/mudrz/ocaml-web-benchmarks/-/blob/master/fsharp-bench/src/fsharp-bench/Program.fs#L81-86">https://gitlab.com/mudrz/ocaml-web-benchmarks/-/blob/master/fsharp-bench/src/fsharp-bench/Program.fs#L81-86</a>
</p>
<ul class="org-ul">
<li>wraps async work in <code>task</code> (for compatibility with C# <a href="https://github.com/rspeele/TaskBuilder.fs">https://github.com/rspeele/TaskBuilder.fs</a> , otherwise <code>async</code>)</li>
<li>"await" with <code>let!</code> and then return with <code>return!</code></li>
</ul>
<div class="org-src-container">
<pre class="src src-fsharp">fun ctx next -&gt; task {
    let! excerpts = Db.fortunes ()
    let res: Db.Excerpt.res = { excerpts= excerpts }
    return! json res ctx next
}
</pre>
</div>
</div>
</div>
</div>
</div>




<div id="outline-container-orgf6236f2" class="outline-2">
<h2 id="3">Query-json: Re-implemented jq in Reason Native/OCaml</h2>
<div class="outline-text-2" id="text-3">
<p>
Archive: <a href="https://discuss.ocaml.org/t/query-json-re-implemented-jq-in-reason-native-ocaml/6410/1">https://discuss.ocaml.org/t/query-json-re-implemented-jq-in-reason-native-ocaml/6410/1</a>
</p>
</div>

<div id="outline-container-org7b1633c" class="outline-3">
<h3 id="org7b1633c">David Sancho announced</h3>
<div class="outline-text-3" id="text-org7b1633c">
<p>
I re-implementatied jq in Reason Native and OCaml and I'm a little proud :star:, started as a way to
learn how to write lexers/parsers/compilers with the OCaml stack, but ending up very functional.
</p>

<p>
I'm using it right now, every day. It's called query-json or for short "q".
</p>

<p>
<a href="https://github.com/davesnx/query-json">https://github.com/davesnx/query-json</a>
</p>

<p>
It has better performance (between 2x and 5x) than jq, richer error messages and simplified API. It's
mostly thanks to OCaml/Reason, rather than my skill to code a compiler! Still isn't feature complete,
though, but have implemented most of the common functionality, Adding those features shouldn't affect
the performance, so I will keep adding them with time.
</p>

<p>
You can check the benchmarks here: <a href="https://github.com/davesnx/query-json#Performance">https://github.com/davesnx/query-json#Performance</a>
</p>

<p>
The main idea is to improve the api of the operations and errors with manipulation JSON files.
</p>

<p>
If you don't know what jq is, check thoughtbot dot com/blog/jq-is-sed-for-json or programminghistorian
dot org/en/lessons/json-and-jq.
</p>

<p>
Hope you like it and let me know if there's something that you struggled with jq and I can make it
better in <b>q</b>, let me know, I'm always open to any DM.
</p>

<p>
Thanks 👋🏽
</p>

<p>
PS: The creator of jq (@stedolan), which is a current OCaml core maintainer is doing ocaml-multicore,
which at some point could improve the "q" performance even more.
</p>
</div>
</div>
</div>




<div id="outline-container-org689f2da" class="outline-2">
<h2 id="4">Suggestions for a simple, portable, graphics library?</h2>
<div class="outline-text-2" id="text-4">
<p>
Archive: <a href="https://discuss.ocaml.org/t/suggestions-for-a-simple-portable-graphics-library/6413/1">https://discuss.ocaml.org/t/suggestions-for-a-simple-portable-graphics-library/6413/1</a>
</p>
</div>

<div id="outline-container-org3dc6b1f" class="outline-3">
<h3 id="org3dc6b1f">Yaron Minsky asked</h3>
<div class="outline-text-3" id="text-org3dc6b1f">
<p>
I'm working on a little side project where I need to do some simple, cross-platform game-like graphics.
Really simple: I want to be able to draw some colored lines, and splat out rotated images.  But I'd
also like this to be reasonably efficient, and reasonable easy to use.
</p>

<p>
And, ideally, I'd love for something that was portable to Windows.
</p>

<p>
I've done just a bit of poking around, and it wasn't quite clear to me what the right choice was.
</p>

<ul class="org-ul">
<li>I looked at <b>tsdl</b> and <b>tgls</b>, but it wasn't clear to me with either of them how to rotate a texture. Maybe I'm just missing something?  Also, I found tgls a little hard to navigate, since I haven't used opengl for 20 years. I feel like rotation has to be in there, but searching for "rotate" in the docs comes up empty, and I couldn't find any good examples. The portability story here seemed hopeful.</li>
<li>I looked at OCaml's venerable <b>Graphics</b> library. Super easy to use, not sure about the portability story.</li>
<li><b>wall</b>.  Seems to have all the capabilities, not sure about the portability story.</li>
<li><b>web</b>. Portable, though I'd need to have a more complex setup for users, where the native OCaml program would run a web-server that would communicate to the OCaml UI, since I need this to be a native app. Feels extra complicated.</li>
</ul>

<p>
Anyway, does anyone have any suggestions on what path to take? Am I missing any options?
</p>
</div>
</div>


<div id="outline-container-org3294f1a" class="outline-3">
<h3 id="org3294f1a">Daniel Bünzli replied</h3>
<div class="outline-text-3" id="text-org3294f1a">
<blockquote>
<p>
I looked at <b>tsdl</b> and <b>tgls</b> , but it wasn’t clear to me with either of them how to rotate a
texture. Maybe I’m just missing something?
</p>
</blockquote>

<p>
I have never really used the SDL 2D support but it could have you covered.
<a href="https://erratique.ch/software/tsdl/doc/Tsdl/Sdl/index.html#val-render_copy_ex">This</a> should allow you
to rotate a texture.
</p>

<blockquote>
<p>
Maybe I’m just missing something? Also, I found tgls a little hard to navigate, since I haven’t used
opengl for 20 years. I feel like rotation has to be in there, but searching for “rotate” in the docs
comes up empty, and I couldn’t find any good examples. The portability story here seemed hopeful.
</p>
</blockquote>

<p>
The OpenGL of today bares little ressemblance to the one you knew,
<a href="https://github.com/dbuenzli/tgls/blob/master/test/trigl3.ml">this</a> is the  hello world nowadays.
Rotation is there under the form of matrices that you access in shaders but you also need to deal with
defining, compiling and feeding those with data which brings quite a bit of boiler plate (see the
example).
</p>

<p>
Also on macOS, OpenGL "the API", seems to be on the way out. I suspect the 2D SDL API may be a better
bet since it will likely keep you with a compatibility, hardware accelerated layer.
</p>

<p>
If you can lift the native constraint, the web would still be my first shot, nothing beats it's ease of
installation.
</p>
</div>
</div>


<div id="outline-container-orgeb46dec" class="outline-3">
<h3 id="orgeb46dec">holmdunc added</h3>
<div class="outline-text-3" id="text-orgeb46dec">
<p>
Yeah, SDL already uses the Metal rendering backend by default on macOS. Can be confirmed using <a href="https://erratique.ch/software/tsdl/doc/Tsdl/Sdl/index.html#val-get_renderer_info">this
function</a>.
</p>
</div>
</div>


<div id="outline-container-orgd9a1553" class="outline-3">
<h3 id="orgd9a1553">Tobias Mock also replied</h3>
<div class="outline-text-3" id="text-orgd9a1553">
<p>
You surely can't go wrong with SDL/tsdl.
</p>

<p>
Another alternative could be <a href="https://www.raylib.com/">raylib</a>, a gamedev library created mainly for
teaching. The lib has tons of examples, of which a few are already translated to the <a href="https://github.com/tjammer/raylib-ocaml">OCaml
bindings</a>. There is also an <a href="https://github.com/tjammer/raylib-ocaml/blob/master/examples/textures/textures_srcrec_dstrec.ml">example for rotating a
texture</a>.
And it works on Windows.
</p>
</div>
</div>


<div id="outline-container-org4b86667" class="outline-3">
<h3 id="org4b86667">Ohad Rau said</h3>
<div class="outline-text-3" id="text-org4b86667">
<p>
Looks like I'm a little late to the thread but I think
<a href="https://github.com/revery-ui/reason-skia">reason-skia</a> is an awesome choice. It should provide all the
Skia primitives which are pretty similar to the JavaScript canvas API and it's specifically focused on
2d graphics. It's also got great cross-platform support. It's being very actively developed as part of
<a href="https://github.com/revery-ui/revery">Revery</a>, so it seems much more up to date than tsdl/tgls (IIRC
Bryan, the maintainer for Revery, developed his own SDL bindings since tsdl was too out of date).
</p>

<p>
It's also possible to use the Skia bindings through Revery to take advantage of the rest of Revery's
features: <a href="https://github.com/revery-ui/revery/blob/79cab021464662fb56ebe57b70b9d18e65e2d99e/examples/CanvasExample.re">Revery exposes Skia as part of its Canvas
API</a>.
This is really nice because you can avoid all the window setup stuff you'd have to do with SDL or raw
OpenGL.
</p>


<div class="figure">
<p><img src="https://aws1.discourse-cdn.com/standard11/uploads/ocaml/original/2X/4/4af4285b00a0712cc751c703932dbcbad3e5800d.png" alt="4af4285b00a0712cc751c703932dbcbad3e5800d.png" />
</p>
</div>
</div>
</div>


<div id="outline-container-orgc2070d9" class="outline-3">
<h3 id="orgc2070d9">Tom Ekander added</h3>
<div class="outline-text-3" id="text-orgc2070d9">
<p>
If you excuse the Reason-syntax, here's a "Hello World"-example for Revery using Canvas.
</p>


<div class="figure">
<p><img src="https://aws1.discourse-cdn.com/standard11/uploads/ocaml/optimized/2X/0/0d8e788aa1770f2462af2aad7ddce98f9a0201e0_2_1035x739.jpeg" alt="0d8e788aa1770f2462af2aad7ddce98f9a0201e0_2_1035x739.jpeg" />
</p>
</div>
</div>
</div>


<div id="outline-container-org8955bfd" class="outline-3">
<h3 id="org8955bfd">Daniel Bünzli then asked</h3>
<div class="outline-text-3" id="text-org8955bfd">
<blockquote>
<p>
it seems much more up to date than tsdl/tgls (IIRC Bryan, the maintainer for Revery, developed his own
SDL bindings since tsdl was too out of date).
</p>
</blockquote>

<p>
Before false information starts to spread could you please make precise what is "too out of date" in
tsdl ?
</p>

<p>
A few things that made it in SDL <a href="https://hg.libsdl.org/SDL/file/3b03741c0095/WhatsNew.txt">2.0.7-11</a>
may not be in (but some of these things were actually contributed, I don't remember exactly which
ones).
</p>

<p>
But given the surface of the API and as you can witness by reading the linked release notes if
something is missing that's not much and rather trivial to add.
</p>
</div>
</div>
</div>




<div id="outline-container-orgdc40afa" class="outline-2">
<h2 id="5">1sr release of omlr: Multiple Linear Regression modeling (using R under the carpet)</h2>
<div class="outline-text-2" id="text-5">
<p>
Archive: <a href="https://discuss.ocaml.org/t/ann-1sr-release-of-omlr-multiple-linear-regression-modeling-using-r-under-the-carpet/6417/1">https://discuss.ocaml.org/t/ann-1sr-release-of-omlr-multiple-linear-regression-modeling-using-r-under-the-carpet/6417/1</a>
</p>
</div>

<div id="outline-container-orgc64a35e" class="outline-3">
<h3 id="orgc64a35e">UnixJunkie announced</h3>
<div class="outline-text-3" id="text-orgc64a35e">
<p>
omlr is now available in opam.
</p>
<pre class="example">
# opam info omlr

&lt;&gt;&lt;&gt; omlr: information on all versions &gt;&lt;&gt;&lt;&gt;&lt;&gt;&lt;&gt;&lt;&gt;&lt;&gt;&lt;&gt;&lt;&gt;&lt;&gt;&lt;&gt;&lt;&gt;&lt;&gt;&lt;&gt;&lt;&gt;&lt;&gt;&lt;&gt;&lt;&gt;&lt;&gt;&lt;&gt;&lt;&gt;
name                   omlr
all-installed-versions 1.0.2 [default]
all-versions           1.0.2

&lt;&gt;&lt;&gt; Version-specific details &lt;&gt;&lt;&gt;&lt;&gt;&lt;&gt;&lt;&gt;&lt;&gt;&lt;&gt;&lt;&gt;&lt;&gt;&lt;&gt;&lt;&gt;&lt;&gt;&lt;&gt;&lt;&gt;&lt;&gt;&lt;&gt;&lt;&gt;&lt;&gt;&lt;&gt;&lt;&gt;&lt;&gt;&lt;&gt;&lt;&gt;&lt;&gt;&lt;&gt;
version       1.0.2
repository    github
url.src:      "https://github.com/UnixJunkie/omlr/archive/v1.0.2.tar.gz"
url.checksum: "md5=4b637863b4bc4ed2e27de45cf0872736"
homepage:     "https://github.com/UnixJunkie/omlr"
bug-reports:  "https://github.com/UnixJunkie/omlr/issues"
dev-repo:     "git+https://github.com/UnixJunkie/omlr.git"
authors:      "Francois Berenger"
maintainer:   "unixjunkie@sdf.org"
license:      "BSD-3"
depends:      "batteries"
              "conf-gnuplot"
              "conf-r"
              "cpm"
              "dolog" {&gt;= "4.0.0"}
              "dune" {&gt;= "1.11"}
              "minicli" {&gt;= "5.0.0"}
              "ocaml"
synopsis      Multiple Linear Regression model
description   Train a MLR model using R.
              usage:
              ./mlr_model
                [-i &lt;input.csv&gt;]: input CSV file
                [--NxCV &lt;int&gt;]: number of folds of cross validation
                [-s|--save &lt;filename&gt;]: save model to file
                [-l|--load &lt;filename&gt;]: restore model from file
                [-o &lt;filename&gt;]: predictions output file
                [--no-shuffle]: do not randomize input lines
                [--no-header]: CSV file has no header
                [--no-plot]: don't call gnuplot
                [-d &lt;char&gt;]: field delimited in CSV file (default=',')
                [-v]: verbose/debug mode
                [-h|--help]: show this message
</pre>

<p>
The project is here:
<a href="https://github.com/UnixJunkie/omlr">https://github.com/UnixJunkie/omlr</a>
</p>

<p>
Note that it could be entirely programmed using owl.
However, I find R more portable than owl, hence the hack.
</p>
</div>
</div>
</div>




<div id="outline-container-org311ebcc" class="outline-2">
<h2 id="6">Multicore OCaml: August 2020</h2>
<div class="outline-text-2" id="text-6">
<p>
Archive: <a href="https://discuss.ocaml.org/t/multicore-ocaml-august-2020/6418/1">https://discuss.ocaml.org/t/multicore-ocaml-august-2020/6418/1</a>
</p>
</div>

<div id="outline-container-orgf5f46d3" class="outline-3">
<h3 id="orgf5f46d3">Anil Madhavapeddy announced</h3>
<div class="outline-text-3" id="text-orgf5f46d3">
<p>
Welcome to the August 2020 Multicore OCaml report (a few weeks late due to August slowdown). This
update along with the <a href="https://discuss.ocaml.org/tag/multicore-monthly">previous updates</a> have been
compiled by @shakthimaan, @kayceesrk and myself.
</p>

<p>
There are some talks related to multicore OCaml which are now freely available online:
</p>

<ul class="org-ul">
<li>At the OCaml Workshop, @sadiq presented <a href="https://www.youtube.com/watch?v=Z7YZR1q8wzI&amp;list=PLKO_ZowsIOu5fHjRj0ua7_QWE_L789K_f&amp;index=6&amp;t=0s">"How to parallelise your code with Multicore OCaml"</a></li>
<li>At ICFP, @kayceesrk presented <a href="https://www.youtube.com/watch?v=i9wgeX7e-nc&amp;t=6180s">"Retrofitting Parallelism onto OCaml"</a>, which was also awarded a Distinguished Paper award.</li>
<li>At ICFP, Glenn Mével presented <a href="https://www.youtube.com/watch?v=aNLOi-1ixwM&amp;t=2610s">"Cosmo: A Concurrent Separation Logic for Multicore OCaml"</a>.</li>
<li>At the WebAssembly Community Group meeting,  @kayceesrk gave a talk on <a href="https://kcsrk.info/slides/WASM_CG_4Aug20.pdf">Effect Handlers in Multicore OCaml</a>.  This is related to our longer term efforts to ensure that OCaml has an efficient compilation strategy to WebAssembly.</li>
</ul>

<p>
The Multicore OCaml project has had a number of optimisations and performance improvements in the month
of August 2020:
</p>
<ul class="org-ul">
<li>The PR on the <a href="https://github.com/ocaml-multicore/ocaml-multicore/pull/381">implementation of systhreads with pthreads</a> continues to undergo review and improvement. When merged, this opens up the possibility of installing dune and other packages with Multicore OCaml.</li>
<li>Implementations of mutex and condition variables is also now <a href="https://github.com/ocaml-multicore/ocaml-multicore/pull/390">under review</a> for the `Domain` module.</li>
<li>Work has begun on implementing <a href="https://github.com/ocaml-multicore/ocaml-multicore/pull/394">GC safe points</a> to ensure reliable, low-latency garbage collection can occur.</li>
</ul>

<p>
We would like to particularly thank these external contributors:
</p>
<ul class="org-ul">
<li>Albin Coquereau and Guillaume Bury for their comments and recommendations on building Alt-Ergo.2.3.2 with dune.2.6.0 and Multicore OCaml 4.10.0 in a sandbox environment.</li>
<li>@Leonidas for testing the code size metric implementation with <code>Core</code> and <code>Async</code>, and for code review changes.</li>
</ul>

<p>
Contributions such as the above towards adapting your projects with our benchmarking suites are always
most welcome.  As with previous updates, we begin with the Multicore OCaml updates, which are then
followed by the enchancements and bug fixes to the Sandmark benchmarking project. The upstream OCaml
ongoing and completed tasks are finally mentioned for your reference.
</p>
</div>

<div id="outline-container-org11b9c78" class="outline-4">
<h4 id="org11b9c78">Multicore OCaml</h4>
<div class="outline-text-4" id="text-org11b9c78">
</div>
<ul class="org-ul">
<li><a id="org3bae572"></a>Ongoing<br />
<div class="outline-text-5" id="text-org3bae572">
<ul class="org-ul">
<li><p>
<a href="https://github.com/ocaml-multicore/ocaml-multicore/pull/381">ocaml-multicore/ocaml-multicore#381</a>
Reimplementating systhreads with pthreads
</p>

<p>
This PR has made tremendous progress with additions to domain API,
changes in interaction with the backup thread, and bug fixes. We are
now able to build <code>dune.2.6.1</code> and <code>utop</code> with this PR for Multicore
OCaml, and it is ready for review!
</p></li>

<li><p>
<a href="https://github.com/ocaml-multicore/ocaml-multicore/pull/384">ocaml-multicore/ocaml-multicore#384</a>
Add a primitive to insert nop instruction
</p>

<p>
The <code>nop</code> primitive is introduced to identify the start and end of
an instruction sequence to aid in debugging low-level code.
</p></li>

<li><p>
<a href="https://github.com/ocaml-multicore/ocaml-multicore/pull/390">ocaml-multicore/ocaml-multicore#390</a>
Initial implementation of Mutexes and Condition Variables
</p>

<p>
A draft proposal that adds support for Mutex variables and Condition
operations for the Multicore runtime.
</p></li>
</ul>
</div>
</li>

<li><a id="orgdd5ebf7"></a>Completed<br />
<ul class="org-ul">
<li><a id="org1478b71"></a>Optimisations<br />
<div class="outline-text-6" id="text-org1478b71">
<ul class="org-ul">
<li><p>
<a href="https://github.com/ocaml-multicore/domainslib/pull/16">ocaml-multicore/domainslib#16</a>
Improvement of parallel_for implementation
</p>

<p>
A divide-and-conquer scheme is introduced to distribute work in
<code>parallel_for</code>, and the <code>chunk_size</code> is made a parameter to improve
scaling with more than 8-16 cores. The blue line in the following
illustration shows the improvement for few benchmarks in Sandmark
using the default <code>chunk_size</code> along with this PR:
<img src="https://aws1.discourse-cdn.com/standard11/uploads/ocaml/optimized/2X/d/d2cb71fa73825cce9231538e213d1815dde0f139_2_697x750.png" alt="d2cb71fa73825cce9231538e213d1815dde0f139_2_697x750.png" />
</p></li>

<li><p>
<a href="https://github.com/ocaml-multicore/multicore-opam/pull/28">ocaml-multicore/multicore-opam</a>
Use <code>-j%{jobs}%</code> for multicore variant builds
</p>

<p>
The use of <code>-j%{jobs}%</code> in the build step for multicore variants
will speed up opam installs.
</p></li>

<li><p>
<a href="https://github.com/ocaml-multicore/ocaml-multicore/pull/374">ocaml-multicore/ocaml-multicore#374</a>
Force major slice on minor collection
</p>

<p>
A minor collection will need to schedule a major collection, if a
blocked thread may not progress the major GC when servicing the
minor collector through <code>handle_interrupt</code>.
</p></li>

<li><p>
<a href="https://github.com/ocaml-multicore/ocaml-multicore/pull/378">ocaml-multicore/ocaml-multicore#378</a>
Hold onto empty pools if swept while allocating
</p>

<p>
An optimization to improve pause times and reduce the number of
locks by using a <code>release_to_global_pool</code> flag in <code>pool_sweep</code>
function that continues to hold onto the empty pools.
</p></li>

<li><p>
<a href="https://github.com/ocaml-multicore/ocaml-multicore/pull/379">ocaml-multicore/ocaml-multicore#379</a>
Interruptible mark and sweep
</p>

<p>
The mark and sweep work is now made interruptible so that domains
can enter the stop-the-world minor collections even if one domain is
performing a large task. For example, for the binary tree benchmark
with four domains, major work (pink) in domain three stalls progress
for other domains as observed in the eventlog.
<img src="https://aws1.discourse-cdn.com/standard11/uploads/ocaml/optimized/2X/e/ef309b229845e21ce8d2753ef30009139e6da5f0_2_808x750.png" alt="ef309b229845e21ce8d2753ef30009139e6da5f0_2_808x750.png" />
</p>

<p>
With this patch, we can observe that the major work in domains two
and four make progress in the following illustration:
<img src="https://aws1.discourse-cdn.com/standard11/uploads/ocaml/optimized/2X/1/1b731fa02e721c6b00a5a81080a7517742751aab_2_982x750.png" alt="1b731fa02e721c6b00a5a81080a7517742751aab_2_982x750.png" />
</p></li>

<li><p>
<a href="https://github.com/ocaml-multicore/ocaml-multicore/pull/380">ocaml-multicore/ocaml-multicore#380</a>
Make DLS call to <code>caml_domain_dls_get</code> <code>@@noalloc</code>
</p>

<p>
The <code>caml_dls_get</code> is tagged with <code>@@noalloc</code> to reduce the C call
overhead.
</p></li>

<li><p>
<a href="https://github.com/ocaml-multicore/ocaml-multicore/pull/382">ocaml-multicore/ocaml-multicore#382</a>
Optimise <code>caml_continuation_use_function</code>
</p>

<p>
A couple of optimisations that yield 25% performance improvements
for the generator example by using <code>caml_domain_alone</code>, and using
<code>caml_gc_log</code> under <code>DEBUG</code> mode.
</p></li>

<li><p>
<a href="https://github.com/ocaml-multicore/ocaml-multicore/pull/389">ocaml-multicore/ocaml-multicore#389</a>
Avoid holding domain_lock when using backup thread
</p>

<p>
The wait time for the main OCaml thread is reduced by altering the
backup thread logic without holding the <code>domain_lock</code> for the
<code>BT_IN_BLOCKING_SECTION</code>.
</p></li>
</ul>
</div>
</li>

<li><a id="orgd96a5c9"></a>Sundries<br />
<div class="outline-text-6" id="text-orgd96a5c9">
<ul class="org-ul">
<li><p>
<a href="https://github.com/ocaml-multicore/ocaml-multicore/pull/391">ocaml-multicore/ocaml-multicore#391</a>
Use <code>Word_val</code> for pointers with <code>Patomic_load</code>
</p>

<p>
A bug fix to correctly handle <code>Patomic_load</code> for loaded pointers.
</p></li>

<li><p>
<a href="https://github.com/ocaml-multicore/ocaml-multicore/pull/392">ocaml-multicore/ocaml-multicore#392</a>
Include Ipoll in leaf function test
</p>

<p>
The <code>Ipoll</code> operation is now added to <code>asmcomp/amd64/emit.mlp</code> as an external call.
</p></li>
</ul>
</div>
</li>
</ul>
</li>
</ul>
</div>

<div id="outline-container-org4964fd4" class="outline-4">
<h4 id="org4964fd4">Benchmarking</h4>
<div class="outline-text-4" id="text-org4964fd4">
</div>
<ul class="org-ul">
<li><a id="orgc11a451"></a>Ongoing<br />
<div class="outline-text-5" id="text-orgc11a451">
<ul class="org-ul">
<li><p>
<a href="https://github.com/ocaml-bench/sandmark/issues/122">ocaml-bench/sandmark#122</a>
Measurements of code size
</p>

<p>
The code size of a benchmark is one measurement that is required for
<code>flambda</code> branch. A
<a href="https://github.com/ocaml-bench/sandmark/pull/165">PR</a> has been
created that now emits a count of the CAML symbols in the output of
a bench result as shown below:
</p>

<pre class="example">
{"name":"knucleotide.", ... ,"codesize":276859.0, ...}
</pre></li>

<li><p>
<a href="https://github.com/ocaml-bench/sandmark/pull/169">ocaml-bench/sandmark#169</a>
Add check_url for .json and pkg-config, m4 in Makefile
</p>

<p>
A <code>check_url</code> target in the Makefile has been defined to ensure that
the <code>ocaml-versions/*.json</code> files have a URL parameter. The patch
also adds <code>pkg-config</code> and <code>m4</code> to Ubuntu dependencies.
</p></li>
</ul>
</div>
</li>

<li><a id="org6f1c5dc"></a>Completed<br />
<ul class="org-ul">
<li><a id="org9ef5a81"></a>Benchmarks<br />
<div class="outline-text-6" id="text-org9ef5a81">
<ul class="org-ul">
<li><p>
<a href="https://github.com/ocaml-bench/sandmark/issues/107">ocaml-bench/sandmark#107</a>
Add Coq benchmarks
</p>

<p>
The <code>fraplib</code> library from the <a href="https://github.com/achlipala/frap">Formal Reasoning About
Programs</a> has been dunified and
included in Sandmark for Coq benchmarks.
</p></li>

<li><p>
<a href="https://github.com/ocaml-bench/sandmark/pull/151">ocaml-bench/sandmark#151</a>
Evolutionary algorithm parallel benchmark
</p>

<p>
The evolutionary algorithm parallel benchmark is now added to Sandmark.
</p></li>

<li><p>
<a href="https://github.com/ocaml-bench/sandmark/pull/152">ocaml-bench/sandmark#152</a>
LU decomposition: random numbers initialisation in parallel
</p>

<p>
The random number initialisation for the LU decomposition benchmark
now has parallelism that uses <code>Domain.DLS</code> and <code>Random.State</code>.
</p></li>

<li><p>
<a href="https://github.com/ocaml-bench/sandmark/pull/153">ocaml-bench/sandmark#153</a>
Add computationally intensive Coq benchmarks
</p>

<p>
The <code>BasicSyntax</code> and <code>AbstractInterpretation</code> Coq files perform a
lot of minor GCs and allocations, and have been added as benchmarks
to Sandmark.
</p></li>

<li><p>
<a href="https://github.com/ocaml-bench/sandmark/pull/155">ocaml-bench/sandmark#155</a>
Sequential version of Evolutionary Algorithm
</p>

<p>
The sequential version of algorithms are used for comparison with
their respective parallel implementations. A sequential
implementation for the <code>Evolutionary Algorithm</code> has now been included
in Sandmark.
</p></li>

<li><p>
<a href="https://github.com/ocaml-bench/sandmark/pull/157">ocaml-bench/sandmark#157</a>
Minilight Multicore: Port to Task API and DLS for Random States
</p>

<p>
The Minilight benchmark has been ported to use the Task API along
with the use of Domain Local Storage for the Random States. The
speedup is shown in the following illustration:
</p>


<div class="figure">
<p><img src="https://user-images.githubusercontent.com/13328130/89261588-f5072980-d64b-11ea-9364-3f18342b7274.png" alt="89261588-f5072980-d64b-11ea-9364-3f18342b7274.png" />
</p>
</div></li>

<li><p>
<a href="https://github.com/ocaml-bench/sandmark/pull/164">ocaml-bench/sandmark#164</a>
Tweaks to multicore-numerical/game_of_life
</p>

<p>
The <code>board_size</code> for the Game of Life numerical benchmark is now
configurable, and can be supplied as an argument.
</p></li>
</ul>
</div>
</li>

<li><a id="org2570ced"></a>Bug Fixes<br />
<div class="outline-text-6" id="text-org2570ced">
<ul class="org-ul">
<li><p>
<a href="https://github.com/ocaml-bench/sandmark/pull/156">ocaml-bench/sandmark#156</a>
Fix calculation of Nbody Multicore
</p>

<p>
Minor fixes in the calculation of interactions of the bodies in the
<code>Nbody</code> implementation, and use of local ref vars to reduce writes and
cache traffic.
</p></li>

<li><p>
<a href="https://github.com/ocaml-bench/sandmark/pull/158">ocaml-bench/sandmark#158</a>
Fix key error for Grammatrix for Jupyter notebook
</p>

<p>
The <code>Key Error</code> issue with <code>notebooks/parallel/parallel.ipynb</code> is
now resolved by passing a value to params in the
<code>multicore_parallel_run_config.json</code> file.
</p></li>
</ul>
</div>
</li>

<li><a id="orgbc80f61"></a>Sundries<br />
<div class="outline-text-6" id="text-orgbc80f61">
<ul class="org-ul">
<li><p>
<a href="https://github.com/ocaml-bench/sandmark/pull/154">ocaml-bench/sandmark#154</a>
Revert PARAMWRAPPER changes
</p>

<p>
Undo the <code>PARAMWRAPPER</code> configuration for parallel benchmark runs in
the Makefile, as they are not required for sequential execution.
</p></li>

<li><p>
<a href="https://github.com/ocaml-bench/sandmark/pull/160">ocaml-bench/sandmark#160</a>
Specify prefix,libdir for alt-ergo sandbox builds
</p>

<p>
The <code>alt-ergo</code> library and parser require the <code>prefix</code> and <code>libdir</code>
to be specified with <code>configure</code> in order to build in a sandbox
environment. The initial discussion is available at
<a href="https://github.com/OCamlPro/alt-ergo/issues/351">OCamlPro/alt-ergo#351</a>.
</p></li>

<li><p>
<a href="https://github.com/ocaml-bench/sandmark/pull/162">ocaml-bench/sandmark#162</a>
Avoid installing packages which are unused for Multicore runs
</p>

<p>
The <code>PACKAGES</code> variable in the Makefile has been simplified to
include only those dependency packages that are required to build
Sandmark.
</p></li>

<li><p>
<a href="https://github.com/ocaml-bench/sandmark/pull/163">ocaml-bench/sandmark#163</a>
Update to domainslib 0.2.2 and use default chunk_size
</p>

<p>
The <code>domainslib</code> dependency package has been updated to use the
0.2.2 released version, and <code>chunk_size</code> for various benchmarks uses
<code>num_tasks/num_domains</code> as default.
</p></li>
</ul>
</div>
</li>
</ul>
</li>
</ul>
</div>

<div id="outline-container-orgd14b072" class="outline-4">
<h4 id="orgd14b072">OCaml</h4>
<div class="outline-text-4" id="text-orgd14b072">
</div>
<ul class="org-ul">
<li><a id="orgadcd98d"></a>Ongoing<br />
<div class="outline-text-5" id="text-orgadcd98d">
<ul class="org-ul">
<li><p>
<a href="https://github.com/ocaml/ocaml/pull/9756">ocaml/ocaml#9756</a>
Garbage collectors colour change
</p>

<p>
The PR is needed for use with the Multicore OCaml major collector by
removing the need of gray colour in the garbage collector (GC)
colour scheme.
</p></li>
</ul>
</div>
</li>

<li><a id="orgb0468a9"></a>Completed<br />
<div class="outline-text-5" id="text-orgb0468a9">
<ul class="org-ul">
<li><p>
<a href="https://github.com/ocaml/ocaml/pull/9722">ocaml/ocaml#9722</a>
EINTR-based signals, again
</p>

<p>
The patch provides a new implementation to solve a collection of
locking, signal-handling and error checking issues.
</p></li>
</ul>

<p>
Our thanks to all the OCaml developers and users in the community for their support and contribution to
the project. Stay safe!
</p>
</div>
</li>
</ul>
</div>

<div id="outline-container-org443aea7" class="outline-4">
<h4 id="org443aea7">Acronyms</h4>
<div class="outline-text-4" id="text-org443aea7">
<ul class="org-ul">
<li>API: Application Programming Interface</li>
<li>DLS: Domain Local Storage</li>
<li>GC: Garbage Collector</li>
<li>OPAM: OCaml Package Manager</li>
<li>LU: Lower Upper (decomposition)</li>
<li>PR: Pull Request</li>
</ul>
</div>
</div>
</div>
</div>




<div id="outline-container-org53093c9" class="outline-2">
<h2 id="org53093c9">Old CWN</h2>
<div class="outline-text-2" id="text-org53093c9">
<p>
If you happen to miss a CWN, you can <a href="mailto:alan.schmitt@polytechnique.org">send me a message</a> and I'll mail it to you, or go take a look at <a href="http://alan.petitepomme.net/cwn/">the archive</a> or the <a href="http://alan.petitepomme.net/cwn/cwn.rss">RSS feed of the archives</a>.
</p>

<p>
If you also wish to receive it every week by mail, you may subscribe <a href="http://lists.idyll.org/listinfo/caml-news-weekly/">online</a>.
</p>

<div class="authorname">
<p>
<a href="http://alan.petitepomme.net/">Alan Schmitt</a>
</p>

</div>
</div>
</div>
</div>
</body>
</html>
