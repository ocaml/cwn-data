<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<!-- 2022-01-04 Tue 08:52 -->
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>OCaml Weekly News</title>
<meta name="generator" content="Org mode" />
<style type="text/css">
 <!--/*--><![CDATA[/*><!--*/
  .title  { text-align: center;
             margin-bottom: .2em; }
  .subtitle { text-align: center;
              font-size: medium;
              font-weight: bold;
              margin-top:0; }
  .todo   { font-family: monospace; color: red; }
  .done   { font-family: monospace; color: green; }
  .priority { font-family: monospace; color: orange; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .org-right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .org-left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .org-center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #ccc;
    box-shadow: 3px 3px 3px #eee;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: auto;
    padding-top: 1.2em;
  }
  pre.src:before {
    display: none;
    position: absolute;
    background-color: white;
    top: -10px;
    right: 10px;
    padding: 3px;
    border: 1px solid black;
  }
  pre.src:hover:before { display: inline; margin-top: 14px;}
  /* Languages per Org manual */
  pre.src-asymptote:before { content: 'Asymptote'; }
  pre.src-awk:before { content: 'Awk'; }
  pre.src-C:before { content: 'C'; }
  /* pre.src-C++ doesn't work in CSS */
  pre.src-clojure:before { content: 'Clojure'; }
  pre.src-css:before { content: 'CSS'; }
  pre.src-D:before { content: 'D'; }
  pre.src-ditaa:before { content: 'ditaa'; }
  pre.src-dot:before { content: 'Graphviz'; }
  pre.src-calc:before { content: 'Emacs Calc'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-fortran:before { content: 'Fortran'; }
  pre.src-gnuplot:before { content: 'gnuplot'; }
  pre.src-haskell:before { content: 'Haskell'; }
  pre.src-hledger:before { content: 'hledger'; }
  pre.src-java:before { content: 'Java'; }
  pre.src-js:before { content: 'Javascript'; }
  pre.src-latex:before { content: 'LaTeX'; }
  pre.src-ledger:before { content: 'Ledger'; }
  pre.src-lisp:before { content: 'Lisp'; }
  pre.src-lilypond:before { content: 'Lilypond'; }
  pre.src-lua:before { content: 'Lua'; }
  pre.src-matlab:before { content: 'MATLAB'; }
  pre.src-mscgen:before { content: 'Mscgen'; }
  pre.src-ocaml:before { content: 'Objective Caml'; }
  pre.src-octave:before { content: 'Octave'; }
  pre.src-org:before { content: 'Org mode'; }
  pre.src-oz:before { content: 'OZ'; }
  pre.src-plantuml:before { content: 'Plantuml'; }
  pre.src-processing:before { content: 'Processing.js'; }
  pre.src-python:before { content: 'Python'; }
  pre.src-R:before { content: 'R'; }
  pre.src-ruby:before { content: 'Ruby'; }
  pre.src-sass:before { content: 'Sass'; }
  pre.src-scheme:before { content: 'Scheme'; }
  pre.src-screen:before { content: 'Gnu Screen'; }
  pre.src-sed:before { content: 'Sed'; }
  pre.src-sh:before { content: 'shell'; }
  pre.src-sql:before { content: 'SQL'; }
  pre.src-sqlite:before { content: 'SQLite'; }
  /* additional languages in org.el's org-babel-load-languages alist */
  pre.src-forth:before { content: 'Forth'; }
  pre.src-io:before { content: 'IO'; }
  pre.src-J:before { content: 'J'; }
  pre.src-makefile:before { content: 'Makefile'; }
  pre.src-maxima:before { content: 'Maxima'; }
  pre.src-perl:before { content: 'Perl'; }
  pre.src-picolisp:before { content: 'Pico Lisp'; }
  pre.src-scala:before { content: 'Scala'; }
  pre.src-shell:before { content: 'Shell Script'; }
  pre.src-ebnf2ps:before { content: 'ebfn2ps'; }
  /* additional language identifiers per "defun org-babel-execute"
       in ob-*.el */
  pre.src-cpp:before  { content: 'C++'; }
  pre.src-abc:before  { content: 'ABC'; }
  pre.src-coq:before  { content: 'Coq'; }
  pre.src-groovy:before  { content: 'Groovy'; }
  /* additional language identifiers from org-babel-shell-names in
     ob-shell.el: ob-shell is the only babel language using a lambda to put
     the execution function name together. */
  pre.src-bash:before  { content: 'bash'; }
  pre.src-csh:before  { content: 'csh'; }
  pre.src-ash:before  { content: 'ash'; }
  pre.src-dash:before  { content: 'dash'; }
  pre.src-ksh:before  { content: 'ksh'; }
  pre.src-mksh:before  { content: 'mksh'; }
  pre.src-posh:before  { content: 'posh'; }
  /* Additional Emacs modes also supported by the LaTeX listings package */
  pre.src-ada:before { content: 'Ada'; }
  pre.src-asm:before { content: 'Assembler'; }
  pre.src-caml:before { content: 'Caml'; }
  pre.src-delphi:before { content: 'Delphi'; }
  pre.src-html:before { content: 'HTML'; }
  pre.src-idl:before { content: 'IDL'; }
  pre.src-mercury:before { content: 'Mercury'; }
  pre.src-metapost:before { content: 'MetaPost'; }
  pre.src-modula-2:before { content: 'Modula-2'; }
  pre.src-pascal:before { content: 'Pascal'; }
  pre.src-ps:before { content: 'PostScript'; }
  pre.src-prolog:before { content: 'Prolog'; }
  pre.src-simula:before { content: 'Simula'; }
  pre.src-tcl:before { content: 'tcl'; }
  pre.src-tex:before { content: 'TeX'; }
  pre.src-plain-tex:before { content: 'Plain TeX'; }
  pre.src-verilog:before { content: 'Verilog'; }
  pre.src-vhdl:before { content: 'VHDL'; }
  pre.src-xml:before { content: 'XML'; }
  pre.src-nxml:before { content: 'XML'; }
  /* add a generic configuration mode; LaTeX export needs an additional
     (add-to-list 'org-latex-listings-langs '(conf " ")) in .emacs */
  pre.src-conf:before { content: 'Configuration File'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.org-right  { text-align: center;  }
  th.org-left   { text-align: center;   }
  th.org-center { text-align: center; }
  td.org-right  { text-align: right;  }
  td.org-left   { text-align: left;   }
  td.org-center { text-align: center; }
  dt { font-weight: bold; }
  .footpara { display: inline; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .equation-container {
    display: table;
    text-align: center;
    width: 100%;
  }
  .equation {
    vertical-align: middle;
  }
  .equation-label {
    display: table-cell;
    text-align: right;
    vertical-align: middle;
  }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  .org-svg { width: 90%; }
  /*]]>*/-->
</style>
<style type="text/css">#table-of-contents h2 { display: none } .title { display: none } .authorname { text-align: right }</style>
<style type="text/css">.outline-2 {border-top: 1px solid black;}</style>
<script type="text/javascript">
// @license magnet:?xt=urn:btih:e95b018ef3580986a04669f1b5879592219e2a7a&dn=public-domain.txt Public Domain
<!--/*--><![CDATA[/*><!--*/
     function CodeHighlightOn(elem, id)
     {
       var target = document.getElementById(id);
       if(null != target) {
         elem.classList.add("code-highlighted");
         target.classList.add("code-highlighted");
       }
     }
     function CodeHighlightOff(elem, id)
     {
       var target = document.getElementById(id);
       if(null != target) {
         elem.classList.remove("code-highlighted");
         target.classList.remove("code-highlighted");
       }
     }
    /*]]>*///-->
// @license-end
</script>
</head>
<body>
<div id="content">
<h1 class="title">OCaml Weekly News</h1>
<p>
<a href="https://alan.petitepomme.net/cwn/2021.12.28.html">Previous Week</a> <a href="https://alan.petitepomme.net/cwn/index.html">Up</a> <a href="https://alan.petitepomme.net/cwn/2022.01.11.html">Next Week</a>
</p>

<p>
Hello
</p>

<p>
Here is the latest OCaml Weekly News, for the week of December 28, 2021 to January 04, 2022.
</p>

<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#1">A hack for toplevel breakpoints using effect handlers</a></li>
<li><a href="#2">Multi-shot continuations gone forever?</a></li>
<li><a href="#3">New release of Menhir (20211230)</a></li>
<li><a href="#4">Improved documentation for Fix</a></li>
<li><a href="#5">pp-binary-ints 0.1.1</a></li>
<li><a href="#org4e6eb8a">Old CWN</a></li>
</ul>
</div>
</div>


<div id="outline-container-1" class="outline-2">
<h2 id="1">A hack for toplevel breakpoints using effect handlers</h2>
<div class="outline-text-2" id="text-1">
<p>
Archive: <a href="https://discuss.ocaml.org/t/a-hack-for-toplevel-breakpoints-using-effect-handlers/9065/1">https://discuss.ocaml.org/t/a-hack-for-toplevel-breakpoints-using-effect-handlers/9065/1</a>
</p>
</div>

<div id="outline-container-org7e0af4c" class="outline-3">
<h3 id="org7e0af4c">wiktor announced</h3>
<div class="outline-text-3" id="text-org7e0af4c">
<p>
I started playing with effect handlers and wondered if they could be used to implement toplevel breakpoints. It's a
big hack and probably unsound at the moment, but it works and here's an example interaction:
</p>

<div class="org-src-container">
<pre class="src src-ocaml"><span style="color: #000000; font-weight: bold;">let</span> <span style="color: #a0522d;">arr</span> =
  <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #0000ff;">fact</span> <span style="color: #a0522d;">n</span> =
    <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #a0522d;">arr</span> = <span style="color: #228b22;">Array.</span>make (n+1) 1 <span style="color: #000000; font-weight: bold;">in</span>
    <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #000000; font-weight: bold;">rec</span> <span style="color: #0000ff;">loop</span> <span style="color: #a0522d;">i</span> =
      <span style="color: #a020f0;">if</span> i &lt;= n <span style="color: #a020f0;">then</span> <span style="color: #000000; font-weight: bold;">begin</span>
        <span style="color: #228b22;">Break.</span>break [<span style="color: #8b2252;">"i"</span>, i; <span style="color: #8b2252;">"arr"</span>, arr];
        arr.(i) &lt;- arr.(i-1) * i;
        loop (i+1)
      <span style="color: #000000; font-weight: bold;">end</span>
    <span style="color: #000000; font-weight: bold;">in</span>
    (loop 1; arr)
  <span style="color: #000000; font-weight: bold;">in</span>
    fact 5<span style="color: #ff4500;">;;</span>
# <span style="color: #b22222;">(* </span><span style="color: #b22222;">We hit a breakpoint and obtain the continuation k </span><span style="color: #b22222;">*)</span>
  k ()<span style="color: #ff4500;">;;</span>
- : bool = <span style="color: #008b8b;">true</span>
# <span style="color: #b22222;">(* </span><span style="color: #b22222;">the bools are leaking from the execute_phrase function</span>
<span style="color: #b22222;">   * inside the toplevel </span><span style="color: #b22222;">*)</span>
  k ()<span style="color: #ff4500;">;;</span>
- : bool = <span style="color: #008b8b;">true</span>
# i<span style="color: #ff4500;">;;</span>
- : int = 3
# arr<span style="color: #ff4500;">;;</span>
- : int array = [|1; 1; 2; 1; 1; 1|]
# <span style="color: #b22222;">(* </span><span style="color: #b22222;">let's disturb the computation of factorials </span><span style="color: #b22222;">*)</span>
  arr.(i-1) &lt;- 42<span style="color: #ff4500;">;;</span>
- : unit = ()
# k ()<span style="color: #ff4500;">;;</span>
- : bool = <span style="color: #008b8b;">true</span>
# <span style="color: #b22222;">(* </span><span style="color: #b22222;">btw: here the user is like a scheduler for yield-based async </span><span style="color: #b22222;">*)</span>
  k ()<span style="color: #ff4500;">;;</span>
- : bool = <span style="color: #008b8b;">true</span>
# k ()<span style="color: #ff4500;">;;</span>
<span style="color: #000000; font-weight: bold;">val</span> <span style="color: #0000ff;">arr</span> : int array = [|1; 1; 42; 126; 504; 2520|]
- : bool = <span style="color: #008b8b;">true</span>
</pre>
</div>

<p>
Currently I don't try to clean up bindings or values, which is a source of unsoundness. After the last <code>k ()</code> we got
two results: First the computation of <code>let arr ...</code> finished, and then the computation of <code>k ()</code> finished. But <code>k</code> is
a part of the execution of <code>let arr ...</code>, so these two executions "intersect" without one being contained in the
other. This makes the question of what should the current variable bindings be complicated. Setting the bindings at
end of execution is futile, when a continuation may in such a way leak bindings from breakpoint time.
</p>

<p>
Possibly a stack discipline for the execution of phrases is required to make the environments behave properly: at the
end of executing a phrase we cancel (with another effect, maybe) other executions which "depend" on the current
execution (evaluate the <code>k</code> obtained from a breakpoint in the current execution). This should eliminate these
"intersections" and we could throw out the bindings added by the cancelled executions.
</p>

<p>
I haven't tried anything with polymorphism yet, but type variables should probably be changed into abstract types
inside the binders.
</p>

<p>
Here's the code:
<a href="https://github.com/ocaml-multicore/ocaml/compare/multicore-pr...wiktorkuchta:toplevel-break">https://github.com/ocaml-multicore/ocaml/compare/multicore-pr...wiktorkuchta:toplevel-break</a>
</p>
</div>
</div>


<div id="outline-container-org796826f" class="outline-3">
<h3 id="org796826f">wiktor later said</h3>
<div class="outline-text-3" id="text-org796826f">
<p>
Well, this might have been unnecessary, as most of it can be done properly in userspace (with more syntactic
overhead).
</p>

<div class="org-src-container">
<pre class="src src-ocaml"><span style="color: #000000; font-weight: bold;">open </span><span style="color: #228b22;">EffectHandlers</span>
<span style="color: #000000; font-weight: bold;">open </span><span style="color: #228b22;">Deep</span>

<span style="color: #000000; font-weight: bold;">type</span> <span style="color: #228b22;">('a, 'b) res</span> =
  | <span style="color: #000000; background-color: #ffffff;">Bp</span> <span style="color: #a020f0;">of</span> 'a * ((unit, ('a, 'b) res) continuation)
  | <span style="color: #000000; background-color: #ffffff;">Fin</span> <span style="color: #a020f0;">of</span> 'b

<span style="color: #000000; font-weight: bold;">module type</span> <span style="color: #228b22;">P1</span> = <span style="color: #000000; font-weight: bold;">sig</span>  <span style="color: #000000; font-weight: bold;">val</span> <span style="color: #0000ff;">i</span> : int  <span style="color: #000000; font-weight: bold;">val</span> <span style="color: #0000ff;">arr</span> : int array <span style="color: #000000; font-weight: bold;">end</span>
<span style="color: #000000; font-weight: bold;">type</span> <span style="color: #228b22;">payload</span> = <span style="color: #000000; background-color: #ffffff;">P1</span> <span style="color: #a020f0;">of</span> (<span style="color: #a020f0;">module</span> <span style="color: #228b22;">P1</span>)
<span style="color: #000000; font-weight: bold;">type</span> <span style="color: #228b22;">_ eff</span> += <span style="color: #000000; background-color: #ffffff;">Break</span> : payload -&gt; unit eff

<span style="color: #000000; font-weight: bold;">let</span> <span style="color: #0000ff;">arr</span> () =
  <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #0000ff;">fact</span> <span style="color: #a0522d;">n</span> =
    <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #a0522d;">arr</span> = <span style="color: #228b22;">Array.</span>make (n+1) 1 <span style="color: #000000; font-weight: bold;">in</span>
    <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #000000; font-weight: bold;">rec</span> <span style="color: #0000ff;">loop</span> <span style="color: #a0522d;">i</span> =
      <span style="color: #a020f0;">if</span> i &lt;= n <span style="color: #a020f0;">then</span> <span style="color: #000000; font-weight: bold;">begin</span>
        perform (<span style="color: #000000; background-color: #ffffff;">Break</span> (<span style="color: #000000; background-color: #ffffff;">P1</span> (<span style="color: #000000; font-weight: bold;">module</span> <span style="color: #000000; font-weight: bold;">struct</span> <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #a0522d;">i</span> = i <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #a0522d;">arr</span> = arr <span style="color: #000000; font-weight: bold;">end</span>)));
        arr.(i) &lt;- arr.(i-1) * i;
        loop (i+1)
      <span style="color: #000000; font-weight: bold;">end</span>
    <span style="color: #000000; font-weight: bold;">in</span>
    (loop 1; arr)
  <span style="color: #000000; font-weight: bold;">in</span>
    fact 5<span style="color: #ff4500;">;;</span>

<span style="color: #000000; font-weight: bold;">let</span> <span style="color: #0000ff;">with_break</span> <span style="color: #a0522d;">th</span> =
  try_with (<span style="color: #a020f0;">fun</span> () -&gt; <span style="color: #000000; background-color: #ffffff;">Fin</span> (th ())) ()
  { effc = <span style="color: #a020f0;">fun</span> (<span style="color: #a020f0;">type</span> <span style="color: #228b22;">a</span>) (<span style="color: #a0522d;">e</span> :<span style="color: #228b22;"> a eff</span>) -&gt;
      <span style="color: #a020f0;">match</span> e <span style="color: #a020f0;">with</span>
      | <span style="color: #000000; background-color: #ffffff;">Break</span> p -&gt; <span style="color: #000000; background-color: #ffffff;">Some</span> (<span style="color: #a020f0;">fun</span> (<span style="color: #a0522d;">k</span> :<span style="color: #228b22;"> (a,_) continuation</span>) -&gt; <span style="color: #000000; background-color: #ffffff;">Bp</span> (p, k))
      | _ -&gt; <span style="color: #000000; background-color: #ffffff;">None</span> }

<span style="color: #000000; font-weight: bold;">let</span> <span style="color: #0000ff;">cont</span> = <span style="color: #a020f0;">function</span>
  | <span style="color: #000000; background-color: #ffffff;">Bp</span> (_, k) -&gt; continue k ()
  | <span style="color: #000000; background-color: #ffffff;">Fin</span> _ -&gt; <span style="color: #483d8b;">failwith</span> <span style="color: #8b2252;">"computation finished, cannot continue"</span>

<span style="color: #000000; font-weight: bold;">let</span> <span style="color: #0000ff;">get</span> = <span style="color: #a020f0;">function</span>
  | <span style="color: #000000; background-color: #ffffff;">Bp</span> (r, _) -&gt; r
  | <span style="color: #000000; background-color: #ffffff;">Fin</span> _ -&gt; <span style="color: #483d8b;">failwith</span> <span style="color: #8b2252;">"computation finished, no breakpoint payload"</span>

<span style="color: #000000; font-weight: bold;">let</span> <span style="color: #0000ff;">get1</span> <span style="color: #a0522d;">r</span> = <span style="color: #a020f0;">match</span> get r <span style="color: #a020f0;">with</span> <span style="color: #000000; background-color: #ffffff;">P1</span> m -&gt; m
</pre>
</div>

<div class="org-src-container">
<pre class="src src-ocaml"># <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #a0522d;">r</span> = with_break arr<span style="color: #ff4500;">;;</span>
<span style="color: #000000; font-weight: bold;">val</span> <span style="color: #0000ff;">r</span> : (payload, int array) res = <span style="color: #000000; background-color: #ffffff;">Bp</span> (<span style="color: #000000; background-color: #ffffff;">P1</span> &lt;<span style="color: #000000; font-weight: bold;">module</span>&gt;, &lt;abstr&gt;)
# <span style="color: #000000; font-weight: bold;">open </span>(<span style="color: #000000; font-weight: bold;">val</span> <span style="color: #0000ff;">get1</span> r)<span style="color: #ff4500;">;;</span>
<span style="color: #000000; font-weight: bold;">val</span> <span style="color: #0000ff;">i</span> : int = 1
<span style="color: #000000; font-weight: bold;">val</span> <span style="color: #0000ff;">arr</span> : int array = [|1; 1; 1; 1; 1; 1|]
</pre>
</div>

<p>
The main pain point is having to define the payload types. In basic cases the payload type could be just a simple
polymorphic variant. It would be nice if it could be completely inferred, but it's unlikely as `Break` has to have a
statically known argument.
</p>

<p>
With a bit of help from tooling (ppxes for code generation and shorthands in the toplevel), this could be better than
printf debugging.
</p>
</div>
</div>


<div id="outline-container-orgbee38c0" class="outline-3">
<h3 id="orgbee38c0">Guillaume Munch-Maccagnoni then said</h3>
<div class="outline-text-3" id="text-orgbee38c0">
<p>
This is an interesting experiment.
</p>
<ul class="org-ul">
<li>This reminds me of the idea of high-level stack inspection for debugging and security (articulated for instance in Clements' PhD thesis <span class="underline"><a href="https://www2.ccs.neu.edu/racket/pubs/dissertation-clements.pdf">Portable and high-level access to the stack with Continuation Marks</a></span>; here's <a href="https://dl.acm.org/doi/10.1145/3385412.3385981">another more recent paper</a> from the Racket people that might be relevant). One can ask whether a PPX can provide high-level stack inspection or if one needs support from the compiler for that. It's nice to experiment.</li>
<li>A few years ago someone asked whether there could be a use to untyped algebraic effects in OCaml (in the sense that they do not appear in the effect annotation in function types). I proposed debugging as an example. Someone suggested that it is not too hard to adapt the interface types of all functions in the call chain to add the appropriate effect annotation (and remove it afterwards), but I was not convinced.</li>
</ul>
</div>
</div>
</div>




<div id="outline-container-2" class="outline-2">
<h2 id="2">Multi-shot continuations gone forever?</h2>
<div class="outline-text-2" id="text-2">
<p>
Archive: <a href="https://discuss.ocaml.org/t/multi-shot-continuations-gone-forever/9072/1">https://discuss.ocaml.org/t/multi-shot-continuations-gone-forever/9072/1</a>
</p>
</div>

<div id="outline-container-org4c84513" class="outline-3">
<h3 id="org4c84513">cyberpink asked</h3>
<div class="outline-text-3" id="text-org4c84513">
<p>
What happens with multi-shot continuations now that Obj.clone_continuation was removed?
(<a href="https://github.com/ocaml-multicore/ocaml-multicore/pull/651">https://github.com/ocaml-multicore/ocaml-multicore/pull/651</a>)
</p>

<p>
Anything that requires a "fork" operation, like say, a probabilistic programming EDSL, needs this. None of the old
examples I've looked at like <a href="https://github.com/ocaml-multicore/effects-examples/blob/master/delimcc.ml">Delimcc on top of
effects</a> have been updated to use a new
method, and I haven't been able to find any hints of one.
</p>

<p>
Are multi-shot continuations just not possible now? Are there plans to add something equivalent back in later?
</p>
</div>
</div>


<div id="outline-container-org1b9ae8e" class="outline-3">
<h3 id="org1b9ae8e">Nicolás Ojeda Bär replied</h3>
<div class="outline-text-3" id="text-org1b9ae8e">
<p>
Yes, multi-shot continuations are gone and is unlikely that they will find their way back any time soon. One (good)
reason is explained in <a href="https://dl.acm.org/doi/10.1145/3434314">https://dl.acm.org/doi/10.1145/3434314</a> :
</p>


<div id="orgf3585b4" class="figure">
<p><img src="https://aws1.discourse-cdn.com/standard11/uploads/ocaml/original/2X/8/8d26520ef0f790fd3dc4407458d925c1a28fdbca.png" alt="8d26520ef0f790fd3dc4407458d925c1a28fdbca.png" />
</p>
</div>

<p>
and
</p>


<div id="org03e20c1" class="figure">
<p><img src="https://aws1.discourse-cdn.com/standard11/uploads/ocaml/original/2X/b/b28fa14f967364743277c0132a804c430d2d66d1.png" alt="b28fa14f967364743277c0132a804c430d2d66d1.png" />
</p>
</div>
</div>
</div>


<div id="outline-container-org3eeb05e" class="outline-3">
<h3 id="org3eeb05e">Guillaume Munch-Maccagnoni then said</h3>
<div class="outline-text-3" id="text-org3eeb05e">
<p>
I think the question still stands. You cut the sentence “_Extending our system with multi-shot continuations is
future work (§8)_”. Also the paper is about a particular model based on separation logic rather than OCaml itself
(for instance the authors also mention that their continuations are affine instead of linear unlike in OCaml
multicore).
</p>

<p>
Nevertheless, the multicore designers were aware that duplicating continuations makes it complicated to reason about
resources. The topic of mixing continuations and linearity has been better studied from the angle of algebraic models
of computation and proof theory. Essentially, with an effect system you could ensure that certain kinds of effects do
not happen in the delimited part of the program (including allocating a resource), which controls copiability of the
stack from the point of view of reasoning about the program. This is inspired by some logics that mix classical and
intuitionistic or linear logic. From this angle the ability to copy a continuation would be restricted to a sub-part
of the language which is pure to some degree. This should also be a suitable starting point if one wanted to develop
a program logic to formalise the reasoning about such programs.
</p>

<p>
However according to <a href="https://github.com/ocaml-multicore/ocaml-multicore/pull/651">#651</a> there were more technical
reasons to drop <code>clone_continuation</code>, such as breaking compiler optimizations. I am curious as well to know whether
there are plans to reintroduce <code>clone_continuation</code> at some point, but obviously this would require some effort.
</p>
</div>
</div>


<div id="outline-container-org3c95be1" class="outline-3">
<h3 id="org3c95be1">KC Sivaramakrishnan said</h3>
<div class="outline-text-3" id="text-org3c95be1">
<p>
@nojb and @gadmm have already answered why we've dropped support for <code>clone_continuation</code> now. We will need to track
the copiability of the continuation in the continuation type and compiler optimisations also need to be made aware of
the possibility of copying. Given the pervasive nature of its effects, there are no immediate plans to bring the
feature back. We will have to come back to this after we have typed effects.
</p>

<blockquote>
<p>
Anything that requires a “fork” operation, like say, a probabilistic programming EDSL
</p>
</blockquote>

<p>
One can get pretty far with PPL with just one-shot continuations. My student and I did some experiments building a
DSL for a PPL to learn about the space: <a href="https://github.com/Arnhav-Datar/EffPPL">https://github.com/Arnhav-Datar/EffPPL</a>. Having spoken to PPL experts there
are indeed some usecases where multi-shot continuations are useful, but from what I understand, the one-shotness
isn't a blocker for PPL.
</p>

<p>
I would be interested in collecting usecases where multi-shot continuations are absolutely necessary.
</p>
</div>
</div>


<div id="outline-container-orgfa44a95" class="outline-3">
<h3 id="orgfa44a95">gasche then said</h3>
<div class="outline-text-3" id="text-orgfa44a95">
<p>
Interesting!
</p>

<p>
My (probably naive) mental model of HANSEI-style libraries, using multishot continuations, is that they are
extensions/generalization of a non-probabilistic "logic/non-deterministic monad" that searches for the set of
solutions to a problem. Multishot continuations are naturally used in non-deterministic computations at backtracking
points, to explore different search directions and collect the result. It is possible to avoid multishot
continuations by replaying the whole search from the start each time (reference: <a href="https://arxiv.org/pdf/1710.10385">Capturing the future by replaying
the past</a>), but this involves duplicated computations so it is less efficient
(reference: <a href="https://arxiv.org/abs/2007.00605">Asymptotic speedup with first-class control</a>).
</p>

<p>
Can you give some intuition of how other approaches to probalistic inference work, that do not require multishot
continuations? Are they also duplicating computations, or are they using a magic trick to avoid this issue with a
different inference algorithm?
</p>

<p>
I tried to find an answer to this question by reading the <a href="https://github.com/Arnhav-Datar/EffPPL/blob/main/EffPPL_Report.pdf">internship
report</a>, but I couldn't locate an answer. (The
report mentions HANSEI in the related work, but it does not discuss this question.) The report explains that the
inference algorithm, called HMC (Hamiltonian Monte Carlo), uses automatic differenciation; so it uses a sort of
symbolic manipulation / analysis of the probabilistic program to sample. But does this avoid repeated computations?
It may be the case instead that the differential is as large or larger than the program itself, and that the search
algorithm using this differential in effect perform a program-sized computation at each search step, duplicating
computations.
</p>
</div>
</div>


<div id="outline-container-org0e7e826" class="outline-3">
<h3 id="org0e7e826">Sadiq said</h3>
<div class="outline-text-3" id="text-org0e7e826">
<p>
Not a PPL but I've been hacking on a little effects-based model checker for concurrent data structures that
implements dynamic partial order reduction (<a href="https://github.com/sadiqj/dscheck/">https://github.com/sadiqj/dscheck/</a> - a WIP!). Multi-shot continuations
would have been very useful.
</p>

<p>
I ended up implementing something that involves maintaining a schedule and repeatedly replaying the computation. It
looks very similar to what <a href="https://arxiv.org/pdf/1710.10385">Capturing the future..</a> proposes.
</p>
</div>
</div>
</div>




<div id="outline-container-3" class="outline-2">
<h2 id="3">New release of Menhir (20211230)</h2>
<div class="outline-text-2" id="text-3">
<p>
Archive: <a href="https://discuss.ocaml.org/t/ann-new-release-of-menhir-20211230/9077/1">https://discuss.ocaml.org/t/ann-new-release-of-menhir-20211230/9077/1</a>
</p>
</div>

<div id="outline-container-orgb8430f9" class="outline-3">
<h3 id="orgb8430f9">François Pottier announced</h3>
<div class="outline-text-3" id="text-orgb8430f9">
<p>
Dear OCaml &amp; Menhir users,
</p>

<p>
I am pleased to announce a new release of Menhir, with a major improvement.
</p>

<p>
The code back-end has been rewritten from the ground up by Émile Trotignon
and by myself, and now produces efficient and well-typed OCaml code. The
infamous Obj.magic is not used any more.
</p>

<p>
Furthermore, the new code back-end produces code that is more aggressively
optimized, leading to a significant reduction in memory allocation and a
typical performance improvement of up to 20% compared to the previous code
back-end.
</p>

<div class="org-src-container">
<pre class="src src-shell">opam update
opam install menhir.20211230
</pre>
</div>

<p>
Happy well-typed parsing in 2022!
</p>
</div>

<div id="outline-container-org710ab9a" class="outline-4">
<h4 id="org710ab9a">2021/12/30</h4>
<div class="outline-text-4" id="text-org710ab9a">
<ul class="org-ul">
<li><p>
The code back-end has been rewritten from the ground up by Émile Trotignon
and François Pottier, and now produces efficient and <b>well-typed</b> OCaml
code. The infamous <code>Obj.magic</code> is not used any more.
</p>

<p>
The table back-end and the Coq back-end are unaffected by this change.
</p>

<p>
The main side effects of this change are as follows:
</p>

<ul class="org-ul">
<li>The code back-end now needs type information. This means that <br />
<i>either</i> Menhir's type inference mechanism must be enabled
	 (the easiest way of enabling it is to use Menhir via <code>dune</code>
	  and to check that the <code>dune-project</code> file says
	  <code>(using menhir 2.0)</code> or later) <br />
<i>or</i> the type of every nonterminal symbol must be
     explicitly given via a <code>%type</code> declaration.</li>

<li>The code back-end no longer allows the type of any symbol to be an
open polymorphic variant type, such as <code>[&gt; `A ]</code>. As a workaround,
we suggest using a closed polymorphic variant instead.</li>

<li><p>
The code back-end now adheres to the <i>simplified</i> error-handling strategy,
as opposed to the <i>legacy</i> strategy.
</p>

<p>
For grammars that do <i>not</i> use the <code>error</code> token, this makes no difference.
</p>

<p>
For grammars that use the <code>error</code> token in the limited way permitted by
the simplified strategy, this makes no difference either. The simplified
strategy makes the following requirement: the <code>error</code> token should always
appear at the end of a production, whose semantic action should abort the
parser by raising an exception.
</p>

<p>
Grammars that make more complex use of the <code>error</code> token, and therefore
need the <code>legacy</code> strategy, cannot be compiled by the new code back-end.
As a workaround, it is possible to switch to the table back-end (using
<code>--table --strategy legacy</code>) or to the ancient code back-end (using
<code>--code-ancient</code>). <b>In the long run, we recommend abandoning the use of
the <code>error</code> token</b>. Support for the <code>error</code> token may be removed
entirely at some point in the future.
</p></li>
</ul>

<p>
The original code back-end, which has been around since the early days of
Menhir (2005), temporarily remains available (using <code>--code-ancient</code>). It
will be removed at some point in the future.
</p>

<p>
The new code back-end offers several levels of optimization, which remain
undocumented and are subject to change in the future. At present, the main
levels are roughly as follows:
</p>

<ul class="org-ul">
<li><code>-O 0 --represent-everything</code> uses a uniform representation of the stack
and produces straightforward code.</li>
<li><code>-O 0</code> uses a non-uniform representation of the stack; some stack cells
have fewer fields; some stack cells disappear altogether.</li>
<li><code>-O 1</code> reduces memory traffic by moving <code>PUSH</code> operations so that they
meet <code>POP</code> operations and cancel out.</li>
<li><code>-O 2</code> optimizes the reduction of unit productions (that is, productions
whose right-hand side has length 1) by performing a limited amount of
code specialization.</li>
</ul>

<p>
The default level of optimization is the maximum level, <code>-O 2</code>.
</p></li>

<li>The new command line switch <code>--exn-carries-state</code> causes the exception
<code>Error</code> to carry an integer parameter: <code>exception Error of int</code>. When the
parser detects a syntax error, the number of the current state is reported
in this way. This allows the caller to select a suitable syntax error
message, along the lines described in
<a href="http://cambium.inria.fr/~fpottier/menhir/manual.html#sec68">Section 11</a>
of the manual. This command line switch is currently supported by the code
back-end only.</li>

<li>The <code>$syntaxerror</code> keyword is no longer supported.</li>

<li>Document the trick of wrapping module aliases in <code>open struct ... end</code>,
like this: <code>%{ open struct module alias M = MyLongModuleName end %}</code>.
This allows you to use the short name <code>M</code> in your grammar, but forces
OCaml to infer types that refer to the long name <code>MyLongModuleName</code>.
(Suggested by Frédéric Bour.)</li>
</ul>
</div>
</div>
</div>
</div>




<div id="outline-container-4" class="outline-2">
<h2 id="4">Improved documentation for Fix</h2>
<div class="outline-text-2" id="text-4">
<p>
Archive: <a href="https://discuss.ocaml.org/t/ann-improved-documentation-for-fix/9079/1">https://discuss.ocaml.org/t/ann-improved-documentation-for-fix/9079/1</a>
</p>
</div>

<div id="outline-container-org946d6e3" class="outline-3">
<h3 id="org946d6e3">François Pottier announced</h3>
<div class="outline-text-3" id="text-org946d6e3">
<p>
My last contribution for 2021 is an improved documentation for Fix, a library that helps with various algorithmic
constructions that involve memoization, recursion, and numbering.
</p>

<p>
The documentation can be <a href="http://cambium.inria.fr/~fpottier/fix/doc/fix/">viewed online</a>.
</p>

<p>
It can also be viewed locally (on your own machine) as follows:
</p>

<div class="org-src-container">
<pre class="src src-shell">opam update
opam install fix.20211231
opam install odig
odig odoc                 <span style="color: #b22222;"># </span><span style="color: #b22222;">this may take some time</span>
odig doc fix              <span style="color: #b22222;"># </span><span style="color: #b22222;">this opens the doc in your browser</span>
</pre>
</div>

<p>
Happy fix'in' in 2022!
</p>
</div>
</div>
</div>




<div id="outline-container-5" class="outline-2">
<h2 id="5">pp-binary-ints 0.1.1</h2>
<div class="outline-text-2" id="text-5">
<p>
Archive: <a href="https://discuss.ocaml.org/t/ann-pp-binary-ints-0-1-1/9080/1">https://discuss.ocaml.org/t/ann-pp-binary-ints-0-1-1/9080/1</a>
</p>
</div>

<div id="outline-container-orgfd34600" class="outline-3">
<h3 id="orgfd34600">Ifaz Kabir announced</h3>
<div class="outline-text-3" id="text-orgfd34600">
<p>
Tired of printing octals and hexadecimals and then mentally converting them to bits. Ever wanted to just see the bits
in an int? Now you can!
</p>

<p>
Just run <code>opam install pp-binary-ints</code> and off you go:
</p>
<div class="org-src-container">
<pre class="src src-ocaml"># <span style="color: #228b22;">Pp_binary_ints.Int.</span>to_string 0b10101001<span style="color: #ff4500;">;;</span>
- : string = <span style="color: #8b2252;">"10101001"</span>
</pre>
</div>

<p>
You can find the documentation for the project and more examples of how to use it
<a href="https://ifazk.github.io/pp-binary-ints/pp-binary-ints/index.html">here</a>.
</p>

<p>
The library is very customizable.
</p>

<ul class="org-ul">
<li>You can choose to print with <code>0b</code> prefixes and <code>_</code> separators.</li>
<li>You can choose to print zeros just like the non-zeros, with prefixes and separators.</li>
<li>If you use zero padding, you can control how many leading zeros show up with the <code>~min_width</code> argument.</li>
<li>It correctly handles the edge cases when adding <code>_</code> separators: you won’t get leading underscores.</li>
<li>It includes pretty printers that work with <code>Format</code> and <code>Fmt</code> , not just <code>to_string</code> functions.</li>
<li>Supports <code>int</code>, <code>int32</code>, <code>int64</code>, and <code>nativeint</code>.</li>
<li>Don't like the default prefixes and suffixes? Customize the prefixes and suffixes with the provided functor.</li>
</ul>
</div>
</div>
</div>




<div id="outline-container-org4e6eb8a" class="outline-2">
<h2 id="org4e6eb8a">Old CWN</h2>
<div class="outline-text-2" id="text-org4e6eb8a">
<p>
If you happen to miss a CWN, you can <a href="mailto:alan.schmitt@polytechnique.org">send me a message</a> and I'll mail it to you, or go take a look at <a href="https://alan.petitepomme.net/cwn/">the archive</a> or the <a href="https://alan.petitepomme.net/cwn/cwn.rss">RSS feed of the archives</a>.
</p>

<p>
If you also wish to receive it every week by mail, you may subscribe <a href="http://lists.idyll.org/listinfo/caml-news-weekly/">online</a>.
</p>

<div class="authorname" id="org4d067ae">
<p>
<a href="https://alan.petitepomme.net/">Alan Schmitt</a>
</p>

</div>
</div>
</div>
</div>
</body>
</html>
