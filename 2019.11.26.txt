			  â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
			   OCAML WEEKLY NEWS
			  â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”


[Previous Week] [Up] [Next Week]

Hello

Here is the latest OCaml Weekly News, for the week of November 19 to 26,
2019.

Table of Contents
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

tiny_httpd 0.1
printbox.0.3
v0.13 release of Jane Street packages
opam2nix (v1)
GitHub Actions for OCaml / opam now available
OCurrent 0.1 (CI/CD pipeline eDSL)
New pages for OCaml API
Irmin 2.0.0 release
Tail cascade: a new indentation style for some OCaml constructs
Old CWN


[Previous Week] <http://alan.petitepomme.net/cwn/2019.11.19.html>

[Up] <http://alan.petitepomme.net/cwn/index.html>

[Next Week] <http://alan.petitepomme.net/cwn/2019.12.03.html>


tiny_httpd 0.1
â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  Archive: <https://discuss.ocaml.org/t/ann-tiny-httpd-0-1/4727/1>


Simon Cruanes announced
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  Hello and good morning, I'm pleased to announce that [tiny_httpd] 0.1
  has been released and is on opam.

  The goal is to emulate python's standard `http.server' by providing a
  0-dependencies, minimalist, simple HTTP server for embedding in
  applications that are not primarily a website, with very basic routing
  (thanks to `Scanf'). A binary `http_of_dir' is also distributed and
  can be used to serve a directory, with optional upload of files.


[tiny_httpd] <https://github.com/c-cube/tiny_httpd>


printbox.0.3
â•â•â•â•â•â•â•â•â•â•â•â•

  Archive: <https://discuss.ocaml.org/t/ann-printbox-0-3/4731/1>


Simon Cruanes announced
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  <https://aws1.discourse-cdn.com/standard11/uploads/ocaml/original/2X/8/8e7c55c5ab69c12f53a7862d2f84dd6e0cfc0dc0.png>

  â”Œâ”€â”€â”€â”€
  â”‚ let b =
  â”‚   let open PrintBox in
  â”‚   PrintBox_unicode.setup();
  â”‚   frame @@ grid_l [
  â”‚     [text "subject"; text_with_style Style.bold "announce: printbox 0.3"];
  â”‚     [text "explanation";
  â”‚     frame @@ text {|PrintBox is a library for rendering nested tables,
  â”‚     trees, and similar structures in monospace text or HTML.|}];
  â”‚     [text "github";
  â”‚     text_with_style Style.(bg_color Blue) "https://github.com/c-cube/printbox/releases/tag/0.3"];
  â”‚     [text "contributors";
  â”‚      vlist_map (text_with_style Style.(fg_color Green)) ["Simon"; "Guillaume"; "Matt"]];
  â”‚     [text "dependencies";
  â”‚     tree empty
  â”‚       [tree (text "mandatory")
  â”‚ 	 [text "dune"; text "bytes"];
  â”‚        tree (text "optional")
  â”‚ 	 [text "uutf"; text "uucp"; text "tyxml"]]];
  â”‚     [text "expected reaction"; text "ğŸ‰"];
  â”‚   ]
  â”‚ 
  â”‚ let () = print_endline @@ PrintBox_text.to_string b
  â””â”€â”€â”€â”€

  ([actual link to the release])


[actual link to the release]
<https://github.com/c-cube/printbox/releases/tag/0.3>


v0.13 release of Jane Street packages
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  Archive:
  <https://discuss.ocaml.org/t/ann-v0-13-release-of-jane-street-packages/4735/1>


Xavier Clerc announced
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  We are pleased to announce the v0.13 release of Jane Street packages!

  This release comes with 14 new packages, and a number of fixes and
  enhancements. The documentation for this release is available on our
  website:

  <https://ocaml.janestreet.com/ocaml-core/v0.13/doc/>

  The remainder of this mail highlights the main changes since the v0.12
  release; we hope it will be useful to developers in the process of
  migrating to the new version. A comprehensive changelog is available
  at the end.


Notable changes
â•Œâ•Œâ•Œâ•Œâ•Œâ•Œâ•Œâ•Œâ•Œâ•Œâ•Œâ•Œâ•Œâ•Œâ•Œ

  â€¢ Changed `Base', `Core_kernel', and `Core' functions to raise
    `Not_found_s' instead of `Not_found'.  `Hashtbl.find_exn' and
    `Map.find_exn' now include the key in their error message.

  â€¢ Changed `Core' and `Core_kernel' to export `int' comparison rather
    than polymorphic comparison.

  â€¢ Removed the "robust" float comparison operators (`>.', `=.', â€¦)
    from the default namespace.

  â€¢ Replaced `sexp_*' types (`sexp_list', `sexp_option', `sexp_opaque',
    â€¦) with preprocessor attributes (`[@sexp.list]', `[@sexp.option]',
    `[@sexp.opaque]', â€¦).

  â€¢ Changed `let%map' syntax from `let%map.Foo.Let_syntax' to
    `let%map.Foo'.

  â€¢ Added to `match%optional' support for specifying a path, so you can
    write `match%optional.Foo foo_option' rather than `let open
    Foo.Optional_syntax in match%optional foo_option'.

  â€¢ Improved `Base.Backtrace' so that it enables recording of backtraces
    in more situations, specifically when `OCAMLRUNPARAM' is defined but
    doesn't mention the backtrace flag, `b'.

  â€¢ Added javascript support for `Zarith', `Bigint', `Bignum', and
    `Bigdecimal'.

  â€¢ Changed `Hashtbl.create''s default `size' from 128 to 0.

  â€¢ Changed `Core_kernel.Command' so that all commands accept double
    dash flags: `--help', `--version', and `--build-info'.


New packages
â•Œâ•Œâ•Œâ•Œâ•Œâ•Œâ•Œâ•Œâ•Œâ•Œâ•Œâ•Œ

  â€¢ async_udp (<https://github.com/janestreet/async_udp>): UDP support
    for Async.

  â€¢ async_websocket (<https://github.com/janestreet/async_websocket>): A
    library that implements the websocket protocol on top of Async.

  â€¢ bonsai (<https://github.com/janestreet/bonsai>): A library for
    building dynamic webapps, using Js_of_ocaml.

  â€¢ postgres_async (<https://github.com/janestreet/postgres_async>):
    OCaml/async implementation of the postgres protocol (i.e., does not
    use C-bindings to libpq).

  â€¢ ppx_cold (<https://github.com/janestreet/ppx_cold>): Expands
    `[@cold]' into `[@inline never][@specialise never][@local never]'.

  â€¢ ppx_pattern_bind (<https://github.com/janestreet/ppx_pattern_bind>):
    A ppx for writing fast incremental bind nodes in a pattern match.

  â€¢ ppx_python (<https://github.com/janestreet/ppx_python>):
    `[@@deriving]' plugin to generate Python conversion functions.

  â€¢ ppx_yojson_conv (<https://github.com/janestreet/ppx_yojson_conv>):
    `[@@deriving]' plugin to generate Yojson conversion functions.

  â€¢ ppx_yojson_conv_lib
    (<https://github.com/janestreet/ppx_yojson_conv_lib>): Runtime lib
    for `ppx_yojson_conv'.

  â€¢ pythonlib (<https://github.com/janestreet/pythonlib>): A library to
    help writing wrappers around OCaml code for python.

  â€¢ sexp_select (<https://github.com/janestreet/sexp_select>): A library
    to use CSS-style selectors to traverse sexp trees.

  â€¢ timezone (<https://github.com/janestreet/timezone>): Time-zone
    handling.

  â€¢ toplevel_backend (<https://github.com/janestreet/toplevel_backend>):
    Shared backend for setting up toplevels.

  â€¢ zarith_stubs_js (<https://github.com/janestreet/zarith_stubs_js>):
    Javascript stubs for the Zarith library.


Deprecations / Removals
â•Œâ•Œâ•Œâ•Œâ•Œâ•Œâ•Œâ•Œâ•Œâ•Œâ•Œâ•Œâ•Œâ•Œâ•Œâ•Œâ•Œâ•Œâ•Œâ•Œâ•Œâ•Œâ•Œ

  `Async_kernel':

  â€¢ Deprecated monadic `ignore' functions in favor of `ignore_m'.

  `Base':

  â€¢ Deleted `Array.replace' and `replace_all' functions, which have been
    deprecated since before the last public release.

  â€¢ Deprecated `Result.ok_unit'; use `Ok ()'.

  â€¢ Removed the `Monad' and `Applicative' interfaces' `all_ignore'
    function; it was previously deprecated and replaced by `all_unit'.

  â€¢ Removed `List.dedup', which has been deprecated since 2017-04.

  â€¢ Removed `String' mutation functions, which have been deprecated in
    favor of `Bytes' since 2017-10.

  â€¢ Deprecated `Array.truncate', `Obj_array.unsafe_truncate', and
    `Uniform_array.unsafe_truncate'.

  â€¢ Deprecated `Sys.argv', which has been superseded by `get_argv',
    which is a function, reflecting the fact that `argv' can change (as
    of OCaml 4.09).

  `Core_kernel':

  â€¢ Removed `Core_kernel.Std', which had been deprecated for a year.

  â€¢ Deprecated type `Command.Spec.param' in favor of `Command.Param.t'.

  â€¢ Removed `Hashtbl' functions that had been deprecated for years.

  â€¢ Removed `Float.to_string_round_trippable', which has been deprecated
    in favor of `to_string' since 2017-04.

  â€¢ Deprecated `Fqueue' functions where one should use `Fdeque' instead:
    `bot', `bot_exn', and `enqueue_top'.

  â€¢ Deleted `Bus.unsubscribes', which will be obviated by a performance
    improvement to `Bus.unsubscribe'.

  `Timing_wheel':

  â€¢ Removed the `alarm_upper_bound' function, which has been deprecated
    for 6 months, and superseded by `max_allowed_alarm_time'.


Moves
â•Œâ•Œâ•Œâ•Œâ•Œ

  `Core_kernel':

  â€¢ Moved `Bounded_int_table' to a standalone library.

  â€¢ Moved the `Pool' and `Tuple_type' modules to a standalone library,
    `Tuple_pool'.

  `Async_unix':

  â€¢ Moved `Unix.Fd.replace' into a `Private' submodule.


Changelog
â•Œâ•Œâ•Œâ•Œâ•Œâ•Œâ•Œâ•Œâ•Œ

  Please visit
  <https://discuss.ocaml.org/t/ann-v0-13-release-of-jane-street-packages/4735>


opam2nix (v1)
â•â•â•â•â•â•â•â•â•â•â•â•â•

  Archive: <https://discuss.ocaml.org/t/ann-opam2nix-v1/4741/1>


Tim Cuthbertson announced
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  Anouncing opam2nix (v1)

  [opam2nix] generates [nix] expressions from the [opam] OCaml package
  repository. It works similarly to [bundix], [node2nix], etc:

  You run an (impure) command to resolve all transitive dependency
  versions using the current opam repository, generating a .nix file
  that locks down the exact package sources and versions. Then this file
  can be imported to provide `buildInputs' for building your ocaml
  project in nix.

  *What is nix and why would I care?* Well, that's a long story but the
   headline benefits of nix are:

  â€¢ reproducible builds (if it builds for me, it builds for you)
  â€¢ stateless (you don't set up switches and then install packages, each
    expression specifies everything it needs, and anything you don't
    have is fetched/built on demand)
  â€¢ language agnostic (takes care of non-ocaml dependencies)

  It's sadly not a shallow learning curve, but those benefits are hard
  to find elsewhere, so I obviously think it's worthwhile. So if you use
  nix (or would like to), please give it a try and provide
  feedback. I'll (slowly) start working on upstreaming it into nixpkgs.


[opam2nix] <https://github.com/timbertson/opam2nix>

[nix] <https://nixos.org/>

[opam] <https://opam.ocaml.org/>

[bundix] <https://github.com/nix-community/bundix>

[node2nix] <https://github.com/svanderburg/node2nix>


GitHub Actions for OCaml / opam now available
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  Archive:
  <https://discuss.ocaml.org/t/github-actions-for-ocaml-opam-now-available/4745/1>


Anil Madhavapeddy announced
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  I was in the [GitHub Actions] beta program and forward ported my code
  to the latest version that just went public.  It's a pretty simple way
  to get your OCaml code tested on Linux, macOS and Windows, without
  requiring an external CI service.  The action attempts to provide a
  homogenous interface across all three operating systems, so invoking
  'opam' from subsequent actions should "just work".

  You can find it here:
  â€¢ In the GitHub Marketplace at
    <https://github.com/marketplace/actions/setup-ocaml>
  â€¢ Source code on <https://github.com/avsm/setup-ocaml/>
  â€¢ Hello World usage on
    <https://github.com/avsm/hello-world-action-ocaml>
  â€¢ Usage in ocaml-yaml:
    â€¢ <https://github.com/avsm/ocaml-yaml/blob/master/.github/workflows/test.yml>
    â€¢ An [example ocaml-yaml run]

  This should be considered fairly experimental as GH Actions is so new.
  If you do use it, then consider [updating this issue with your usage].
  It does not current supporting caching yet, but is pretty fast to
  bootstrap (~4minutes).

  It also doesn't have any higher level purpose other than to set up an
  opam environment, since most of the additional functionality such as
  revdeps testing is planned for addition to the [ocurrent DSL].
  Nevertheless, this GH feature will hopefully be useful for smaller
  projects without a lot of computational requirements.  Let me know how
  it goes!

  Windows is currently supported through @fdopen's excellent fork that
  uses Cygwin.  As Windows support is being mainlined into opam itself
  at the moment, I'm hoping that we will gradually move over to that.
  That should eventually remove the need for two separate
  opam-repositories, so I won't be adding any features that are Linux or
  macOS-specific and do not work on the Cygwin version.


[GitHub Actions] <https://github.com/actions>

[example ocaml-yaml run]
<https://github.com/avsm/ocaml-yaml/runs/314055554>

[updating this issue with your usage]
<https://github.com/avsm/setup-ocaml/issues/4>

[ocurrent DSL]
<https://discuss.ocaml.org/t/ann-ocurrent-0-1-ci-cd-pipeline-edsl/4742/2>


OCurrent 0.1 (CI/CD pipeline eDSL)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  Archive:
  <https://discuss.ocaml.org/t/ann-ocurrent-0-1-ci-cd-pipeline-edsl/4742/1>


Thomas Leonard announced
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  [OCurrent] 0.1 has just been released to opam-repository.

  OCurrent is an OCaml eDSL intended for writing build/test/deploy
  pipelines. It is being used as the engine for [ocaml-ci] and the
  [docker-base-images] builder (used to build the OCaml Docker images,
  such as `ocurrent/opam:alpine-3.10-ocaml-4.08'). Other good uses might
  be building and redeploying a Docker service or a unikernel whenever
  its source repository changes. It can be run locally as a single Unix
  process.

  An OCurrent pipeline is written as an OCaml program, but the OCurrent
  engine ensures that it is kept up-to-date by re-running stages when
  their inputs change. A web UI is available so you can view your
  pipeline and see its current state.

  OCurrent can statically analyse the pipelines before they have run,
  allowing it to run steps in parallel automatically and to display the
  whole pipeline. It does this using a light-weight alternative to
  arrows, which doesn't require programming in an awkward point-free
  style. See [CI/CD Pipelines: Monad, Arrow or Dart?] for more about
  that.

  The basic functionality can be extended using "plugins" (just normal
  OCaml libraries). Plugins are available for interacting with Docker,
  Git, GitHub and Slack. These are in separate packages
  (e.g. `current_github') to avoid having the base package pull in too
  many dependencies).

  There is also an optional Cap'n Proto RPC interface, in the
  `current_rpc' opam package. This is used, for example, by [citty] to
  provide a TTY interface to ocaml-ci.

  [The OCurrent wiki] contains examples, and documentation on the
  various plugins.

  Here's an example pipeline (from the base image builder):

  <https://roscidus.com/blog/images/cicd/docker-base-images-thumb.png>


[OCurrent] <https://github.com/ocurrent/ocurrent>

[ocaml-ci] <https://github.com/ocurrent/ocaml-ci/>

[docker-base-images] <https://github.com/ocurrent/docker-base-images>

[CI/CD Pipelines: Monad, Arrow or Dart?]
<https://roscidus.com/blog/blog/2019/11/14/cicd-pipelines/>

[citty] <https://github.com/ocurrent/citty>

[The OCurrent wiki] <https://github.com/ocurrent/ocurrent/wiki>


Anil Madhavapeddy then added
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  For those curious about the relation to the existing CI used in
  opam-repository, then it is no coincidence that @talex5 is the author
  of both :-)

  This DSL is the next iteration of the [datakit-ci], but specialised to
  be faster and simpler for extending with OCaml and more complex
  workflows that our OCaml Platform tools need these days (like
  ocamlformat linting, or dune expect promotion, or odoc
  cross-referenced doc generation).  We are planning a smooth migration
  next year over to the new system, but wanted to release this early to
  show you some of the pieces going into this new iteration.  I am
  particularly excited about the new tty-based interface that saves an
  awful lot of clicking around on web UIs for CI resultsâ€¦


[datakit-ci] <https://github.com/moby/datakit>


New pages for OCaml API
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  Archive: <https://discuss.ocaml.org/t/new-pages-for-ocaml-api/4720/13>


Continuing this thread, sanette announced
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  I have uploaded a new version (same link
  <https://sanette.github.io/ocaml-api/>)
  â€¢ background color for links in the TOC @Maelan
  â€¢ more indentation for value descriptions @Maelan, @grayswandyr
  â€¢ word wrapping long `<pre>' codes @grayswandyr
  â€¢ type table: remove `(*' and `*)', give more space to code wrt
    comments, diminish comment's color @grayswandyr

  searching is not ready yetâ€¦ please wait suggestions for dark theme
  welcome


sanette later added
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  I have just uploaded a new version with a basic search engine.
  â€¢ for each page, you can search values/modules
  â€¢ in the general index page, the search includes also the descriptions
  â€¢ search results are ranked by relevance

  the downside is that each page now comes with an index of about 570Kb
  in the form of an index.js file. I'm kind of hoping that the browser
  will cache this, but I'm not sure. It would be maybe better to only
  load the index file on demand.


Irmin 2.0.0 release
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  Archive: <https://discuss.ocaml.org/t/ann-irmin-2-0-0-release/4746/1>


Thomas Gazagnaire announced
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  On behalf of the Irmin development team, I am very happy to announce
  the release of Irmin 2.0.0, a major release of the Git-like
  distributed branching and storage substrate that underpins
  [MirageOS]. We began the release process for all the components that
  make up Irmin [back in May 2019], and there have been close to 1000
  commits since Irmin 1.4.0 released back in June 2018. To celebrate
  this milestone, we have a new logo and opened a dedicated website:
  [irmin.org].

  More details here: <https://tarides.com/blog/2019-11-21-irmin-v2>


[MirageOS] <https://mirage.io/>

[back in May 2019]
<https://tarides.com/blog/2019-05-13-on-the-road-to-irmin-v2>

[irmin.org] <https://irmin.org/>


Tail cascade: a new indentation style for some OCaml constructs
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  Archive:
  <https://discuss.ocaml.org/t/tail-cascade-a-new-indentation-style-for-some-ocaml-constructs/4736/1>


gasche announced
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  I recently decided to change my indentation style for certain OCaml
  constructs in a way that I'm going to describe below. I just coined a
  name for this approach, "tail cascade". I'm creating this topic to
  convince everyone that this is a cool idea you should adopt as
  well. Or at least tolerate it when you review other people's code.


Problem
â•Œâ•Œâ•Œâ•Œâ•Œâ•Œâ•Œ

  Programs that heavily use `match' often see a shift to the right due
  to nested indentation.

  â”Œâ”€â”€â”€â”€
  â”‚ match foo with
  â”‚ | Foo -> ...
  â”‚ | Bar x ->
  â”‚   match bar x with
  â”‚   | FooBar -> ...
  â”‚   | Blah y ->
  â”‚     match f y with
  â”‚     | Some z ->
  â”‚       ...
  â””â”€â”€â”€â”€

  Another problem with this style is that it suffers from the "dangling
  bar" issue: if you try to add a new case for one of the exterior
  `match', it is parsed as belonging to the innermost `match'. People
  have been recommending (rightly) to use `begin match .. end' for all
  nested match constructs to avoid this issue.

  â”Œâ”€â”€â”€â”€
  â”‚ match foo with
  â”‚ | Foo -> ...
  â”‚ | Bar x ->
  â”‚   begin match bar x with
  â”‚   | FooBar -> ...
  â”‚   | Blah y ->
  â”‚     begin match f y with
  â”‚     | None -> ...
  â”‚     | Some z ->
  â”‚       ...
  â”‚     end
  â”‚   (* now this is safe *)
  â”‚   | FooBlah -> ...
  â”‚   end
  â””â”€â”€â”€â”€

  But still the unpleasant shift to the right remains.


Proposal: cascading tail case
â•Œâ•Œâ•Œâ•Œâ•Œâ•Œâ•Œâ•Œâ•Œâ•Œâ•Œâ•Œâ•Œâ•Œâ•Œâ•Œâ•Œâ•Œâ•Œâ•Œâ•Œâ•Œâ•Œâ•Œâ•Œâ•Œâ•Œâ•Œâ•Œ

  We should in general use `begin match .. end' for nested matches. But
  the "cascading tail case" proposal is to *not* do it for the *last*
  case of the pattern-matching, and instead *de-indent* (dedent) this
  last case â€“ tail case.

  â”Œâ”€â”€â”€â”€
  â”‚ match foo with
  â”‚ | Foo -> ...
  â”‚ | Bar x ->
  â”‚ match bar x with
  â”‚ | FooBar -> ...
  â”‚ | Blah y ->
  â”‚ match f y with
  â”‚ | None -> ...
  â”‚ | Some z ->
  â”‚ ...
  â””â”€â”€â”€â”€

  Note that with this indentation style, the "dangling match" problem is
  also avoided: unlike with the original, non `end'-protected program,
  the indentation makes it immediately obvious that any further case
  will be attached to the innermost match, and not any of the exterior
  ones.

  A program using this "cascading tail" approach should always use
  `begin match .. end' for nested matches, except for a nested match
  returned within the last branch of an outer match, which can
  (optionally) be dedented instead.

  The choice to dedent the last case corresponds to encouraging a
  sequential reading of the program, where the other cases are
  "auxiliary cases" checked first and dispatched quickly, and the last
  case is the "main part" where the "rest" of the logic of the program
  lies. This pattern is typical of nested pattern-matching on the
  `option' or `result' type for example:

  â”Œâ”€â”€â”€â”€
  â”‚ match foo x with
  â”‚ | Error err ->
  â”‚   fail_foo_error err
  â”‚ | Ok y ->
  â”‚ match bar y with
  â”‚ | Error err ->
  â”‚   fail_bar_error err
  â”‚ | Ok () ->
  â”‚ ...
  â””â”€â”€â”€â”€

  Remark: it is *not* always the case that the `Error' constructor is
  the auxiliary case, and the `Ok' constructor is the main case;
  sometimes we implement fallback logic like "if `foo' work then we are
  good, but otherwise we have to do this and that", and the error case
  is the most salient (and longer) part of the program logic. I would
  recommend being mindful, when you write code, of whether there is a
  most convincing way to "sequentialize" it (distinguish auxiliary and
  main/tail case), and avoid using cascading tails when there is no
  clear sequentialization choice.

  Remark: some cases of tail cascades can be linearized by using a good
  definition of "bind" and a monadic style. This tends to be very
  limited however: it fixes one of the constructors to always be the
  "tail" constructor (always `Some', always `Ok'), and it only works
  when the handling of the other constructors is very homogeneous
  (typically: return directly). In real code, many situations occur
  where the monadic style doesn't fit the problem, but tail cascade does
  help writing a readable program.


Generalization: tail cascade
â•Œâ•Œâ•Œâ•Œâ•Œâ•Œâ•Œâ•Œâ•Œâ•Œâ•Œâ•Œâ•Œâ•Œâ•Œâ•Œâ•Œâ•Œâ•Œâ•Œâ•Œâ•Œâ•Œâ•Œâ•Œâ•Œâ•Œâ•Œ

  While I have never seen cascading tail cases in real-world OCaml code
  before (I'm happy to be given pointers; I think that the idea is not
  new, but I'm not aware of previous attempts to give it a catchy name
  and spread the cascade love), this is in fact a new (to me) instance
  of a common technique that is used for other OCaml constructs:

  â”Œâ”€â”€â”€â”€
  â”‚ if foo x then ...
  â”‚ else if bar x then ...
  â”‚ else ... (* this `tail else` was dedented *)
  â”‚ 
  â”‚ let x = foo in
  â”‚ let y = bar in (* this `tail let` was dedented *)
  â”‚ ...            (* and the rest as well *)
  â”‚ 
  â”‚ bind foo @@ fun x ->
  â”‚ bind bar @@ fun y -> (* this "tail function body" was dedented *)
  â”‚ ...                  (* and the rest as well *)
  â””â”€â”€â”€â”€

  I would call "tail cascade" (or maybe: "cascading tail") the idea of
  dedenting the "rest" of an OCaml expression (compared to a strict
  tree-nesting-based approach) when it morally describes the "rest" of
  the expression. I use the name "tail" because those expressions are
  almost always in tail-position in the sense of tail-calls.

  This general approach legitimizes some styles that I have seen, and
  sometimes used, in the wild, while at the same time considering that I
  may have been doing something improper, for example:

  â”Œâ”€â”€â”€â”€
  â”‚ if foo then blah else
  â”‚ ... (* dedented *)
  â”‚ 
  â”‚ 
  â”‚ Fun.protect
  â”‚   ~finally:(...)
  â”‚ @@ fun () ->
  â”‚ ... (* dedented *)
  â”‚ 
  â”‚ 
  â”‚ try simple_approach with exn ->
  â”‚ ... (* dedented *)
  â”‚ 
  â”‚ 
  â”‚ 1 +
  â”‚ 2 + (* dedented *)
  â”‚ ... (* dedented *)
  â””â”€â”€â”€â”€

  Remark: after a `then' or `else', many people share the reasonable
  view that any expression containing imperative constructs (`foo; bar')
  should be enclosed in a `begin .. end' block to avoid
  surprising-precedence issue. Just as for nested `match', this
  recommendation should be lifted for "tail else" constructs.

  Remark: The last example is a case where the dedented expressions are
  *not* in tail-position from a runtime-evaluation point of view. I am
  not sure as whether the two notions should be made to coincide more
  strongly, but in any case I'm not fond of the style in this particular
  example, I prefer to move the infix operator to the beginning of the
  next line instead, following a different style and justification.

  The possibility this "cascading tail" style today crucially relies on
  the nesting properties of open-ended syntactic constructs, notably
  `let' (commonly cascaded), and now `match' and `if
  ... else'. Proposals to transition to a syntax where `match' and
  `else' are forced to take a closing marker are incompatible with the
  cascading style. I have not made my mind on whether this should be
  considered a blocker for those proposals, but at least it shows that
  having the open-ended form available has value for certain programs.


Louis Gesbert then said
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  @gasche I prototyped a dedicated option in `ocp-indent', if you're
  interested in trying it out :)
  â”Œâ”€â”€â”€â”€
  â”‚ opam pin git+https://github.com/OCamlPro/ocp-indent#match-tail-cascade
  â”‚ echo "match_tail_cascade=true" >> ~/.ocp-indent
  â””â”€â”€â”€â”€


Old CWN
â•â•â•â•â•â•â•

  If you happen to miss a CWN, you can [send me a message] and I'll mail
  it to you, or go take a look at [the archive] or the [RSS feed of the
  archives].

  If you also wish to receive it every week by mail, you may subscribe
  [online].

  [Alan Schmitt]


[send me a message] <mailto:alan.schmitt@polytechnique.org>

[the archive] <http://alan.petitepomme.net/cwn/>

[RSS feed of the archives] <http://alan.petitepomme.net/cwn/cwn.rss>

[online] <http://lists.idyll.org/listinfo/caml-news-weekly/>

[Alan Schmitt] <http://alan.petitepomme.net/>
