<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<!-- 2023-08-15 Tue 18:32 -->
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>OCaml Weekly News</title>
<meta name="generator" content="Org Mode" />
<style>
  #content { max-width: 60em; margin: auto; }
  .title  { text-align: center;
             margin-bottom: .2em; }
  .subtitle { text-align: center;
              font-size: medium;
              font-weight: bold;
              margin-top:0; }
  .todo   { font-family: monospace; color: red; }
  .done   { font-family: monospace; color: green; }
  .priority { font-family: monospace; color: orange; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .org-right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .org-left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .org-center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #e6e6e6;
    border-radius: 3px;
    background-color: #f2f2f2;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: auto;
  }
  pre.src:before {
    display: none;
    position: absolute;
    top: -8px;
    right: 12px;
    padding: 3px;
    color: #555;
    background-color: #f2f2f299;
  }
  pre.src:hover:before { display: inline; margin-top: 14px;}
  /* Languages per Org manual */
  pre.src-asymptote:before { content: 'Asymptote'; }
  pre.src-awk:before { content: 'Awk'; }
  pre.src-authinfo::before { content: 'Authinfo'; }
  pre.src-C:before { content: 'C'; }
  /* pre.src-C++ doesn't work in CSS */
  pre.src-clojure:before { content: 'Clojure'; }
  pre.src-css:before { content: 'CSS'; }
  pre.src-D:before { content: 'D'; }
  pre.src-ditaa:before { content: 'ditaa'; }
  pre.src-dot:before { content: 'Graphviz'; }
  pre.src-calc:before { content: 'Emacs Calc'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-fortran:before { content: 'Fortran'; }
  pre.src-gnuplot:before { content: 'gnuplot'; }
  pre.src-haskell:before { content: 'Haskell'; }
  pre.src-hledger:before { content: 'hledger'; }
  pre.src-java:before { content: 'Java'; }
  pre.src-js:before { content: 'Javascript'; }
  pre.src-latex:before { content: 'LaTeX'; }
  pre.src-ledger:before { content: 'Ledger'; }
  pre.src-lisp:before { content: 'Lisp'; }
  pre.src-lilypond:before { content: 'Lilypond'; }
  pre.src-lua:before { content: 'Lua'; }
  pre.src-matlab:before { content: 'MATLAB'; }
  pre.src-mscgen:before { content: 'Mscgen'; }
  pre.src-ocaml:before { content: 'Objective Caml'; }
  pre.src-octave:before { content: 'Octave'; }
  pre.src-org:before { content: 'Org mode'; }
  pre.src-oz:before { content: 'OZ'; }
  pre.src-plantuml:before { content: 'Plantuml'; }
  pre.src-processing:before { content: 'Processing.js'; }
  pre.src-python:before { content: 'Python'; }
  pre.src-R:before { content: 'R'; }
  pre.src-ruby:before { content: 'Ruby'; }
  pre.src-sass:before { content: 'Sass'; }
  pre.src-scheme:before { content: 'Scheme'; }
  pre.src-screen:before { content: 'Gnu Screen'; }
  pre.src-sed:before { content: 'Sed'; }
  pre.src-sh:before { content: 'shell'; }
  pre.src-sql:before { content: 'SQL'; }
  pre.src-sqlite:before { content: 'SQLite'; }
  /* additional languages in org.el's org-babel-load-languages alist */
  pre.src-forth:before { content: 'Forth'; }
  pre.src-io:before { content: 'IO'; }
  pre.src-J:before { content: 'J'; }
  pre.src-makefile:before { content: 'Makefile'; }
  pre.src-maxima:before { content: 'Maxima'; }
  pre.src-perl:before { content: 'Perl'; }
  pre.src-picolisp:before { content: 'Pico Lisp'; }
  pre.src-scala:before { content: 'Scala'; }
  pre.src-shell:before { content: 'Shell Script'; }
  pre.src-ebnf2ps:before { content: 'ebfn2ps'; }
  /* additional language identifiers per "defun org-babel-execute"
       in ob-*.el */
  pre.src-cpp:before  { content: 'C++'; }
  pre.src-abc:before  { content: 'ABC'; }
  pre.src-coq:before  { content: 'Coq'; }
  pre.src-groovy:before  { content: 'Groovy'; }
  /* additional language identifiers from org-babel-shell-names in
     ob-shell.el: ob-shell is the only babel language using a lambda to put
     the execution function name together. */
  pre.src-bash:before  { content: 'bash'; }
  pre.src-csh:before  { content: 'csh'; }
  pre.src-ash:before  { content: 'ash'; }
  pre.src-dash:before  { content: 'dash'; }
  pre.src-ksh:before  { content: 'ksh'; }
  pre.src-mksh:before  { content: 'mksh'; }
  pre.src-posh:before  { content: 'posh'; }
  /* Additional Emacs modes also supported by the LaTeX listings package */
  pre.src-ada:before { content: 'Ada'; }
  pre.src-asm:before { content: 'Assembler'; }
  pre.src-caml:before { content: 'Caml'; }
  pre.src-delphi:before { content: 'Delphi'; }
  pre.src-html:before { content: 'HTML'; }
  pre.src-idl:before { content: 'IDL'; }
  pre.src-mercury:before { content: 'Mercury'; }
  pre.src-metapost:before { content: 'MetaPost'; }
  pre.src-modula-2:before { content: 'Modula-2'; }
  pre.src-pascal:before { content: 'Pascal'; }
  pre.src-ps:before { content: 'PostScript'; }
  pre.src-prolog:before { content: 'Prolog'; }
  pre.src-simula:before { content: 'Simula'; }
  pre.src-tcl:before { content: 'tcl'; }
  pre.src-tex:before { content: 'TeX'; }
  pre.src-plain-tex:before { content: 'Plain TeX'; }
  pre.src-verilog:before { content: 'Verilog'; }
  pre.src-vhdl:before { content: 'VHDL'; }
  pre.src-xml:before { content: 'XML'; }
  pre.src-nxml:before { content: 'XML'; }
  /* add a generic configuration mode; LaTeX export needs an additional
     (add-to-list 'org-latex-listings-langs '(conf " ")) in .emacs */
  pre.src-conf:before { content: 'Configuration File'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.org-right  { text-align: center;  }
  th.org-left   { text-align: center;   }
  th.org-center { text-align: center; }
  td.org-right  { text-align: right;  }
  td.org-left   { text-align: left;   }
  td.org-center { text-align: center; }
  dt { font-weight: bold; }
  .footpara { display: inline; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .equation-container {
    display: table;
    text-align: center;
    width: 100%;
  }
  .equation {
    vertical-align: middle;
  }
  .equation-label {
    display: table-cell;
    text-align: right;
    vertical-align: middle;
  }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  .org-svg { }
</style>
<style type="text/css">#table-of-contents h2 { display: none } .title { display: none } .authorname { text-align: right }</style>
<style type="text/css">.outline-2 {border-top: 1px solid black;}</style>
</head>
<body>
<div id="content" class="content">
<h1 class="title">OCaml Weekly News</h1>
<p>
<a href="https://alan.petitepomme.net/cwn/2023.08.08.html">Previous Week</a> <a href="https://alan.petitepomme.net/cwn/index.html">Up</a> <a href="https://alan.petitepomme.net/cwn/2023.08.22.html">Next Week</a>
</p>

<p>
Hello
</p>

<p>
Here is the latest OCaml Weekly News, for the week of August 08 to 15, 2023.
</p>

<div id="table-of-contents" role="doc-toc">
<h2>Table of Contents</h2>
<div id="text-table-of-contents" role="doc-toc">
<ul>
<li><a href="#1">decimal 1.0.0</a></li>
<li><a href="#2">rtree 0.1.0</a></li>
<li><a href="#3">Shuttle 0.9.1 released</a></li>
<li><a href="#4">dream-html 1.0.0</a></li>
<li><a href="#5">tiny_httpd 0.14</a></li>
<li><a href="#6">kcas and kcas_data 0.6.1: STM and compositional lock-dree data structures</a></li>
<li><a href="#7">ppx_update 0.81</a></li>
<li><a href="#8">Is a mutable project structure inherently slower?</a></li>
<li><a href="#9">OCaml.org Newsletter: July 2023</a></li>
<li><a href="#10">Using <code>[@poll error]</code> attribute to implement systhread safe data structures</a></li>
<li><a href="#11">forester 2.3</a></li>
<li><a href="#orgf50df1a">Old CWN</a></li>
</ul>
</div>
</div>


<div id="outline-container-1" class="outline-2">
<h2 id="1">decimal 1.0.0</h2>
<div class="outline-text-2" id="text-1">
<p>
Archive: <a href="https://discuss.ocaml.org/t/ann-decimal-1-0-0/12739/2">https://discuss.ocaml.org/t/ann-decimal-1-0-0/12739/2</a>
</p>
</div>

<div id="outline-container-org6cd57ab" class="outline-3">
<h3 id="org6cd57ab">Yawar Amin announced</h3>
<div class="outline-text-3" id="text-org6cd57ab">
<p>
Small update that we have released a bugfix 1.0.1: <a href="https://ocaml.org/p/decimal/latest">https://ocaml.org/p/decimal/latest</a>
</p>

<p>
This fixes the parsing of floating-point numbers into decimal. It was off by an order of magnitude. Yikes!
</p>
</div>
</div>
</div>




<div id="outline-container-2" class="outline-2">
<h2 id="2">rtree 0.1.0</h2>
<div class="outline-text-2" id="text-2">
<p>
Archive: <a href="https://discuss.ocaml.org/t/ann-rtree-0-1-0/12785/1">https://discuss.ocaml.org/t/ann-rtree-0-1-0/12785/1</a>
</p>
</div>

<div id="outline-container-org8c8f6a7" class="outline-3">
<h3 id="org8c8f6a7">Patrick Ferris announced</h3>
<div class="outline-text-3" id="text-org8c8f6a7">
<p>
Hello :wave:
</p>

<p>
I&rsquo;m happy to announce on behalf of the <a href="https://github.com/geocaml">Geocaml</a> organisation, a pure OCaml <a href="https://github.com/geocaml/ocaml-rtree">R-tree
library</a>. This library is an updated version of
<a href="https://github.com/mariusae/ocaml-rtree">https://github.com/mariusae/ocaml-rtree</a> and you can read a little about it in <a href="https://patrick.sirref.org/posts/ocaml-rtree.html">this short blog
post</a>. It supports
<a href="https://ceur-ws.org/Vol-74/files/FORUM_18.pdf">OMT-style</a> bulk-loading for producing efficient trees.
</p>

<p>
Happy hacking :deciduous_tree:
</p>
</div>
</div>
</div>




<div id="outline-container-3" class="outline-2">
<h2 id="3">Shuttle 0.9.1 released</h2>
<div class="outline-text-2" id="text-3">
<p>
Archive: <a href="https://discuss.ocaml.org/t/ann-shuttle-0-9-1-released/11292/2">https://discuss.ocaml.org/t/ann-shuttle-0-9-1-released/11292/2</a>
</p>
</div>

<div id="outline-container-org34f50c2" class="outline-3">
<h3 id="org34f50c2">Anurag Soni announced</h3>
<div class="outline-text-3" id="text-org34f50c2">
<p>
Some new updates since the last release:
</p>

<ul class="org-ul">
<li><code>shuttle_http</code> now supports HTTP/1.1 servers that use <code>async_ssl</code> based encrypted connections.</li>
<li>A server context is forwarded to http services. This context can be used to lookup peer client&rsquo;s address, check if the http service is running on a SSL encrypted server, and if SSL is used lookup peer client&rsquo;s SSL certificates.</li>
<li><p>
HTTP servers support web socket upgrades now. The implementation is based on Janestreet&rsquo;s web socket library (<a href="https://github.com/janestreet/async_websocket">https://github.com/janestreet/async_websocket</a>), and shuttle has a companion library <code>shuttle_websocket</code> that provides the web socket upgrade negotiation for servers, and allows converting a web socket handler to a <code>request -&gt; response promise</code> based http service that can be used by <code>shuttle_http</code>.
</p>

<p>
Example for a http service that serves web socket traffic on some requests:
</p>

<div class="org-src-container">
<pre class="src src-ocaml"><span style="color: #000000; font-weight: bold;">open! </span><span style="color: #444fcf;">Core</span>
<span style="color: #000000; font-weight: bold;">open! </span><span style="color: #444fcf;">Async</span>
<span style="color: #000000; font-weight: bold;">open </span><span style="color: #444fcf;">Shuttle_http</span>

<span style="color: #000000; font-weight: bold;">let</span> <span style="color: #007a9f;">websocket_handler</span> =
  <span style="color: #444fcf;">Shuttle_websocket.</span>create (<span style="color: #006f00; font-weight: bold;">fun</span> <span style="color: #007a9f;">ws</span> -&gt;
    <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #007a9f;">rd</span>, <span style="color: #007a9f;">wr</span> = <span style="color: #444fcf;">Websocket.</span>pipes ws <span style="color: #000000; font-weight: bold;">in</span>
    <span style="color: #444fcf;">Pipe.</span>transfer_id rd wr)
<span style="color: #ff4500;">;;</span>

<span style="color: #000000; font-weight: bold;">let</span> <span style="color: #a7601f;">service</span> <span style="color: #007a9f;">context</span> <span style="color: #007a9f;">request</span> =
  <span style="color: #444fcf;">Log.Global.</span>info <span style="color: #ca3400;">"Peer address: %s"</span> (<span style="color: #444fcf;">Socket.Address.</span>to_string (<span style="color: #444fcf;">Server.</span>peer_addr context));
  <span style="color: #006f00; font-weight: bold;">match</span> <span style="color: #444fcf;">Request.</span>path request <span style="color: #006f00; font-weight: bold;">with</span>
  | <span style="color: #ca3400;">"/websocket"</span>-&gt; websocket_handler request
  | <span style="color: #ca3400;">"/"</span> -&gt; return (<span style="color: #444fcf;">Response.</span>create <span style="color: #00824f;">~body</span>:(<span style="color: #444fcf;">Body.</span>string <span style="color: #ca3400;">"Hello World"</span>) <span style="color: #242521; background-color: #fcf7ef;">`Ok</span>)
  | _ -&gt; return (<span style="color: #444fcf;">Response.</span>create <span style="color: #242521; background-color: #fcf7ef;">`Not_found</span>)
<span style="color: #ff4500;">;;</span>
</pre>
</div>

<p>
The latest release has been published to the opam package repository, and can be installed via opam:
</p>

<pre class="example" id="org2c184b6">
opam install shuttle_http
opam install shuttle_websocket
</pre></li>
<li>Git repository: <a href="https://git.sr.ht/~soni/shuttle_http">https://git.sr.ht/~soni/shuttle_http</a></li>
</ul>
</div>
</div>
</div>




<div id="outline-container-4" class="outline-2">
<h2 id="4">dream-html 1.0.0</h2>
<div class="outline-text-2" id="text-4">
<p>
Archive: <a href="https://discuss.ocaml.org/t/ann-dream-html-1-0-0/12787/1">https://discuss.ocaml.org/t/ann-dream-html-1-0-0/12787/1</a>
</p>
</div>

<div id="outline-container-orgbbc33fd" class="outline-3">
<h3 id="orgbbc33fd">Yawar Amin announced</h3>
<div class="outline-text-3" id="text-orgbbc33fd">
<p>
Hi, dream-html 1.0.0 has been released to opam: <a href="https://ocaml.org/p/dream-html">https://ocaml.org/p/dream-html</a>
</p>

<ul class="org-ul">
<li>Repo: <a href="https://github.com/yawaramin/dream-html">https://github.com/yawaramin/dream-html</a></li>
<li>API docs: <a href="https://yawaramin.github.io/dream-html/dream-html/Dream_html/index.html">https://yawaramin.github.io/dream-html/dream-html/Dream_html/index.html</a></li>
</ul>

<p>
Dream-html is a library for generating HTML, closely integrated with Dream. It can be used as an alternative to
Dream&rsquo;s built-in Embedded ML templating language. Here&rsquo;s the Dream home page example using dream-html:
</p>

<div class="org-src-container">
<pre class="src src-ocaml"><span style="color: #000000; font-weight: bold;">let</span> <span style="color: #a7601f;">hello</span> <span style="color: #007a9f;">who</span> =
  <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #000000; font-weight: bold;">open </span><span style="color: #444fcf;">Dream_html</span> <span style="color: #000000; font-weight: bold;">in</span>
  <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #000000; font-weight: bold;">open </span><span style="color: #444fcf;">HTML</span> <span style="color: #000000; font-weight: bold;">in</span>
  html <span style="color: #242521; background-color: #fcf7ef;">[]</span> [
    body <span style="color: #242521; background-color: #fcf7ef;">[]</span> [
      h1 <span style="color: #242521; background-color: #fcf7ef;">[]</span> [txt <span style="color: #ca3400;">"Hello, %s!"</span> who]]]

<span style="color: #000000; font-weight: bold;">let</span> () =
  <span style="color: #444fcf;">Dream.</span>run
  <span style="color: #a52a2a;">@@</span> <span style="color: #444fcf;">Dream.</span>logger
  <span style="color: #a52a2a;">@@</span> <span style="color: #444fcf;">Dream.</span>router [<span style="color: #444fcf;">Dream.</span>get <span style="color: #ca3400;">"/"</span> (<span style="color: #006f00; font-weight: bold;">fun</span> <span style="color: #007a9f;">_</span> -&gt; <span style="color: #444fcf;">Dream_html.</span>respond (hello <span style="color: #ca3400;">"world"</span>))]
</pre>
</div>

<p>
In this release, I made a breaking change (hence major version bump) to group all HTML tags and attributes under
the same <code>HTML</code> module, so only two ~open~s are needed to access all HTML functionality directly.
</p>

<p>
Another smaller improvement is more granular escaping of HTML text nodes and attribute values, following browser
rules more closely. E.g. I&rsquo;m no longer escaping <code>'</code> and <code>"</code> in text nodes, and not escaping <code>&amp;</code>, <code>&lt;</code>, <code>&gt;</code> in
attribute values.
</p>

<p>
More details in the repo readme and documentation. Enjoy!
</p>
</div>
</div>
</div>




<div id="outline-container-5" class="outline-2">
<h2 id="5">tiny_httpd 0.14</h2>
<div class="outline-text-2" id="text-5">
<p>
Archive: <a href="https://discuss.ocaml.org/t/ann-tiny-httpd-0-14/12788/1">https://discuss.ocaml.org/t/ann-tiny-httpd-0-14/12788/1</a>
</p>
</div>

<div id="outline-container-org9c79498" class="outline-3">
<h3 id="org9c79498">Simon Cruanes announced</h3>
<div class="outline-text-3" id="text-org9c79498">
<p>
Bonjour bonjour,
</p>

<p>
It&rsquo;s with delectation that I announce the release of tiny_httpd 0.14. Tiny_httpd is a <a href="https://github.com/c-cube/tiny_httpd">web server
library</a> that relies on threads[^1] to handle client connections. Overall
Tiny_httpd aims at being self contained, reasonably simple, and performant enough for non-google scale.
</p>

<p>
This release brings a significant amount of improvements:
</p>
<ul class="org-ul">
<li>a <code>Tiny_httpd_io</code> module provides extensible input and output channels (as records of functions)</li>
<li><p>
In terms of flexibility, a request handler can now choose to obtain an output channel (from the <code>Tiny_httpd_io</code> module above) into which to write the response&rsquo;s body; as opposed to only being able to returning a string or a stream (as powerful but the inversion of control isn&rsquo;t as easy to produce). This means that reading a file to return it can look like this:
</p>
<div class="org-src-container">
<pre class="src src-ocaml">  <span style="color: #444fcf;">Tiny_httpd_server.</span>(add_route_handler server
      <span style="color: #444fcf;">Route.</span>(exact <span style="color: #ca3400;">"passwd"</span> <span style="color: #a52a2a;">@/</span> return))
    <span style="color: #a52a2a;">@@</span> <span style="color: #006f00; font-weight: bold;">fun</span> <span style="color: #007a9f;">_req</span> -&gt;
    <span style="color: #8f6f4a; font-style: italic;">(* </span><span style="color: #8f6f4a; font-style: italic;">stream the content of the file</span><span style="color: #8f6f4a; font-style: italic;"> *)</span>
    <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #a7601f;">write</span> <span style="color: #007a9f;">oc</span> =
      <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #007a9f;">buf</span> = <span style="color: #444fcf;">Bytes.</span>create <span style="color: #00824f;">4096</span> <span style="color: #000000; font-weight: bold;">in</span>
      <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #007a9f;">ic</span> = open_in <span style="color: #ca3400;">"/etc/passwd"</span> <span style="color: #000000; font-weight: bold;">in</span>
      <span style="color: #444fcf;">Fun.</span>protect <span style="color: #00824f;">~finally</span>:(<span style="color: #006f00; font-weight: bold;">fun</span> () -&gt; close_in_noerr ic)
      <span style="color: #a52a2a;">@@</span> <span style="color: #006f00; font-weight: bold;">fun</span> () -&gt;
      <span style="color: #006f00; font-weight: bold;">while</span>
        <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #007a9f;">n</span> = input ic buf <span style="color: #00824f;">0</span> (<span style="color: #444fcf;">Bytes.</span>length buf) <span style="color: #000000; font-weight: bold;">in</span>
        <span style="color: #006f00; font-weight: bold;">if</span> n &gt; <span style="color: #00824f;">0</span> <span style="color: #006f00; font-weight: bold;">then</span> <span style="color: #444fcf;">IO.Output.</span>output oc buf <span style="color: #00824f;">0</span> n;
        n &gt; <span style="color: #00824f;">0</span>
      <span style="color: #006f00; font-weight: bold;">do</span>
        ()
      <span style="color: #006f00; font-weight: bold;">done</span>
    <span style="color: #000000; font-weight: bold;">in</span>

    <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #007a9f;">writer</span> = <span style="color: #444fcf;">IO.Writer.</span>make ~write () <span style="color: #000000; font-weight: bold;">in</span>
    <span style="color: #444fcf;">Response.</span>make_writer <span style="color: #a52a2a;">@@</span> <span style="color: #242521; background-color: #fcf7ef;">Ok</span> writer)
</pre>
</div></li>
<li>client address is passed to the handler throught the <code>Request.t</code> object;</li>
<li>performance was improved by setting <code>TCP_NODELAY</code> on the sockets and by adding a buffer pool to reduce memory churn;</li>
<li>some improvements to termination behavior were implemented by @VPhantom, so that the main thread waits for all connections to terminate before returning, and also handling signals better.</li>
</ul>

<p>
Full changelog <a href="https://github.com/c-cube/tiny_httpd/releases/tag/0.14">here</a>.
</p>

<p>
Cheerio!
</p>
</div>
</div>
</div>




<div id="outline-container-6" class="outline-2">
<h2 id="6">kcas and kcas_data 0.6.1: STM and compositional lock-dree data structures</h2>
<div class="outline-text-2" id="text-6">
<p>
Archive: <a href="https://discuss.ocaml.org/t/ann-kcas-and-kcas-data-0-6-1-stm-and-compositional-lock-dree-data-structures/12674/3">https://discuss.ocaml.org/t/ann-kcas-and-kcas-data-0-6-1-stm-and-compositional-lock-dree-data-structures/12674/3</a>
</p>
</div>

<div id="outline-container-org0b4a35d" class="outline-3">
<h3 id="org0b4a35d">Vesa Karvonen announced</h3>
<div class="outline-text-3" id="text-org0b4a35d">
<p>
And the second part of the blog post <a href="https://tarides.com/blog/2023-08-10-kcas-building-a-lock-free-stm-for-ocaml-2-2/">Kcas: Building a lock-free STM for
OCaml</a> is now online as well.
</p>

<p>
If you have any feedback or questions on Kcas, I&rsquo;m happy to discuss.
</p>

<p>
Feel free to ask here or on OCaml Discord, for example.
</p>
</div>
</div>
</div>




<div id="outline-container-7" class="outline-2">
<h2 id="7">ppx_update 0.81</h2>
<div class="outline-text-2" id="text-7">
<p>
Archive: <a href="https://discuss.ocaml.org/t/ann-ppx-update-0-81/12794/1">https://discuss.ocaml.org/t/ann-ppx-update-0-81/12794/1</a>
</p>
</div>

<div id="outline-container-org344d2a1" class="outline-3">
<h3 id="org344d2a1">Yotam Barnoy announced</h3>
<div class="outline-text-3" id="text-org344d2a1">
<p>
Hi guys. I wanted to let you know about <code>ppx_update</code>. This is a <a href="https://github.com/bluddy/ppx_update">small utility
ppx</a> that rewrites some record update expressions to make them more
efficient.
</p>

<p>
When updating the contents of a record functionally, one might want to avoid reallocating the record if the
contents haven&rsquo;t changed. Similarly, when updating the contents of a mutable field of a record, one might want to
avoid the cost of the write barrier in case the field content hasn&rsquo;t changed. Instead of having to write
error-prone code checking each field with physical equality, <code>ppx_update</code> does the added physical comparisons for
you behind the scenes.
</p>

<p>
You can install <code>ppx_update</code> via <code>opam</code> and easily apply it to your code with <code>dune</code>.
</p>
</div>
</div>
</div>




<div id="outline-container-8" class="outline-2">
<h2 id="8">Is a mutable project structure inherently slower?</h2>
<div class="outline-text-2" id="text-8">
<p>
Archive: <a href="https://discuss.ocaml.org/t/is-a-mutable-project-structure-inherently-slower/12790/9">https://discuss.ocaml.org/t/is-a-mutable-project-structure-inherently-slower/12790/9</a>
</p>
</div>

<div id="outline-container-orgd70758c" class="outline-3">
<h3 id="orgd70758c">Deep in this thread, Daniel Bünzli said</h3>
<div class="outline-text-3" id="text-orgd70758c">
<p>
Btw. there are a few gameboy emulators written in OCaml you may want to check out what they do:
</p>

<ol class="org-ol">
<li><a href="https://linoscope.github.io/writing-a-game-boy-emulator-in-ocaml/">https://linoscope.github.io/writing-a-game-boy-emulator-in-ocaml/</a></li>
<li><a href="https://github.com/Engil/Goodboy">https://github.com/Engil/Goodboy</a></li>
</ol>
</div>
</div>
</div>




<div id="outline-container-9" class="outline-2">
<h2 id="9">OCaml.org Newsletter: July 2023</h2>
<div class="outline-text-2" id="text-9">
<p>
Archive: <a href="https://discuss.ocaml.org/t/ocaml-org-newsletter-july-2023/12798/1">https://discuss.ocaml.org/t/ocaml-org-newsletter-july-2023/12798/1</a>
</p>
</div>

<div id="outline-container-org4a499f8" class="outline-3">
<h3 id="org4a499f8">Thibaut Mattio announced</h3>
<div class="outline-text-3" id="text-org4a499f8">
<p>
Welcome to the July 2023 edition of the OCaml.org newsletter! As with the <a href="https://discuss.ocaml.org/tag/ocamlorg-newsletter">previous
issues</a>, this update has been compiled by @sabine and @tmattio.
</p>

<p>
Our goal is to make OCaml.org the best resource for anyone who wants to get started and be productive in OCaml. The
OCaml.org newsletter provides an update of our progress towards that goal and an overview of changes we are working
on.
</p>

<p>
We couldn&rsquo;t do it without all the amazing OCaml community members who help us review, revise, and create better
OCaml documentation. Your feedback enables us to better prioritise our work and make progress towards our goal.
Thank you!
</p>

<p>
This month, our priorities were:
</p>
<ul class="org-ul">
<li><b>Learn Area:</b> We&rsquo;re working towards making OCaml.org a great resource to learn OCaml and discover its ecosystem. This month, we continued writing the new documentation content and iterating on community feedback. We also finalised the Figma light desktop designs and started implementing the UI.</li>
<li><b>JavaScript Toplevels</b>: We started exploring how to generate JavaScript toplevels for OCaml packages, with the goal of allowing users to load packages into the <a href="https://ocaml.org/play">OCaml Playground</a>, and adding a new toplevel feature to the <a href="https://ocaml.org/packages">OCaml Packages area</a>. Ultimately, we aim to make every code block on OCaml.org interactive!</li>
<li><b>General Improvements:</b> As usual, we also worked on general maintenance and improvements based on user feedback, and we&rsquo;re highlighting some of our work.</li>
</ul>

<p>
In addition to our work on the site, we introduced new ways for the team to interact with the community. We&rsquo;ve
created an <a href="https://discord.com/channels/436568060288172042/1126433906976112700">#ocaml.org Discord channel</a>, and
we started holding <a href="https://discuss.ocaml.org/t/you-can-attend-the-new-ocaml-org-community-meetings/12656/1">public OCaml.org dev
meetings</a>. Don&rsquo;t hesitate
to reach out to us on Discord and join the dev meetings. We&rsquo;re always looking for new insights on things to
improve!
</p>
</div>

<div id="outline-container-org8e50c5d" class="outline-4">
<h4 id="org8e50c5d">Learn Area</h4>
<div class="outline-text-4" id="text-org8e50c5d">
</div>
<ul class="org-ul">
<li><a id="org05ca3ea"></a>1. Redesign of the Learn Area<br />
<div class="outline-text-5" id="text-org05ca3ea">
<p>
As the designs for the new Learn area are nearing completion, we started implementing the UI. If you have visited
the documentation in the past few weeks, you&rsquo;ve probably noticed a few changes. The most prominent one being the
new tabs to navigate the different parts of the documentation.
</p>

<p>
On the design front, our focus will now be directed to the mobile views and dark mode.
</p>

<p>
<b>Relevant PRs and Activities:</b>
</p>

<ul class="org-ul">
<li>Continued work on <a href="https://www.figma.com/file/Aqk5y03fsaCuhTSywmmY06/OCaml.org-Public-Designs?type=design&amp;node-id=130-754&amp;mode=design&amp;t=XvVCMukq5AR3oxRf-0">Figma UX/UI designs</a> for the new Learn area:
<ul class="org-ul">
<li>Finalised the light theme designs</li>
<li>Created color variants and a color palette in Figma, aiming for consistency with Figma to the Tailwind configuration, and established naming conventions for light and dark mode colors.</li>
<li>Designed various button variants on Figma, including Extra large, Large, Small, Large Ghost, Ghost, and Level tag styles.</li>
</ul></li>
<li>Started implementing new components for the Learn Area:
<ul class="org-ul">
<li>Tab &#x2013; <a href="https://github.com/ocaml/ocaml.org/pull/1389">ocaml/ocaml.org#1389</a></li>
<li>Tutorial block &#x2013; <a href="https://github.com/ocaml/ocaml.org/pull/1387">ocaml/ocaml.org#1387</a></li>
<li>Language Manual banner &#x2013; <a href="https://github.com/ocaml/ocaml.org/pull/1406">ocaml/ocaml.org#1406</a></li>
<li>Skill level tag &#x2013; <a href="https://github.com/ocaml/ocaml.org/pull/1427">ocaml/ocaml.org#1427</a></li>
</ul></li>
<li>Introduced new tabs to navigate the OCaml documentation by section &#x2013; <a href="https://github.com/ocaml/ocaml.org/pull/1429">ocaml/ocaml.org#1429</a></li>
</ul>
</div>
</li>

<li><a id="orgd501ec9"></a>2. OCaml Documentation<br />
<div class="outline-text-5" id="text-orgd501ec9">
<p>
We also continued the work on the new documentation content. As we&rsquo;ve been through the lifecycle of new pages a
couple times, we&rsquo;re getting more structured. Each new page goes through the following steps: Outline Approval,
Drafting, Internal Review and, finally, Community Review. We have two new pages that are in the final stage
(community review), namely the File Manipulation tutorial and Arrays guide. They should be ready to merge in the
coming weeks. We also have a completely new Getting Started tutorial that aims to replace the existing &ldquo;Your First
Day with OCaml.&rdquo; It&rsquo;s currently in the internal review stage and should be shared on Discuss for community review
soon.
</p>

<p>
Plus, we&rsquo;ve got a lot more content in the drafting stage.
</p>

<p>
Stay tuned, as we&rsquo;ll be sharing more and more new documentation pages for community review!
</p>

<p>
<b>Relevant PRs and Activities:</b>
</p>

<ul class="org-ul">
<li>Created a tentative <a href="https://hackmd.io/p-JHDQUCSS6z3n2NYa8Qzw?view">high-level outline</a> and [meta-issue]((<a href="https://github.com/ocaml/ocaml.org/issues/1415">https://github.com/ocaml/ocaml.org/issues/1415</a>)) to track our progress.</li>
<li>Worked on the new documentation content
<ul class="org-ul">
<li>File Manipulation (status: community review)
<ul class="org-ul">
<li><a href="https://github.com/ocaml/ocaml.org/pull/1400">Pull Request</a></li>
<li><a href="https://discuss.ocaml.org/t/help-review-the-new-file-manipulation-tutorial-on-ocaml-org/12638">Discuss thread</a></li>
</ul></li>
<li>New Arrays tutorial (status: community review)
<ul class="org-ul">
<li><a href="https://github.com/ocaml/ocaml.org/pull/1405">Pull Request</a></li>
<li><a href="https://discuss.ocaml.org/t/feedback-needed-new-arrays-tutorial-on-ocaml-org/12683">Discuss thread</a></li>
</ul></li>
<li>Tour of OCaml (status: internal review)
<ul class="org-ul">
<li><a href="https://github.com/ocaml/ocaml.org/pull/1431">Pull Request</a></li>
</ul></li>
<li>S-Expressions tutorial (internal review)</li>
<li>Maps and Sets guides (status: drafting)</li>
<li>Basic Datatypes guide (status: drafting)</li>
</ul></li>
<li>Watched TheVimeagen <a href="https://www.youtube.com/watch?v=mhkoWp5Akww">&ldquo;Learning OCaml Part 1&rdquo;</a> and <a href="https://www.youtube.com/watch?v=EgigQXpadFw">&ldquo;Learn OCaml Part 2&rdquo;</a>. Subsequently, made it clearer how to activate the opam switch on the install page  &#x2013; <a href="https://github.com/ocaml/ocaml.org/pull/1390">ocaml/ocaml.org#1390</a></li>
<li>Incorporating feedback from reviews:
<ul class="org-ul">
<li>Include <a href="https://github.com/gmevel">@gmevel</a> proof-reading of Seq tutorial <a href="https://github.com/ocaml/ocaml.org/pull/1376">ocaml/ocaml.org#1376</a></li>
</ul></li>
<li>Other documentation improvements
<ul class="org-ul">
<li>Line edits on existing Labels tutorial <a href="https://github.com/ocaml/ocaml.org/pull/1040">ocaml.org#1040</a></li>
<li>Moved the Error Handling guide from Language to the Guides section &#x2013; <a href="https://github.com/ocaml/ocaml.org/pull/1383">ocaml.org#1383</a></li>
<li>Converted example from LaTeX to markdown in the If Statements, Loops, and Recursion tutorial &#x2013; <a href="https://github.com/ocaml/ocaml.org/pull/1439">ocaml.org#1439</a></li>
<li>Replaced <code>dune build @runtest</code> by <code>dune runtest</code> in the Running Executables and Tests with Dune tutorial &#x2013; <a href="https://github.com/ocaml/ocaml.org/pull/1430">ocaml.org#1430</a></li>
</ul></li>
</ul>
</div>
</li>

<li><a id="orgc88bbaf"></a>3. Preparing the Move of the opam Documentation to OCaml.org<br />
<div class="outline-text-5" id="text-orgc88bbaf">
<p>
The next step for the centralised package documentation is to serve the documentation of critical OCaml packages,
including the OCaml manual and the Platform tools documentation. This requires a lot of work on <code>odoc</code> to remove
the blockers that prevents project from moving from their current documentation generator to <code>odoc</code>. As an
intermediate step, we&rsquo;ll be moving the opam documentation to OCaml.org&rsquo;s Learn area, so we can retire the frontend
of opam.ocaml.org and redirect all the trafic to ocaml.org.
</p>

<p>
We&rsquo;ve been working towards these goals this month. You can follow our progress on <a href="https://github.com/ocaml/ocaml.org/pull/1367">this
PR</a>.
</p>

<p>
<b>Relevant PRs and Activities:</b>
</p>

<ul class="org-ul">
<li>ocaml/opam:
<ul class="org-ul">
<li>Move opam documentation from opam.ocaml.org to ocaml.org &#x2013; <a href="https://github.com/ocaml/ocaml.org/pull/1367">ocaml/ocaml.org#1367</a></li>
<li>Convert man pages to Markdown with YAML header &#x2013; <a href="https://github.com/ocaml/opam/pull/5594">ocaml/opam#5594</a></li>
<li>Changing the Markdown files in <code>doc/pages</code> to be amenable for use on OCaml.org &#x2013; <a href="https://github.com/ocaml/opam/pull/5593">ocaml/opam#5593</a></li>
</ul></li>
<li>ocaml-opam/opam2web:
<ul class="org-ul">
<li>Rearrange <code>opam2web</code> to remove all package info, build only opam archive, keep public key, and create redirections from opam.ocamlorg to ocaml.org in a Caddyfile. Current WIP branch at <a href="https://github.com/sabine/opam2web/tree/strip_to_bare_minimum">https://github.com/sabine/opam2web/tree/strip_to_bare_minimum</a></li>
</ul></li>
<li>ocaml/ocaml.org:
<ul class="org-ul">
<li><a href="https://github.com/ocaml/ocaml.org/pull/1459">Give Local Blogs a Page and RSS Feeds</a>. This introduces the concept of a &ldquo;blog hosted on OCaml.org.&rdquo; This way, we can host the non-changelog posts of the opam blog in such a way that we can redirect <code>opam.ocaml.org/blog/feed.xml</code> to <code>ocaml.org/blog/opam/feed.xml</code></li>
</ul></li>
</ul>
</div>
</li>
</ul>
</div>

<div id="outline-container-org8db5f39" class="outline-4">
<h4 id="org8db5f39">JavaScript Toplevels</h4>
<div class="outline-text-4" id="text-org8db5f39">
<p>
Always with the aim to improve the learning experience, we&rsquo;re exploring how to generate JavaScript toplevels for
all the OCaml packages (the ones that are JavaScript-compatible, that is).
</p>

<p>
This would enable a few very neat new features:
</p>

<ul class="org-ul">
<li>Loading OCaml packages from the OCaml Playground: to enable the use of any JavaScript-compatible package. This is very handy to share code snippets to beginners, which is currently limited to using the standard library.</li>
<li>Toplevels for OCaml packages on the centralised documentation: to spawn a toplevel while navigating the documentation.</li>
<li>Interactive toplevels for every code block: This includes the OCaml packages that contain code examples, but also every code block and exercices on the Learn area. You&rsquo;d be able to run the code, edit it, run it again and inspect the result directly from the browser. Every documentation page becomes a Jupyter notebook!</li>
</ul>

<p>
We&rsquo;re very excited at the possibilities this brings to improving the learning experience. Let us know what you
think, and stay tuned for updates on our explorations!
</p>

<p>
<b>Relevant PRs and Activities:</b>
</p>

<ul class="org-ul">
<li>Process <code>.cma</code>&rsquo;s, <code>.cmi</code>&rsquo;s and toplevel <code>.js</code> files &#x2013; <a href="https://github.com/ocaml-doc/voodoo/pull/114">ocaml-doc/voodoo#114</a></li>
</ul>
</div>
</div>

<div id="outline-container-orgbd57c7a" class="outline-4">
<h4 id="orgbd57c7a">General Improvements</h4>
<div class="outline-text-4" id="text-orgbd57c7a">
<p>
This month, we&rsquo;re welcoming no less than 4 new contributors:
</p>
<ul class="org-ul">
<li><a href="https://github.com/contificate">@contificate</a> improved the OCaml Playground layout with <a href="https://github.com/StonedHesus">@StonedHesus</a> doing a review</li>
<li><a href="https://github.com/just-max">@just-max</a> fixed an issue with code sharing on the OCaml Playground</li>
<li><a href="https://github.com/AshineFoster">@AshineFoster</a> updated the dev setup to be able to run the site without an internet connection.</li>
<li><a href="https://github.com/theteachr">@theteachr</a> contributed a typo fix to the homepage.</li>
<li><a href="https://github.com/brandoncc">@brandoncc</a> contributed a typo fix to the First Day with OCaml tutorial</li>
</ul>

<p>
Thanks a lot to all the contributors this month! It&rsquo;s lovely to see more and more people making contributions to
the site!
</p>

<p>
<b>Relevant PRs and Activities:</b>
</p>

<ul class="org-ul">
<li>OCaml Playground:
<ul class="org-ul">
<li><a href="https://github.com/contificate">@contificate</a> resolved the layout problem of the playground&rsquo;s bottom bar and thoroughly tested it in different browsers with a review from <a href="https://github.com/StonedHesus">@StonedHesus</a> &#x2013; <a href="https://github.com/ocaml/ocaml.org/pull/1384">ocaml.org#1384</a></li>
<li>Building the playground was challenging due to a script incompatibility with POSIX  &#x2013; <a href="https://github.com/ocaml/ocaml.org/pull/1456">ocaml.org#1456</a></li>
<li><a href="https://github.com/just-max">@just-max</a> discovered and resolved an issue with Base64-encoded URLs generated by the Playground share button, ensuring backward compatibility  &#x2013; <a href="https://github.com/ocaml/ocaml.org/pull/1434">ocaml.org#1434</a></li>
</ul></li>
<li>OCaml.org package documentation:
<ul class="org-ul">
<li>Voodoo output format was updated to list README/LICENSE/CHANGELOG as part of <code>status.json</code>  &#x2013; <a href="https://github.com/ocaml-doc/voodoo/pull/68">voodoo#68</a>, <a href="https://github.com/ocaml/ocaml.org/pull/1435">ocaml.org#1435</a></li>
<li>Voodoo now includes a <code>Voodoo_serialize</code> module for data serialisation and deserialisation  &#x2013; <a href="https://github.com/ocaml-doc/voodoo/pull/103">voodoo#103</a>, <a href="https://github.com/ocaml/ocaml.org/pull/1442">ocaml.org#1442</a></li>
<li>Compile step issues with documentation pipeline generation tool addressed  &#x2013; <a href="https://github.com/ocaml-doc/voodoo/pull/115">voodoo#115</a></li>
<li>In case of missing documentation, users are now redirected to the last documented version  &#x2013; <a href="https://github.com/ocaml/ocaml.org/pull/1438">ocaml.org#1438</a></li>
</ul></li>
<li>Bug fixes and miscellaneous improvements:
<ul class="org-ul">
<li><a href="https://github.com/AshineFoster">@AshineFoster</a> made ocaml.org run offline during development  &#x2013; <a href="https://github.com/ocaml/ocaml.org/pull/1366">ocaml.org#1366</a></li>
<li>OCaml Changelog is no longer experimental  &#x2013; <a href="https://github.com/ocaml/ocaml.org/pull/1369">ocaml.org#1369</a></li>
<li>Resolved OCaml Changelog tags&rsquo; overflow issue  &#x2013; <a href="https://github.com/ocaml/ocaml.org/pull/1358">ocaml.org#1358</a></li>
<li>Fixed unreadable components due to tailwind configuration changes  &#x2013; <a href="https://github.com/ocaml/ocaml.org/pull/1375">ocaml.org#1375</a>, <a href="https://github.com/ocaml/ocaml.org/pull/1377">ocaml.org#1377</a>, <a href="https://github.com/ocaml/ocaml.org/pull/1428">ocaml.org#1428</a></li>
<li>Dark mode navigation&rsquo;s logo color was corrected for mobile view  &#x2013; <a href="https://github.com/ocaml/ocaml.org/pull/1385">ocaml.org#1385</a></li>
<li>Applied <code>odoc</code>&rsquo;s styles to package documentation pages  &#x2013; <a href="https://github.com/ocaml/ocaml.org/pull/1378">ocaml.org#1378</a></li>
<li>Improved CONTRIBUTING.md instructions  &#x2013; <a href="https://github.com/ocaml/ocaml.org/pull/1365">ocaml.org#1365</a></li>
<li>Added a Be Sport social network success story  &#x2013; <a href="https://github.com/ocaml/ocaml.org/pull/1362">ocaml.org#1362</a></li>
<li>Published &ldquo;Invitation to Contribute to OCaml.org&rdquo; news entry  &#x2013; <a href="https://github.com/ocaml/ocaml.org/pull/1363">ocaml.org#1363</a></li>
<li>URLs in the <code>data/</code> folder are now routinely checked by <code>tarides/olinkcheck</code>.</li>
</ul></li>
</ul>
</div>
</div>
</div>
</div>




<div id="outline-container-10" class="outline-2">
<h2 id="10">Using <code>[@poll error]</code> attribute to implement systhread safe data structures</h2>
<div class="outline-text-2" id="text-10">
<p>
Archive: <a href="https://discuss.ocaml.org/t/using-poll-error-attribute-to-implement-systhread-safe-data-structures/12804/1">https://discuss.ocaml.org/t/using-poll-error-attribute-to-implement-systhread-safe-data-structures/12804/1</a>
</p>
</div>

<div id="outline-container-org5f9f795" class="outline-3">
<h3 id="org5f9f795">Vesa Karvonen announced</h3>
<div class="outline-text-3" id="text-org5f9f795">
<p>
For a long time OCaml has supported lightweight threads exposed via the
<a href="https://v2.ocaml.org/api/Thread.html">Thread</a> module. These threads are often called &ldquo;systhreads&rdquo;, but I will
simply call them &ldquo;threads&rdquo; in this post.
</p>

<p>
The OCaml Stdlib also provides many mutable data structures such as
<a href="https://v2.ocaml.org/api/Hashtbl.html">Hashtbl</a>, <a href="https://v2.ocaml.org/api/Queue.html">Queue</a>, and
<a href="https://v2.ocaml.org/api/Stack.html">Stack</a>. As the documentation alerts, none of these are thread-safe.
</p>

<p>
In this post I will very briefly describe an approach to implementing lock-free thread-safe data structures.
</p>

<p>
In OCaml 4 and in OCaml 5, within a single <a href="https://v2.ocaml.org/api/Domain.html">Domain</a>, only a single thread may
run at a time. In other words, threads do not run in parallel except when they run in different domains in OCaml 5.
The OCaml runtime schedules threads and semi pre-emptively switches (within a domain) between threads (created
within the domain) during &ldquo;safe points&rdquo;. In other words, thread switches cannot happen at arbitrary points &amp;mdash;
they may only happen at safe points. Memory allocations are safe points. Additional safe points (where no actual
memory allocation happens) are inserted into various constructs such as loops.
</p>

<p>
This means that within a block of code where there are no safe points it is possible to make multiple read and
write accesses atomically with respect to threads (within the domain).
</p>

<p>
How does one ensure that a block of code does not include a safe point?
</p>

<p>
The OCaml compiler provides an annotation <a href="https://github.com/ocaml/ocaml/pull/10462"><code>[@poll error]</code></a> that one can
use on a function to ensure that the function does not include a safe point.
</p>

<p>
IOW, using <code>[@poll error]</code> one can essentially create functions that are executed atomically with respect to
threads (within a domain).
</p>

<p>
With a particular application in mind, I have created a lock-free thread-safe (integer keyed) hash table,
<a href="https://github.com/ocaml-multicore/thread-table/tree/main">thread-table</a>.
</p>

<p>
As mentioned in the README, the implementation has &ldquo;zero synchronization overhead on lookups&rdquo;. Indeed, if you look
at the <a href="https://github.com/ocaml-multicore/thread-table/blob/d98848de454ff55fd771e0126e6f923bf3c3df36/src/thread_table.ml#L56-L61"><code>find</code>
operation</a>
implementation
</p>

<div class="org-src-container">
<pre class="src src-ocaml"><span style="color: #000000; font-weight: bold;">let</span> <span style="color: #a7601f;">find</span> <span style="color: #007a9f;">t</span> <span style="color: #007a9f;">k'</span> =
  <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #007a9f;">h</span> = <span style="color: #444fcf;">Mix.</span>int k' <span style="color: #000000; font-weight: bold;">in</span>
  <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #007a9f;">buckets</span> = t.buckets <span style="color: #000000; font-weight: bold;">in</span>
  <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #007a9f;">n</span> = <span style="color: #444fcf;">Array.</span>length buckets <span style="color: #000000; font-weight: bold;">in</span>
  <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #007a9f;">i</span> = h <span style="color: #a52a2a;">land</span> (n - <span style="color: #00824f;">1</span>) <span style="color: #000000; font-weight: bold;">in</span>
  find k' (<span style="color: #444fcf;">Array.</span>unsafe_get buckets i)
</pre>
</div>

<p>
it includes no synchronization. In this case not even a <code>[@poll error]</code> attribute is needed.
</p>

<p>
For other operations the thread-table implementation uses functions annotated with the <code>[@poll error]</code> attribute
(to make atomic updates) and familiar lock-free programming patterns such as retry loops and cooperation to avoid
starvation. As an example, see the <a href="https://github.com/ocaml-multicore/thread-table/blob/d98848de454ff55fd771e0126e6f923bf3c3df36/src/thread_table.ml#L120-L139"><code>add</code>
operation</a>
implementation:
</p>

<div class="org-src-container">
<pre class="src src-ocaml"><span style="color: #000000; font-weight: bold;">let</span><span style="color: #a2604f;">[@poll error]</span> <span style="color: #a7601f;">add_atomically</span> <span style="color: #007a9f;">t</span> <span style="color: #007a9f;">buckets</span> <span style="color: #007a9f;">n</span> <span style="color: #007a9f;">i</span> <span style="color: #007a9f;">before</span> <span style="color: #007a9f;">after</span> =
  t.rehash = <span style="color: #00824f;">0</span> <span style="color: #a52a2a;">&amp;&amp;</span> buckets == t.buckets
  <span style="color: #a52a2a;">&amp;&amp;</span> before == <span style="color: #444fcf;">Array.</span>unsafe_get buckets i
  <span style="color: #a52a2a;">&amp;&amp;</span> <span style="color: #000000; font-weight: bold;">begin</span>
       <span style="color: #444fcf;">Array.</span>unsafe_set buckets i after;
       <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #007a9f;">length</span> = t.length + <span style="color: #00824f;">1</span> <span style="color: #000000; font-weight: bold;">in</span>
       t.length &lt;- length;
       <span style="color: #006f00; font-weight: bold;">if</span> n &lt; length <span style="color: #a52a2a;">&amp;&amp;</span> n &lt; max_buckets_div_2 <span style="color: #006f00; font-weight: bold;">then</span> t.rehash &lt;- n * <span style="color: #00824f;">2</span>;
       <span style="color: #00824f;">true</span>
     <span style="color: #000000; font-weight: bold;">end</span>

<span style="color: #000000; font-weight: bold;">let</span> <span style="color: #000000; font-weight: bold;">rec</span> <span style="color: #a7601f;">add</span> <span style="color: #007a9f;">t</span> <span style="color: #007a9f;">k'</span> <span style="color: #007a9f;">v'</span> =
  <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #007a9f;">h</span> = <span style="color: #444fcf;">Mix.</span>int k' <span style="color: #000000; font-weight: bold;">in</span>
  maybe_rehash t;
  <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #007a9f;">buckets</span> = t.buckets <span style="color: #000000; font-weight: bold;">in</span>
  <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #007a9f;">n</span> = <span style="color: #444fcf;">Array.</span>length buckets <span style="color: #000000; font-weight: bold;">in</span>
  <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #007a9f;">i</span> = h <span style="color: #a52a2a;">land</span> (n - <span style="color: #00824f;">1</span>) <span style="color: #000000; font-weight: bold;">in</span>
  <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #007a9f;">before</span> = <span style="color: #444fcf;">Array.</span>unsafe_get buckets i <span style="color: #000000; font-weight: bold;">in</span>
  <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #007a9f;">after</span> = <span style="color: #242521; background-color: #fcf7ef;">Cons</span> (k', v', before) <span style="color: #000000; font-weight: bold;">in</span>
  <span style="color: #006f00; font-weight: bold;">if</span> <span style="color: #a52a2a;">not</span> (add_atomically t buckets n i before after) <span style="color: #006f00; font-weight: bold;">then</span> add t k' v'
</pre>
</div>

<p>
Compared to e.g. using a Stdlib <a href="https://v2.ocaml.org/api/Mutex.html"><code>Mutex</code></a> to protect a data structure against
concurrent accesses by threads, this sort of lock-free implementation can give better performance (especially for
read-only operations) and also allows use of the operations in contexts, such as signal handlers, where locks are
not appropriate.
</p>

<p>
Note that this technique is not sufficient for parallelism-safe implementation of data structures.
</p>
</div>
</div>


<div id="outline-container-org39cac05" class="outline-3">
<h3 id="org39cac05">Guillaume Munch-Maccagnoni said</h3>
<div class="outline-text-3" id="text-org39cac05">
<p>
Thanks for the write-up! I do not remember someone writing about this before.
</p>

<p>
This trick is used in JaneStreet&rsquo;s
<a href="https://github.com/janestreet/core_unix/blob/master/nano_mutex/src/nano_mutex.mli">Nano_mutex</a> and
<a href="https://github.com/janestreet/core_kernel/blob/master/thread_safe_queue/src/thread_safe_queue.mli">Thread_safe_queue</a>.
<code>[@poll error]</code> was in fact motivated by these use-cases (and I am surprised not to see them used in the latest
version of JaneStreet&rsquo;s libraries).
</p>

<p>
As you note, with multicore OCaml, these data structures should never be shared between different domains, but the
technique remains valid and useful for data structures designed to stay on a single domain.
</p>

<p>
Be careful that <code>[@poll error]</code> is a recent addition (OCaml 4.14). Earlier version of OCaml require attributes to
<b>disable inlining</b> (among other things), to avoid that polling points could be added during compilation via code
transformations. <code>[@poll error]</code> has the correct semantics in this regard in OCaml 4.14, but earlier OCaml versions
will disregard the attribute and potentially produce incorrect code in the absence of additional attributes. Also,
I would not recommend trying to do without the <code>[@poll error]</code> attribute, because this is error-prone and requires
knowledge of the compiler.
</p>

<p>
<code>[@poll error]</code> is also inoperant in bytecode (which is trickier because it has more polling locations).
</p>

<p>
Lastly, it should be noted that <code>[@poll error]</code> is very inexpressive in the kind of code that it accepts. The
reasoning-about-polling-locations trick is also used in parts of the stdlib, for which <code>[@poll error]</code> is not
expressive enough. I proposed a more expressive attribute to handle those cases, but it was not accepted. There is
also a proposal to delay the polling with &ldquo;masking&rdquo; during critical sections, at runtime (hence even more
expressive).
</p>
</div>
</div>


<div id="outline-container-org6e57719" class="outline-3">
<h3 id="org6e57719">Calascibetta Romain asked and Vesa Karvonen replied</h3>
<div class="outline-text-3" id="text-org6e57719">
<blockquote>
<p>
As far as I understand, the usage of <code>[poll error]</code> starts to be interesting when we start to use a mix of <code>Thread</code>
and <code>Domain</code>?
</p>
</blockquote>

<p>
Yes, and also when using only <code>Thread</code>​s (and no <code>Domain</code>​s).
</p>

<p>
One might ask why one would use <code>Thread</code>​s when we have <code>Domain</code>​s and effects?
</p>

<p>
My comment <a href="https://github.com/ocaml/ocaml/issues/12385#issuecomment-1640954003">here</a> hopefully provides some
ideas where threads could still be very useful. The tl;dr is that threads could be used to allow effects based
schedulers to effectively share domains and threads could also be used, in part, to e.g. implement IO in such a way
that it becomes scheduler independent.  If we do use threads, then it will likely be very useful to be able to
implement communication between threads within a domain with as little synchronization as possible.
</p>

<blockquote>
<p>
For instance, if we allocate only <code>Domain</code>​s, the usage of an <code>Hashtbl</code> into one (and uniquely one, the <code>Hashtbl</code> is
not shared between <code>Domain</code>​s) is “safe”? Moreover, <code>Mutex</code> still is the best practice (regardless <code>Domain</code> or
<code>Thread</code>) to protect an <code>Hashtbl</code> against data-race conditon?
</p>
</blockquote>

<p>
If you mean the Stdlib <code>Hashtbl</code>, then, yes, it is neither thread-safe nor parallelism-safe and one will need to
e.g. use a <code>Mutex</code> to protect it when it might be accessed from multiple threads concurrently or from multiple
domains in parallel.
</p>

<p>
As another currently available alternative, the <a href="https://ocaml-multicore.github.io/kcas/">Kcas</a> library comes with
a companion package of lock-free and parallelism-safe (and also thread-safe) data structures including a
<a href="https://ocaml-multicore.github.io/kcas/doc/kcas_data/Kcas_data/Hashtbl/index.html"><code>Hashtbl</code></a> implementation that
is designed to be an almost drop-in replacement for the Stdlib <code>Hashtbl</code>.  When used in parallel from multiple
domains it should provide better performance than Stdlib <code>Hashtbl</code> protected by a <code>Mutex</code>.  It is also
<a href="https://ocaml-multicore.github.io/kcas/doc/kcas_data/Kcas_data/index.html">composable</a> (read from &ldquo;But why should
you care about composability?&rdquo;), which can make the implementation of more interesting use cases a breeze compared
to the use of non-composable concurrent programming techniques.
</p>
</div>
</div>


<div id="outline-container-orgfb9fc38" class="outline-3">
<h3 id="orgfb9fc38">Calascibetta Romain asked and Vesa Karvonen replied</h3>
<div class="outline-text-3" id="text-orgfb9fc38">
<blockquote>
<p>
Did you consider the idea to integrate that directly into the Stdlib’s <code>Hashtbl</code>?
</p>
</blockquote>

<p>
Yes, and not really.
</p>

<p>
The API of Stdlib <code>Hashtbl</code> is not designed for concurrent programming.  In sequential use cases it will be faster
than any parallelism safe implementation that supports the full API.
</p>

<p>
The reason for mimicking the Stdlib <code>Hashtbl</code> API in Kcas is to allow for easier learning curve and to potentially
make it easier to port an existing application to parallelism-safe OCaml 5.
</p>

<p>
In the future I expect there will be data structures that are designed from the start for concurrent programming
and will e.g. avoid or de-emphasize features with inherent sequential bottlenecks (such as maintenance of exact
length) and operations with inherent risk of starvation (such as being able to (atomically) insert an arbitrary
number of elements to a data structure) and provide fused operations that support common use cases (such as
get-or-add).
</p>
</div>
</div>
</div>




<div id="outline-container-11" class="outline-2">
<h2 id="11">forester 2.3</h2>
<div class="outline-text-2" id="text-11">
<p>
Archive: <a href="https://discuss.ocaml.org/t/ann-forester-2-3/12815/1">https://discuss.ocaml.org/t/ann-forester-2-3/12815/1</a>
</p>
</div>

<div id="outline-container-org04749d3" class="outline-3">
<h3 id="org04749d3">Jon Sterling announced</h3>
<div class="outline-text-3" id="text-org04749d3">
<p>
I would like to announce the release on opam of <a href="https://opam.ocaml.org/packages/forester/">forester 2.3</a>. is an
OCaml utility to develop “Forests”, which are densely interlinked scientific websites / Zettelkästen similar to the
Stacks Project or Kerodon. An example of a “Forest” is my <a href="https://www.jonmsterling.com/">own website</a>.
</p>

<p>
This is a major release involving changes to the command line interface, among other things. Please see the <a href="https://www.jonmsterling.com/jms-006Z.xml">full
changelog</a> for a detailed description of the changes. Below I give a
brief summary:
</p>

<ul class="org-ul">
<li>The existing behavior of the <code>forester</code> command is now located under <code>forester build</code>.</li>
<li>A new <code>forester new</code> command to create the &ldquo;next&rdquo; tree under the base-36 tree addressing scheme.</li>
<li>A new <code>forester complete</code> command for completing tree titles, to facilitate tool support.</li>
<li>Rudimentary support for emitting XML attributes.</li>
<li>Subdirectories of input directories will now be traversed automatically; note that the tree address model remains flat, and subdirectories are present only for convenience.</li>
<li>Added a nicer command line interface with <code>--help</code> documentation.</li>
<li>I have migrated much of the system code to use the experimental <a href="https://github.com/ocaml-multicore/eio">Eio library</a> for improved portability.</li>
<li>The example forest has been removed from the main repository, and moved into a separate <a href="https://git.sr.ht/~jonsterling/forest-template">template repository</a>.</li>
</ul>

<p>
My thanks to Armaël Guéneau, Riley Shahar, and Masanori Ogino for their contributions of code and ideas that made
it into this release.
</p>
</div>
</div>
</div>




<div id="outline-container-orgf50df1a" class="outline-2">
<h2 id="orgf50df1a">Old CWN</h2>
<div class="outline-text-2" id="text-orgf50df1a">
<p>
If you happen to miss a CWN, you can <a href="mailto:alan.schmitt@polytechnique.org">send me a message</a> and I&rsquo;ll mail it to you, or go take a look at <a href="https://alan.petitepomme.net/cwn/">the archive</a> or the <a href="https://alan.petitepomme.net/cwn/cwn.rss">RSS feed of the archives</a>.
</p>

<p>
If you also wish to receive it every week by mail, you may subscribe <a href="http://lists.idyll.org/listinfo/caml-news-weekly/">online</a>.
</p>

<div class="authorname" id="org499ca97">
<p>
<a href="https://alan.petitepomme.net/">Alan Schmitt</a>
</p>

</div>
</div>
</div>
</div>
</body>
</html>