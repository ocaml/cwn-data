<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<!-- 2019-09-10 Tue 15:09 -->
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>OCaml Weekly News</title>
<meta name="generator" content="Org mode" />
<style type="text/css">
 <!--/*--><![CDATA[/*><!--*/
  .title  { text-align: center;
             margin-bottom: .2em; }
  .subtitle { text-align: center;
              font-size: medium;
              font-weight: bold;
              margin-top:0; }
  .todo   { font-family: monospace; color: red; }
  .done   { font-family: monospace; color: green; }
  .priority { font-family: monospace; color: orange; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .org-right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .org-left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .org-center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #ccc;
    box-shadow: 3px 3px 3px #eee;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: visible;
    padding-top: 1.2em;
  }
  pre.src:before {
    display: none;
    position: absolute;
    background-color: white;
    top: -10px;
    right: 10px;
    padding: 3px;
    border: 1px solid black;
  }
  pre.src:hover:before { display: inline;}
  /* Languages per Org manual */
  pre.src-asymptote:before { content: 'Asymptote'; }
  pre.src-awk:before { content: 'Awk'; }
  pre.src-C:before { content: 'C'; }
  /* pre.src-C++ doesn't work in CSS */
  pre.src-clojure:before { content: 'Clojure'; }
  pre.src-css:before { content: 'CSS'; }
  pre.src-D:before { content: 'D'; }
  pre.src-ditaa:before { content: 'ditaa'; }
  pre.src-dot:before { content: 'Graphviz'; }
  pre.src-calc:before { content: 'Emacs Calc'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-fortran:before { content: 'Fortran'; }
  pre.src-gnuplot:before { content: 'gnuplot'; }
  pre.src-haskell:before { content: 'Haskell'; }
  pre.src-hledger:before { content: 'hledger'; }
  pre.src-java:before { content: 'Java'; }
  pre.src-js:before { content: 'Javascript'; }
  pre.src-latex:before { content: 'LaTeX'; }
  pre.src-ledger:before { content: 'Ledger'; }
  pre.src-lisp:before { content: 'Lisp'; }
  pre.src-lilypond:before { content: 'Lilypond'; }
  pre.src-lua:before { content: 'Lua'; }
  pre.src-matlab:before { content: 'MATLAB'; }
  pre.src-mscgen:before { content: 'Mscgen'; }
  pre.src-ocaml:before { content: 'Objective Caml'; }
  pre.src-octave:before { content: 'Octave'; }
  pre.src-org:before { content: 'Org mode'; }
  pre.src-oz:before { content: 'OZ'; }
  pre.src-plantuml:before { content: 'Plantuml'; }
  pre.src-processing:before { content: 'Processing.js'; }
  pre.src-python:before { content: 'Python'; }
  pre.src-R:before { content: 'R'; }
  pre.src-ruby:before { content: 'Ruby'; }
  pre.src-sass:before { content: 'Sass'; }
  pre.src-scheme:before { content: 'Scheme'; }
  pre.src-screen:before { content: 'Gnu Screen'; }
  pre.src-sed:before { content: 'Sed'; }
  pre.src-sh:before { content: 'shell'; }
  pre.src-sql:before { content: 'SQL'; }
  pre.src-sqlite:before { content: 'SQLite'; }
  /* additional languages in org.el's org-babel-load-languages alist */
  pre.src-forth:before { content: 'Forth'; }
  pre.src-io:before { content: 'IO'; }
  pre.src-J:before { content: 'J'; }
  pre.src-makefile:before { content: 'Makefile'; }
  pre.src-maxima:before { content: 'Maxima'; }
  pre.src-perl:before { content: 'Perl'; }
  pre.src-picolisp:before { content: 'Pico Lisp'; }
  pre.src-scala:before { content: 'Scala'; }
  pre.src-shell:before { content: 'Shell Script'; }
  pre.src-ebnf2ps:before { content: 'ebfn2ps'; }
  /* additional language identifiers per "defun org-babel-execute"
       in ob-*.el */
  pre.src-cpp:before  { content: 'C++'; }
  pre.src-abc:before  { content: 'ABC'; }
  pre.src-coq:before  { content: 'Coq'; }
  pre.src-groovy:before  { content: 'Groovy'; }
  /* additional language identifiers from org-babel-shell-names in
     ob-shell.el: ob-shell is the only babel language using a lambda to put
     the execution function name together. */
  pre.src-bash:before  { content: 'bash'; }
  pre.src-csh:before  { content: 'csh'; }
  pre.src-ash:before  { content: 'ash'; }
  pre.src-dash:before  { content: 'dash'; }
  pre.src-ksh:before  { content: 'ksh'; }
  pre.src-mksh:before  { content: 'mksh'; }
  pre.src-posh:before  { content: 'posh'; }
  /* Additional Emacs modes also supported by the LaTeX listings package */
  pre.src-ada:before { content: 'Ada'; }
  pre.src-asm:before { content: 'Assembler'; }
  pre.src-caml:before { content: 'Caml'; }
  pre.src-delphi:before { content: 'Delphi'; }
  pre.src-html:before { content: 'HTML'; }
  pre.src-idl:before { content: 'IDL'; }
  pre.src-mercury:before { content: 'Mercury'; }
  pre.src-metapost:before { content: 'MetaPost'; }
  pre.src-modula-2:before { content: 'Modula-2'; }
  pre.src-pascal:before { content: 'Pascal'; }
  pre.src-ps:before { content: 'PostScript'; }
  pre.src-prolog:before { content: 'Prolog'; }
  pre.src-simula:before { content: 'Simula'; }
  pre.src-tcl:before { content: 'tcl'; }
  pre.src-tex:before { content: 'TeX'; }
  pre.src-plain-tex:before { content: 'Plain TeX'; }
  pre.src-verilog:before { content: 'Verilog'; }
  pre.src-vhdl:before { content: 'VHDL'; }
  pre.src-xml:before { content: 'XML'; }
  pre.src-nxml:before { content: 'XML'; }
  /* add a generic configuration mode; LaTeX export needs an additional
     (add-to-list 'org-latex-listings-langs '(conf " ")) in .emacs */
  pre.src-conf:before { content: 'Configuration File'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.org-right  { text-align: center;  }
  th.org-left   { text-align: center;   }
  th.org-center { text-align: center; }
  td.org-right  { text-align: right;  }
  td.org-left   { text-align: left;   }
  td.org-center { text-align: center; }
  dt { font-weight: bold; }
  .footpara { display: inline; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .equation-container {
    display: table;
    text-align: center;
    width: 100%;
  }
  .equation {
    vertical-align: middle;
  }
  .equation-label {
    display: table-cell;
    text-align: right;
    vertical-align: middle;
  }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  .org-svg { width: 90%; }
  /*]]>*/-->
</style>
<style type="text/css">#table-of-contents h2 { display: none } .title { display: none } .authorname { text-align: right }</style>
<style type="text/css">.outline-2 {border-top: 1px solid black;}</style>
<script type="text/javascript">
/*
@licstart  The following is the entire license notice for the
JavaScript code in this tag.

Copyright (C) 2012-2019 Free Software Foundation, Inc.

The JavaScript code in this tag is free software: you can
redistribute it and/or modify it under the terms of the GNU
General Public License (GNU GPL) as published by the Free Software
Foundation, either version 3 of the License, or (at your option)
any later version.  The code is distributed WITHOUT ANY WARRANTY;
without even the implied warranty of MERCHANTABILITY or FITNESS
FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.

As additional permission under GNU GPL version 3 section 7, you
may distribute non-source (e.g., minimized or compacted) forms of
that code without the copy of the GNU GPL normally required by
section 4, provided you include this license notice and a URL
through which recipients can access the Corresponding Source.


@licend  The above is the entire license notice
for the JavaScript code in this tag.
*/
<!--/*--><![CDATA[/*><!--*/
 function CodeHighlightOn(elem, id)
 {
   var target = document.getElementById(id);
   if(null != target) {
     elem.cacheClassElem = elem.className;
     elem.cacheClassTarget = target.className;
     target.className = "code-highlighted";
     elem.className   = "code-highlighted";
   }
 }
 function CodeHighlightOff(elem, id)
 {
   var target = document.getElementById(id);
   if(elem.cacheClassElem)
     elem.className = elem.cacheClassElem;
   if(elem.cacheClassTarget)
     target.className = elem.cacheClassTarget;
 }
/*]]>*///-->
</script>
</head>
<body>
<div id="content">
<h1 class="title">OCaml Weekly News</h1>
<p>
<a href="http://alan.petitepomme.net/cwn/2019.09.03.html">Previous Week</a> <a href="http://alan.petitepomme.net/cwn/index.html">Up</a> <a href="http://alan.petitepomme.net/cwn/2019.09.17.html">Next Week</a>
</p>

<p>
Hello
</p>

<p>
Here is the latest OCaml Weekly News, for the week of September 03 to 10, 2019.
</p>

<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#1">Implicits for the masses</a></li>
<li><a href="#2">Ppx_yojson_conv: deriving plugin to generate Yojson conversion functions</a></li>
<li><a href="#3">Memory usage in recursive function as infinite loop</a></li>
<li><a href="#4">Receiving/sending http requests in an Ocaml program</a></li>
<li><a href="#5">Other OCaml News</a></li>
<li><a href="#orgbf9cf55">Old CWN</a></li>
</ul>
</div>
</div>


<div id="outline-container-org7be254d" class="outline-2">
<h2 id="1">Implicits for the masses</h2>
<div class="outline-text-2" id="text-1">
<p>
Archive: <a href="https://sympa.inria.fr/sympa/arc/caml-list/2019-09/msg00003.html">https://sympa.inria.fr/sympa/arc/caml-list/2019-09/msg00003.html</a>
</p>
</div>

<div id="outline-container-org1c0e073" class="outline-3">
<h3 id="org1c0e073">Oleg announced</h3>
<div class="outline-text-3" id="text-org1c0e073">
<p>
This is to announce a simple, plain OCaml library to experiment with
type-class/implicits resolution, which can be thought of as evaluating
a Prolog-like program. One may allow `overlapping instances' &#x2013; or
prohibit them, insisting on uniqueness. One may make the search fully
deterministic, fully non-deterministic, or something in-between.
There is an immediate, albeit modest practical benefit: the facility
like "#install_printer", which was restricted to top-level, is now
available for all &#x2013; as a small, self-contained, plain OCaml library
with no knowledge or dependencies on the compiler internals. We show
an example at the end of the message.
</p>

<p>
This message has been inspired by the remarkable paper
</p>
<p class="verse">
Canonical Structures for the working Coq user<br />
Assia Mahboubi, Enrico Tassi<br />
DOI: 10.1007/978-3-642-39634-2_5<br />
</p>
<p>
Its introduction is particularly insightful: the power of
(mathematical) notation is in eliding distracting details. Yet to
formally check a proof, or to run a program, the omitted has to be
found. When pressed to fill in details, people `skillful in the art'
look in the database of the `state of the art', with the context as
the key. Computers can be programmed similarly; types well represent
the needed context to guide the search.
</p>

<p>
Mahboubi and Tassi's paper explains very well how this eliding and
filling-in is realized, as a programmable unification, and used in
Coq. Yet their insights go beyond Coq and deserve to be known better.
This message and the accompanying code is to explain them in
plain OCaml and encourage experimentation. It could have been titled
`Canonical Structures for the working OCaml (meta) programmer'.
</p>

<p>
The rudiment of canonical structures is already present in OCaml, in
the form of the registry of printers for user-defined types. This
facility is available only at the top-level, however, and deeply
intertwined with it. As a modest practical benefit, this facility is
now available for all programs, as a plain, small, self-contained
library, with no compiler or other magic. The full potential of the
method is realized however in (multi-) staged programming. In fact, I'm
planning to use it in the upcoming version of MetaOCaml to implement
`lifting' from a value to the code that produces it &#x2013; letting the
users register lifting functions for their own data types.
</p>


<ul class="org-ul">
<li><a href="http://okmij.org/ftp/ML/canonical.ml">http://okmij.org/ftp/ML/canonical.ml</a> <br />
The implementation and the examples, some of which are noted below.</li>
<li><a href="http://okmij.org/ftp/ML/trep.ml">http://okmij.org/ftp/ML/trep.ml</a> <br />
A generic library of type representations: something like
Typeable in Haskell. Some day it may be built-in into the compiler</li>
<li><a href="http://okmij.org/ftp/ML/canonical_leadup.ml">http://okmij.org/ftp/ML/canonical_leadup.ml</a> <br />
A well-commented code that records the progressive development of
canonical.ml. It is not part of the library, but may serve as
its explanation.</li>
</ul>

<p>
Here are a few examples, starting with the most trivial one
</p>
<div class="org-src-container">
<pre class="src src-ocaml"><span style="color: #000000; font-weight: bold;">module</span> <span style="color: #228b22;">Show</span> = <span style="color: #228b22;">MakeResolve</span>(<span style="color: #000000; font-weight: bold;">struct</span> <span style="color: #000000; font-weight: bold;">type</span> <span style="color: #228b22;">'a dict</span> = 'a -&gt; string <span style="color: #000000; font-weight: bold;">end</span>)
<span style="color: #000000; font-weight: bold;">let</span> () = <span style="color: #228b22;">Show.</span>register <span style="color: #000000; background-color: #ffffff;">Int</span> string_of_int    <span style="color: #b22222;">(* </span><span style="color: #b22222;">Define `instances' </span><span style="color: #b22222;">*)</span>
<span style="color: #000000; font-weight: bold;">let</span> () = <span style="color: #228b22;">Show.</span>register <span style="color: #000000; background-color: #ffffff;">Bool</span> string_of_bool
<span style="color: #228b22;">Show.</span>find <span style="color: #000000; background-color: #ffffff;">Int</span> 1<span style="color: #ff4500;">;;</span>
</pre>
</div>

<p>
However contrived and flawed, it is instructive. Here (Int : int trep)
is the value representing the type int. The type checker can certainly
figure out that 1 is of the type int, and could potentially save us
trouble writing Int explicitly. What the type checker cannot do by
itself is to find out which function to use to convert an int to a
string. After all, there are many of them. Show.register lets us
register the <b>canonical</b> int-&gt;string function. Show.find is to search
the database of such canonical functions: in effect, finding <b>the</b>
evidence that the type int-&gt;string is populated. Keeping Curry-Howard
in mind, Show.find does a <span class="underline">proof search</span>.
</p>

<p>
The type of Show.find is 'a trep -&gt; ('a -&gt; string). Compare with
Haskell's show : Show a =&gt; a -&gt; String (or, desuraging =&gt; and Show)
show : ('a -&gt; string) -&gt; ('a -&gt; string).  Haskell's show indeed does
not actually do anything: it is the identity function. All the hard
work &#x2013; finding out the right dictionary (the string producing
function) &#x2013; is done by the compiler. If one does not like the way the
compiler goes about it &#x2013; tough luck. There is little one may do save
complaining on reddit. In contrast, the first argument of Show.find is
trivial: it is a mere reflection of the type int, with no further
information. Hence Show.find has to do a non-trivial work.  In the
case of int, this work is the straightforward database search &#x2013;
or, if you prefer, running the query ?- dict(int,R) against a logic
program
</p>
<pre class="example">
dict(int,string_of_int).
dict(bool,string_of_bool).
</pre>
<p>
The program becomes more interesting when it comes to pairs:
</p>
<pre class="example">
dict(T,R) :- T = pair(X,Y), !,
    dict(X,DX), dict(Y,DY), R=make_pair_dict(DX,DY).
</pre>
<p>
Here is how it is expressed in OCaml:
</p>
<div class="org-src-container">
<pre class="src src-ocaml"><span style="color: #000000; font-weight: bold;">let</span> () =
  <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #000000; font-weight: bold;">open </span><span style="color: #228b22;">Show</span> <span style="color: #000000; font-weight: bold;">in</span>
  <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #0000ff;">pat</span> :<span style="color: #228b22;"> </span><span style="color: #a020f0;">type</span><span style="color: #228b22;"> b. b trep -&gt; b rule_body option </span>= <span style="color: #a020f0;">function</span>
    | <span style="color: #000000; background-color: #ffffff;">Pair</span> (x,y) -&gt;
        <span style="color: #000000; background-color: #ffffff;">Some</span> (<span style="color: #000000; background-color: #ffffff;">Arg</span> (x, <span style="color: #a020f0;">fun</span> <span style="color: #a0522d;">dx</span> -&gt; <span style="color: #000000; background-color: #ffffff;">Arg</span> (y, <span style="color: #a020f0;">fun</span> <span style="color: #a0522d;">dy</span> -&gt;
          <span style="color: #000000; background-color: #ffffff;">Fact</span> (<span style="color: #a020f0;">fun</span> (<span style="color: #a0522d;">x</span>,<span style="color: #a0522d;">y</span>) -&gt; <span style="color: #8b2252;">"("</span> <span style="color: #a52a2a;">^</span> dx x <span style="color: #a52a2a;">^</span> <span style="color: #8b2252;">","</span> <span style="color: #a52a2a;">^</span> dy y <span style="color: #a52a2a;">^</span> <span style="color: #8b2252;">")"</span>))))
    | _      -&gt; <span style="color: #000000; background-color: #ffffff;">None</span>
  <span style="color: #000000; font-weight: bold;">in</span> register_rule {pat}

<span style="color: #000000; font-weight: bold;">let</span> () = <span style="color: #228b22;">Show.</span>register (<span style="color: #000000; background-color: #ffffff;">Pair</span>(<span style="color: #000000; background-color: #ffffff;">Bool</span>,<span style="color: #000000; background-color: #ffffff;">Bool</span>))
           (<span style="color: #a020f0;">fun</span> (<span style="color: #a0522d;">x</span>,<span style="color: #a0522d;">y</span>) -&gt; string_of_bool x <span style="color: #a52a2a;">^</span> string_of_bool y)
</pre>
</div>

<p>
Our library permits `overlapping instances'. We hence registered the
printer for generic pairs, and a particular printer just for pairs of
booleans.
</p>

<p>
The library is extensible with user-defined data types, for example:
</p>
<div class="org-src-container">
<pre class="src src-ocaml"><span style="color: #000000; font-weight: bold;">type</span> <span style="color: #228b22;">my_fancy_datatype</span> = <span style="color: #000000; background-color: #ffffff;">Fancy</span> <span style="color: #a020f0;">of</span> int * string * (int -&gt; string)
</pre>
</div>

<p>
After registering the type with trep library, and the printer
</p>
<div class="org-src-container">
<pre class="src src-ocaml"><span style="color: #000000; font-weight: bold;">type</span> <span style="color: #228b22;">_ trep</span> += <span style="color: #000000; background-color: #ffffff;">MyFancy</span> : my_fancy_datatype trep
<span style="color: #000000; font-weight: bold;">let</span> () = <span style="color: #228b22;">Show.</span>register <span style="color: #000000; background-color: #ffffff;">MyFancy</span> (<span style="color: #a020f0;">function</span> <span style="color: #000000; background-color: #ffffff;">Fancy</span>(x,y,_) -&gt;
  string_of_int x <span style="color: #a52a2a;">^</span> <span style="color: #8b2252;">"/"</span> <span style="color: #a52a2a;">^</span> y <span style="color: #a52a2a;">^</span> <span style="color: #8b2252;">"/"</span> <span style="color: #a52a2a;">^</span> <span style="color: #8b2252;">"&lt;fun&gt;"</span>)
</pre>
</div>

<p>
one can print rather complex data with fancy, with no further ado:
</p>
<div class="org-src-container">
<pre class="src src-ocaml"><span style="color: #228b22;">Show.</span>find (<span style="color: #000000; background-color: #ffffff;">List</span>(<span style="color: #000000; background-color: #ffffff;">List</span>(<span style="color: #000000; background-color: #ffffff;">Pair</span>(<span style="color: #000000; background-color: #ffffff;">MyFancy</span>,<span style="color: #000000; background-color: #ffffff;">Int</span>)))) [[(<span style="color: #000000; background-color: #ffffff;">Fancy</span> ...,5)];<span style="color: #000000; background-color: #ffffff;">[]</span>]
</pre>
</div>

<p>
As Mahboubi and Tassi would say, proof synthesis at work!
</p>

<p>
We should stress that what we have described is not a type-class
facility for OCaml. It is <b>meta</b> type-class facility.  Show.find has
many drawbacks: we have to explicitly pass the trep argument like
Int. The resolution happens at run time, and hence the failure of the
resolution is a run-time exception. But the canonical instance
resolution was intended to be a part of a type checker. There, the
resolution failure is a type checking error. The trep argument,
representing the type in the object program, is also at
hand. Likewise, the drawbacks of Show.find disappear when we use the
library in a meta-program (code generator). The library then becomes a
type-class/implicits facility, for the generated code &#x2013; the facility,
we can easily (re)program.
</p>
</div>
</div>


<div id="outline-container-orgeb29900" class="outline-3">
<h3 id="orgeb29900">Ivan Gotovchits</h3>
<div class="outline-text-3" id="text-orgeb29900">
<p>
Very interesting and thought-provoking writeup, thank you!
</p>

<p>
Incidentally, we're investigating the same venues, in our CMU BAP project,
as we found out that we need the extensibility in the style of type
classes/canonical structures to decouple complex dependencies which arise
in the program analysis domain.
In fact, we build our new BAP 2.0 framework largely on your
<a href="http://okmij.org/ftp/tagless-final/index.html">tagless-final</a> style which, let's admit it, works much better with type
classes. Therefore we ended up implementing extensible type representations
along with registries for our type classes. Unfortunately, the idea of
storing rules in the registry didn't visit us, but we're now thinking about
how to incorporate it (the classes that we have are very nontrivial,
usually having hundreds of methods, so we're currently using functors to
manually derive on class from another, and registering the resulting
structures - but using your approach we can register functors as well and
automate the derivation). We also didn't generalize the type class
instantiation, so our solutions do have some boilerplate (but I have to
admit, that the total number of type classes that we need is not very big,
so it really never bothered us). What could be surprising is that the
universe of types actually grew quite large, that large that the linear
search in the registry is not an option for us anymore. In fact, we have so
many comparisons between treps, that instead of extracting the extension
constructor number from an extensible variant we had to rely on our own
freshly generated identifier. But I'm running in front of myself, an
important lesson that we have learned is that treps should not only be
equality comparable but also ordered (and even hashable) so that we can
implement our registries as hash tables. It is also better to keep them
abstract so that we can later extend them without breaking user code (to
implement introspection as well as different resolution schemes). This is
basically an elaboration of your approach (which is also could be commonly
found in Janestreet's Core (Type_equal.Uid.t) and other implementations of
existentials). In our case, we ended up with the following implementation
</p>
<div class="org-src-container">
<pre class="src src-ocaml"><span style="color: #000000; font-weight: bold;">type</span> <span style="color: #228b22;">'a witness</span> = ..

<span style="color: #000000; font-weight: bold;">module type</span> <span style="color: #228b22;">Witness</span> = <span style="color: #000000; font-weight: bold;">sig</span>
  <span style="color: #000000; font-weight: bold;">type</span> <span style="color: #228b22;">t</span>
  <span style="color: #000000; font-weight: bold;">type</span> <span style="color: #228b22;">_ witness</span> += <span style="color: #000000; background-color: #ffffff;">Id</span> : t witness
<span style="color: #000000; font-weight: bold;">end</span>

<span style="color: #000000; font-weight: bold;">type</span> <span style="color: #228b22;">'a typeid</span> = (<span style="color: #000000; font-weight: bold;">module</span> <span style="color: #228b22;">Witness</span> <span style="color: #000000; font-weight: bold;">with type</span> <span style="color: #228b22;">t</span> = 'a)

<span style="color: #000000; font-weight: bold;">type</span> <span style="color: #228b22;">'a key</span> = {
  ord : int;
  key : 'a typeid;
  name : string; <span style="color: #b22222;">(* </span><span style="color: #b22222;">for introspection </span><span style="color: #b22222;">*)</span>
  show : 'a -&gt; <span style="color: #228b22;">Sexp.</span>t; <span style="color: #b22222;">(* </span><span style="color: #b22222;">also for introspection </span><span style="color: #b22222;">*)</span>
}
</pre>
</div>
<p>
Now, we can use the <code>ord</code> field to order types, compare them, store in
maps, hash tables, and even arrays. E.g., this is how our <code>teq</code> function
looks like,
</p>
<div class="org-src-container">
<pre class="src src-ocaml"><span style="color: #000000; font-weight: bold;">let</span> <span style="color: #0000ff;">same</span> (<span style="color: #a020f0;">type</span> <span style="color: #228b22;">a</span> <span style="color: #228b22;">b</span>) <span style="color: #a0522d;">x</span> <span style="color: #a0522d;">y</span> :<span style="color: #228b22;"> (a,b) </span><span style="color: #228b22;">Type_equal.</span><span style="color: #228b22;">t </span>=
  <span style="color: #a020f0;">if</span> x.id =  y.id <span style="color: #a020f0;">then</span>
    <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #000000; font-weight: bold;">module</span> <span style="color: #228b22;">X</span> = (<span style="color: #a020f0;">val</span> <span style="color: #228b22;">x.key </span>:<span style="color: #228b22;"> Witness with type t = a</span>) <span style="color: #000000; font-weight: bold;">in</span>
    <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #000000; font-weight: bold;">module</span> <span style="color: #228b22;">Y</span> = (<span style="color: #a020f0;">val</span> <span style="color: #228b22;">y.key </span>:<span style="color: #228b22;"> Witness with type t = b</span>) <span style="color: #000000; font-weight: bold;">in</span>
    <span style="color: #a020f0;">match</span> <span style="color: #228b22;">X.</span><span style="color: #000000; background-color: #ffffff;">Id</span> <span style="color: #a020f0;">with</span>
    | <span style="color: #228b22;">Y.</span><span style="color: #000000; background-color: #ffffff;">Id</span> -&gt; <span style="color: #228b22;">Type_equal.</span><span style="color: #000000; background-color: #ffffff;">T</span>
    | _ -&gt; <span style="color: #483d8b;">failwith</span> <span style="color: #8b2252;">"broken type equality"</span>
  <span style="color: #a020f0;">else</span> <span style="color: #483d8b;">failwith</span> <span style="color: #8b2252;">"types are not equal"</span>
</pre>
</div>

<p>
It is often used in the context where we already know that <code>x.id = y.id</code>,
e.g., when we already found an entry, so we just need to obtain the
equality witness (we use Janestreet's Type_equal.T, which is the same as
yours eq type).
</p>

<p>
Concerning the representation of the registry, we also experimented with
different approaches (since we have a few ways to make a type existential
in OCaml), and found out the following to be the most efficient and easy to
work with,
</p>

<div class="org-src-container">
<pre class="src src-ocaml"><span style="color: #000000; font-weight: bold;">type</span> <span style="color: #228b22;">ordered</span> = {
    order : 'a. 'a key -&gt; 'a -&gt; 'a -&gt; int;
  } <span style="color: #483d8b;">[@@unboxed]</span>
</pre>
</div>

<p>
Notice, that thanks to <code>[@@unboxed]</code> we got a free unpacked existential. We
will next store <code>ordered</code> in our registry, which is a hash table,
</p>

<div class="org-src-container">
<pre class="src src-ocaml"><span style="color: #000000; font-weight: bold;">let</span> <span style="color: #a0522d;">ordered</span> :<span style="color: #228b22;"> ordered </span><span style="color: #228b22;">Hashtbl.</span><span style="color: #000000; background-color: #ffffff;">M</span><span style="color: #228b22;">(</span><span style="color: #000000; background-color: #ffffff;">Int</span><span style="color: #228b22;">).t </span>= <span style="color: #228b22;">Hashtbl.</span>create (<span style="color: #a020f0;">module</span> <span style="color: #228b22;">Int</span>)
</pre>
</div>
<p>
and register it as simple as,
</p>
<div class="org-src-container">
<pre class="src src-ocaml">  <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #0000ff;">register</span>:<span style="color: #228b22;"> </span><span style="color: #a020f0;">type</span><span style="color: #228b22;"> p. p </span><span style="color: #228b22;">Key.</span><span style="color: #228b22;">t -&gt; (p -&gt; p -&gt; int) -&gt; unit </span>= <span style="color: #a020f0;">fun</span> <span style="color: #a0522d;">key</span> <span style="color: #a0522d;">order</span>
-&gt;
    <span style="color: #228b22;">Hashtbl.</span>add_exn vtables <span style="color: #008b8b;">~key</span>:(uid key) <span style="color: #008b8b;">~data</span>:{
      order = <span style="color: #a020f0;">fun</span> (<span style="color: #a020f0;">type</span> <span style="color: #228b22;">a</span>) (<span style="color: #a0522d;">k</span> :<span style="color: #228b22;"> a key</span>) (<span style="color: #a0522d;">x</span> :<span style="color: #228b22;"> a</span>) (<span style="color: #a0522d;">y</span> :<span style="color: #228b22;"> a</span>) -&gt;
        <span style="color: #000000; font-weight: bold;">let</span> <span style="color: #000000; background-color: #ffffff;">T</span> = same k key <span style="color: #000000; font-weight: bold;">in</span> <span style="color: #b22222;">(* </span><span style="color: #b22222;">obtain the witness that we found the right structure </span><span style="color: #b22222;">*)</span>
        order x y
     }
</pre>
</div>

<p>
Instead of a hashtable, it is also possible to use <code>ordered array ref</code>
(since our <code>ord</code> is just an integer which we increment every time a new
class is declared). This will give us even faster lookup.
</p>

<p>
I hope that this was interesting. And if yes, I'm ready to elaborate more
on our design decision or to hear suggestions and critics. Here are a few
links:
</p>

<ul class="org-ul">
<li><a href="https://github.com/BinaryAnalysisPlatform/bap">https://github.com/BinaryAnalysisPlatform/bap</a> - the BAP project per se.</li>
<li><a href="https://binaryanalysisplatform.github.io/knowledge-intro-1">https://binaryanalysisplatform.github.io/knowledge-intro-1</a>  - a small introductionary post about BAP 2.0 Knowledge representation</li>
<li><a href="https://github.com/BinaryAnalysisPlatform/bap/blob/master/lib/knowledge/bap_knowledge.ml">https://github.com/BinaryAnalysisPlatform/bap/blob/master/lib/knowledge/bap_knowledge.ml</a> - the implementation of the knowledge system</li>
<li><a href="https://github.com/BinaryAnalysisPlatform/bap/tree/master/lib/bap_core_theory">https://github.com/BinaryAnalysisPlatform/bap/tree/master/lib/bap_core_theory</a> - The Core Theory, an exemplar type class of the theory that we're developing :)</li>
</ul>
</div>
</div>
</div>




<div id="outline-container-org5bda110" class="outline-2">
<h2 id="2">Ppx_yojson_conv: deriving plugin to generate Yojson conversion functions</h2>
<div class="outline-text-2" id="text-2">
<p>
Archive: <a href="https://discuss.ocaml.org/t/ann-ppx-yojson-conv-deriving-plugin-to-generate-yojson-conversion-functions/4109/7">https://discuss.ocaml.org/t/ann-ppx-yojson-conv-deriving-plugin-to-generate-yojson-conversion-functions/4109/7</a>
</p>
</div>

<div id="outline-container-org4b5360a" class="outline-3">
<h3 id="org4b5360a">Hhugo announced</h3>
<div class="outline-text-3" id="text-org4b5360a">
<p>
@trefis has worked on splitting the ppx_yojson_conv runtime to a different library. See <a href="https://github.com/janestreet/ppx_yojson_conv_lib">https://github.com/janestreet/ppx_yojson_conv_lib</a>
</p>
</div>
</div>
</div>




<div id="outline-container-org33f4355" class="outline-2">
<h2 id="3">Memory usage in recursive function as infinite loop</h2>
<div class="outline-text-2" id="text-3">
<p>
Archive: <a href="https://discuss.ocaml.org/t/memory-usage-in-recursive-function-as-infinite-loop/4320/1">https://discuss.ocaml.org/t/memory-usage-in-recursive-function-as-infinite-loop/4320/1</a>
</p>
</div>

<div id="outline-container-orga719c97" class="outline-3">
<h3 id="orga719c97">Diego Guraieb asked</h3>
<div class="outline-text-3" id="text-orga719c97">
<p>
On my project I have a process that has to run every 1 sec,  fetching events and doing some work with them.
</p>

<p>
Should I use. a while true loop or recursive function?  How does it affect memory usage?
</p>
</div>
</div>


<div id="outline-container-org35a23e9" class="outline-3">
<h3 id="org35a23e9">Ivan Gotovchits replied</h3>
<div class="outline-text-3" id="text-org35a23e9">
<p>
A tail recursive function doesn't affect memory usage and is no different in that sense from a while/for or any other loop. A tail recursive function is such function that calls itself in the tail position. In general it means that the recursive call is not followed by any other operation, that uses the result of the call. For example, this is a tail recursive function
</p>

<div class="org-src-container">
<pre class="src src-ocaml"><span style="color: #000000; font-weight: bold;">open </span><span style="color: #228b22;">Printf</span>

<span style="color: #000000; font-weight: bold;">let</span> re&#1089; <span style="color: #a0522d;">loop</span> <span style="color: #a0522d;">rounds</span> =
   <span style="color: #a020f0;">if</span> rounds &gt; 0
   <span style="color: #a020f0;">then</span> <span style="color: #000000; font-weight: bold;">begin</span>
      printf <span style="color: #8b2252;">"Round %d\n"</span> round;
      loop (rounds - 1)
   <span style="color: #000000; font-weight: bold;">end</span>
   <span style="color: #a020f0;">else</span> printf <span style="color: #8b2252;">"We are done!\n"</span>
</pre>
</div>

<p>
In this function, the <code>loop (rounds - 1)</code> call is in the tail position and is not followed by any other expression.
</p>

<p>
Any loop could be rewritten using tail-recursion, so if you're having a choice between using a while/for loop and a recursive function, then, given that recursion is a more natural representation of iteration, it is better to use the recursive function, instead of relying on adhoc for or while loops.
</p>
</div>
</div>


<div id="outline-container-org1cd0b46" class="outline-3">
<h3 id="org1cd0b46">Chimrod then added</h3>
<div class="outline-text-3" id="text-org1cd0b46">
<p>
Nothe that you also can add the <a href="https://caml.inria.fr/pub/docs/manual-ocaml/manual035.html#sec265">@tailcall</a> annotation to ensure that the function will be properly tranformed in a loop. This code trigger a warning at the compilation
</p>

<div class="org-src-container">
<pre class="src src-ocaml"><span style="color: #000000; font-weight: bold;">open </span><span style="color: #228b22;">Printf</span>

<span style="color: #000000; font-weight: bold;">let</span> <span style="color: #000000; font-weight: bold;">rec</span> <span style="color: #0000ff;">loop</span> <span style="color: #a0522d;">rounds</span> =
   <span style="color: #a020f0;">if</span> rounds &gt; 0
   <span style="color: #a020f0;">then</span> <span style="color: #000000; font-weight: bold;">begin</span>
      printf <span style="color: #8b2252;">"Rounds left %d\n"</span> rounds;
      <span style="color: #a020f0;">try</span> (loop <span style="color: #483d8b;">[@tailcall]</span>) (rounds - 1)
      <span style="color: #a020f0;">with</span> <span style="color: #483d8b;">Not_found</span> -&gt; printf <span style="color: #8b2252;">"Error\n"</span>
   <span style="color: #000000; font-weight: bold;">end</span>
   <span style="color: #a020f0;">else</span> printf <span style="color: #8b2252;">"We are done!\n"</span>
</pre>
</div>

<pre class="example">
ocamlc test.ml
File "test.ml", line 7, characters 10-41:
Warning 51: expected tailcall
</pre>
</div>
</div>
</div>




<div id="outline-container-orgf34bec0" class="outline-2">
<h2 id="4">Receiving/sending http requests in an Ocaml program</h2>
<div class="outline-text-2" id="text-4">
<p>
Archive: <a href="https://discuss.ocaml.org/t/receiving-sending-http-requests-in-an-ocaml-program/4332/1">https://discuss.ocaml.org/t/receiving-sending-http-requests-in-an-ocaml-program/4332/1</a>
</p>
</div>

<div id="outline-container-org01209ce" class="outline-3">
<h3 id="org01209ce">Luc_ML asked</h3>
<div class="outline-text-3" id="text-org01209ce">
<p>
I have an Ocaml program that does its job.
Now I would like to make it deliver services over the internet as soon as possible.
I'm not experienced in the web side of an Ocaml program. I've just studied some tutorials.
Could you please indicate me how to setup that in a straigth manner?
</p>

<p>
I understand that I need two things:
</p>
<ol class="org-ol">
<li>receiving http request:
<ul class="org-ul">
<li>get  incoming data flow from listened port</li>
<li>transform (json/xml) data in OCaml values</li>
</ul></li>

<li>sending http request:
<ul class="org-ul">
<li>transform Ocaml values in json data</li>
<li>send data over http (http request targetting IP:port)</li>
</ul></li>
</ol>

<p>
That should be pretty simple for people doing that everyday.
</p>

<p>
I see that Yojson can read a json data flow (Yojson.Basic.from_channel) and print  a json data (Yojson.Basic.pretty_to_string).
So it should answer one requirement. Am I right?
</p>

<p>
I intended to wrap curl command to send request, but there should be more elegant methods.
</p>

<p>
My main question seems to be: how can I receive and send http requests using a json (or xml) object?
</p>
</div>
</div>


<div id="outline-container-org993e348" class="outline-3">
<h3 id="org993e348">Philippe replied</h3>
<div class="outline-text-3" id="text-org993e348">
<p>
<code>yojson</code> is a good choice for the JSON part. Here are two simple options for the web server:
</p>
<ul class="org-ul">
<li>either <code>cohttp</code> [0], to have total control on your server</li>
<li>or <code>opium</code> [1] which seems well-suited for your task and is more high-level (opium runs on top of cohttp)</li>
</ul>

<p>
[0] <a href="https://github.com/mirage/ocaml-cohttp">https://github.com/mirage/ocaml-cohttp</a><br />
[1] <a href="https://github.com/rgrinberg/opium">https://github.com/rgrinberg/opium</a>
</p>
</div>
</div>
</div>




<div id="outline-container-org9b310b3" class="outline-2">
<h2 id="5">Other OCaml News</h2>
<div class="outline-text-2" id="text-5">
</div>
<div id="outline-container-orgc55e05d" class="outline-3">
<h3 id="orgc55e05d">From the ocamlcore planet blog</h3>
<div class="outline-text-3" id="text-orgc55e05d">
<p>
Here are links from many OCaml blogs aggregated at <a href="http://ocaml.org/community/planet/">OCaml Planet</a>.
</p>

<ul class="org-ul">
<li><a href="http://math.andrej.com/2019/09/09/on-complete-ordered-fields/">On complete ordered fields</a></li>
<li><a href="https://tarides.com/blog/2019-09-04-an-introduction-to-fuzzing-ocaml-with-afl-crowbar-and-bun.html">An introduction to fuzzing OCaml with AFL, Crowbar and Bun</a></li>
<li><a href="http://math.andrej.com/2019/09/03/what-is-algebraic-about-algebraic-effects/">What is algebraic about algebraic effects?</a></li>
<li><a href="http://math.andrej.com/2019/09/03/the-blog-moved-from-wordpress-to-jekyll/">The blog moved from Wordpress to Jekyll</a></li>
<li><a href="http://www.ocamlpro.com/2019/08/30/ocamlpros-compiler-team-work-update/">OCamlPro’s compiler team work update</a></li>
<li><a href="https://blog.janestreet.com/what-the-interns-have-wrought-2019/">What the interns have wrought, 2019 edition</a></li>
</ul>
</div>
</div>
</div>




<div id="outline-container-orgbf9cf55" class="outline-2">
<h2 id="orgbf9cf55">Old CWN</h2>
<div class="outline-text-2" id="text-orgbf9cf55">
<p>
If you happen to miss a CWN, you can <a href="mailto:alan.schmitt@polytechnique.org">send me a message</a> and I'll mail it to you, or go take a look at <a href="http://alan.petitepomme.net/cwn/">the archive</a> or the <a href="http://alan.petitepomme.net/cwn/cwn.rss">RSS feed of the archives</a>.
</p>

<p>
If you also wish to receive it every week by mail, you may subscribe <a href="http://lists.idyll.org/listinfo/caml-news-weekly/">online</a>.
</p>

<div class="authorname">
<p>
<a href="http://alan.petitepomme.net/">Alan Schmitt</a>
</p>

</div>
</div>
</div>
</div>
</body>
</html>
